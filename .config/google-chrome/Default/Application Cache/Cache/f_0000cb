/*
 * Copyright (c) 2014 Amazon.com, Inc. All rights reserved.
 */
(function(){var f=Handlebars.template,h=Handlebars.templates=Handlebars.templates||{};h.KindleLibraryAppCacheFailDialog=f(function(d,e,c,b,g){this.compilerInfo=[2,">= 1.0.0-rc.3"];var c=c||d.helpers,g=g||{},d="",a,j=c.helperMissing,k=this.escapeExpression;d+='<div id=\'kindle_dialog_appCacheFail\'>\n    <div class="box-top">&nbsp;</div>\n    <div class="content-container">\n        <div id="content">\n            <h2> ';b={hash:{},data:g};d+=k((a=c.str,a?a.call(e,"k_dialog_appCache_title_text",b):
j.call(e,"str","k_dialog_appCache_title_text",b)))+"</h2>\n            <p> ";b={hash:{},data:g};d+=k((a=c.str,a?a.call(e,"k_dialog_appCache_message_text",b):j.call(e,"str","k_dialog_appCache_message_text",b)))+' </p>\n            <div id="appCacheDialogFail_toggler" class="toggler"> \n                <span id="appCacheDialogFail_arrow" class="kindleLibrary_arrowClosed">\n                </span>\n                <span class = "boldText"> \n                  ';b={hash:{},data:g};d+=k((a=c.str,a?a.call(e,
"k_dialog_appCache_readmore_text",b):j.call(e,"str","k_dialog_appCache_readmore_text",b)))+" \n                </span>\n            </div>\n            <br/>\n            <div id=\"appCacheDialogFail_content\" style='display:none'>\n                    <span class='appCacheFail_label boldText'>";b={hash:{},data:g};d+=k((a=c.str,a?a.call(e,"k_dialog_appCache_step1_text",b):j.call(e,"str","k_dialog_appCache_step1_text",b)))+"</span> <span class='appCacheFail_field'>";b={hash:{},data:g};d+=k((a=c.str,
a?a.call(e,"k_dialog_appCache_instruction1_text",b):j.call(e,"str","k_dialog_appCache_instruction1_text",b)))+"</span><br/>\n                    <span class='appCacheFail_label boldText'>";b={hash:{},data:g};d+=k((a=c.str,a?a.call(e,"k_dialog_appCache_step2_text",b):j.call(e,"str","k_dialog_appCache_step2_text",b)))+"</span> <span class='appCacheFail_field'>";b={hash:{},data:g};d+=k((a=c.str,a?a.call(e,"k_dialog_appCache_instruction2_text",b):j.call(e,"str","k_dialog_appCache_instruction2_text",b)))+
"</span><br/>\n                    <span class='appCacheFail_label boldText'>";b={hash:{},data:g};d+=k((a=c.str,a?a.call(e,"k_dialog_appCache_step3_text",b):j.call(e,"str","k_dialog_appCache_step3_text",b)))+"</span> <span class='appCacheFail_field'>";b={hash:{},data:g};d+=k((a=c.str,a?a.call(e,"k_dialog_appCache_instruction3_text",b):j.call(e,"str","k_dialog_appCache_instruction3_text",b)))+"</span><br/>\n                    <span class='appCacheFail_label boldText'>";b={hash:{},data:g};d+=k((a=
c.str,a?a.call(e,"k_dialog_appCache_step4_text",b):j.call(e,"str","k_dialog_appCache_step4_text",b)))+"</span> <span class='appCacheFail_field'>";b={hash:{},data:g};d+=k((a=c.str,a?a.call(e,"k_dialog_appCache_instruction4_text",b):j.call(e,"str","k_dialog_appCache_instruction4_text",b)))+"</span><br/>\n                    <span class='appCacheFail_label boldText'>";b={hash:{},data:g};d+=k((a=c.str,a?a.call(e,"k_dialog_appCache_step5_text",b):j.call(e,"str","k_dialog_appCache_step5_text",b)))+"</span> <span class='appCacheFail_field'>";
b={hash:{},data:g};d+=k((a=c.str,a?a.call(e,"k_dialog_appCache_instruction5_text",b):j.call(e,"str","k_dialog_appCache_instruction5_text",b)))+'</span><br/><br/>\n           </div>\n        </div>\n    </div>\n    <div class="box-bottom">\n        <p>\n            <span class="primary_btn" id="kindle_appCacheDialog_button">';b={hash:{},data:g};d+=k((a=c.str,a?a.call(e,"k_dialog_appCache_button_text",b):j.call(e,"str","k_dialog_appCache_button_text",b)))+"</span>\n        </p>\n    </div>\n</div>";
return d});h.KindleLibraryBookContainer=f(function(d,e,c,b,g){this.compilerInfo=[2,">= 1.0.0-rc.3"];var c=c||d.helpers,g=g||{},d="",a=this.escapeExpression;d+='<div id="';(b=c.asin)?b=b.call(e,{hash:{},data:g}):(b=e.asin,b=typeof b==="function"?b.apply(e):b);d+=a(b)+'" class="book_container">\n    <div class="book_cover">\n        <img class="book_image book_click_area" src="';(b=c.src)?b=b.call(e,{hash:{},data:g}):(b=e.src,b=typeof b==="function"?b.apply(e):b);d+=a(b)+'" title="';(b=c.title)?b=b.call(e,
{hash:{},data:g}):(b=e.title,b=typeof b==="function"?b.apply(e):b);d+=a(b)+'">\n        <div class="alt_title book_click_area"></div>\n    </div>\n    <div class="book_details">\n        <div class="book_title book_click_area">';(b=c.title)?b=b.call(e,{hash:{},data:g}):(b=e.title,b=typeof b==="function"?b.apply(e):b);d+=a(b)+'</div>\n        <div class="book_author book_click_area">';(b=c.author)?b=b.call(e,{hash:{},data:g}):(b=e.author,b=typeof b==="function"?b.apply(e):b);d+=a(b)+"</div>\n    </div>\n</div>";
return d});h.KindleLibraryControlBar=f(function(d,e,c,b,g){this.compilerInfo=[2,">= 1.0.0-rc.3"];var c=c||d.helpers,g=g||{},d="",a,j,b=c.helperMissing,k=this.escapeExpression;d+='<div id="view_sort_size_controls">\n    <div id="view_toggle">\n        <div id="view_buttons">\n            <div id="view_grid" class="btn_set btn_set_left" value="grid" title=\'';j={hash:{},data:g};d+=k((a=c.str,a?a.call(e,"k_L_toolbar_grid_button",j):b.call(e,"str","k_L_toolbar_grid_button",j)))+'\'>\n                <div id="view_grid_icon" value="grid"></div>\n            </div>\n            <div id="view_list" class="btn_set btn_set_right" value="list" title=\'';
j={hash:{},data:g};d+=k((a=c.str,a?a.call(e,"k_L_toolbar_list_button",j):b.call(e,"str","k_L_toolbar_list_button",j)))+'\'>\n                <div id="view_list_icon" value="list"></div>\n            </div>\n        </div>\n    </div>\n    <div id="view_sort">\n        <div id="kindleLibrary_button_sort" class="btn_set btn_set_left btn_set_right" title=\'';j={hash:{},data:g};d+=k((a=c.str,a?a.call(e,"k_L_toolbar_sort_button",j):b.call(e,"str","k_L_toolbar_sort_button",j)))+'\'>\n            <div id="kindleLibrary_button_sort_label" style="display: inline">';
(j=c.sortParam)?j=j.call(e,{hash:{},data:g}):(j=e.sortParam,j=typeof j==="function"?j.apply(e):j);d+=k(j)+'</div>\n            <div id="kindleLibrary_button_sort_arrow"></div>\n        </div>\n    </div>\n    <div id="view_state">\n       <div id="view_state_buttons">\n        <div id="view_cloud"      class="btn_set btn_set_left" value="cloud"\n        title=\'';j={hash:{},data:g};d+=k((a=c.str,a?a.call(e,"k_L_toolbar_cloud_button",j):b.call(e,"str","k_L_toolbar_cloud_button",j)))+"'>";j={hash:{},
data:g};d+=k((a=c.str,a?a.call(e,"k_L_toolbar_cloud_label",j):b.call(e,"str","k_L_toolbar_cloud_label",j)))+'</div>\n        <div id="view_downloaded" class="btn_set btn_set_right"\n        value="downloaded" title=\'';j={hash:{},data:g};d+=k((a=c.str,a?a.call(e,"k_L_toolbar_downloaded_button",j):b.call(e,"str","k_L_toolbar_downloaded_button",j)))+"'>";j={hash:{},data:g};d+=k((a=c.str,a?a.call(e,"k_L_toolbar_downloaded_label",j):b.call(e,"str","k_L_toolbar_downloaded_label",j)))+'</div>\n       </div>\n       <div id="cache_state">\n            <div id="cache_icon">\n                <div id="kindleLibrary_cache_spinner" class="spinner">\n                    <div class="bar1"></div>\n                    <div class="bar2"></div>\n                    <div class="bar3"></div>\n                    <div class="bar4"></div>\n                    <div class="bar5"></div>\n                    <div class="bar6"></div>\n                    <div class="bar7"></div>\n                    <div class="bar8"></div>\n                    <div class="bar9"></div>\n                    <div class="bar10"></div>\n                    <div class="bar11"></div>\n                    <div class="bar12"></div>\n                </div>\n                <div id="cache_image"></div>\n            </div>\n            <span id="cache_message">';
j={hash:{},data:g};d+=k((a=c.str,a?a.call(e,"k_L_caching",j):b.call(e,"str","k_L_caching",j)))+"</span>\n       </div>\n    </div>\n</div>";return d});h.KindleLibraryFeedbackDialog=f(function(d,e,c,b,g){this.compilerInfo=[2,">= 1.0.0-rc.3"];var c=c||d.helpers,g=g||{},d="",a,j=c.helperMissing,k=this.escapeExpression;d+='<form id="KindleLibrary_feedback_container">\n    <p id="kindle_feedback_title_text" class="kindle_dialog_title_text">';b={hash:{},data:g};d+=k((a=c.str,a?a.call(e,"k_provide_feedback_title",
b):j.call(e,"str","k_provide_feedback_title",b)))+'</p>\n    <p id="kindle_feedback_message_text" class="kindle_dialog_text">';b={hash:{},data:g};d+=k((a=c.str,a?a.call(e,"k_provide_feedback_text",b):j.call(e,"str","k_provide_feedback_text",b)))+'</p>\n    <textarea id="kindleLibrary_feedback_area"></textarea>\n    <div id="kindleLibrary_feedback_status"></div>\n</form>';return d});h.KindleLibraryHeaderBar=f(function(d,e,c,b,g){this.compilerInfo=[2,">= 1.0.0-rc.3"];var c=c||d.helpers,g=g||{},d="",
a,j=c.helperMissing,k=this.escapeExpression;d+="<div id='page_header'>\n    <div id='kindleLibrary_kindleLogo'></div>\n    <div id='header_left' class='libraryControls'>\n\n        <div\n            id='kindleLibrary_button_notebook'\n            class='header_bar_icon'\n            btnLbl='";b={hash:{},data:g};d+=k((a=c.str,a?a.call(e,"k_L_toolbar_notebook_button",b):j.call(e,"str","k_L_toolbar_notebook_button",b)))+"'\n            title='";b={hash:{},data:g};d+=k((a=c.str,a?a.call(e,"k_L_toolbar_notebook_button_tooltip",
b):j.call(e,"str","k_L_toolbar_notebook_button_tooltip",b)))+"'\n        ></div>\n\n        <div\n            id='kindleLibrary_button_sync'\n            class='header_bar_icon'\n            btnLbl='";b={hash:{},data:g};d+=k((a=c.str,a?a.call(e,"k_L_toolbar_sync_button",b):j.call(e,"str","k_L_toolbar_sync_button",b)))+"'\n            title='";b={hash:{},data:g};d+=k((a=c.str,a?a.call(e,"k_L_toolbar_sync_button_tooltip",b):j.call(e,"str","k_L_toolbar_sync_button_tooltip",b)))+"'\n        ></div>\n\n        <div\n            id='kindleLibrary_button_manage'\n            class='header_bar_icon'\n            btnLbl='";
b={hash:{},data:g};d+=k((a=c.str,a?a.call(e,"k_L_toolbar_manage_button",b):j.call(e,"str","k_L_toolbar_manage_button",b)))+"'\n            title='";b={hash:{},data:g};d+=k((a=c.str,a?a.call(e,"k_L_toolbar_manage_button_tooltip",b):j.call(e,"str","k_L_toolbar_manage_button_tooltip",b)))+"'\n        ></div>\n\n    </div>\n\n    <div id='kindleLibrary_search' class='search libraryControls'>\n\n        <div\n            id='kindleLibrary_button_search'\n            class='search header_bar_icon large'\n            btnLbl='";
b={hash:{},data:g};d+=k((a=c.str,a?a.call(e,"k_L_toolbar_search_button",b):j.call(e,"str","k_L_toolbar_search_button",b)))+"'\n            title='";b={hash:{},data:g};d+=k((a=c.str,a?a.call(e,"k_L_toolbar_search_button_tooltip",b):j.call(e,"str","k_L_toolbar_search_button_tooltip",b)))+"'\n        ></div>\n\n        <input\n            id='kindleLibrary_bar_search'\n            disabled='disabled'\n            class='search'/>\n\n        <div\n            id='kindleLibrary_clear_search'\n            class='search'\n        ></div>\n\n    </div>\n\n   <div id='header_right' class='libraryControls'>\n        <div\n            class='kbtn header_bar_icon'\n            id='kindleLibrary_button_store'\n            btnLbl='";
b={hash:{},data:g};d+=k((a=c.str,a?a.call(e,"k_L_toolbar_store_button",b):j.call(e,"str","k_L_toolbar_store_button",b)))+"'\n            title='";b={hash:{},data:g};d+=k((a=c.str,a?a.call(e,"k_L_toolbar_store_button_tooltip",b):j.call(e,"str","k_L_toolbar_store_button_tooltip",b)))+"'\n        >\n                ";b={hash:{},data:g};d+=k((a=c.str,a?a.call(e,"k_L_toolbar_store_button",b):j.call(e,"str","k_L_toolbar_store_button",b)))+"\n        </div>\n    </div>\n\n    <div id='header_center'></div>\n</div>";
return d});h.KindleLibraryHomeScreenPopup=f(function(){this.compilerInfo=[2,">= 1.0.0-rc.3"];return'<div id="kindleAddToHomeScreen" class=\'ui-corner-all\'>\n    <div class="addToHomeIcon"></div>\n    <div class="arrow"></div>\n    <div class="addToHomeText"></div>\n</div>'});h.KindleLibraryImageSlider=f(function(d,e,c,b,g){this.compilerInfo=[2,">= 1.0.0-rc.3"];var c=c||d.helpers,g=g||{},d="",a,b=c.helperMissing,j=this.escapeExpression;d+='<div id="scaleHolder">\n<div class="kindleLibrary_scaleHolder" style="position: absolute" /> \n    <div id="view_scale">\n        <div id="kindleLibrary_coverImage_slider"\n        title=\'';
g={hash:{},data:g};d+=j((a=c.str,a?a.call(e,"k_L_toolbar_cover_slider",g):b.call(e,"str","k_L_toolbar_cover_slider",g)))+"'>\n        </div>\n    </div>\n</div>";return d});h.KindleLibraryJPMerchandiseContent=f(function(d,e,c,b,g){this.compilerInfo=[2,">= 1.0.0-rc.3"];var c=c||d.helpers,g=g||{},d="",a,j=this.escapeExpression,k=c.helperMissing;d+='<p class="kindleLibrary_jp_merchandise_message">';b={hash:{},data:g};d+=j((a=c.str,a?a.call(e,"k_L_jp_merchandise_dialog_message",b):k.call(e,"str","k_L_jp_merchandise_dialog_message",
b)))+'</p>\n<div id="kindleLibrary_jp_merchandise_scrollWrapper">\n    <div id="kindleLibrary_jp_merchandise_scrollPane">\n        ';if((e=c.each.call(e,e.bookList,{hash:{},inverse:this.noop,fn:this.program(1,function(a){var b="",c;b+='\n            <div class="book_container">\n                <img class="book_merch_image" src="'+j((c=a.imgUrl,typeof c==="function"?c.apply(a):c))+'" title="'+j((c=a.title,typeof c==="function"?c.apply(a):c))+'" data-asin="'+j((c=a.asin,typeof c==="function"?c.apply(a):
c))+'">\n            </div>\n        ';return b},g),data:g}))||e===0)d+=e;d+="\n    </div>\n</div>\n";return d});h.KindleLibraryJPMerchandiseDialog=f(function(d,e,c,b,g){this.compilerInfo=[2,">= 1.0.0-rc.3"];var c=c||d.helpers,g=g||{},d="",a,b=c.helperMissing,j=this.escapeExpression;d+='<div id="kindleLibrary_jp_merchandise_pane">\n    <div id="kindleLibrary_jp_merchandise_header">';g={hash:{},data:g};d+=j((a=c.str,a?a.call(e,"k_L_jp_merchandise_dialog_title",g):b.call(e,"str","k_L_jp_merchandise_dialog_title",
g)))+'</div>\n    <div id="kindleLibrary_jp_merchandise_content">\n    </div>\n</div>';return d});h.KindleLibraryMessagePane=f(function(d,e,c,b,g){this.compilerInfo=[2,">= 1.0.0-rc.3"];var c=c||d.helpers,g=g||{},d="",a,j=c.helperMissing,k=this.escapeExpression;d+='<div id=\'empty_library_messages\'>\n\t<div id="empty-lib-box"> \n\t\t<div id="empty-lib-msg"> \n\t\t\t<p class="title"> ';b={hash:{},data:g};d+=k((a=c.str,a?a.call(e,"k_empty_library_title",b):j.call(e,"str","k_empty_library_title",b)))+
' </p>\n\t\t\t<p class="main"></p> \n\t\t\t<p class="free">';b={hash:{},data:g};d+=k((a=c.str,a?a.call(e,"k_empty_library_free",b):j.call(e,"str","k_empty_library_free",b)))+' </p>\n            <p class="button"><span class="primary_btn">';b={hash:{},data:g};d+=k((a=c.str,a?a.call(e,"k_empty_library_shop",b):j.call(e,"str","k_empty_library_shop",b)))+'</span></p>\n\t\t\t<p class="legal">';b={hash:{},data:g};d+=k((a=c.str,a?a.call(e,"k_empty_library_legal",b):j.call(e,"str","k_empty_library_legal",
b)))+' </p>\n\t\t</div> \n\t</div>\n    <div id="empty_search_box">\n        <div id="empty_search_text"></div>\n        <div id="empty_search_detail"></div>\n    </div>\n</div>';return d});h.KindleLibraryNoDownloadedMessage=f(function(d,e,c,b,g){this.compilerInfo=[2,">= 1.0.0-rc.3"];var c=c||d.helpers,g=g||{},d="",a,j=c.helperMissing,k=this.escapeExpression;d+="<div id='kindleLibrary_noDownloadedMessage_div' class='kindleLibrary_noDownloadsMsg'>\n    <div class='kindleLibrary_noDownloadedTitle'>";
b={hash:{},data:g};d+=k((a=c.str,a?a.call(e,"k_noDownloadedBooks_title",b):j.call(e,"str","k_noDownloadedBooks_title",b)))+'</div>\n    <div class="kindleLibrary_noDownloadedToggle"> \n    \t<span class="kindleLibrary_noDownloadedArrow kindleLibrary_arrowClosed">\n\t\t</span>\n\t\t<span class="download-hdr"> \n\t\t\t';b={hash:{},data:g};d+=k((a=c.str,a?a.call(e,"k_noDownloadedBooks_showmore",b):j.call(e,"str","k_noDownloadedBooks_showmore",b)))+" \n\t\t</span>\n    </div>\n    <div class='kindleLibrary_noDownloadedContent' style='display:none'>\n\t\t<span class=\"download-txt\">\n\t\t\t";
b={hash:{},data:g};d+=k((a=c.str,a?a.call(e,"k_noDownloadedBooks_msg",b):j.call(e,"str","k_noDownloadedBooks_msg",b)))+"\n\t\t</span>\n\t</div>\n</div>";return d});h.KindleLibraryProgressDialog=f(function(d,e,c,b,g){this.compilerInfo=[2,">= 1.0.0-rc.3"];var c=c||d.helpers,g=g||{},d="",a,j=c.helperMissing,k=this.escapeExpression;d+="<div id='kindleLibrary_dialog_progress'>\n    <p id='kindleLibrary_dialog_progressTitle' class='kindle_dialog_title_text'>";b={hash:{},data:g};d+=k((a=c.str,a?a.call(e,
"k_L_progress_dialog_title",b):j.call(e,"str","k_L_progress_dialog_title",b)))+"</p>\n    <p id='kindleLibrary_dialog_progressMessage' class='kindle_dialog_text'>";b={hash:{},data:g};d+=k((a=c.str,a?a.call(e,"k_L_progress_dialog_message",b):j.call(e,"str","k_L_progress_dialog_message",b)))+"</p>\n\t<div id='kindleLibrary_progressbar_div'></div>\n</div>";return d});h.KindleLibraryScrollBar=f(function(){this.compilerInfo=[2,">= 1.0.0-rc.3"];return'<div id="kindleLibrarySliderBar">\n    <a id="kindleLibrarySliderUpArrow" class="library_slider_arrow"></a>\n    <div id="KindleLibrarySliderContainer">\n        <div id="KindleLibrarySliderDiv">\n            <div id="KindleLibraryProgress"></div>\n        </div>\n    </div>\n    <a id="kindleLibrarySliderDownArrow" class="library_slider_arrow"></a>\n</div>'});
h.KindleUnsupportedContentDialog=f(function(d,e,c,b,g){this.compilerInfo=[2,">= 1.0.0-rc.3"];var c=c||d.helpers,g=g||{},d="",a=c.helperMissing,j=this.escapeExpression;d+='<div id="unsupportedContent_dialog">\n    ';if((e=c["if"].call(e,e.isiPad,{hash:{},inverse:this.program(3,function(b,e){var g="",d,f;g+='\n        <div id="unsupportedContent_text"> \n            ';f={hash:{},data:e};if((f=(d=c.str,d?d.call(b,"k_L_text_me_widget_Text",f):a.call(b,"str","k_L_text_me_widget_Text",f)))||f===0)g+=f;
g+='\n        </div>\n        <div id="unsupportedContent_instruction">';f={hash:{},data:e};g+=j((d=c.str,d?d.call(b,"k_L_text_me_wdiget_Instruction",f):a.call(b,"str","k_L_text_me_wdiget_Instruction",f)))+'</div>\n        <div id="unsupportedContent_text_me_widget_wrapper"></div>\n    ';return g},g),fn:this.program(1,function(b,g){var d="",e,f;d+='\n        <div id="unsupportedContent_text"> \n            ';f={hash:{},data:g};if((f=(e=c.str,e?e.call(b,"k_L_text_me_widget_Text",f):a.call(b,"str",
"k_L_text_me_widget_Text",f)))||f===0)d+=f;d+=' \n        </div>\n        <a id="unsupportedContent_get_app_button" target="_blank" href="';(f=c.getAppLink)?f=f.call(b,{hash:{},data:g}):(f=b.getAppLink,f=typeof f==="function"?f.apply(b):f);d+=j(f)+'">';f={hash:{},data:g};d+=j((e=c.str,e?e.call(b,"k_text_me_widget_GetApp",f):a.call(b,"str","k_text_me_widget_GetApp",f)))+"</a>\n    ";return d},g),data:g}))||e===0)d+=e;d+="\n</div>";return d})})();
function KindleModuleManagerFactory(){function f(a,b){if(o[a])throw"Duplicate registration of module "+a;if(!b)throw"Module is not initialized with an object "+a;o[a]=b;p[a].resolve(b)}function h(a){if(o.hasOwnProperty(a))throw"Duplicate registration of module "+a;o[a]=void 0}function d(a,b){p[a]||(p[a]=new jQuery.Deferred);f(a,b)}function e(a,b){h(a);p[a]||(p[a]=new jQuery.Deferred);b(p[a]);p[a].done(function(b){f(a,b)})}function c(a,b){e(a,function(a){b.done(a.resolve).fail(a.reject)})}function b(a){p[a]||
(p[a]=new jQuery.Deferred);return p[a].promise()}function g(a){if(!o[a])throw"Trying to get uninitialized module "+a;return o[a]}function a(a){return o.hasOwnProperty(a)}function j(a,b){o[a]=b}function k(a){var b=o[a];return{done:function(a){a(b)},fail:function(){},when:function(a){a(b)}}}function m(a){for(var b={},c=0;c<a.length;c++)b[name]=o[a];return{done:function(a){a(b)},fail:function(){},when:function(a){a(b)}}}function l(){o={}}var r={CONSTANTS:"Constants",DB_CLIENT:"DBClient",RESOURCE_BUNDLE:"ResourceBundle",
METRICS_MANAGER:"metrics_manager",SERVICE_CLIENT:"ServiceClient",APP_REGISTRATION:"Registration",JOURNAL_MANAGER:"JournalManager",BOOK_METADATA:"book_metaData",BOOK_FRAGMAP:"book_fragmap",EMBEDDED_HOSTINTERFACE:"embeddedHostInterface",CONTENT_MIGRATION:"contentMigration",NETWORK:"network",LINK_URLS:"linkUrls"},o={},p={};return{CONSTANTS:r.CONSTANTS,DB_CLIENT:r.DB_CLIENT,RESOURCE_BUNDLE:r.RESOURCE_BUNDLE,METRICS_MANAGER:r.METRICS_MANAGER,SERVICE_CLIENT:r.SERVICE_CLIENT,APP_REGISTRATION:r.APP_REGISTRATION,
JOURNAL_MANAGER:r.JOURNAL_MANAGER,BOOK_METADATA:r.BOOK_METADATA,BOOK_FRAGMAP:r.BOOK_FRAGMAP,EMBEDDED_HOSTINTERFACE:r.EMBEDDED_HOSTINTERFACE,CONTENT_MIGRATION:r.CONTENT_MIGRATION,NETWORK:r.NETWORK,LINK_URLS:r.LINK_URLS,ERROR_CODE_CANCEL:"canceled",registerModule:d,registerModuleList:function(a){for(var b in a)d(b,a[b])},registerModuleWithInitializer:e,registerModuleWithDeferred:c,detachModule:function(a){var b=o[a],c=p[a];c&&!c.isResolved()&&c.reject("canceled");delete o[a];delete p[a];return b},getModule:b,
getModuleList:function(a){var c=new jQuery.Deferred,d,e=[];for(d=0;d<a.length;d++)e.push(b(a[d]));$.when.apply($,e).done(function(){var b,d={};for(b=0;b<a.length;b++)d[a[b]]=arguments[b];c.resolve(d)}).fail(c.reject);return c.promise()},getModuleSync:g,isModuleInitialized:function(a){return o[a]!==void 0},isModuleRegistered:a,switchToTestMode:function(){this.registerModuleTest=j;this.getModule=k;this.getModuleSync=g;this.getModuleList=m;this.clear=l;delete this.registerModuleWithDeferred;delete this.registerModuleWithInitializer},
define:function(d,e,g){if(!a(d)){var j=[],k=$.Deferred();c(d,k);e&&e.length&&e.forEach(function(a){j.push(a&&$.isFunction(a.promise)?a:b(a))});$.when.apply($,j).then(function(){var a;typeof g==="function"?(a=$.makeArray(arguments),a=g.apply(g,a)):a=g;a&&$.isFunction(a.promise)?a.then(k.resolve,function(){k.reject()}):k.resolve(a)},function(){k.reject()})}},require:function(a,c){$.isArray(a)||(a=[a]);var d,e,g=[];a.forEach(function(a){g.push(a&&$.isFunction(a.promise)?a:b(a))});c||(e=$.Deferred(),
d=e.promise());$.when.apply($,g).then(function(){var a=$.makeArray(arguments);c?c.apply(c,a):e.resolve.apply(e,a)},function(){e&&e.reject()});return d}}}
var KindleModuleManager=KindleModuleManagerFactory(),BookChunk=function(){var f=Object.freeze?function(c){return Object.freeze(c)}:function(c){return c},h=["fragment","glyph","skeleton","resource","locationMap"],d={};h.forEach(function(c){d[c]={}});d.resource.huge=!0;var e={types:f(h),properties:f(d),getId:function(c){if(c.fragmentMetadata!==void 0)return c.fragmentMetadata.id;else if(c.skeletonMetadata!==void 0)return c.skeletonMetadata.id;else if(c.glyphFragmentMetadata!==void 0)return c.glyphFragmentMetadata.id;
else if(c.metadata!==void 0)return c.metadata.id;else KindleAssert(!1,"Can't get id from book chunk: unrecognizable metadata.")}};h.forEach(function(c){e[c.toUpperCase()+"_TYPE"]=c});return f(e)}(),BookDownloadController=function(){function f(d){if(!this instanceof f)return new f(d);var e={downloading:!1,waiting:!1,total:0,remaining:0,scaleFactor:1};Object.defineProperty(this,"downloading",{get:function(){return e.downloading},set:function(b){e.downloading=!!b},enumerable:!0});Object.defineProperty(this,
"waiting",{get:function(){return e.waiting},set:function(b){e.waiting=!!b},enumerable:!0});Object.defineProperty(this,"total",{get:function(){return e.total},set:function(b){e.total=b},enumerable:!0});Object.defineProperty(this,"scaledTotal",{get:function(){return e.total*e.scaleFactor},enumerable:!0});Object.defineProperty(this,"remaining",{get:function(){return e.remaining},set:function(b){e.remaining=b},enumerable:!0});Object.defineProperty(this,"scaledRemaining",{get:function(){return e.remaining*
e.scaleFactor},enumerable:!0});Object.defineProperty(this,"scaleFactor",{get:function(){return e.scaleFactor},set:function(b){e.scaleFactor=b},enumerable:!0});var d=d||{},c;for(c in d)d[c]!==void 0&&d.hasOwnProperty(c)&&e.hasOwnProperty(c)&&(e[c]=d[c])}var h={glyph:7,resource:20,sidecar:10,valueFor:function(d){return h.hasOwnProperty(d)?h[d]:1}};return{create:function(d){function e(){function a(b){if(m[b].waiting)return m[b].waiting=!1,m[b].downloading=!0,m[b].start(),!0}var b=!1,c=!1,d=!1;BookChunk.types.forEach(function(a){b=
b||m[a].downloading;d=d||m[a].waiting});l.forEach(function(a){b=b||m[a].downloading;c=c||m[a].waiting});d?BookChunk.types.some(a):!b&&!c?(KindleDebug.log("done downloading"),k.resolve()):!b&&c&&l.some(a)}function c(a){var c=new $.Deferred;if(m[a].remaining<=0)return g(a),c.resolve();a=d.downloaders[a];a.addEventListener("onProgress",b);a.addEventListener("onCompleted",function(a){g(a);c.resolve()});a.addEventListener("onFailed",function(a,b,d){m[a].waiting=!1;j(b,d);c.reject()});a.start();return c.promise()}
function b(a,b){if(b!==m[a].remaining){m[a].remaining=b;var c=0,d=0;BookChunk.types.forEach(function(a){c+=m[a].scaledRemaining;d+=m[a].scaledTotal});l.forEach(function(a){c+=m[a].scaledRemaining;d+=m[a].scaledTotal});k.notify(c,d)}}function g(a){m[a].downloading=!1;m[a].waiting=!1;e()}function a(a){function c(){KindleDebug.log("Finished downloading sidecar: "+a);m[j].downloading=!1;b(j,0);e()}function g(c){KindleDebug.error("Error downloading sidecar '"+a+"': "+c);m[j].downloading=!1;b(j,0);e()}
var j="SC:"+a;l.push(j);m[j]=new f({scaleFactor:h.valueFor("sidecar"),total:1,remaining:1,waiting:!0});m[j].start=function(){KindleDebug.log("Downloading sidecar: "+a);d.sidecarManager.download(a).then(c,g)}}function j(a,b){a=a||Kindle.ERROR.CANCELLED;BookChunk.types.forEach(function(a){if(m[a].downloading)d.downloaders[a].cancel(),m[a].downloading=!1});k.reject(a,b)}var k=$.Deferred(),m={},l=[];BookChunk.types.forEach(function(a){m[a]=new f({scaleFactor:h.valueFor(a)})});return{startDownload:function(){var b=
d.downloadingContentProvider;$.when(b.getBookinfo(),b.computeCacheQuota(),KindleModuleManager.getModule(Kindle.MODULE.SidecarManager)).done(function(b){var g=b.context.cacheState||b.cacheState;if(g===Kindle.BookInfo.CachedState.CACHED||g===Kindle.BookInfo.CachedState.PINNED)k.resolve();else{var j={skeleton:(Number(b.fragmap.fragmentMetadata.numberOfSkeletons)||1)-1,fragment:Number(b.fragmap.fragmentMetadata.numberOfFragments)-1,glyph:(Number(b.metadata.numOfGlyphFragments)||0)-1,resource:b.manifest&&
b.manifest.resourceManifest?Number(Math.max.apply(Math,Object.keys(b.manifest.resourceManifest))):-1,locationMap:b.metadata.locationsInfo&&b.metadata.locationsInfo.numOfLocations?Math.floor((Number(b.metadata.locationsInfo.numOfLocations)-1)/Number(b.metadata.locationsInfo.mapSize)):-1};BookChunk.types.forEach(function(a){var b=d.downloaders[a];b.init(j[a],d.fast);m[a].waiting=!0;m[a].remaining=m[a].total=b.getNumIds();m[a].start=function(){c(a)}});Object.keys(d.sidecarManager.names).forEach(a);e()}})},
failDownload:j,cancelDownload:j,pauseDownload:function(){BookChunk.types.forEach(function(a){m[a].downloading&&d.downloaders[a].pause()})},resumeDownload:function(){BookChunk.types.forEach(function(a){m[a].downloading&&d.downloaders[a].resume()})},whenDownloadComplete:function(){return k.promise()}}}}}();
function KindleBookDownloaderFactory(f){var h=5E3,d=0,e=1E3,c=$.Deferred().resolve(),b={};f.downloader=b;b.type=f.type;b.cache=f.cache;b.throttle=f.throttle;b.readAheadActive=!1;b.readAheadPauseCount=0;b.dbPutter=f.dbPutter;b.dbGetIdList=f.dbGetIdList;b.dbOosHandler=f.dbOosHandler;b.dbCheckCache=f.dbCheckCache;b.dbIsCached=f.dbIsCached;b.dbIsOos=f.dbIsOos;b.netGetter=f.netGetter;b.urlGetter=f.urlGetter;b.fileGetter=f.fileGetter;b.fileProgress=f.fileProgress;b.downloadError=f.downloadError;b.isIdRequired=
f.isIdRequired||function(){return!0};b.numIds=0;b.pauseReadAhead=function(){this.readAheadPauseCount++};b.resumeReadAhead=function(){this.readAheadPauseCount=Math.max(0,--this.readAheadPauseCount)};b.setNextId=function(b){if(b!==void 0&&this.readAheadActive)this.nextReadAheadId=b};b.removeIdFromReadAhead=function(b){if(this.readAheadActive){var a;for(a=0;a<this.readAheadIds.length;a++)if(this.readAheadIds[a]===b){this.readAheadIds.splice(a,1);break}for(a=0;a<this.readAheadUrls.length;a++)if(this.readAheadUrls[a].id===
b){this.readAheadUrls.splice(a,1);break}}};b.freeDbSpace=function(){var b=this;if(c&&c.state()==="pending")return c.promise();c=new $.Deferred;b.dbCheckCache();b.dbOosHandler(c.resolve,function(){if(b.readAheadActive)b.readAheadActive=!1,b.dbIsOos();c.reject()});return c.promise()};b.isStillActive=function(b){return!this.readAheadActive||this.readAheadGeneration!==b?!1:!0};b.readAheadOne=function(b){function a(){l.isStillActive(b)&&(l.numReadAheadNetRequests--,l.readAheadUrls.length===0?l.numReadAheadNetRequests===
0&&setTimeout(function(){l.getReadAheadUrls(b)},l.interReadWait):setTimeout(function(){l.readAheadOne(b)},l.interReadWait))}function d(a){var b=l.numReadAhead,a=a&&(a.data||JSON.stringify(a)).length||0,c=Math.max(Date.now()-f,1),c=(a/c*1E3).toFixed(),e=l.readAheadThroughput;a>4E4&&(e=(l.readAheadThroughput*0.8+c*0.2).toFixed(),c>1E5?b=Math.min(b+1,l.maxReadAhead):c<1E4&&(b=Math.max(b-1,1)));b>l.numReadAhead?l.numReadAheadIncreased++:b<l.numReadAhead&&l.numReadAheadDecreased++;l.highestReadAhead=Math.max(l.highestReadAhead,
b);l.numReadAhead=b;l.readAheadThroughput=e}function e(c,k){if(l.isStillActive(b)){if(k==="timeout")l.throttle?d(null):l.numReadAhead>1&&l.numReadAhead--;else if(k==="error"&&KindleModuleManager.getModuleSync(KindleModuleManager.NETWORK).isOnline()===!1){l.downloadError(Kindle.ERROR.NETWORK,Kindle.ERROR_CODE.OFFLINE);l.readAheadActive=!1;return}a()}}function m(e){function k(){l.isStillActive(b)&&(l.readAheadRemaining--,l.fileProgress(l.readAheadRemaining),a())}function m(d){function e(){if(l.readAheadActive)l.readAheadActive=
!1,l.dbIsOos();c.reject()}function j(){l.readAheadActive&&(KindleHostDeviceDetector.isIE()||l.dbPutter(r,k,e),k())}l.isStillActive(b)&&(d=d||{},!(d.code===Kindle.DB.CONSTRAINT_ERR||d.message==="constraint failed")&&d.code===Kindle.DB.QUOTA_ERR?l.freeDbSpace().then(j):a())}if(l.isStillActive(b)){l.throttle&&d(e);var f=BookChunk.getId(e),r=[];r[f]=e;$.when(c).then(function(){l.dbPutter(r,k,m)})}}var l=this,f=Date.now();if(l.isStillActive(b))if(l.readAheadStillAlive++,this.readAheadPauseCount>0)setTimeout(function(){l.readAheadOne(b)},
l.startReadWait);else if(l.readAheadUrls.length===0&&l.numReadAheadNetRequests===0)l.getReadAheadUrls(b);else for(;l.numReadAheadNetRequests<l.numReadAhead&&l.readAheadUrls.length>0;){l.numReadAheadNetRequests++;var h=l.readAheadUrls.shift();l.fileGetter(h,m,e)}};b.getReadAheadUrls=function(b){function a(a){e.readAheadUrls=a;setTimeout(function(){e.isStillActive(b)&&e.readAheadOne(b)},e.interReadWait)}function c(){e.downloadError(Kindle.ERROR.NETWORK,Kindle.ERROR_CODE.NO_URL)}function d(){if(e.dbCheckCache())e.getReadAheadUrls(b);
else if(e.isStillActive(b))e.readAheadActive=!1,e.dbIsOos()}var e=this;if(e.isStillActive(b))if(e.dbCheckCache()){e.readAheadStillAlive++;for(var l=[],f=0;f<e.readAheadIds.length&&e.readAheadIds[f]<e.nextReadAheadId;)f++;f===e.readAheadIds.length&&(f=0);l=e.readAheadIds.splice(f,e.numReadAheadUrls);l.length===0?e.refreshReadAheadList(b):(e.nextReadAheadId=f<e.readAheadIds.length?e.readAheadIds[f]:0,e.urlGetter(l,a,c))}else e.freeDbSpace().then(d)};b.refreshReadAheadList=function(c){function a(a){function e(){d.readAheadActive&&
d.getReadAheadUrls(c)}if(d.readAheadActive){var j=f.createSubTimer("success");d.readAheadStillAlive++;var h,n=[];for(h in a)n[a[h]]=!0;d.readAheadIds=[];for(h=0;h<=d.maxReadAheadId;h++)!n[h]&&b.isIdRequired(h)&&d.readAheadIds.push(h);j.addCount("needed",d.readAheadIds.length);j.addCount("total",d.maxReadAheadId+1);j.endTimer();f.endTimer();f.log();if(d.readAheadIds.length>0){if(d.readAheadRemaining=d.readAheadIds.length,d.readAheadRemaining!==d.readAheadRemainingPrev)d.readAheadRemainingPrev=d.readAheadRemaining,
setTimeout(e,d.startReadWait)}else d.readAheadActive=!1,d.dbIsCached()}}function e(){f.endTimer();d.downloadError(Kindle.ERROR.UNKNOWN_DB_ERROR)}var d=this;if(c===this.readAheadGeneration){var f;this.readAheadActive&&(f=KindleMetricsProfiler("bookDownloader.getIdList"),this.dbGetIdList(a,e))}};b.readAheadWatchdog=function(){var b=this;if(this.readAheadActive){if(this.readAheadStillAlive===0&&(this.readAheadPauseCount===0||this.readAheadGeneration===0))this.readAheadGeneration++,this.readAheadRemaining<
this.generationReadAheadRemaining?(this.numReadAheadNetRequests=0,this.generationReadAheadRemaining=this.readAheadRemaining,this.readAheadRemainingPrev=this.readAheadRemaining+1,this.watchDogTimeout=3E4,this.refreshReadAheadList(this.readAheadGeneration)):this.timeoutRetry?(this.generationReadAheadRemaining=this.readAheadRemaining+1,this.watchDogTimeout=12E4):this.downloadError(Kindle.ERROR.TIMEOUT);setTimeout(function(){b.readAheadWatchdog()},this.watchDogTimeout)}this.readAheadStillAlive=0};b.initialize=
function(c,a){if(this.cache){this.fastest=a;this.readAheadUrls=[];this.readAheadIds=[];this.numReadAheadNetRequests=this.nextReadAheadId=0;this.maxReadAheadId=c;this.readAheadActive=!0;this.readAheadGeneration=this.readAheadStillAlive=0;this.watchDogTimeout=3E4;for(var j=this.numIds=0;j<=c;j++)b.isIdRequired(j)&&this.numIds++;this.readAheadRemaining=this.numIds+1;this.readAheadRemainingPrev=this.readAheadRemaining+1;this.generationReadAheadRemaining=this.numIds+2;this.fastest?(this.startReadWait=
this.interReadWait=this.startReadAheadWait=0,this.numReadAhead=8,this.numReadAheadUrls=200):(this.startReadAheadWait=h,this.interReadWait=d,this.startReadWait=e,this.numReadAhead=4,this.numReadAheadUrls=20,this.timeoutRetry=!0);if(this.throttle)this.maxReadAhead=this.numReadAhead,this.highestReadAhead=1,this.numReadAheadDecreased=this.numReadAheadIncreased=0,this.numReadAhead=1,this.readAheadThroughput=0,this.numReadAheadUrls=40;this.debugCounter=15}else this.readAheadActive=!1;this.initialized=!0};
b.startReadAhead=function(){var b=this;KindleAssert(b.initialized,"Failed to call initialize before startReadAhead");b.cache?setTimeout(function(){b.readAheadWatchdog()},b.startReadAheadWait):b.readAheadActive=!1};b.cancelReadAhead=function(){this.readAheadActive=!1;this.readAheadGeneration=-1;this.readAheadIds=this.readAheadUrls=null};b.setReadAheadTimersForTestMode=function(){e=d=h=0};return b}
function KindleReaderBookInfoProviderFactory(){var f="book_context",h="book_metaData",d="book_manifest",e="book_key",c="book_fragmap",b="book_ok_to_download",g="book_skeleton_builder",a="book_resource_urls";return{BookInfo:function(j,k){function m(a,b){ka&&ka(b-a,b)}function l(){var a=new jQuery.Deferred;KindleLibraryBookCover.getOfflineCover(T).then(function(b){s.getModuleSync(KindleModuleManager.DB_CLIENT).getBookDb().getTable("covers").insertRecord({asin:T,coverData:b}).then(a.resolve,a.reject)},
a.reject);return a.promise()}function r(a){function b(){var c=s.getModuleSync(f);C.updateBookinfo({cacheState:a,context:c}).then(d.resolve,d.reject)}function c(){d.reject(Kindle.ERROR.NETWORK,Kindle.ERROR_CODE.CACHED_STATE)}var d=new jQuery.Deferred;D().done(function(){var e;s.isModuleInitialized(f)?(e=s.getModuleSync(f),e.isSample?b():(e={asin:T,kindleSessionId:e.kindleSessionId,isOffline:a===Kindle.BookInfo.CachedState.PINNED},s.getModuleSync(s.SERVICE_CLIENT).setOfflineStatus(e).then(b,c))):d.reject()});
return d.promise()}function o(){U&&(U.endTimer(),U.log(),U=null);var a=F!==ga&&F!==Kindle.BookInfo.CachedState.PINNED?r(ga):!0;$.when(a).then(function(){l().then(R.resolve,R.resolve)},function(a){a===Kindle.ERROR.NETWORK?R.reject(a,Kindle.ERROR_CODE.CACHED_STATE):R.reject(Kindle.ERROR.UNKNOWN_DB_ERROR)});var b=[];if(a=y.getBookType())b.push("::"+a),a===Kindle.BookInfo.BookType.MOBI8&&(y.isContentScrambled()===!0?b.push("::mobi8::scrambled"):y.isContentScrambled()===!1&&b.push("::mobi8::unscrambled"));
C.getBookStatistics().then(function(a){N&&(a.fragments!==void 0&&(v.increaseSubCounter(N,"fragmentCount",a.fragments.count),v.increaseSubCounter(N,"fragmentsSize",a.fragments.size)),a.glyphs!==void 0&&(v.increaseSubCounter(N,"glyphCount",a.glyphs.count),v.increaseSubCounter(N,"glyphsSize",a.glyphs.size)),v.endMetrics(N,b))},function(){N&&v.endMetrics(N,b)})}function p(){function a(){KindleModuleManager.getModuleSync(Kindle.MODULE.DB_CLIENT).removeEventListener(Kindle.ERROR.DB_LINGERING_WRITE,c);o()}
function b(a){KindleModuleManager.getModuleSync(Kindle.MODULE.DB_CLIENT).removeEventListener(Kindle.ERROR.DB_LINGERING_WRITE,c);R.reject(a)}function c(a){a.type===Kindle.ERROR.DB_LINGERING_WRITE&&(a.stalled?K.downloadController.pauseDownload():K.downloadController.resumeDownload())}K.downloadController?(KindleModuleManager.getModuleSync(Kindle.MODULE.DB_CLIENT).addEventListener(Kindle.ERROR.DB_LINGERING_WRITE,c),K.downloadController.startDownload(),K.downloadController.whenDownloadComplete().then(a,
b,[m,R.progress])):ca?b():R.reject(Kindle.CACHING.DISABLED)}function n(){if(!s.isModuleRegistered(c)){v.startSubTimer(J,"getFragMap");var a=H.getFragmap();a.done(function(){v.endSubTimer(J,"getFragMap")});s.registerModuleWithDeferred(c,a)}return s.getModule(c)}function q(a){var b;a.cpr!==void 0&&(b={},KindleCompression.lzAddStringsToDictionary(a.cpr,b),KindleCompression.lzAddNumbersToDictionary(b),ba=KindleCompression.lzGetDecompressionDictionary(b));a.cprJson!==void 0&&(b={},KindleCompression.lzAddStringsToDictionary(a.cprJson,
b,256),KindleCompression.lzAddNumbersToDictionary(b,256),ha=KindleCompression.lzGetDecompressionDictionary(b))}function t(){function a(b){H.getMetadata().then(function(a){v.endSubTimer(J,"getMetadata");q(a);b.resolve(a)},b.reject)}s.isModuleRegistered(h)||(v.startSubTimer(J,"getMetadata"),s.registerModuleWithInitializer(h,a));return s.getModule(h)}function u(){if(!s.isModuleRegistered(d)){v.startSubTimer(J,"getManifest");var a=H.getManifest();a.done(function(){v.endSubTimer(J,"getManifest")});s.registerModuleWithDeferred(d,
a)}return s.getModule(d)}function G(){var a,b;b={resource:{isIdRequired:function(b){return b in a}}};var c={bookinfo:y,moduleManager:s,contentCache:C,kcrFree:j.kcrFree};P=s.getModuleSync(Kindle.MODULE.SidecarManager).create(c);H=NetworkContentProvider.create({context:s.getModuleSync(f),bookInfo:y,asin:T});u().done(function(b){a=b.resourceManifest||{}});ca?(b={asin:T,source:H,cache:C,tweaks:b,readAheadAgressively:la,sidecarManager:P},K=I=DownloadingContentProvider.create(b),KindleLocalStorage.getItem(Kindle.CACHING.CACHING)!==
Kindle.CACHING.ENABLED&&(v.emit([{name:z.ENABLED,params:{breakdown:["Browser"]}}]),KindleLocalStorage.setItem(Kindle.CACHING.CACHING,Kindle.CACHING.ENABLED))):(K=H,KindleLocalStorage.getItem(Kindle.CACHING.CACHING)!==Kindle.CACHING.DISABLED&&(v.emit([{name:z.DISABLED,params:{breakdown:["Browser"]}}]),KindleLocalStorage.setItem(Kindle.CACHING.CACHING,Kindle.CACHING.DISABLED)));$.when(u(),n()).done(function(a,b){ContentPrefetchOptimizations.modify(K,a,b);x();B()})}function x(){function a(b){s.getModuleList([h,
d]).done(function(a){a=KindleBookSkeletonBuilderFactory(K[BookChunk.SKELETON_TYPE],K[BookChunk.RESOURCE_TYPE],a[d],ba);v.endSubTimer(J,"getSkeletonBuilder");b.resolve(a)}).fail(b.fail)}s.isModuleRegistered(g)||(v.startSubTimer(J,"getSkeletonBuilder"),s.registerModuleWithInitializer(g,a))}function B(){function b(a){s.getModule(d).done(function(b){b=KindleBookResourceUrlTranslator(K[BookChunk.RESOURCE_TYPE],b,y);v.endSubTimer(J,"getResourceUrlTranslator");a.resolve(b)}).fail(a.fail)}s.isModuleRegistered(a)||
(v.startSubTimer(J,"getResourceUrlTranslator"),s.registerModuleWithInitializer(a,b))}function D(){function a(b){var g=b.context&&b.metadata&&b.fragmap?b:null;if(b.cacheState){F=b.cacheState;if(F===Kindle.BookInfo.CachedState.PINNING)ga=Kindle.BookInfo.CachedState.PINNED;Kindle.BookInfo.CachedState.isFullyDownloaded(F)&&s.registerModule(e,!0)}b.context!==void 0&&s.registerModule(f,b.context);b.metadata!==void 0&&(q(b.metadata),s.registerModule(h,b.metadata));b.manifest!==void 0?s.registerModule(d,
b.manifest):s.registerModule(d,{});b.fragmap!==void 0&&s.registerModule(c,b.fragmap);da.resolve(g)}function b(a){function c(){window.location.reload(!0)}a&&a.code===Kindle.DB.DATABASE_ERR&&a.message.indexOf("no such table")>=0&&v.emit("App::DatabaseGoneOnGetBookInfo",{breakdown:["Browser"]}).then(c,c);da.resolve()}if(!da){da=new jQuery.Deferred;if(j.contentProvider)C=j.contentProvider;else{var g=s.getModuleSync(s.DB_CLIENT);g.getBookDb()&&(g=g.getBookDb().BookInfoDB(T),C=DatabaseContentCache.create({bookinfoDb:g,
asin:T}))}C?C.queryBookinfo().then(a,b):(ca=!1,b())}return da.promise()}function w(){N=v.startMetrics("BookDownload::Reading",{breakdown:["Browser"]});s.getModuleList([f,h,d,c,b]).done(function(a){var b=$.extend({},a[f]);delete b.kindleSessionId;a={metadata:a[h],manifest:a[d],fragmap:a[c],context:b,cacheState:S};ca?(I.putBookinfo(a),KindleLocalStorage.getItem(Kindle.CACHING.CACHING)!==Kindle.CACHING.ENABLED&&(v.emit([{name:z.ENABLED,params:{breakdown:["Browser"]}}]),KindleLocalStorage.setItem(Kindle.CACHING.CACHING,
Kindle.CACHING.ENABLED))):KindleLocalStorage.getItem(Kindle.CACHING.CACHING)!==Kindle.CACHING.DISABLED&&(v.emit([{name:z.DISABLED,params:{breakdown:["Browser"]}}]),KindleLocalStorage.setItem(Kindle.CACHING.CACHING,Kindle.CACHING.DISABLED))})}function A(k){function l(b){var j,k=new jQuery.Deferred,m=v.createTimer();if(b)F=Kindle.BookInfo.CachedState.PARTIAL,j=Kindle.ERROR.FORCE_DELETE;else if(F===Kindle.BookInfo.CachedState.PINNED)S=F=Kindle.BookInfo.CachedState.PINNING,ga=Kindle.BookInfo.CachedState.PINNED,
j=Kindle.ERROR.PINNED_CONTENT_UPGRADE;else if(F===Kindle.BookInfo.CachedState.CACHED)F=Kindle.BookInfo.CachedState.PARTIAL,j=Kindle.ERROR.CONTENT_UPGRADE;(C?C.deleteBooksData():$.Deferred().resolve()).fail(k.reject).done(function(){s.detachModule(e);s.detachModule(c);s.detachModule(h);s.detachModule(d);s.detachModule(f);s.detachModule(g);s.detachModule(a);q=null;m.emit(b?"BookDownload::ForceDelete":"BookDownload::ContentUpgrade");k.resolve(j)});return k.promise()}function m(a){function g(){var k;
if(a.downloadRestrictionReason)V=a.downloadRestrictionReason.reasonCode,X=a,O.reject(y);else{k=ja.createSubTimer("finishStartReading");j.contentProvider&&j.contentProvider.initMetadata({version:a.contentVersion,acr:a.formatVersion});if(s.isModuleInitialized(f)){var l=s.getModuleSync(f),m=!1;if(l.originType==="FreeTrial"&&l.expirationDate!==a.expirationDate)l.expirationDate=a.expirationDate,m=!0;if(l.contentVersion===a.contentVersion&&l.lastPageReadData&&a.lastPageReadData&&l.lastPageReadData.position!==
a.lastPageReadData.position)l.lastPageReadData=a.lastPageReadData,m=!0;if(l.isOwned===void 0)l.isOwned=a.isOwned!==void 0?a.isOwned:!0,m=!0;if(l.contentType===void 0)l.contentType=a.contentType||(l.isSample?Kindle.CONTENT_TYPE.EBSP:Kindle.CONTENT_TYPE.EBOK),m=!0;m&&C.updateBookinfo({context:l});l.kindleSessionId=a.kindleSessionId;X=l}else X=a,s.registerModule(f,a);if(a.originType==="FreeTrial"&&(KindleBadging.pushAsinForBadgeUpdate(y.getAsin()),a.expirationDate<=Date.now())){V=Kindle.ERROR.FREE_TRIAL_EXPIRED;
O.reject(y);return}if(a.contentType===Kindle.CONTENT_TYPE.EBSP)!W&&!a.isOwned&&(ca=!1,C=null),s.isModuleInitialized(e)||s.registerModule(e,!0);else if(j.isSample){k.endTimer();ja.endTimer();ja.log();V=Kindle.ERROR.UNKNOWN_ERR;O.reject(y);return}a.contentChecksum&&!s.isModuleInitialized(e)&&s.registerModule(e,a.contentChecksum);q||(B=!0,G(),w());$.when(t(),u(),n()).done(function(){k.endTimer();k=ja.createSubTimer("resolve");O.resolve(y);k.endTimer();ja.endTimer();ja.log()}).fail(function(){V=Kindle.ERROR.OPEN_BOOK_LOAD_FAILURE;
O.reject(y)});P.getPageNumbers().done(function(a){a&&(Y=a,Y.arePageNumbersAvailable()&&typeof KindleReaderUI!=="undefined"&&KindleReaderUI.initializePageNumbers(Y))});s.getModuleList([f,h,d,c,b]).done(p).fail(R.reject)}}M=!0;A.endTimer();v.endSubTimer(J,"StartReading");var k=q&&a.contentVersion&&a.contentVersion!==q.context.contentVersion,r=q&&a.formatVersion&&a.formatVersion!==q.context.formatVersion,o=a.downloadRestrictionReason&&a.downloadRestrictionReason.reasonCode,o=o===Kindle.ERROR.CONTENT_LOAN_ENDED||
o===Kindle.ERROR.CONTENT_RENTAL_EXPIRED;Z=k||r;k||r||o?l(o).then(g,function(a){V=a;O.reject(y)}):g()}function r(a){M=!1;v.endSubTimer(J,"StartReading");q?(X=q.context,O.resolve(y)):(V=a,O.reject(y));Kindle.BookInfo.CachedState.isFullyDownloaded(F)?(P.getPageNumbers().done(function(a){a&&(Y=a,Y.arePageNumbersAvailable()&&typeof KindleReaderUI!=="undefined"&&KindleReaderUI.initializePageNumbers(Y))}),R.resolve()):R.reject(Kindle.ERROR.NETWORK,Kindle.ERROR_CODE.START_READING)}function o(a){x.endTimer();
q=a;v.endSubTimer(J,"CheckDB");v.startMetrics("Reader::StartReading");A=ja.createSubTimer("startReading");a=$.extend({asin:T},j);if(q&&q.context&&F===Kindle.BookInfo.CachedState.PINNED)a.kindleSessionId=q.context.kindleSessionId;v.startSubTimer(J,"MetadataLoaded");O.always(function(){v.endSubTimer(J,"MetadataLoaded");v.renameSubTimer(J,"MetadataLoaded","MetadataLoaded::"+(B?"RemoteContent":"LocalContent"))});v.startSubTimer(J,"StartReading");H=Q(a);q&&G();H.then(m,r)}var q,ja,x,A,H;R=new jQuery.Deferred;
J=k;ja=KindleMetricsProfiler("bookInfo.startReading");x=ja.createSubTimer("getInfoFromDB");v.startSubTimer(J,"CheckDB");if(j.kcrFree==="only")j.isSample=!0;var B=!1;j.isSample&&!W?(ca=!1,o(null)):D().done(o);return O.promise()}var z={DISABLED:"Book::Caching::Disabled",ENABLED:"Book::Caching::Enabled"},H=null,C=null,I=null,P=null,K=null,N,O=$.Deferred(),y,T=j.asin,W=j.cacheSample,s=k||KindleModuleManager,v=s.getModuleSync(s.METRICS_MANAGER),Z,aa=null,Y=null,da=null,F=null,ba=null,ha=null,ca=!0,R=null,
ka=null,ga=Kindle.BookInfo.CachedState.CACHED,la=!1,S=Kindle.BookInfo.CachedState.PARTIAL,U=null,J=null,M,V,X,ia=!1,L=!1,Q=function(a){var b=new jQuery.Deferred;s.getModuleSync(s.SERVICE_CLIENT).startReading(a).pipe(function(b){var c=b.downloadRestrictionReason&&b.downloadRestrictionReason.reasonCode,d=[Kindle.ERROR.CONTENT_LOANED,Kindle.ERROR.CONTENT_LOAN_ENDED,Kindle.ERROR.CONTENT_LICENSE_EXCEEDED,Kindle.ERROR.CONTENT_RENTAL_EXPIRED,Kindle.ERROR.SESSION_LIMIT_EXCEEDED];return a.kcrFree&&b&&b.contentType!==
Kindle.CONTENT_TYPE.EBSP&&d.indexOf(c)>=0?(a.isSample=!0,s.getModuleSync(s.SERVICE_CLIENT).startReading(a)):b}).pipe(function(c){var d=c.isSample||!1;if(c.isOwned===void 0)c.isOwned=!d;if(c.contentType===void 0)c.contentType=d?Kindle.CONTENT_TYPE.EBSP:Kindle.CONTENT_TYPE.EBOK;if(a.kcrFree)c.kcrFree=!0;b.resolve(c)},function(){b.reject("timeout")});return b.promise()};return y={getBookInfoDfd:function(){return O.promise()},getAsin:function(){return T},getRefEmId:function(){var a=s.getModuleSync(h);
return a.refEmId||a.referenceEmbeddedId||a.guid},isOpenedOnline:function(){return M},getOpenError:function(){return V},getContext:function(){return X},startReading:function(a,c){s.registerModuleWithDeferred(b,c);return A(a)},doneReading:function(){K.close(Kindle.ERROR.USER_CLOSED_BOOK)},getImageBaseUrl:function(){return s.getModuleSync(f).imageBaseUrl+"/"},getKindleSessionId:function(){return s.getModuleSync(f).kindleSessionId},getFragmentMap:function(a,b){setTimeout(function(){s.getModule(c).then(a,
b)},15)},getBookType:function(){return s.getModuleSync(c).fragmentMetadata.bookType},getBookSkeleton:function(a,b,c){s.getModule(g).then(function(d){d.buildSkeleton(c).then(a,b)},b)},getBookFragments:function(a,b,c){K[BookChunk.FRAGMENT_TYPE].getChunks(c,function(b){if(b.fragmentMetadata.compression===1||b.fragmentMetadata.compression===2){b.fragmentData=KindleCompression.lzExpandWithStaticDictionary(b.fragmentData,ba);if(b.paraData!==void 0&&typeof b.paraData==="string"){var c=KindleCompression.lzExpandWithStaticDictionary(b.paraData,
ha,256);b.paraData=JSON.parse(c)}delete b.fragmentMetadata.compression}a(b)},b)},getGlyphFragments:function(a,b,c){K[BookChunk.GLYPH_TYPE].getChunks(c,function(b){if(b.glyphFragmentMetadata.compression===1||typeof b.glyphData==="string"){var c=KindleCompression.lzExpandWithStaticDictionary(b.glyphData,ha,256);b.glyphData=JSON.parse(c);delete b.glyphFragmentMetadata.compression}a(b)},b)},getMetadata:function(a,b){return s.getModule(h).then(a,b)},getResourceUrls:function(b,c,d){s.getModule(a).then(function(a){a.getResourceUrls(d,
b,c)},c)},UNKNOWN_FPR:-1,getFurthestPositionReadData:function(){return s.getModuleSync(f).lastPageReadData||{}},getLocationConverter:function(){function a(b){var c=jQuery.Deferred();K[BookChunk.LOCATIONMAP_TYPE].getChunks([b],c.resolve,c.reject);return c}if(aa===null){var b={},d=s.getModuleSync(c),e=s.getModuleSync(h);b.locationsInfo=e.locationsInfo;b.minPosition=d.fragmentArray[0].cPos;b.maxPosition=d.fragmentArray[d.fragmentArray.length-1].ePos;b.mapGetter=a;aa=KindleUserLocationConverter.getLocationConverter(d.fragmentMetadata.bookType,
b)}return aa},getPageNumberConverter:function(){return Y},hasCover:function(a,b){var c=$.Deferred();s.getModuleSync(f).manifestUrl?s.getModule(d).then(function(a){a=a.coverResource;c.resolve(a!==void 0&&a!==null)},c.reject):c.resolve(!1);return c.promise().then(a,b)},isContentScrambled:function(){return ia},updateContentScrambledFlag:function(a){a.metadata.map&&(ia=!0)},setNetworkAccessed:function(a){L=a},isNetworkAccessed:function(){return L},getCoverUrl:function(a,b){var c=$.Deferred();s.getModuleSync(f).manifestUrl?
s.getModule(d).then(function(a){a=a.coverResource;a!==void 0&&a!==null&&K[BookChunk.RESOURCE_TYPE].getChunks(a,function(a){c.resolve(a)},c.reject)},c.reject):c.resolve(null);return c.promise().then(a,b)},getCachedAnnotations:function(){return!C?$.Deferred().reject():C.getAnnotations()},cacheAnnotations:function(a){return!C?$.Deferred().reject():C.putAnnotations(a)},getCachedPageNumbers:function(){return!C?$.Deferred().reject():C.getPageNumbers()},cachePageNumbers:function(a){return!C?$.Deferred().reject():
C.putPageNumbers(a)},getBookPositions:function(){var a=new jQuery.Deferred;s.getModule(h).then(function(b){var c=KindleModuleManager.getModuleSync(f);a.resolve({toc:b.positions.toc,srl:c.srl||b.positions.srl,cover:b.positions.cover})},a.reject);return a.promise()},getSearchIndex:function(){return P.getSearchIndex()},startDownloading:function(a,c){[Kindle.MODULE.SidecarManager,Kindle.MODULE.SearchIndexManager,Kindle.MODULE.PageNumberManager].forEach(function(a){s.isModuleRegistered(a)||(KindleDebug.log("Copying registration of "+
a),s.registerModule(a,KindleModuleManager.getModuleSync(a)))});KindleReaderAnnotationManager.clear();ga=Kindle.BookInfo.CachedState.PINNED;la=!0;s.registerModuleWithDeferred(b,c);var d=A(a);R.always(KindleReaderAnnotationManager.clear);return d},cancelDownloading:function(a){K.downloadController&&K.downloadController.failDownload(a||Kindle.ERROR.CANCELLED)},pauseDownloading:function(){I&&I.downloadController.pauseDownload()},resumeDownloading:function(){I&&I.downloadController.resumeDownload()},getDownloadComplete:function(a){ka=
a;return R.promise()},isBookDownloaded:function(){return F===Kindle.BookInfo.CachedState.CACHED||F===Kindle.BookInfo.CachedState.PINNED},setCachedState:r,getSizeInfo:function(){var a=new jQuery.Deferred;$.when(s.getModule(h),C.computeQuota()).then(function(b,c){a.resolve({bookSize:b.bookSize,quota:c})},a.reject);return a.promise()},isUpdated:function(){return!!Z}}}}}var KindleReaderBookInfoProvider=KindleReaderBookInfoProviderFactory();
function KindleBookSkeletonBuilderFactory(f,h,d,e){function c(a,b){b&&(a=a.replace(/\burl\s*\(\s*(?:'([^']*)'|"([^"]*)")\s*\)/gi,function(a,c,d){return(c=b[c||d])?'url("'+c+'")':c===null?"none":a}));return a}function b(a,b,c,d){a=a.includes;if(a!==void 0){for(var e,g=0;g<a.length;g++){var f=d[a[g]],n=b[f.metadata.id];if(n.type==="text/css")e=e||{},e[n.name]=f.data}if(e)c.skeletonData=c.skeletonData.replace(/<link\s(?:[^\/>'"]|'[^']*'|"[^"]*")*href\s*=\s*(?:'([^']*)'|"([^"]*)")(?:[^\/>'"]|'[^']*'|"[^"]*")*(?:\/>|>\s*<\/link>)/gi,
function(a,b,c){return(b=e[b||c])?'<style type="text/css">'+b+"</style>":a})}}function g(a,d,e,g){if(e!==null){var f=a.resourceManifest,a=a.skeletonManifest[d.skeletonMetadata.id],h;for(h in e){var p=e[h],n=f[p.metadata.id].includes;if(n!==void 0){for(var q={},t=0;t<n.length;t++){var u=e[n[t]];q[f[n[t]].name]=u===void 0?null:u.data}p.data=c(p.data,q)}}b(a,f,d,e);e=a.depends;if(e!==void 0){h=[];for(a=0;a<e.length;a++)p=f[e[a]],p.resInfo!==void 0&&h.push(p.resInfo);d.resourceInfo=h}}g.resolve(d)}var a=
{};a.skeletonManager=f;a.resourceManger=h;a.manifest=d;a.dictionary=e;a.buildSkeleton=function(a){function b(a){a.data=c(a.data,a.resList);q[a.metadata.id]=a;h++;n!==null&&h>=f&&g(t,n,q,d)}var d=new jQuery.Deferred,e=this.dictionary,f=0,h=0,p=[];if(this.manifest.skeletonManifest!==void 0&&this.manifest.skeletonManifest[a]!==void 0&&this.manifest.skeletonManifest[a].depends!==null)p=this.manifest.skeletonManifest[a].depends.slice(),f=p.length;var n=null,q=null,t=this.manifest;this.skeletonManager.getChunks([a],
function(a){if(a.skeletonMetadata.compression===1)a.skeletonData=KindleCompression.lzExpandWithStaticDictionary(a.skeletonData,e),delete a.skeletonMetadata.compression;h>=f?g(t,a,q,d):n=a},d.reject);f>0&&(q={},this.resourceManger.getChunks(p,b,d.reject));return d.promise()};return a}
var KindleCompression=function(){function f(a,c,d){var e,d=d>0?d:b;for(e in c)c[e]>=d&&(d=c[e]+1);e=d;for(var g in a)for(var d=a[g],j=2;j<=d.length;j++){var f=d.substr(0,j);c.hasOwnProperty(f)||(c[f]=e++)}return c}function h(c,d){var f,r=b;f="";for(var h=0;h<d.length;){var p=d.charAt(h);h++;p.charCodeAt(0)<=e?c.hasOwnProperty(f+p)?f+=p:(f.length>0&&r<g&&(c[f+p]=r,r++,r===a&&(r=j)),f=p):f=""}return c}function d(){if(defaultDictionary===void 0||defaultDictionary==={})defaultDictionary=h({},defaultDictionaryString);
return defaultDictionary}var e=9983,c=e+1,b=c+100+1,g=65533,a=55295,j=57344;return{lzCompress:function(d){var f={},l=[],h,o=b,p,n,q;p=h="";for(var t=0;t<d.length;){var u=d.charAt(t);t++;if(u.charCodeAt(0)<=e){for(;p.length>0;){n=Math.min(100,p.length);q=p.substr(0,n);p=p.substr(n);l.push(c+n);for(n=0;n<q.length;n++)l.push(q.charCodeAt(n))}f.hasOwnProperty(h+u)?h+=u:(h.length>0&&(l.push(h.length===1?h.charCodeAt(0):f[h]),o<g&&(f[h+u]=o,o++,o===a&&(o=j))),h=u)}else h.length>0&&(l.push(h.length===1?
h.charCodeAt(0):f[h]),h=""),p+=u}for(h.length>0&&l.push(h.length===1?h.charCodeAt(0):f[h]);p.length>0;){n=Math.min(100,p.length);q=p.substr(0,n);p=p.substr(n);l.push(c+n);for(n=0;n<q.length;n++)l.push(q.charCodeAt(n))}for(i=0;i<l.length;i++)l[i]=String.fromCharCode(l[i]);return l.join("")},lzExpand:function(d){for(var f={},l=[],h,o=b,p="",n,q=0;q<d.length;){h=d.charCodeAt(q);q++;if(h<=e)h=String.fromCharCode(h);else if(h>=b)(h=f[h])||(h=p+n);else{p=h-c;l.push(d.substr(q,p));q+=p;p="";continue}l.push(h);
n=h.charAt(0);o<g&&p.length>0&&(f[o]=p+n,o++,o===a&&(o=j));p=h}return l.join("")},lzBuildDictionary:h,lzGetDecompressionDictionary:function(a){var b=[],c;for(c in a)b[a[c]]=c;return b},lzAddStringsToDictionary:f,lzAddNumbersToDictionary:function(a,b){for(var c=[],d=100;d<1E3;d++)c.push(""+d);return f(c,a,b)},lzCompressWithStaticDictionary:function(a,b){if(b===void 0||b==={})b=d();var g=[],j,f,h,n;f=j="";for(var q=0;q<a.length;){var t=a.charAt(q);q++;if(t.charCodeAt(0)<=e){for(;f.length>0;){h=Math.min(100,
f.length);n=f.substr(0,h);f=f.substr(h);g.push(c+h);for(h=0;h<n.length;h++)g.push(n.charCodeAt(h))}b.hasOwnProperty(j+t)?j+=t:(j.length>0&&g.push(j.length===1?j.charCodeAt(0):b[j]),j=t)}else j.length>0&&(g.push(j.length===1?j.charCodeAt(0):b[j]),j=""),f+=t}for(j.length>0&&g.push(j.length===1?j.charCodeAt(0):b[j]);f.length>0;){h=Math.min(100,f.length);n=f.substr(0,h);f=f.substr(h);g.push(c+h);for(h=0;h<n.length;h++)g.push(n.charCodeAt(h))}for(i=0;i<g.length;i++)g[i]=String.fromCharCode(g[i]);return g.join("")},
lzExpandWithStaticDictionary:function(a,g,j){if(g===void 0||g===[]){if(defaultDeDictionary===void 0||defaultDeDictionary===[]){d();defaultDeDictionary=[];for(var f in defaultDictionary)defaultDeDictionary[defaultDictionary[f]]=f}g=defaultDeDictionary}f=e;var h=b;j!==void 0&&(f=j-1,h=j);for(var j=[],p=0;p<a.length;){var n=a.charCodeAt(p);p++;n<=f?j.push(String.fromCharCode(n)):n>=h?j.push(g[n]):(n-=c,j.push(a.substr(p,n)),p+=n)}return j.join("")}}}(),ContentMigration=function(){function f(c){function b(a){var b=
"get"+(a.substr(0,1).toUpperCase()+a.substr(1))+"Ids";return c.source[b]().pipe(function(b){function d(){var j=b.splice(0,100);if(j.length===0)e.then(g.resolve,g.reject);else{var f="get"+(a.substr(0,1).toUpperCase()+a.substr(1))+"s",j=c.source[f](j);$.when(j,e).then(function(b){var g={};b.forEach(function(a,b){g[b]=a});e=c.target("putChunksNonT",c.asin,a,g);setTimeout(d,100)},g.reject)}}var e=$.Deferred().resolve(),g=$.Deferred();d();return g.promise()})}function d(){var c=BookChunk.types[e++];c?
b(c).then(d,a.reject):a.resolve()}var a=$.Deferred(),e=0,f=c.timer.createSubTimer("chunks");d();a.done(function(){f.endTimer()});return a.promise()}function h(c){var b=$.Deferred(),d=c.timer.createSubTimer("annotations");c.source.getAnnotations().then(function(a){c.target("putAnnotations",c.asin,a).then(b.resolve,b.reject)},b.reject);b.done(function(){d.endTimer()});return b.promise()}function d(c){var b=$.Deferred(),d=c.timer.createSubTimer("pageNumbers");c.source.getPageNumbers().then(function(a){c.target("putPageNumbers",
c.asin,a).then(b.resolve,b.reject)},b.reject);b.done(function(){d.endTimer()});return b.promise()}function e(c){var b=$.Deferred(),d=c.timer.createSubTimer("bookinfo");c.source.getBookInfo().then(function(a){c.target("putBookinfo",c.asin,a).then(b.resolve,b.reject)},b.reject);b.done(function(){d.endTimer()});return b.promise()}return{initialize:function(){KindleModuleManager.define(KindleModuleManager.CONTENT_MIGRATION,[Kindle.MODULE.DB_CLIENT,KindleModuleManager.EMBEDDED_HOSTINTERFACE],function(c,
b){return{moveBook:function(g){var a=$.Deferred(),j=c.getBookDb();if(!g)return a.reject("Need ASIN as param").promise();var k={timer:KindleMetricsProfiler("Migrate "+g),asin:g,target:b.contentProvider,source:j.BookInfoDB(g)},g=$.when(f(k),h(k),d(k),e(k));g.then(function(){k.timer.endTimer();k.timer.log()});g.then(a.resolve,a.reject);return a.promise()},notifyMigrationStatus:function(b){var a=$.Deferred();if(!b||!b.status)return a.reject("Need param.status as param").promise();b.status==="done"?c.getBookDb().dropTables().then(a.resolve,
a.reject):a.reject("this status is not handled");return a.promise()}}})}}}(),DatabaseContentCache=function(){return{create:function(f){var h=$.Deferred(),d=f.bookinfoDb,e={};BookChunk.types.forEach(function(c){var b=c.substr(0,1).toUpperCase()+c.substr(1);e[c]={getChunks:function(c,a,e){d["get"+b+"s"](c).then(a,e)},putChunks:function(c,a,e){d["put"+b+"s"](c).then(a,e)},getCachedIds:function(c,a){d["get"+b+"Ids"]().then(c,a)}}});e.queryBookinfo=function(){return d.getBookInfo().pipe(function(c){h.resolve(c);
return c})};e.getBookinfo=function(){return h.promise()};e.putBookinfo=function(c){h.resolve(c);return d.insertBookInfo(c)};e.updateBookinfo=d.updateBookInfo;e.getAnnotations=d.getAnnotations;e.putAnnotations=d.putAnnotations;e.getPageNumbers=d.getPageNumbers;e.putPageNumbers=d.putPageNumbers;e.getSearchIndex=d.getSearchIndex;e.putSearchIndex=d.putSearchIndex;e.computeQuota=function(){return d.computeCacheQuota()};e.getBookStatistics=d.getBookStatistics;e.checkCache=function(){return!0};e.deleteOldestBook=
function(c,b){d.deleteOldestBookData(f.asin).then(c,b)};e.deleteBooksData=function(){bookInfo=void 0;h.state()!=="pending"&&(h=$.Deferred());return d.deleteBooksData([f.asin])};return e}}}(),DownloadingContentProvider=function(){function f(d){function e(d,e,f){function h(b){var c;if(!a){for(c in b)e(b[c]),g.removeId(c);var d=[],j;for(j=0;j<t.length;j++)c=t[j],b[c]===void 0&&(G=c,d.push(c));t=d;d.length>0?q(d):n()}}function r(){a||q(t)}function o(c){function d(){a||e(c)}if(!a){var g=BookChunk.getId(c);
if(b){var j=[];j[g]=c;b.putChunks(j,d,d);--u===0&&n()}else e(c)}}function p(b,d,e,g){var j;a||(Object.prototype.toString.call(g)==="[object Array]"?(j=g,g="list"):j=[g],x[g]=x[g]+1||1,x[g]<=2?c.getChunks(j,o,p):(f(b,d,e),--u===0&&n()))}function n(){g.setNextId(G);setTimeout(flowControl.resume,0)}function q(a){u=a.length;c.getChunks(a,o,p)}Object.prototype.toString.call(d)!=="[object Array]"&&(d=[d]);var t=d.slice(0),u=0,G=Math.max.apply(Math,t)+1,x=[];b?(flowControl.pause(),b.getChunks(d,h,r)):q(d)}
var c,b,g,a=!1;c=d.source;b=d.cache;g=d.downloader;flowControl=d.flowControl;return{getChunks:e,getPieces:function(a,b,c){return e(a,b,c)},close:function(){a=!0}}}function h(d,e){var c=KindleBookDownloaderFactory({type:e,cache:!0,throttle:BookChunk.properties[e].huge,netGetter:d.source[e].getChunks,urlGetter:d.source[e].getUrls,fileGetter:d.source[e].getChunkFromUrl,dbPutter:d.cache[e].putChunks,dbGetIdList:d.cache[e].getCachedIds,dbCheckCache:d.cache.checkCache,dbOosHandler:d.cache.deleteOldestBook,
fileProgress:function(c){b.callEventListeners("onProgress",e,c)},dbIsCached:function(){b.callEventListeners("onCompleted",e)},dbIsOos:function(){b.callEventListeners("onFailed",e,Kindle.ERROR.OUT_OF_SPACE)},downloadError:function(c,a){b.callEventListeners("onFailed",e,c,a)},isIdRequired:d.tweaks&&d.tweaks[e]&&d.tweaks[e].isIdRequired}),b=ListenerManager();return{init:function(b,a){c.initialize(b,a)},start:function(){c.startReadAhead()},cancel:function(){c.cancelReadAhead()},pause:function(){c.pauseReadAhead()},
resume:function(){c.resumeReadAhead()},setNextId:function(b){c.setNextId(b)},removeId:function(b){c.removeIdFromReadAhead(b)},getNumIds:function(){return c.numIds},addEventListener:function(c,a){b.addEventListener(c,a)}}}return{create:function(d){var e={},c={},b={},g={},a={pause:function(){g.pauseDownload()},resume:function(){g.resumeDownload()}};BookChunk.types.forEach(function(b){c[b]=h(d,b);e[b]=f({type:b,source:d.source[b],cache:d.cache[b],downloader:c[b],flowControl:a})});b={downloadingContentProvider:e,
fast:d.readAheadAgressively,downloaders:c,sidecarManager:d.sidecarManager};g=BookDownloadController.create(b);e.queryBookinfo=d.cache.queryBookinfo;e.getBookinfo=d.cache.getBookinfo;e.putBookinfo=d.cache.putBookinfo;e.computeCacheQuota=d.cache.computeQuota;e.downloadController={startDownload:g.startDownload,failDownload:g.failDownload,cancelDownload:g.failDownload,pauseDownload:g.pauseDownload,resumeDownload:g.resumeDownload,whenDownloadComplete:g.whenDownloadComplete};e.close=function(a){d.source.close();
g.failDownload(a);BookChunk.types.forEach(function(a){e[a].close()})};return e}}}(),ContentPrefetchOptimizations=function(){function f(c,d,e){function j(c){function f(b){for(ix=0;ix<a.length;ix++)if(a[ix].skeleton===b)return a[ix];return null}var k=f(c);k&&k.getSkeleton()!=="rejected"?k.getSkeleton().then(b(d),e):(a.splice(0,a.length-g),k=h(c),k.getSkeleton().then(b(d),e),a.push(k),++c<r.fragmentMetadata.numberOfSkeletons&&((k=f(c))||a.push(h(c))))}c.length>1||c[0]===0?m(c,d,e):j(c[0])}function h(a){var b=
d(a),g=b.fragmentIds,b=b.resourceIds,j=$.Deferred(),f={},k={};g.forEach(function(a){f[a]=$.Deferred()});b.forEach(function(a){k[a]=$.Deferred()});m(a,function(a){j.resolve(a)},function(a,b,c,d){j.reject(a,b,c,d)});e(g,function(a){f[a.fragmentMetadata.id].resolve(a)},function(a,b,c,d){f[d].reject(a,b,c,d)});c(b,function(a){k[a.metadata.id].resolve(a)},function(a,b,c,d){k[d].reject(a,b,c,d)});return{skeleton:a,getSkeleton:function(){return j},getFragmentById:function(a){return f[a]},getResourceById:function(a){return k[a]}}}
function d(a){var b=function(){return r.fragmentArray.filter(function(b){return b.sId===a}).map(function(a){return a.fId})}(),c=l.skeletonManifest[a].depends;l.fragmentManifest&&b.forEach(function(a){l.fragmentManifest[a]&&l.fragmentManifest[a].includes&&c.push.apply(c,l.fragmentManifest[a].includes)});return{fragmentIds:b,resourceIds:c}}function e(c,d,e){$.isArray(c)||(c=[c]);c=c.filter(function(c){for(var g=0;g<a.length;g++){var j=a[g].getFragmentById(c);if(j&&j.state!=="rejected")return j.then(b(d),
e),!1}return!0});c.length>0&&k(c,d,e)}function c(c,d,e){$.isArray(c)||(c=[c]);c=c.filter(function(c){for(var g=0;g<a.length;g++){var j=a[g].getResourceById(c);if(j&&j.state!=="rejected")return j.then(b(d),e),!1}return!0});c.length>0&&j(c,d,e)}function b(a){return function(b){b=jQuery.extend(!0,{},b);a(b)}}var g=40,a=[],j,k,m,l,r;return{modify:function(a,b,d){l=b;r=d;m=a[BookChunk.SKELETON_TYPE].getChunks;k=a[BookChunk.FRAGMENT_TYPE].getChunks;j=a[BookChunk.RESOURCE_TYPE].getChunks;a[BookChunk.SKELETON_TYPE].getChunks=
f;a[BookChunk.FRAGMENT_TYPE].getChunks=e;a[BookChunk.RESOURCE_TYPE].getChunks=c}}}(),KindleO_Aaa=function(){function f(b){for(var a=[],c,d,f,h,r,o,p=0;p<b.length;)f=b.charCodeAt(p++)&255,c=b.charCodeAt(p++),h=c&255,d=b.charCodeAt(p++),r=d&255,o=f>>2,f=(f&3)<<4|h>>4,h=(h&15)<<2|r>>6,r&=63,isNaN(c)?h=r=64:isNaN(d)&&(r=64),a.push(e.charAt(o)+e.charAt(f)+e.charAt(h)+e.charAt(r));return a.join("")}function h(b){for(var a=[],d,e,f,h,r,o=0;o<b.length;)d=c[b.charCodeAt(o++)],e=c[b.charCodeAt(o++)],h=c[b.charCodeAt(o++)],
r=c[b.charCodeAt(o++)],d=d<<2|e>>4,e=(e&15)<<4|h>>2,f=(h&3)<<6|r,a.push(String.fromCharCode(d)),h!==64&&a.push(String.fromCharCode(e)),r!==64&&a.push(String.fromCharCode(f));return a.join("")}function d(b,a){var c=[];c.length=256;for(var d=0;d<256;d++)c[d]=d;for(var e=0,f,d=0;d<256;d++)e=e+c[d]+a[d%a.length]&255,f=c[d],c[d]=c[e],c[e]=f;for(var e=d=0,h=[],o=0;o<b.length;o++)d=d+1&255,e=e+c[d]&255,f=c[d],c[d]=c[e],c[e]=f,h.push(String.fromCharCode(b.charCodeAt(o)^c[c[d]+c[e]&255]));return h.join("")}
for(var e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",c=[],b=0;b<e.length;b+=1)c[e.charCodeAt(b)]=b;return{o_aaa:f,o_aag:h,o_aac:function(c,a){var e;e=c.replace(/\x0d\x0a/g,"\n");for(var k=[],h=0;h<e.length;h++){var l=e.charCodeAt(h);l<128?k.push(String.fromCharCode(l)):(l>127&&l<2048?k.push(String.fromCharCode(l>>6|192)):(k.push(String.fromCharCode(l>>12|224)),k.push(String.fromCharCode(l>>6&63|128))),k.push(String.fromCharCode(l&63|128)))}e=k.join("");k=a;k+="00000000000000000000000000000000".substring(0,
32-k.length);h=[];for(b=0;b<k.length;b+=2)h.push(parseInt(k.substring(b,b+2),16));return f(d(e,h))},o_aad:function(b,a){for(var c=h(b),e=[],f=0;f<a.length;f++)e.push(a.charCodeAt(f));for(var c=d(c,e),e=[],f=0,l,r,o;f<c.length;)l=c.charCodeAt(f),l<128?(e.push(String.fromCharCode(l)),f++):l>191&&l<224?(r=c.charCodeAt(f+1),e.push(String.fromCharCode((l&31)<<6|r&63)),f+=2):(r=c.charCodeAt(f+1),o=c.charCodeAt(f+2),e.push(String.fromCharCode((l&15)<<12|(r&63)<<6|o&63)),f+=3);return e.join("")}}}(),KindleReaderAnnotationManager=
function(){function f(a,b){return a.start-b.start}function h(a){for(var b=0;b<a.length;b++)if(a[b].guid&&!a[b].refEmId)a[b].refEmId=a[b].guid}function d(a){function b(){e(a).then(d.resolve,d.reject)}function c(){o(a).then(b,d.reject)}var d=new jQuery.Deferred;d.then(function(){for(var b=0;b<a.length;b++)s.emit(g(a[b]))},function(){for(var b=0;b<a.length;b++)s.emit(g(a[b],"Fail"))});k(a);for(var f=0;f<a.length;f++){if(a[f].asin===void 0||a[f].refEmId===void 0||a[f].start===void 0||a[f].type===void 0)return s.emit(g(a[f],
"Invalid")),KindleDebug.error("Tried to delete an invalid annotation."),d.reject().promise();if(a[f].note)a[f].note=n(a[f].note)}Z.acquire().done(function(){v=Date.now();W.saveToJournal(a).then(c,d.reject);d.then(Z.release,Z.release)});return d.promise()}function e(a){function b(){for(var e,g=!1,j,k=0;k<a.length;k++)j=a[k],e=c(j.type,j.start),j.action===w?e===-1&&(y.push(j),g=!0):j.action===A?e!==-1&&(y.splice(e,1),y.push(j),g=!0):j.action===z&&e!==-1&&y.splice(e,1);g&&y.sort(f);d.resolve();P.cacheAnnotations(y)}
var d=new jQuery.Deferred;t().then(b,b);return d.promise()}function c(a,b){for(var c in y){var d=y[c];if(d.type===a&&d.start===b)return c}return-1}function b(a,b){return y[c(a,Number(b))]||null}function g(a,b){var c="Reader::"+C[a.action]+C[a.type];b&&(c+=b);return c}function a(a){for(var b=(new Date).getTime(),c=0;c<a.length;c++)a[c].asin=K,a[c].refEmId=N,a[c].action=w,a[c].modifiedTimestamp=b;return a}function j(a){for(var b=(new Date).getTime(),c=0;c<a.length;c++)a[c].action=z,a[c].modifiedTimestamp=
b;return a}function k(a){for(var b=0;b<a.length;b++)a[b].positionType=O;return a}function m(b){a(b);return d(b)}function l(a){for(var b=(new Date).getTime(),c=0;c<a.length;c++)a[c].action=A,a[c].modifiedTimestamp=b;return d(a)}function r(a){j(a);return d(a)}function o(a){function b(){function e(a){j.context=a;b()}for(var g,f,j;d<a.length&&!(a[d].action===w&&(a[d].type===x||a[d].type===D));)++d;if(d<a.length){j=a[d++];switch(j.type){case x:g=j.position;f=j.position+H;break;case D:g=j.start,f=j.end}p(g,
f).then(e,b)}else c.resolve()}var c=new jQuery.Deferred,d=0;b();return c.promise()}function p(a,b){aa===null&&(aa=KindleRenderer.createWordIterator());return aa.getText(a,b)}function n(a){a.length>Kindle.opt.maxNoteChars&&(s.emit("Reader::NoteLengthLimitExceeded",{submetrics:[{name:"ResultSize",value:a.length}]}),a=a.substr(0,Kindle.opt.maxNoteChars));return a}function q(b,c,e,g){var f=KindleReaderAnnotationManager.getAnnotationsInRange(b,c,D),k=f.length,h={type:D,start:b,position:e,end:c},l=[];g&&
l.push.apply(l,a([{type:B,start:c,position:e,end:c,note:g}]));if(f.length===1&&b>=f[0].start&&c<=f[0].end){if(l.length===0)return(new jQuery.Deferred).resolve([f[0]])}else{if(k>0)h.start=Math.min(b,f[0].start),h.end=Math.max(c,f[k-1].end),l.push.apply(l,j(f));l.push.apply(l,a([h]))}return d(l)}function t(){var a=new jQuery.Deferred;P.getCachedAnnotations().then(function(b){b&&b.length!==void 0&&(y=b,h(y));a.resolve()},a.reject);return a.promise()}function u(){function a(){c.resolve()}function b(){c.resolve()}
var c=new jQuery.Deferred;T.getAnnotations(K,N).then(function(c){y=c.annotations;h(y);P.cacheAnnotations(y).then(a,b)},c.reject);return c.promise()}function G(){function a(){t().then(c.reject,c.reject)}function b(){u().then(c.resolve,a)}var c=new jQuery.Deferred;W.uploadJournal().then(b,b);return c.promise()}var x="kindle.bookmark",B="kindle.note",D="kindle.highlight",w="create",A="modify",z="delete",H=100,C={};C[x]="Bookmark";C[B]="Note";C[D]="Highlight";C[w]="Create";C[A]="Modify";C[z]="Delete";
var I,P=null,K=null,N=null,O=null,y=null,T=null,W=null,s,v=Date.now(),Z=Lock(),aa=null;return{BOOKMARK:x,NOTE:B,NOTE_ICON:"kindle.note.icon",HIGHLIGHT:D,POPULAR_HIGHLIGHT:"kindle.popular",getLastUpdateTime:function(){return v},deferredInitialize:function(a,b){function c(){I.resolve(e)}function d(a){T=a[b.SERVICE_CLIENT];W=a[b.JOURNAL_MANAGER];s=a[b.METRICS_MANAGER];G().then(c,c)}var e,g;I||(b=b||KindleModuleManager,I=$.Deferred(),e=this,g=[b.SERVICE_CLIENT,b.JOURNAL_MANAGER,b.METRICS_MANAGER],y=[],
a.then(function(a){P=a;K=P.getAsin();N=P.getRefEmId();O=P.getBookType();P.getContext().isOwned?b.getModuleList(g).then(d,I.reject):I.reject()},I.reject));return I.promise()},clear:function(){var a=I;I=null;y=[];K=N=O=null;a&&a.reject()},getAnnotation:b,getAllAnnotations:function(){return y.slice()},getAnnotationsInRange:function(a,b,c){var d=[],e;for(e in y){var g=y[e];(g.start<=b&&g.end>=a||g.start>=a&&g.start<=b)&&(!c||c===g.type)&&d.push(g)}return d},createBookmark:function(a){return m([{type:x,
start:a,position:a,end:a,context:""}])},createNote:q,modifyNote:function(a,c,d){var e=new jQuery.Deferred;(a=b(B,a))?(a.note=d,a.position=c,l([a]).then(e.resolve,e.reject)):e.reject();return e.promise()},createHighlight:function(a,b,c){return q(a,b,c,null)},deleteAnnotations:r,getContext:p,updateAnnotations:function(a){for(var b,c=[],d=[],e=[],g=[],f=0;f<a.length;f++)switch(b=a[f],b.action){case w:c.push(b);break;case A:e.push(b);break;case z:d.push(b)}c.length>0&&g.push(m(c));e.length>0&&g.push(l(e));
d.length>0&&g.push(r(d));return $.when.apply($,g)}}}(),NetworkContentProvider=function(){var f=3E4;return{create:function(h){function d(a,b){var c=new jQuery.Deferred;$.jsonp({url:a,callback:b,cache:!0,timeout:f,error:function(a,b){c.reject(a,b)},success:function(a){c.resolve(a)}});return c.promise()}function e(a,b,c){function e(a,b,c){var d,g;if(a&&a.length)for(d=0;d<a.length;d++)g=b+a[d].id,c(a[d].signedUrl,g,a[d].id)}h.bookInfo.setNetworkAccessed(!0);e(a.skeletonUrls,"loadSkeleton",function(a,
e,g){d(a,e).then(function(a){if(a.skeletonMetadata!==void 0&&a.skeletonMetadata.encryption===1){var c=KindleO_Aaa.o_aad(a.skeletonData,j);a.skeletonData=c;delete a.skeletonMetadata.encryption}b(a)},function(a,b){c(null,b,null,g)})});e(a.fragmentUrls,"loadFragment",function(a,e,g){d(a,e).then(function(a){if(a.fragmentMetadata!==void 0&&a.fragmentMetadata.encryption===1){var c=KindleO_Aaa.o_aad(a.fragmentData,j);a.fragmentData=c;delete a.fragmentMetadata.encryption}b(a)},function(a,b){c(null,b,null,
g)})});e(a.glyphUrls,"loadGlyphFragment",function(a,e,g){d(a,e).then(function(a){if(a.glyphFragmentMetadata!==void 0)a.glyphFragmentMetadata.id=g;b(a)},function(a,b){c(null,b,null,g)})});e(a.resourceUrls,"loadResource",function(a,e,g){d(a,e).then(function(a){h.bookInfo.updateContentScrambledFlag(a);b(a)},function(a,b){c(null,b,null,g)})});e(a.locationMapUrls,"loadMobiLocationMap",function(a,e,g){d(a,e).then(b,function(a,b){c(null,b,null,g)})})}function c(b,c){var d={asin:h.asin,contentVersion:a.contentVersion,
formatVersion:a.formatVersion,isSample:a.isSample};if(a.kindleSessionId)d.kindleSessionId=a.kindleSessionId;if(a.kcrFree)d.kcrFree=!0;d[b+"Ids"]=c;return g.getFileUrl(d)}function b(a,b,d,g){Object.prototype.toString.call(b)!=="[object Array]"&&(b=[b]);c(a,b).then(function(a){k||e(a,d,g)},function(a,c,d){g(a,c,d,b)})}var g,a,j,k=!1;a=h.context;j=a.contentChecksum;g=KindleModuleManager.getModuleSync(Kindle.MODULE.SERVICE_CLIENT);var m={};BookChunk.types.forEach(function(a){m[a]={getChunks:function(c,
d,e){b(a,c,d,e)},getUrls:function(b,d,e){c(a,b).then(function(b){d(b[a+"Urls"])},e)},getChunkFromUrl:function(b,c,d){var g={};g[a+"Urls"]=[b];e(g,c,d)}}});m.getFragmap=function(){var b=$.Deferred();d(a.fragmentMapUrl,"loadFragmap").then(function(a){b.resolve(a)},function(a,c){b.reject(c)});return b.promise()};m.getMetadata=function(){var b=$.Deferred();d(a.metadataUrl,"loadMetadata").then(function(a){b.resolve(a)},function(a,c){b.reject(c)});return b.promise()};m.getManifest=function(){function b(a){e.resolve(a)}
function c(){e.resolve({})}var e=$.Deferred();a.manifestUrl?d(a.manifestUrl,"loadManifest").then(b,c):e.resolve({});return e.promise()};m.close=function(){k=!0};return m}}}(),RemoteContentCache=function(){return{create:function(f){function h(a){g=a;if(!d||d.state!=="pending")d=$.Deferred();d.resolve(g)}var d=$.Deferred(),e=f.asin,c=f.contentProvider,b=f.contentRemover,g,a={};BookChunk.types.forEach(function(b){a[b]={getChunks:function(a,d,g){c("getChunks",e,b,a).then(d,g)},putChunks:function(a,d,
g){var f={};a.forEach(function(a,b){f[b]=a});c("putChunks",e,b,f).then(d,g)},getCachedIds:function(a,d){c("getChunkIds",e,b).then(a,d)}}});a.queryBookinfo=function(){return c("getBookinfo",e).pipe(function(a){h(a);return a})};a.getBookinfo=function(){return d.promise()};a.putBookinfo=function(a){h(a);return c("putBookinfo",e,a)};a.updateBookinfo=function(a){if(!g)return $.Deferred().reject("bad state");$.extend(g,a);return c("updateBookinfo",e,a)};a.getAnnotations=function(){return c("getAnnotations",
e)};a.putAnnotations=function(a){return c("putAnnotations",e,a)};a.getPageNumbers=function(){return c("getPageNumbers",e)};a.putPageNumbers=function(a){return c("putPageNumbers",e,a)};a.computeQuota=function(){return $.Deferred().resolve(0)};a.getBookStatistics=function(){return $.Deferred().reject()};a.checkCache=function(){return!0};a.deleteOldestBook=function(a,b){b()};a.deleteBooksData=function(){g=void 0;d.state()!=="pending"&&(d=$.Deferred());return b({asin:e})};a.downloadSearchIndex=function(a){return c("getSearchIndexReader",
e,a)};a.initMetadata=function(a){return c("initMetadata",e,a)};return a}}}();
function KindleBookResourceUrlTranslator(f,h,d){var e={};e.bookInfo=d;e.resourceManger=f;e.resourceManifest=h.resourceManifest;e.reverseLookup={};for(var c in e.resourceManifest)e.reverseLookup[e.resourceManifest[c].name]=c;e.getResourceUrls=function(b,c,a){function d(a){var b=r[a.metadata.id].name;e.bookInfo.updateContentScrambledFlag(a);var f={};f[b]=a.data;if(a.metadata)f.metadata=a.metadata;c(f)}for(var f=[],h=0;h<b.length;h++){var l=this.reverseLookup[b[h]];l!==void 0&&f.push(l)}var r=this.resourceManifest;
f.length!==b.length&&a();f.length>0?this.resourceManger.getChunks(f,d,a):c({})};return e}
(function(){function f(a){function b(e){for(var g={},f,j=0;j<e.length;j++)if(f=e[j].filename,f.endsWith(l.words))g.words=e[j].data;else if(f.endsWith(l.properties))g.properties=e[j].data;else if(f.endsWith(l.positions))g.positions=e[j].data;g.asin=a.asin;d.endTimer();d.log();c.notify("finished");c.resolve(g)}var c=new $.Deferred,d=KindleMetricsProfiler("unzip search index");if(a.length>1)return KindleDebug.error("Cannot Unzip: We have too many array buffers"),c.reject("Index too large");KindleZip.unzip(a[0]).pipe(b,
b);return c.promise()}function h(a,b){for(var c=KindleMetricsProfiler("decrypt search index"),d=b.decryptionIV,e=b.decryptionKey,g=[],f,j=0;j<a.length;j++)f=KindleCrypto.decrypt(a[j],e,d),f=f.buffer,g.push(f);g.asin=b.asin;c.endTimer();c.log();return g}function d(a){function c(b){function d(){w.endTimer();K.push(z.response);I+=H;I<P?(C-=Date.now(),C<k?H*=2:C>m&&(H/=2),h()):(A.endTimer(),A.log(),N.resolve(K,l))}function e(a){a.lengthComputable?(a=Math.floor(100*a.loaded/a.total),a!==o&&(o=a)):KindleDebug.log("progress unknown")}
function g(){KindleDebug.error("An error occurred while transferring the file.");N.reject("failed")}function f(){KindleDebug.error("The transfer has been canceled by the user.");N.reject("cancelled")}function h(){C=Date.now();w=A.createSubTimer("@"+I);var a=Math.min(I+H-1,P);z=new XMLHttpRequest;z.open("GET",D);z.setRequestHeader("Range","bytes="+I+"-"+a);z.responseType="arraybuffer";z.addEventListener("progress",e,!1);z.addEventListener("load",d,!1);z.addEventListener("error",g,!1);z.addEventListener("abort",
f,!1);z.send(null)}var l=b;if(l.s3Url===null)return $.Deferred().reject(Kindle.ERROR.SITB_INDEX_NOT_AVAILABLE);l.asin=a.asin;var o=-1,D=l.s3Url.replace(/http:\/\//,"https://"),w,A=KindleMetricsProfiler("download search index"),z,H=j,C,I=0,P=l.indexSize-1,K=[],N=$.Deferred();h();return N}return KindleHostDeviceDetector.isOnline()?b.getSearchIndexInfo(a).pipe(c,function(a){return a.status===0?$.Deferred().reject(Kindle.ERROR.SITB_OFFLINE):$.Deferred().reject(Kindle.ERROR.SITB_COMMON_ERROR)}):$.Deferred().reject(Kindle.ERROR.SITB_OFFLINE)}
function e(b){function c(a){return!b.contentCache?$.Deferred().resolve(a):b.contentCache.putSearchIndex(a)}if(!KindleDeviceCapabilities.searchInTheBook())return $.Deferred().reject("Unsupported OS");if(a[b.asin])return a[b.asin];a={};a[b.asin]=(!b.contentCache?$.Deferred().reject("no db"):b.contentCache.getSearchIndex()).pipe(null,function(){return d(b).pipe(h).pipe(f).pipe(c)}).pipe(g.openSearchIndex);return a[b.asin]}function c(a){return a.contentCache.downloadSearchIndex({asin:a.asin})}var b,g,
a={},j=16777216,k=1E4,m=2E4,l={words:".words",positions:".positions",properties:".properties"};KindleModuleManager.define(Kindle.MODULE.SearchIndexManager,[Kindle.MODULE.SERVICE_CLIENT,Kindle.MODULE.DB_CLIENT,"SearchIndexParser"],function(a,d,f){b=a;g=f;return{getSearchIndex:KindleHostDeviceDetector.isMetro()?c:e}})})();
(function(){function f(d){function e(){return KindleDebug.assert.apply(KindleDebug,arguments)}function c(){return KindleDebug.log.apply(KindleDebug,arguments)}function b(){return $.Deferred().reject.apply($,arguments)}function g(a){for(var a=new Uint8Array(d[a]),b=[],c=0;c<a.byteLength;c++)b.push(String.fromCharCode(a[c]));a=b.join("");return $.Deferred().resolve(a)}function a(a,c,d,g,f){a=a.cloneStream();a.seek(c);return a.readAsync(d).pipe(function(c){function d(){switch(g){case 1:return j.readByte()+
f;case 2:return j.readInt16()+f;case 3:return(j.readByte()<<16)+j.readUInt16()+f;case 4:return j.readInt32()+f;default:e("Got unexpected bytes-per-entity:"+g)}}try{for(var j=c,c=[];j.unconsumedBufferLength>0;)c.push(d());j.close();a.close();return c}catch(h){return a.close(),b(h)}},a.close)}function f(b,c){var d=b.directory.BytesPerEntity;return a(b.positionsStream,b.directory.Positions.offset+c.o*d,c.n*d,d,b.directory.MinimumTitleEntityValue)}var k={magicLength:4,magic:"AZSA",headerOffset:-28,directoryOffset:-24,
stringEntries:["Magic","WhereIndexed","IndexerHelperClassName"],wordsFilename:"index.words",positionsFilename:"index.positions",propertiesFilename:"index.properties"},m=$.Deferred();(function(a){var c,d,e,g=a.positionsStream,f=Math.min(g.size,Math.abs(k.headerOffset));g.seek(Math.max(0,g.size+k.headerOffset));return a.positionsStream.readAsync(f).pipe(function(c){try{var g=c.readInt32();d=c.readInt32();e=c.readInt32();c.close();if(g!==a.positionsStream.size)return b("bad header size");a.positionsStream.seek(d);
return a.positionsStream.readAsync(e)}catch(f){return b(f)}}).pipe(function(d){try{c={Magic:{offset:0,length:k.magicLength,isString:!0}};for(var e,g,f,j;d.unconsumedBufferLength>0;)if(e=d.readInt32(),g=d.readInt32(),f=d.readByte(),j=d.readString(f),c[j]={offset:e,length:g},k.stringEntries.indexOf(j)>=0)c[j].isString=!0;d.close();var h=c.SearchBoundaryPositions.offset;a.positionsStream.seek(0);return a.positionsStream.readAsync(h)}catch(m){return b(m)}}).pipe(function(d){function e(a){for(var b=Object.keys(c),
d=0;d<b.length;++d)if(c[b[d]].offset===a)return b[d]}try{for(var g,f=0;d.unconsumedBufferLength>0;){g=e(f);if(!g)return d.close(),b("Can't read directory entries");f+=c[g].length;if(c[g].isString)c[g]=d.readString(c[g].length);else if(c[g].length===1)c[g]=d.readByte();else if(c[g].length===4)c[g]=d.readInt32();else return d.close(),b("Bad size for numeric entry")}d.close();if(c.Magic!==k.magic)return b("bad magic");a.directory=c;return a}catch(j){return b(j)}})})({getPositionsForWord:function(a){var b=
$.Deferred(),d=this.wordList[a],e={word:a,searchBoundaryPositions:this.searchBoundaryPositions,positions:[]};d?f(this,d).pipe(function(d){c('Word "'+a+'" has '+d.length+" occurances");e.positions=d;b.resolve(e)},function(){b.reject(Kindle.ERROR.SITB_INDEX_UNREADABLE)}):b.resolve(e);return b.promise()},getProperty:function(a){return this.properties[a]},close:function(){this.positionsStream=null},positionsStream:new h(d.positions)}).pipe(function(a){return g("words").pipe(function(b){var c={};b.split("\n").forEach(function(a){a=
a.split(":");c[a[2]]={o:a[0],n:a[1]}});a.wordList=c;return a})}).pipe(function(a){return g("properties").pipe(function(b){var c={},d=/(.*?)=(.*)/;b.split("\n").forEach(function(a){a&&(a=d.exec(a),a.length===3&&(c[a[1]]=a[2]))});a.properties=c;return a})}).pipe(function(b){return a(b.positionsStream,b.directory.SearchBoundaryPositions.offset,b.directory.SearchBoundaryPositions.length,b.directory.BytesPerEntity,b.directory.MinimumTitleEntityValue).pipe(function(a){b.searchBoundaryPositions=a;return b})}).pipe(m.resolve,
function(){m.reject(Kindle.ERROR.SITB_INDEX_UNREADABLE)});return m.promise()}var h;KindleModuleManager.define("SearchIndexParser",["SearchIndexUtilities"],function(d){h=d.Stream;return{openSearchIndex:f}})})();
(function(){function f(d){if(!(this instanceof f)){var e=Object.create(f.prototype);return f.apply(e,arguments)}this.bytes=new Uint8Array(d);this.position=0;this.size=this.bytes.length;return this}function h(d,e,c){if(!(this instanceof h)){var b=Object.create(h.prototype);return h.apply(b,arguments)}this.uBytes=d.bytes;this.bytes=new Int8Array(this.uBytes);this.base=e!==void 0?e:0;this.position=0;this.unconsumedBufferLength=this.size=c!==void 0?c:this.uBytes.length-this.base;return this}if(!Uint8Array.prototype.subarray)Uint8Array.prototype.subarray=
function(d,e){for(var d=d===void 0?0:d,e=e===void 0||e>copy.length?copy.length:e,c=new Uint8Array(e-d),b=0;b<c.length;b++)c[b]=this[b+d];return c};f.prototype.seek=function(d){this.position=Math.min(Math.max(d,0),this.size)};f.prototype.readAsync=function(d){return $.Deferred().resolve(new h(this,this.position,Math.min(d,this.size-this.position)))};f.prototype.cloneStream=function(){var d=new f(this.bytes);d.position=this.position;return d};f.prototype.close=function(){this.bytes=null};h.prototype.seek=
function(d){this.position=Math.min(Math.max(d,0),this.size);this.unconsumedBufferLength=this.size-this.position};h.prototype.getPosition=function(){return this.position};h.prototype.readByte=function(){if(this.unconsumedBufferLength<1)throw Error("Out of data");var d=this.uBytes[this.base+this.position];this.position++;this.unconsumedBufferLength--;return d};h.prototype.readInt8=function(){if(this.unconsumedBufferLength<1)throw Error("Out of data");var d=this.bytes[this.base+this.position];this.position++;
this.unconsumedBufferLength--;return d};h.prototype.readInt16=function(){if(this.unconsumedBufferLength<2)throw Error("Out of data");var d=this.base+this.position,d=(this.bytes[d]<<8)+this.uBytes[d+1];this.position+=2;this.unconsumedBufferLength-=2;return d};h.prototype.readUInt16=function(){if(this.unconsumedBufferLength<2)throw Error("Out of data");var d=this.base+this.position,d=(this.uBytes[d]<<8)+this.uBytes[d+1];this.position+=2;this.unconsumedBufferLength-=2;return d};h.prototype.readInt32=
function(){return(this.readInt16()<<16)+this.readUInt16()};h.prototype.readUInt32=function(){return(this.readUInt16()<<16)+this.readUInt16()};h.prototype.readString=function(d){if(this.unconsumedBufferLength<d)throw Error("Out of data");var e=this.base+this.position,c;try{c=String.fromCharCode.apply(null,this.uBytes.subarray(e,e+d))}catch(b){c=[];for(var g=e;g<e+d;g++)c.push(String.fromCharCode(this.uBytes[g]));c=c.join("")}this.position+=d;this.unconsumedBufferLength-=d;return c};h.prototype.close=
function(){this.unconsumedBufferLength=0;this.uBytes=this.bytes=null};KindleModuleManager.define("SearchIndexUtilities",null,{Stream:f,Buffer:h})})();
(function(){function f(e){function c(){if(!a)if(n.seek(0),g=n.readInt16(),g!==1)KindleDebug.warn("Unsupported page numbering file format version "+g);else if(f=n.readInt16(),f===0)KindleDebug.log("PageNumbers File for this book is revoked by the service"),a=Kindle.ERROR.PN_REVOKED;else{k=[];for(var b=0;b<f;b++)k[b]=n.readUInt32();b=n.readUInt32();a=b>0?n.readString(b):"";m=[];o=[];l=[];r=[]}}function b(a){c();var b;a>=f||a<=-1?(KindleDebug.log("The requested page numbering edition at index "+a+" is out of bounds for the available count of editions "+
f),b=!1):b=!0;if(b&&!r[a])if(n.seek(k[a]),b=n.readInt16(),b!==1)KindleDebug.log("Unsupported edition pagination format "+b+" for edition "+a);else{b=n.readInt16();var d=n.readInt16(),e=n.readInt16();if(e>32)KindleDebug.log("Unsupported pagination format position width "+e+" for edition "+a);else{var g;b>0&&(g=n.readString(b));m[a]=parseInt(n.getPosition(),10);o[a]=d;l[a]=e;r[a]=g;return!0}}}var g,a,f,k,m,l,r,o,p=[],e=new d(e),n=new h(e,0,e.size);return{getHeaderMetadata:function(){c();return a},getEditionMetadata:function(a){return b(a)?
r[a]:!1},getOrdinalPagePositions:function(a){b(a);var c=o[a],d=l[a]/8;p.length=c+1;n.seek(m[a]);for(a=1;a<=c;a++){var e=d===2?n.readUInt16():d===4?n.readUInt32():0;p[a]=parseInt(e,10)}for(c=1;c<p.length;c++)p[c-1]>p[c]&&KindleDebug.log("Invalid position value at index "+c+": "+p[c]+", previous position: "+p[c-1]);return p},getEditionCount:function(){return f},getTotalPageCount:function(a){return o[a]}}}var h,d;KindleModuleManager.define("BinaryPageLabelSidecarReader",["SearchIndexUtilities"],function(e){h=
e.Buffer;d=e.Stream;return{openReader:f}})})();
var PageLabelIndexer=function(){return{create:function(f,h){function d(a){var c=0,d;for(d in b)b[d].getPageLabelType()===a&&b[d].getEndingOrdinalPageNumber()>c&&(c=b[d].getEndingOrdinalPageNumber());return c}function e(c){var d,e;c<1||c>a?e=void 0:(e=PageNumberUtilities.binarySearchPosition(g,c),e=b[g[e]]);e&&(c-=e.getStartingOrdinalPageNumber(),c=e.getStartingPageLabel()+c,d=e.getPageLabelAtSeriesIndex(c));return d}var c="",b,g,a;if(f==="")KindleDebug.log("pageLabelIndexString cannot be blank, pageLabelIndexString = "+c);
else if(h<0)KindleDebug.log("TotalPages cannot be less than 0, total pages = "+h);else{c=f.toString();a=h;var j=0,k=null;for(b={};j<c.length;){if(c.charAt(j)!=="("){KindleDebug.log("Each page number scheme must start with '('; was given: "+c.substring(j));return}var m=c.indexOf(")",j);if(m<0)break;j=c.substring(j+1,m);j=PageLabelSeq.create(j);k!==null&&k.setEndingOrdinalPageNumber(j.getStartingOrdinalPageNumber()-1);k=b[parseInt(j.getStartingOrdinalPageNumber(),10)]=j;j=m+1;j<c.length&&c.charAt(j)===
","&&j++}k.setEndingOrdinalPageNumber(h);g=[];var c=0,l;for(l in b)b.hasOwnProperty(l)&&(g[c]=b[l].getStartingOrdinalPageNumber(),c++);g.sort(function(a,b){return a-b});return{getLabelSequences:function(){return b},getOrdinalPageForPageLabelText:function(a){var c=null,d=0,e;for(e in b){var g=b[e];if(g.isLabeled()){g.getStartingOrdinalPageNumber()<=d&&(c=null);var f=g.getOrdinalPageForPageLabelText(a);f>=0&&(c=g,d=f)}}return c===null||d>h?0:d},getPageLabelTextForOrdinalPage:e,getHighestPageLabel:function(){var a=
d("a");a===0&&(a=d("r"));var b="";a>0&&(b=e(a));return b},getPageNumberRanges:function(){var a={},c;for(c in b){var d=b[c],e=PageLabelType[d.getPageLabelType()],g=a[e];g?(g.minPage=Math.min(g.minPage,d.getStartingPageLabel()),g.maxPage=Math.max(g.maxPage,d.getEndingPageLabel())):(g={},g.minPage=d.getStartingPageLabel(),g.maxPage=d.getEndingPageLabel());a[e]=g}return a}}}}}}(),PageLabelSeq=function(){return{create:function(f){function h(){return c}function d(){return b}function e(){return b+j-c}var c,
b,g,a,j,f=f.split(",");j=c=parseInt(f[0],10);g=f[1].charAt(0);if(g===null)console.error("Unknown Page Numbering scheme");else return b=0,a=null,g==="c"?(a=f[2].split("|"),b=1):g!=="i"?b=parseInt(f[2],10):f[2]&&(b=parseInt(f[2],10)),{getStartingPageLabel:d,getStartingOrdinalPageNumber:h,getPageLabelType:function(){return g},getEndingPageLabel:e,getDisplayPageRange:function(){return[b,e()]},getEndingOrdinalPageNumber:function(){return j},setEndingOrdinalPageNumber:function(a){j<c&&console.error("ending ordinal page number must be >= than starting ordinal page number,endingOrdinalPageNumber  = "+
j+", startingOrdinalPageNumber = "+c);j=a},isLabeled:function(){return g!=="i"},getPageLabelAtSeriesIndex:function(b){var c;g==="a"?c=b.toString():g==="r"?c=PageNumberUtilities.toRomanNumeral(b).toString().toLowerCase():g==="i"?c="":g==="c"&&(b-=1,c=b<a.length?a[b]:"");return c},getOrdinalPageForPageLabelText:function(d){var e=0,f=!1;if(g==="a")try{e=parseInt(d,10),f=e>=b}catch(j){e=0,f=!1}g==="r"&&PageNumberUtilities.isValidRomanNumeral(d)&&(e=PageNumberUtilities.parseRomanNumeral(d),f=e>=b);g===
"c"&&a!==null&&(a[d]&&(e=a[d]+1),e>0&&(f=!0));return!f?-1:c+(e-b)}}}}}(),PageNumberProvider=function(){return{create:function(f){var h=!1,d,e=[],c=-1,b=0;if(f){e=f.oPNToPosition;b=f.totalPages;d=PageLabelIndexer.create(f.pageMapString,b);var f=d.getLabelSequences(),g=b=null,a;for(a in f){if(f[a]===null){KindleDebug.log("Page number sidecar edition doesn't contain a valid page label index");return}b===null&&(b=f[a]);g=f[a]}h=!0;c=b.getStartingOrdinalPageNumber();g.getEndingOrdinalPageNumber()}return{arePageNumbersAvailable:function(){return h},
pageNumberFromPosition:function(a){var b;if(a>=e[c]){a=PageNumberUtilities.binarySearchPosition(e,a);a<c&&(a=c);var g;a>=1&&(g=d.getPageLabelTextForOrdinalPage(a));b=g}return b},positionFromPageNumber:function(a){var b=d.getOrdinalPageForPageLabelText(a);b<=0&&parseInt(a,10);if(b<=0)return-1;b>=e.length&&(b=e.length-1);return e[b]},getMaxPageNumberLabel:function(){return d.getHighestPageLabel()},getPageNumberRanges:function(){return d.getPageNumberRanges()}}}}}();
(function(){function f(b){function c(){e.endTimer();f.emit("Service::GetPageNumber");j.resolve(h.response)}function d(){KindleDebug.error("An error occurred while transferring the file.");j.reject(Kindle.ERROR.PN_DOWNLOAD_FAIL)}var e,f,j,h;return function(b){j=$.Deferred();h=new XMLHttpRequest;h.open("GET",b);h.responseType="arraybuffer";h.addEventListener("load",c,!1);h.addEventListener("error",d,!1);e=a.createSubTimer("download page numbers");f=g.createTimer();h.send(null);return j.promise()}(b)}
function h(a){var b=$.Deferred();a.getCachedPageNumbers().then(function(a){a?b.resolve(a):b.reject()},b.reject);return b.promise()}function d(a){var b=a.getContext().pageNumberUrl;return!b?(g.emit("PageNumber::Unavailable"),$.Deferred().resolve()):h(a).pipe(null,function(){return f(b).pipe(c).done(a.cachePageNumbers)}).pipe(function(a){g.emit("PageNumber::Success");return a},function(a){a===Kindle.ERROR.PN_DOWNLOAD_FAIL&&g.emit("PageNumber::DownloadFailure");g.emit("PageNumber::Fail")})}function e(b){var c=
b.getAsin();if(!j[c]){if(!KindleDeviceCapabilities.showPageNumbers())return $.Deferred().reject("Unsupported OS");a=KindleMetricsProfiler("get page numbers");j={};j[c]=d(b).pipe(function(b){var c;b&&(c=PageNumberProvider.create(b));a.endTimer();a.log();return c})}return j[c]}function c(c){function d(a){a===Kindle.ERROR.PN_REVOKED?g.emit("PageNumber::RevokedData"):g.emit("PageNumber::CorruptData");return $.Deferred().reject()}var e=g.createTimer(),f=a.createSubTimer("parse page number file"),c=b.openReader(c),
j=c.getHeaderMetadata();if(j){if(j===Kindle.ERROR.PN_REVOKED)return d(Kindle.ERROR.PN_REVOKED)}else return KindleDebug.log("Corrupt Header Data for Page Number."),d();if(!JSON.parse(j).fileRevisionId)return KindleDebug.log("Page number sidecar header doesn't contain appropriate metadata (missing fileRevisionId)."),d();if(c.getEditionCount()>0){j=c.getEditionMetadata(0);if(!j)return KindleDebug.log("Edition Header corrupted for Page Number."),d();j=JSON.parse(j);if(!j.pageMap)return KindleDebug.log("Page number sidecar edition doesn't contain appropriate metadata (missing pageMap)."),
d();c={oPNToPosition:c.getOrdinalPagePositions(0),pageMapString:j.pageMap,totalPages:c.getTotalPageCount(0)};e.emit("PageNumber::FileParse");f.endTimer();return c}else return d()}var b,g,a,j={};KindleModuleManager.define(Kindle.MODULE.PageNumberManager,[Kindle.MODULE.DB_CLIENT,Kindle.MODULE.METRICS_MANAGER,"BinaryPageLabelSidecarReader"],function(a,c,d){g=c;b=d;return{getPageNumbers:e}})})();
var PageLabelType={r:"roman",a:"arabic",c:"custom",i:"insert"},PageNumberUtilities=function(){var f={M:1E3,CM:900,D:500,CD:400,C:100,XC:90,L:50,XL:40,X:10,IX:9,V:5,IV:4,I:1},h=["M","CM","D","CD","C","XC","L","XL","X","IX","V","IV","I"];return{toRomanNumeral:function(d){for(var e="",d=parseInt(d,10),c=0;c<h.length;c++)for(var b=h[c];d>=f[b];)e+=b,d-=f[b];return e},parseRomanNumeral:function(d){for(var d=d.toUpperCase(),e=0,c=0;c<d.length-1;)f[d.charAt(c)]<f[d.charAt(c+1)]?e-=f[d.charAt(c)]:e+=f[d.charAt(c)],
c++;e+=f[d[c]];return e},binarySearchPosition:function(d,e){for(var c=0,b=d.length-1,g;c<=b;)if(g=Math.floor((c+b)/2),d[g]<e)c=g+1;else if(d[g]>e)b=g-1;else return g;return b>=0?b:c},isValidRomanNumeral:function(d){return/^M{0,4}(CM|CD|D?C{0,3})(XC|XL|L?X{0,3})(IX|IV|V?I{0,3})$/.exec(d.toString().toUpperCase())?!0:!1}}}();
(function(){function f(b){function g(){return KindleReaderAnnotationManager.deferredInitialize(b.bookinfo.getBookInfoDfd(),b.moduleManager)}function a(){var a;return b.bookinfo.getBookInfoDfd().pipe(function(b){a=b;return a.getMetadata()}).pipe(function(c){var d=a.getContext(),g=a.getAsin();return c.headerMetadata&&(c.headerMetadata.bookType===Kindle.BookInfo.PublisherMetadata.COMIC||c.headerMetadata.bookType===Kindle.BookInfo.PublisherMetadata.CHILDREN)?$.Deferred().resolve():e.getSearchIndex({asin:g,
formatVersion:d.formatVersion,contentVersion:d.contentVersion,contentCache:b.contentCache,kcrFree:b.kcrFree})})}function f(){return b.bookinfo.getBookInfoDfd().pipe(c.getPageNumbers)}return{names:Object.freeze(d),getAnnotations:g,getSearchIndex:a,getPageNumbers:f,download:function(b){switch(b){case "annotations":return g();case "searchIndex":return a();case "pageNumbers":return f();default:return $.Deferred().reject("Unknown sidecar")}}}}var h={annotations:{},pageNumbers:{},searchIndex:{}},d={};Object.keys(h).forEach(function(b){h[b].name=
b;d[b]=b});var e,c;KindleModuleManager.define(Kindle.MODULE.SidecarManager,[Kindle.MODULE.SearchIndexManager,Kindle.MODULE.PageNumberManager],function(b,d){e=b;c=d;return{create:f}})})();function AssertionError(f){Error.call(this,f)}AssertionError.prototype=Error();AssertionError.prototype.name="AssertionError";function KindleAssert(){}
var KindleAuthor=function(){var f=["phd","md","sir"];return{getDisplayableString:function(h){for(var d="",e=h.length,c=0;c<e;c++){for(var b=h[c].split(","),g=[],a=[],j=0;j<b.length;j++){var k=$.trim(b[j]);f.indexOf(k.toLowerCase())>-1?g.push(k):a.unshift(k)}if(a.length===2){d+=a[0]+" "+a[1];for(b=0;b<g.length;b++)d+=", ",d+=g[b]}else d+=h[c];e>1&&(c===e-2?d+=ResourceBundle.getLocalizedString("k_author_conjunction"):c<e-2&&(d+=", "))}return d},getLegacyDisplayableString:function(f){for(var d="",e=
f.length,c=0;c<e;c++)d+=f[c],c<e-1&&(d+="; ");return d}}}(),KindleDebug=function(){return{error:function(){},log:function(){},warn:function(){},saveLogs:function(){saveLog=!0}}}(),KindleDeviceCapabilities=function(){function f(){return KindleHostDeviceDetector.isMetro()||KindleHostDeviceDetector.isIE()?!0:!1}var h;return{searchInTheBook:function(){return!KindleHostDeviceDetector.isiOS_4x()},showPageNumbers:function(){return!KindleHostDeviceDetector.isiOS_4x()},multiColumnMode:function(){return!0},
useNativeSelection:f,useCSSRegions:function(){return f()},useLocaleCompare:function(){if(h===void 0){try{"a".localeCompare("b","i")}catch(d){return h=d.name==="RangeError"}h=!1}return h},showFirstRunDialog:function(){return!KindleHostDeviceDetector.isMSEdge()},hasPageResizeIssues:function(){return KindleHostDeviceDetector.isiOS_9x()?!0:!1},hasSplitView:function(){return KindleHostDeviceDetector.isiOS()&&KindleHostDeviceDetector.getOSMajorVersion()>=9}}}(),KindleHostDeviceDetector=function(){function f(){return navigator.platform.indexOf("iPad")!==
-1}function h(){return navigator.platform.indexOf("iPhone")!==-1||navigator.platform.indexOf("iPod")!==-1}function d(){return f()||h()||k()}function e(){var a=-1;d()&&(a=navigator.userAgent.match(/OS (\d+)_/)[1]);return a}function c(){return(f()||h())&&parseInt(e(),10)===7}function b(){return(f()||h())&&parseInt(e(),10)>=8}function g(){return(f()||h())&&parseInt(e(),10)>=9}function a(){return navigator.userAgent.indexOf("Firefox")!==-1&&navigator.userAgent.indexOf("Trident")<0}function j(a){var b=
navigator.userAgent.match(/Version\/(\d+\.\d+)(?:\.\d+)*(?: Mobile\/\S+)? Safari/);return!b?!1:!a?!0:Number(b[1])>=Number(a)}function k(){return navigator.userAgent.indexOf("Cloud9")!==-1}function m(){return navigator.userAgent.indexOf("MSAppHost")!==-1}function l(){return m()&&r()}function r(){return!!/arm/i.test(navigator.cpuClass)}function o(){return a()?navigator.onLine:KindleModuleManager.getModuleSync(KindleModuleManager.NETWORK).isOnline()}function p(){return navigator.userAgent.indexOf("MSIE")!==
-1||navigator.userAgent.indexOf("Trident")!==-1}function n(){return navigator.userAgent.indexOf("Chrome")!==-1&&navigator.userAgent.indexOf("Safari")!==-1&&navigator.userAgent.indexOf("Edge")!==-1}function q(){return"standalone"in navigator&&navigator.standalone}function t(){return window.chrome&&Kindle.top.chrome.app&&Kindle.top.chrome.app.isInstalled}function u(){return window.navigator.msMaxTouchPoints>=1}return{isiOS:d,isiPad:f,isiPhone:h,isiOS_4x:function(){return(f()||h())&&navigator.userAgent.indexOf("OS 4")!==
-1},isiOS_5xOrGreater:function(){return(f()||h())&&parseInt(e(),10)>=5},isiOS_7x:c,isiOS_8x:b,isiOS_9x:g,hasiOSInnerHeightBug:function(){return!g()&&(c()||b())},hasCanvasSizeLimitProblem:function(){return d()},isMacintosh:function(){return navigator.userAgent.indexOf("(Macintosh;")!==-1},isFirefox:a,hasHangingDbPrompt:function(){if(!a())return!1;var b=/Firefox\/(\d+)/.exec(navigator.userAgent);return b.length>=1&&b[1]>=17},isSafari:j,isMetro:m,isMetroArm:l,isMetroSnappedView:function(){return m()&&
window.outerWidth===320},isIE:p,isIE10:function(){return p()&&navigator.userAgent.indexOf("Trident/6.0")!==-1},isIE11:function(){return p()&&(navigator.userAgent.indexOf("Trident/7.0")!==-1||navigator.userAgent.indexOf("Trident/8.0")!==-1)},isMSEdge:n,isArm:r,isCloud9:k,isTablet:function(){return f()||m()},isOnline:o,isNetworkAvailable:function(){if(!o())return(new jQuery.Deferred).reject().promise();var a=$.Deferred();$.ajax({url:"/ping",error:function(){a.reject()},timeout:5E3}).then(a.resolve,
a.reject);return a.promise()},isNetworkAvailableSync:function(){if(!o())return!1;var a=!0;$.ajax({url:"/ping",error:function(){a=!1},timeout:50,async:!1});return a},isChrome:function(){return window.chrome&&!n()},isiOSAppMode:q,isChromeApp:t,isFirefoxAppSupported:function(){return!!KindleHostDeviceDetector.isFirefox()&&window.navigator.mozApps},isInAppMode:function(){return q()||t()},isCookieEnabled:function(){return navigator.cookieEnabled},areWebWorkersSupported:function(){return typeof Worker!==
"undefined"},isLocalStorageEnabled:function(){return KindleLocalStorage.isLocalStorageEnabled()},hasArrayLikeApply:function(){return!d()||parseInt(KindleHostDeviceDetector.getOSMajorVersion(),10)>=6},isWebSQLSupported:function(){return!!window.openDatabase},isIndexedDBSupported:function(){return!!window.mozIndexedDB||!!window.indexedDB},isMSTouchEnabledDevice:u,isTouchDevice:function(){return d()||u()},getDevicePlatform:function(){return f()?"iPad":h()?"iPhone":k()?"otter":l()?"metroArm":m()?"metro":
"desktop"},hasCanvasPerformanceProblem:function(){return f()&&KindleHostPadDetector.isPad1(q())||l()},hasMissingImgOnLoadProblem:function(){return j()||q()||a()},hasImageRenderingProblem:function(){return j()||q()},getDeviceType:function(){return m()?Kindle.DeviceType.Metro:Kindle.DeviceType.KCR},getClientName:function(){return m()?Kindle.ClientName.Metro:Kindle.ClientName.KCR},getOSMajorVersion:e,getOSMinorVersion:function(){var a=-1;d()&&(a=navigator.userAgent.match(/OS (\d+)_(\d+_?(\d+)?)/)[2]);
return a},getBrowserLanguage:function(){return navigator.language||navigator.userLanguage}}}(),KindleHostPadDetector=function(){return{isPad1:function(f){if(KindleLocalStorage.getItem("definitelyNotPad1"))return!1;var h=0,d=1E3,e=0,c;for(i=0;i<3;i++)c=SunSpiderBenchmark.get3DSpeed(),c>h?h=c:c<d&&(d=c),e+=c;h=e/3;if(h>=200&&f)return!0;if(h>=100&&!f)return!0;KindleLocalStorage.setItem("definitelyNotPad1","true");return!1}}}();
function KindleInterfacesFactory(){function f(f,d){for(var e in d)if(d.hasOwnProperty(e)&&typeof f[e]!==typeof d[e])return!1;return!0}return{IKindleLibrary:{onReaderOpenStatus:function(){},onReaderClose:function(){},onStoreOpenStatus:function(){},libraryUpdateNeeded:function(){}},IKindleReader:{openBook:function(){},unloadReader:function(){},onStoreOpenStatus:function(){},pauseReader:function(){},resumeReader:function(){},setToolbarVisible:function(){},downloadBook:function(){},removeBook:function(){}},
IKindleAppForLibrary:{storeIsTOS:function(){},openStore:function(){},openBook:function(){},onLibraryLoaded:function(){},getQueryParameters:function(){}},IKindleAppForReader:{onReaderReady:function(){},closeReader:function(){},onStartReadingStatus:function(){},onRendererLoaded:function(){},openStore:function(){},pinBookToStart:function(){},onReaderTapped:function(){},onUserAction:function(){},hideAppBar:function(){}},checkImplements:f,assertImplements:function(h,d){f(h,d)||KindleAssert(!1,"Object fails to provide all properties of interface prototype")}}}
var KindleInterfaces=KindleInterfacesFactory(),KindlJournalManager=function(){function f(a){var b=[],c;for(c in a){var d=a[c].entry;d.guid=d.guid||d.refEmId;delete d.refEmId;d&&b.push(d)}return b}function h(a){var d=[],e;for(e in a)d.push({entry:a[e]});return b.getAppDb().getTable(c).insertList(d)}function d(a){function c(){var r,o=KindleModuleManager.getModuleSync(KindleModuleManager.RESOURCE_BUNDLE).getLocalTimeOffset();e<a.length?(h=Math.min(e+100,a.length),r=Array.prototype.slice.call(a,e,h),
e=h,g.updateAnnotations(f(r),o).then(function(){b.getAppDb().deleteJournalEntries(r).then(c,d.reject)},d.reject)):d.resolve()}var d=new jQuery.Deferred,e=0,h;c();return d.promise()}function e(){var a=new jQuery.Deferred;b.getAppDb().getTable(c).getRecord().then(function(b){b.length>0?d(b).then(a.resolve,a.reject):a.resolve()},a.reject);return a.promise()}var c="journal",b=null,g=null;return{initialize:function(){var a=new jQuery.Deferred,c=this;KindleModuleManager.getModuleList([KindleModuleManager.SERVICE_CLIENT,
KindleModuleManager.DB_CLIENT]).then(function(d){g=d[KindleModuleManager.SERVICE_CLIENT];b=d[KindleModuleManager.DB_CLIENT];a.resolve(c)},a.reject);return a.promise()},saveToJournal:function(a){var b=new jQuery.Deferred;h(a).then(function(){e().then(b.resolve,b.resolve)},b.reject);return b.promise()},uploadJournal:e}}(),KindleLegacyDeviceTokenStorage=function(){return{hasDeviceTokenFromStorage:function(){return KindleLocalStorage.getItem("kindleDeviceToken")!==null},getDeviceTokenFromStorage:function(){return KindleLocalStorage.getItem("kindleDeviceToken")},
setDeviceToken:function(f){KindleLocalStorage.setItem("kindleDeviceToken",f)},clearDeviceTokenFromStorage:function(){KindleLocalStorage.removeItem("kindleDeviceToken")}}}(),KindleMetricsProfiler=function(f){function h(d){for(var c=0,b=0;b<d.length;b+=1)c+=d[b].end-d[b].start;return c}var d={};d.name=f;d.counters=null;d.subTimers=null;d.runs=[{start:(new Date).getTime(),end:null}];d.endTimer=function(){var d=this.runs[this.runs.length-1];if(d.end===null)d.end=(new Date).getTime()};d.addCount=function(d,
c){if(this.counters===null)this.counters={};this.counters[d]===void 0?this.counters[d]=c:this.counters[d]+=c};d.createSubTimer=function(d){if(this.subTimers===null)this.subTimers={};this.subTimers[d]===void 0?this.subTimers[d]=KindleMetricsProfiler(d):this.subTimers[d].runs.push({start:(new Date).getTime(),end:null});return this.subTimers[d]};d.log=function(){this.logAsPercentageOfTime("",h(this.runs))};d.logAsPercentageOfTime=function(d,c){var b=d+":"+this.name,g,a=h(this.runs);KindleDebug.log(b+
":Time: "+a+"ms - ("+(c?a/c*100:100).toFixed(2)+"%)");for(g in this.counters)KindleDebug.log(b+":"+g+" : "+this.counters[g]);for(g in this.subTimers)this.subTimers[g].logAsPercentageOfTime(b,c)};return d},KindleRemoteClient=function(){return{uploadFeedback:function(f){if(!f)return(new $.Deferred.reject).promise();var h=KindleLibrarySetting.getSettings(),h={DevicePlatform:KindleHostDeviceDetector.getDevicePlatform(),UserAgent:navigator.userAgent,WindowHeight:window.innerHeight,WindowWidth:window.innerWidth,
AppCached:!!KindleLocalStorage.getItem("cached"),AppCacheStatus:window.applicationCache.status,TouchEnabled:KindleHostDeviceDetector.isTouchDevice(),ApplicationMode:KindleHostDeviceDetector.isInAppMode(),Language:navigator.language,LocalStorageEnabled:KindleHostDeviceDetector.isLocalStorageEnabled(),LibrarySort:h.sortParam,LibraryView:h.viewState,TLD:Kindle.URL.getAmazonDomain()||"unknown"};return function(d){return KindleModuleManager.getModule(KindleModuleManager.DB_CLIENT).pipe(function(e){try{var c=
e.getAppDb(),b=c.getCachedAsins(Kindle.BookInfo.CachedState.FULLY_DOWNLOADED),g=c.getAllBooks();d.info.OfflineStorageEnabled=!!e.bookDbEnabled();return $.when(b,g)}catch(a){return $.Deferred.reject()}}).pipe(function(e,c){$.extend(d.info,{TotalBookCount:c.length,TotalBookDownloaded:e.length});return d.eid?d.eid:KindleModuleManager.getModuleSync(Kindle.MODULE.SERVICE_CLIENT).getEID()}).pipe(function(e){d.eid=e;return d},function(){return $.Deferred().resolve(d)})}({version:KindleVersion.getVersionString(),
message:f.text,deviceType:KindleHostDeviceDetector.getDeviceType(),info:h}).pipe(function(d){d={url:"/remote/feedback",type:"POST",processData:!1,contentType:"application/json",data:JSON.stringify(d)};return $.ajax(d)})}}}(),KindleTemplateManager=function(){return{initialize:function(){Handlebars.registerHelper("str",function(f){return ResourceBundle.getLocalizedString(f)})}}}(),KindleUserAgentMetricsInfo=function(){function f(){function a(){var a=/MSAppHost\/([0-9\.]+)/.exec(navigator.userAgent);
if(a)return a[1]}var b;if(!(b=function(){var a;if(["ipad","iphone"].indexOf(d)!==-1&&(d="ios",(a=/CPU OS ([0-9_]+) /.exec(navigator.userAgent))&&a.length>=2))return a[1]}())){var c;KindleHostDeviceDetector.isIE()&&(c=KindleHostDeviceDetector.isIE10()?"10":KindleHostDeviceDetector.isIE11()?"11":"unknown");b=c||a()||GoogleUserAgent.browserVersionString.toLowerCase()}return b}var h,d,e,c,b,g={chrome:14,firefox:7,safari:5,metro:1,ie:10,ios:4};return{browserWithVersionString:function(){if(!h){d=GoogleUserAgent.browserName.toLowerCase();
e=f();a:{if(e){var a=/^0*([0-9]+)/.exec(e);if(a&&a.length>=2){c=parseInt(a[1],10);break a}else KindleDebug.error("Bad regex on versionString: "+e)}c=void 0}b="undefined"===typeof c?"other":g[d]?[d,c].join("@"):"other";h=!0}return b}}}(),KindleVersion=function(){var f="011201999";window.location.hostname==="k4w-dev.aka.amazon.com"&&(f="999999998");if(f.length!==9)throw{name:"BadVersion",message:"bad version number. got: "+f};var h=null,d=null;return{getMetricsVersionString:function(){d||(d=parseInt(f.slice(0,
2),10),d+=".",d+=parseInt(f.slice(2,4),10),d+=".",d+=parseInt(f.slice(4,6),10));return d},getVersionString:function(){h||(h=parseInt(f.slice(0,2),10),h+=".",h+=parseInt(f.slice(2,4),10),h+=".",h+=parseInt(f.slice(4,6),10),h+=".",h+=parseInt(f.slice(6),10));return h},getVersionNumber:function(){return Number(f)},parseVersionString:function(d){return d&&(d=/(\d{1,2})\.(\d{1,2})\.(\d{1,2})\.(\d{1,3})/.exec(d))?Number(d[1])*1E7+Number(d[2])*1E5+Number(d[3])*1E3+Number(d[4]):NaN}}}(),LinkUrls=function(){function f(){e||
(Kindle.URL.isPreProd()?(d=(d=Kindle.URL.getPreProdCountryCode())?d:"us",e=Kindle.CountryToDomainMap[d]):(e=Kindle.URL.getAmazonDomain(),d=Kindle.DomainToCountryMap[e]))}function h(d){return $.Deferred().resolve(function(){var e;e=c+Kindle.CountryToDomainMap.us+b;e+="?"+a.DeviceType+"="+Kindle.DeviceType.KCR+"&"+a.Eid+"="+(k||"")+"&"+a.Method+"="+d;return e}())}var d,e,c="https://www.",b="/gp/kindle/kcp/links",g={Help:{NodeId:"200701430"},OfflineReading:{NodeId:"201255020"},IncreaseOfflineStorage:{NodeId:"201265520"},
TroubleShooting:{NodeId:"200732370"},License:{NodeId:"200701450",RefTag:"kcr_legalnotices_menu"},KCPLanding:{DocId:{us:"1000493771",uk:"1000425503",de:"1000482783",fr:"1000538763",it:"1000576423",es:"1000576363",jp:"3077089376",au:"3077705566",cn:"98968","in":"1000659093",ca:"1000817631",br:"1000828031",mx:"1001216041"},iTunesURL:"https://itunes.apple.com/",iTunesEndPoint:"/app/apple-store/id302584613?mt=8",DesktopEndpoint:"/gp/feature.html",DesktopQueryParam:"?ie=UTF8&docId="}},a={DeviceType:"deviceType",
Eid:"eid",Method:"method",Asin:"a"},j={Help:"Help",Legal:"License",Terms:"TermsCond",Store:"StoreFront",Privacy:"Privacy",DetailPage:"DetailPage"},k;return{getStoreUrl:function(a){if(k&&!a.kcrFree)return h(j.Store).pipe(function(b){a.tag&&(b+="&tag="+a.tag);a.refTag&&(b+="&ref_="+a.refTag);return b});else{f();var b=c+e+"?ref_="+a.refTag;a.tag&&(b+="&tag="+a.tag+"&at="+a.tag);return $.Deferred().resolve(b)}},getPrivacyUrl:function(){f();return c+e+"/privacy"},getTermsOfUseUrl:function(){return"http://www.kindle.com/support/terms"},
getLegalUrl:function(){f();return c+e+"/gp/help/customer/display.html?nodeId="+g.License.NodeId+"ref="+g.License.RefTag},getHelpUrl:function(){f();return c+e+"/gp/help/customer/display.html?nodeId="+g.Help.NodeId},getOfflineReadingUrl:function(){f();return c+e+"/gp/help/customer/display.html?nodeId="+g.OfflineReading.NodeId},getIncreaseOfflineStorageUrl:function(){f();return c+e+"/gp/help/customer/display.html?nodeId="+g.IncreaseOfflineStorage.NodeId},getTroubleShootingUrl:function(){f();return c+
e+"/gp/help/customer/display.html?nodeId="+g.TroubleShooting.NodeId},getDetailPage:function(b){if(k&&!b.kcrFree)return h(j.DetailPage).pipe(function(c){c+="&"+a.Asin+"="+b.asin;b.tag&&(c+="&tag="+b.tag);b.refTag&&(c+="&ref_="+b.refTag);return c});else{f();var d=c+e+"/dp/"+b.asin+("?ref_="+(b.refTag||Kindle.RefTag.Values.StoreSample));b.tag&&(d+="&tag="+b.tag+"&at="+b.tag);return $.Deferred().resolve(d)}},getKCPLandingPageLink:function(a){(!e||!d)&&f();var b;KindleHostDeviceDetector.isiPad()?b=g.KCPLanding.iTunesURL+
d+g.KCPLanding.iTunesEndPoint:(b=c+e+g.KCPLanding.DesktopEndpoint,b=a?b+"/ref="+a:b,b+=g.KCPLanding.DesktopQueryParam+g.KCPLanding.DocId[d]);return b},getDownloadLink:function(a){(!e||!d)&&f();var b=c+e+"/gp/kindle/kcpApp.html";return a?b+"/ref="+a:b},getAmazonDomainURL:function(){(!e||!d)&&f();return c+e},getRTEServiceURL:function(){(!e||!d)&&f();if(Kindle.URL.isPreProd()){var a="https://kindlestore-preprod";if(d==="it"||d==="es"||d==="in")a+="-eux";return a+"."+e+"/gp/digital/fiona/ajax/send-email-or-sms.html"}return this.getAmazonDomainURL()+
"/gp/digital/fiona/ajax/send-email-or-sms.html"},getNotebookURL:function(a,b){var c=Kindle.URL.getHostURL()+"/notebook",d=[];a&&d.push("asin="+a);b&&d.push("ref_="+b);return c=d?c+"?"+d.join("&"):c},initializeEid:function(a){k=a}}}(),KindleChromeInstaller=function(){function f(){function d(){window.location.reload(!1)}Kindle.top.chrome.webstore.install(void 0,function(){KindleDebug.log("install success");setTimeout(d,250)},function(d){KindleDebug.error(d)})}function h(){return window.chrome&&Kindle.top.chrome.webstore&&
Kindle.top.chrome.webstore.install}return{install:function(){h()?window.parent.document.getElementById("inlineInstallProxy").click():KindleMessageDialog.showError(Kindle.ERROR.OUTDATED_CHROME)},initialize:function(){if(KindleHostDeviceDetector.isChrome()&&h()){var d=document.createElement("button");d.id="inlineInstallProxy";d.style.display="none";$(d).click(f);$("body").append(d)}}}}(),KindleFirefoxInstaller=function(){function f(){return Kindle.URL.getHostURL()+"/offline/kcr_ff.webapp"}function h(){if(!KindleHostDeviceDetector.isFirefoxAppSupported())return $.Deferred().reject().promise();
var d=$.Deferred(),e=navigator.mozApps.getInstalled();e.onsuccess=function(){var c=!1,b=f();e.result.forEach(function(d){d.manifestURL===b&&(c=!0)});d.resolve(c)};e.onerror=function(){KindleDebug.error("Error checking installation status: "+this.error.message);d.reject()};return d.promise()}return{install:function(){var d=$.Deferred();h().done(function(e){e?d.reject():(e=navigator.mozApps.install(f()),e.onsuccess=function(){KindleDebug.log("Firefox App successfully installed.");d.resolve()},e.onerror=
function(){KindleDebug.error("Firefox App failed to install.");d.reject()})}).fail(d.reject);return d.promise()}}}(),KindleJPMerchandiseManager=function(){return{getBookList:function(){return $.ajax({url:"/kcpextservice_jp/external-service?method=getCampaign&slotName=right-3&deviceType="+Kindle.DeviceType.KCR+"&userCode=KcrKin&storeType=ebooks",dataType:"json"}).pipe(function(f){return f&&f.data&&f.data.items?f.data.items:[]},function(){return[]})}}}(),KindleLibrary=function(){function f(){KindleLibraryHomeScreenPopup.show();
KindleLibraryControlBar.setCacheDone()}function h(){KindleLibraryScrollPane.checkForBadgeUpdates();v().getAllBooks().done(x)}function d(a){KindleSpinner.hide();a===Kindle.STORE.OFFLINE_ERROR?F(Kindle.ERROR.STORE_OPEN_OFFLINE_FAILED):a===Kindle.STORE.GENERIC_ERROR&&F(Kindle.ERROR.STORE_OPEN_FAILED)}function e(){U||(KindleHostDeviceDetector.isiOS()?KindleLibraryHeaderBar.dismissKeyboard():KindleLibraryHeaderBar.deactivateSearch());return!1}function c(){var a={breakdown:["Browser"]};KindleLocalStorage.getItem(Kindle.App.LIBRARY_FAIL_FLAG)?
E.emit("Library::OpenLibraryFail",a):KindleLocalStorage.setItem(Kindle.App.LIBRARY_FAIL_FLAG,"true");M=E.startMetrics("Library::OpenLibrary",a);KindleSpinner.show();KindleLibrarySetting.initialize();J=KindleHostDeviceDetector.isiPad();KindleLibraryContentList.addChangeListener(b);g().then(function(){v().getBookDataLastSyncTime(p);KindleHostDeviceDetector.isiOS_5xOrGreater()?$("body",Kindle.top.document).bind("orientationchange.library",m):$(window).resize(m);$(window).keydown(l);$(window).keyup(r);
KindleWindowSizeWatcher.setMetricsContext("Library");KindleDeviceCapabilities.hasSplitView()&&KindleWindowSizeWatcher.startPolling();KindleHostDeviceDetector.isiOS()?$("#page_body").bind("touchstart",e):$("#page_body").bind("click",e);KindleHostDeviceDetector.hasiOSInnerHeightBug()&&$("body").addClass("iosInnerHeightBug");KindleHostDeviceDetector.isiOS()||$(window).focus(function(){ea.checkTokenConsistency()});KindleOffline.isEnabled()?v().getCachedAsins(void 0).then(function(a){var b,c,d={};d[Kindle.BookInfo.CachedState.CACHED]=
0;d[Kindle.BookInfo.CachedState.PINNED]=0;for(b in a)c=a[b],d[c.cacheState]++;d[Kindle.BookInfo.CachedState.CACHED]&&E.increaseSubCounter(M,"booksCached",d[Kindle.BookInfo.CachedState.CACHED]);d[Kindle.BookInfo.CachedState.PINNED]&&E.increaseSubCounter(M,"booksPinned",d[Kindle.BookInfo.CachedState.PINNED])}):E.increaseSubCounter(M,"noOffline",1)})}function b(a,b){KindleLibraryScrollPane.setLayout(KindleLibrarySetting.getLastLayoutView());var c=KindleLibraryScrollPane.displayBooks(a,b);b&&c===0?KindleLibraryMessagePane.showEmptySearchMessage(!KindleHostDeviceDetector.isOnline()):
KindleLibraryMessagePane.hideEmptySearchMessage()}function g(){var a;C();I();a=KindleLibrarySetting.getSettings();a=KindleLibraryScrollPane.initialize(a,s,w,A,z);D();if(KindleDeviceCapabilities.hasSplitView())KindleWindowSizeWatcher.onWindowResized();KindleLibrarySetting.getLastLibraryView()==="downloaded"&&(KindleLibraryScrollPane.setView("downloaded"),KindleLibrarySetting.setLibraryView("downloaded"));!J&&!KindleHostDeviceDetector.isIE()&&P();return a}function a(){KindleLibraryHeaderBar.setSyncButtonDisabled(!0);
KindleSpinner.show();v().getBookDataLastSyncTime(p)}function j(){fa=!0;a()}function k(){Q.openNotebook()}function m(){S?X=!0:(KindleLibraryContextMenu&&KindleLibraryContextMenu.hide(),da())}function l(a){if(!S)switch(a.which){case 38:KindleLibraryScrollBar.moveStart(!0);break;case 40:KindleLibraryScrollBar.moveStart(!1)}}function r(a){if(!S)switch(a.which){case 33:KindleLibraryScrollBar.movePage(!0);break;case 34:KindleLibraryScrollBar.movePage(!1);break;case 27:KindleLibraryHeaderBar.deactivateSearch(!0);
break;default:KindleLibraryScrollBar.moveEnd()}}function o(a){fa?(B(),KindleHostDeviceDetector.isOnline()?F(Kindle.ERROR.SYNC_FAILED):F(Kindle.ERROR.SYNC_FAILED_OFFLINE)):a?v().getAllBooks().done(u):KindleMessageDialog.showError(Kindle.ERROR.LIBRARY_LOAD_FAILED,function(){p(Kindle.DB.NEVER)},ResourceBundle.getLocalizedString("k_dialog_message_retryButton_text"))}function p(a){var b=a===Kindle.DB.NEVER?null:a;KindleHostDeviceDetector.isOnline()?(M&&b!==null&&E.modifyMetricsMethod(M,"Library::OpenLibraryCached"),
ea.getOwnedContent(b,fa?"Customer":b?"KindleForegrounded":"Registration").then(function(a){ia.getBookDb()&&a.asinsToAdd&&!$.isEmptyObject(a.asinsToAdd)&&n(a.asinsToAdd);v().updateBookData(a.asinsToRemove,a.asinsToAdd,a.syncTime).then(t,q)},function(){o(b!==null)})):(M&&E.modifyMetricsMethod(M,"Library::OpenLibraryOffline"),o(b!==null))}function n(a){v().getCachedAsins(Kindle.BookInfo.CachedState.FULLY_DOWNLOADED,!0).then(function(b){if(b.length>0){var c={};b.forEach(function(b){if(a[b.asin]&&a[b.asin].contentType===
Kindle.CONTENT_TYPE.EBOK&&b.context.contentType===Kindle.CONTENT_TYPE.EBSP){var d=b.context;d.contentType=a[b.asin].contentType;c[b.asin]={cacheState:b.cacheState===Kindle.BookInfo.CachedState.PINNED?Kindle.BookInfo.CachedState.PINNING:Kindle.BookInfo.CachedState.PARTIAL,cachedSize:null,context:d}}});$.isEmptyObject(c)||ia.getBookDb().updateBookInfos(c)}},function(){})}function q(){KindleLibraryHeaderBar.setSyncButtonDisabled(!1)}function t(a){fa&&a===0?B():v().getAllBooks().done(function(b){var c=
[];b.forEach(function(a,b,d){if(a.title===void 0||a.authors===void 0)c.push({operation:Kindle.DB.DELETE_RECORD_OPERATION,tableName:"bookdata",params:[{asin:a.asin}]}),delete d[b]});c.length>0&&v().batchTransaction(c);u(b,a===0)})}function u(a,b){U&&y(U);v().getCachedAsins(Kindle.BookInfo.CachedState.FULLY_DOWNLOADED).then(function(c){a.length===0?KindleLibraryMessagePane.showEmptyLibraryMessage():(KindleLibraryMessagePane.hideEmptyLibraryMessage(),$.isEmptyObject(c)?KindleLibraryNoDownloadedMessage.show():
KindleLibraryNoDownloadedMessage.hide(),KindleLibraryScrollPane.updateCachedAsins(c),KindleLibraryContentList.handleBookData(a,b));B();M&&(E.increaseSubCounter(M,KindleLibrarySetting.getLastLayoutView(),1),E.increaseSubCounter(M,KindleLibrarySetting.getLastLibraryView(),1),E.increaseSubCounter(M,"bookCount",la.length),E.endMetrics(M),M=void 0)})}function G(a){if(a&&a.length>0)for(var b=0;b<a.length;b++)if(a[b].contentType==="EBOK")return!0;return!1}function x(a){a=!G(a);Kindle.URL.isJPDomain()&&a&&
KindleJPMerchandiseManager.getBookList().then(function(a){function b(a){W({asin:a,openInNewTab:!0,refTag:Kindle.RefTag.Values.StorePromoMangaJP});E.emitNow("Library::JPMerch::ClickBookCoverToStore")}function c(){E.emitNow("Library::JPMerch::Closed")}a&&a.length>3?(KindleLibraryJPMerchandiseDialog.open(a,b,c),E.emitNow("Library::JPMerch::Shown")):E.emitNow("Library::JPMerch::getCampaignEmpty");E.emitNow("Library::JPMerch::getCampaignSuccess")},function(){E.emitNow("Library::JPMerch::getCampaignFail")})}
function B(){fa=!1;U=void 0;KindleSpinner.hide();KindleLibraryHeaderBar.setSyncButtonDisabled(!1);ma&&(ma=!1,v().getAllBooks().done(x));Q.onLibraryLoaded();KindleLocalStorage.removeItem(Kindle.App.LIBRARY_FAIL_FLAG)}function D(){KindleLibraryMessagePane.initialize(function(a){$("#message_container").append(a)},function(){Kindle.URL.isJPDomain()?L.gotoURL("http://www.amazon.co.jp/gp/feature.html?docId=3077720936&ref_="+Kindle.RefTag.Values.StorePromoMangaJP,!0):W({isSourceEmptyLibBtn:!0})},Kindle.URL.isJPDomain())}
function w(a,b){function c(a,b){return s(a.asin,b)}function d(a){var b={asin:a.asin},c=E.startMetrics("Library::SaveBook",{breakdown:["Browser"]});v().getBookDataLastSyncTime(p);KindleOffline.pinBook(b,F).then(function(b,d){var e=["::"+b];b===Kindle.BookInfo.BookType.MOBI8&&(d?e.push("::mobi8::scrambled"):e.push("::mobi8::unscrambled"));E.endMetrics(c,e);y(a.asin)},function(){E.cancelMetrics(c)})}function e(a){KindleOffline.removeBook({asin:a.asin},function(){y(a.asin)},function(a){F(a===Kindle.ERROR.NETWORK?
Kindle.ERROR.REMOVE_NETWORK_FAILURE:Kindle.ERROR.REMOVE_FAILURE)})}function g(a){E.emit("Library::RemoveOwnershipDialog::Shown");(function(){var b=$.Deferred();KindleMessageDialog.open(ResourceBundle.getLocalizedString("k_L_dialog_delete_prompt_title"),ResourceBundle.getLocalizedString("k_L_dialog_delete_prompt",{bookTitle:a.title}),null,null,[{buttonText:ResourceBundle.getLocalizedString("k_L_dialog_delete_cancel"),callback:b.reject},{buttonText:ResourceBundle.getLocalizedString("k_L_dialog_delete"),
callback:b.resolve}]);return b.promise()})().done(function(){E.emit("Library::RemoveOwnershipDialog::Initiated");ea.removeOwnership(a.asin,a.contentType).done(function(){var b=[];b.push({asin:a.asin});v().updateBookData(b,[]).done(t)}).fail(function(){F(Kindle.ERROR.REVOKE_FAILED)})}).fail(function(){E.emit("Library::RemoveOwnershipDialog::Cancelled")})}U||v().getBookCachedState(a.asin).done(function(f){var j=KindleOffline.isEnabled()?KindlePopupMenu.ITEM_ENABLED:KindlePopupMenu.ITEM_DISABLED,h=KindlePopupMenu.ITEM_ENABLED,
k=KindlePopupMenu.ITEM_HIDDEN,j=KindleHostDeviceDetector.isOnline()?j:KindlePopupMenu.ITEM_DISABLED,l=Kindle.CONTENT_TYPE.EBSP===a.contentType,n="unknown";if(f&&f.length>0)n=f[0].cacheState;switch(n){case Kindle.BookInfo.CachedState.PINNED:f=[h,k,j,k,l?h:k];break;case Kindle.BookInfo.CachedState.CACHED:f=[h,j,j,k,l?h:k];break;default:f=[h,k,k,j,l?h:k]}KindleLibraryContextMenu.show(a,f,b,[c,d,e,d,g])})}function A(a,b,c){J||(c>=a?$("#slide_container").removeClass("scrollbar_shown"):($("#slide_container").addClass("scrollbar_shown"),
KindleLibraryScrollBar.updateValueRange(a,b,c)))}function z(a){KindleLibraryScrollBar.updateValue(a)}function H(){KindleLibrarySettingsMenu.show(Q.openExternalLink)}function C(){var a,b,c=KindleLibraryHeaderBar,d={},e={};d[c.EVENT_NOTEBOOK_CLICKED]=k;d[c.EVENT_SYNC_CLICKED]=j;d[c.EVENT_MANAGE_CLICKED]=H;d[c.EVENT_STORE_CLICKED]=function(){W({})};e[c.SEARCH_CALLBACK.ENABLE]=function(){a=!KindleHostDeviceDetector.isOnline()?"downloaded":"cloud";KindleLibraryControlBar.hideViewTabs();b=KindleLibraryScrollPane.setView(a)};
e[c.SEARCH_CALLBACK.SEARCH]=KindleUtils.debounce(function(b){KindleLibraryContentList.setSearchString(b);KindleLibraryScrollPane.setView(a)},200);e[c.SEARCH_CALLBACK.DISABLE]=function(){KindleLibraryMessagePane.hideEmptySearchMessage();KindleLibraryContentList.setSearchString(null);KindleLibraryScrollPane.setView(b);KindleLibraryControlBar.showViewTabs()};c.initialize(function(a){$("body").append(a);na.resolve()},d,e)}function I(){var a=KindleLibraryControlBar;a.setRetryCallback(R);a.setAppCacheStatusGetter(L.getSharedModuleSync(Kindle.MODULE.APPCACHE_EVENTHANDLER).getCacheStatus);
var b={};b[a.EVENT_LIBRARY_SORT_CLICKED]=ha;b[a.EVENT_LIBRARY_LAYOUT_CLICKED]=ca;b[a.EVENT_LIBRARY_IMAGE_CHANGING]=N;b[a.EVENT_LIBRARY_IMAGE_CHANGED]=O;b[a.EVENT_LIBRARY_VIEW_CLICKED]=T;a.initialize(function(a){$("#page_body_content_containers").prepend(a)},KindleLibrarySetting.getSettings(),b)}function P(){KindleLibraryScrollBar.initialize(function(a){$("#slide_container").append(a)},K)}function K(a,b){KindleLibraryScrollPane.setScrollValue(a,b)}function N(a,b){KindleLibraryScrollPane.updateCoverSize(b.value,
!1)}function O(a,b){var c=b.value;KindleLibrarySetting.setCoverSize(c);KindleLibraryScrollPane.updateCoverSize(c,!0)}function y(a){v().getBookCachedState(a).done(function(b){KindleLibraryScrollPane.updateBookCacheState(a,b.length>0?b[0].cacheState:"");KindleLibraryScrollPane.checkForBadgeUpdates();v().getCachedAsins(Kindle.BookInfo.CachedState.FULLY_DOWNLOADED).then(function(a){$.isEmptyObject(a)?KindleLibraryNoDownloadedMessage.show():KindleLibraryNoDownloadedMessage.hide()})})}function T(a){function b(){KindleLibraryScrollPane.setView(a);
KindleLibrarySetting.setLibraryView(a);KindleLibraryControlBar.setViewState(a)}a!==KindleLibrarySetting.getLastLibraryView()&&(!KindleHostDeviceDetector.isOnline()&&a==="cloud"?F(Kindle.ERROR.BOOK_NOT_AVAILABLE):a==="downloaded"&&!KindleOffline.isEnabled()?KindleHostDeviceDetector.isFirefox()?KindleOffline.enableOfflineMessage().done(b):KindleOffline.firstRunMessage().done(b):b())}function W(a){KindleSpinner.show();e();Q.openStore(a)}function s(a,b){a!==null&&!S&&(V=b,KindleHostDeviceDetector.isOnline()?
Z(a):v().getBookCachedState(a).done(function(b){b.length>0&&Kindle.BookInfo.CachedState.isMaybeDownloaded(b[0].cacheState)?Z(a):(E.emit("Library::OpenBookNotAvailable"),F(Kindle.ERROR.BOOK_NOT_AVAILABLE),V&&V())}))}function v(){return ia.getAppDb()}function Z(a){oa=U=a;Q.openBook({asin:a})}function aa(){KindleLibraryHeaderBar.deactivateSearch(!0);KindleDeviceCapabilities.hasSplitView()&&KindleWindowSizeWatcher.stopPolling();V&&V()}function Y(){KindleTouchEventsToggler.isRequired()&&KindleTouchEventsToggler.allowTouchEvents();
X&&(da(),X=!1);a();S=!1}function da(){KindleLibraryScrollPane.resizeScrollPane();if(KindleDeviceCapabilities.hasSplitView())KindleWindowSizeWatcher.onWindowResized()}function F(a,b){a===Kindle.ERROR.FREE_TRIAL_EXPIRED?ga():a===Kindle.ERROR.CONTENT_RENTAL_EXPIRED?ka():a===Kindle.ERROR.CONTENT_UNSUPPORTED?KindleUnsupportedContentDialog.open():(b&&(a={name:a,code:b}),KindleMessageDialog.showError(a))}function ba(a,b,c){a?(S=!0,KindleSpinner.hide(),KindleTouchEventsToggler.isRequired()&&KindleTouchEventsToggler.disallowTouchEvents(),
setTimeout(aa,500)):(F(b,c),V&&V(),Y())}function ha(){var a;a=KindleHostDeviceDetector.isiOS()?"up":"down";KindleLibrarySortMenu.show(a,function(a){if(a!==KindleLibrarySetting.getLastSortParam())document.getElementById("kindleLibrary_button_sort_label").innerHTML=ResourceBundle.getLocalizedString(KindleLibrarySort.getLabel(a)),KindleLibraryContentList.sort(a)})}function ca(a){KindleLibraryScrollPane.setLayout(a);KindleLibrarySetting.setLayoutView(a)}function R(){E.emit("KindleApp:AppCacheError:RetryClicked",
{breakdown:["Browser"]});KindleLibraryAppCacheFailDialog.hasBeenShownThisSession()?(KindleLibraryAppCacheFailDialog.open(),E.emit("KindleApp:AppCacheError:RetryClickedAfterRebootDialogShown",{breakdown:["Browser"]})):Kindle.top.location.reload(!1)}function ka(){var a=!0;E.emit("Library::Rentals:ExpiredDialogShown");var b=function(){var b=U;return function(){a&&(a=!1,E.emit("Library::Rentals:BuyOrRentAgainClicked"));if(b!==void 0){var c="https://www.amazon.com/dp/"+b+"/ref=kcr_store_expired";KindleHostDeviceDetector.isiPad()?
(c+="_ipad",Q.openExternalLink(c)):(c+="_desktop",Kindle.top.location=c)}else KindleDebug.error("no asin selected for BuyOrRentAgainClicked")}}();KindleMessageDialog.showError(Kindle.ERROR.CONTENT_RENTAL_EXPIRED,function(){a&&(a=!1,E.emit("Library::Rentals:DismissClicked"))},ResourceBundle.getLocalizedString("k_dialog_rental_expired_dismiss_button_text"),[{buttonText:ResourceBundle.getLocalizedString("k_common_cancel_button")},{buttonText:ResourceBundle.getLocalizedString("k_dialog_rental_expired_extend_button_text"),
callback:b}])}function ga(){KindleLibraryScrollPane.checkForBadgeUpdates();KindleMessageDialog.showError(Kindle.ERROR.FREE_TRIAL_EXPIRED,null,ResourceBundle.getLocalizedString("k_endOfFreeTrial_Text"),[{buttonText:ResourceBundle.getLocalizedString("k_common_cancel_button")},{buttonText:ResourceBundle.getLocalizedString("k_endOfFreeTrial_buyfullversion_button"),callback:function(){var a="https://www.amazon.com/dp/"+oa+"/ref=kcr_freetrial_expired";KindleHostDeviceDetector.isiPad()?(a+="_ipad",Q.openExternalLink(a)):
(a+="_desktop",Kindle.top.location=a)}}])}var la=[],S=!1,U,J,M,V,X=!1,ia=null,L,Q,E,ea,fa=!1,ma=!0,na,oa;return{initialize:function(){na||(na=jQuery.Deferred());L=window.parent.KindleApp;KindleTouchEventsToggler.isRequired()&&KindleTouchEventsToggler.initialize();L&&($("body").bind("touchmove.elastic",KindleIOSScrollStopper.stopScroll),Q=L.getAppInterfaceForLibrary(),Kindle=L.getSharedModuleSync(KindleModuleManager.CONSTANTS),ResourceBundle=L.getSharedModuleSync(KindleModuleManager.RESOURCE_BUNDLE),
KindleTemplateManager.initialize(),L.setLibraryInterface({onReaderOpenStatus:ba,onReaderClose:Y,onStoreOpenStatus:d,libraryUpdateNeeded:a,onShowLibrary:h}),L.registerEventCallback(Kindle.APP_CACHE.CACHE_PROGRESS,function(a){KindleLibraryControlBar.setCacheProgress(a.progressRatio)}),L.registerEventCallback(Kindle.APP_CACHE.CACHE_CACHED,f),L.registerEventCallback(Kindle.APP_CACHE.CACHE_DONE,f),L.registerEventCallback(Kindle.APP_CACHE.CACHE_NEEDS_RETRY,function(){KindleLibraryControlBar.setCacheNeedsRetry()}),
L.registerEventCallback(Kindle.APP_CACHE.CACHE_NEEDS_BROWSER_RESTART,function(){KindleLibraryControlBar.setCacheNeedsRetry()}),L.registerEventCallback(Kindle.APP_CACHE.CACHE_NEEDS_BROWSER_RESTART,function(){KindleLibraryAppCacheFailDialog.open()}),L.getSharedModules().done(function(a){KindleModuleManager.registerModuleList(a);KindleOffline.isFirstTime()&&!L.getQueryParams().asin&&KindleDeviceCapabilities.showFirstRunDialog()&&KindleOffline.firstRunMessage();!KindleOffline.isFirstTime()&&!KindleLocalStorage.getItem("haveDB")&&
KindleHostDeviceDetector.isFirefox()&&KindleOffline.enableOfflineMessage();E=a[KindleModuleManager.METRICS_MANAGER];ia=a[KindleModuleManager.DB_CLIENT];ea=a[KindleModuleManager.SERVICE_CLIENT];c()}),KindleHostDeviceDetector.isIE()&&document.body.addEventListener("MSHoldVisual",function(a){a.preventDefault()},!1),$("body").bind("contextmenu",function(a){a.preventDefault()}),Q&&Q.getQueryParameters())},registerControlHotkey:function(a,b,c){$(document).keydown(function(d){if(d.keyCode===a.charCodeAt(0)&&
(d.ctrlKey||d.metaKey)&&!d.shiftKey)return d.preventDefault(),b.apply(this,c),!1})},register:function(a,b){return Q.register(a,b)},deregister:function(a,b){return Q.deregister(a,b)},onStoreLinkClicked:function(a){var b={};b[a]=!0;W(b);KindleNotificationDialog.hide();return!1}}}(),KindleX=KindleLibrary,KindleLibraryBookCover=function(){function f(){a||(a=KindleHostDeviceDetector.isiPad()?b:c);return a}function h(a){g||(g=e,g=g.replace("{width}",f().width),g=g.replace("{height}",f().height));var b=
g;return b=b.replace("{asin}",a)}function d(a){var b=$.Deferred(),c=new XMLHttpRequest;c.open("GET",a);c.responseType="arraybuffer";c.onload=function(){var a=c.response,d,e;if(a){if(KindleHostDeviceDetector.hasArrayLikeApply())try{d=[],e=new Uint8Array(a),d.push(String.fromCharCode.apply(null,e))}catch(g){d=null}if(!d){d=[];e=new Uint8Array(a);for(a=0;a<e.length;a++)d.push(String.fromCharCode(e[a]))}d="data:image/jpeg;base64,"+KindleO_Aaa.o_aaa(d.join(""));b.resolve(d)}else b.reject()};c.onerror=
function(){b.reject(c)};c.send();return b.promise()}var e="https://images-na.ssl-images-amazon.com/images/P/{asin}.01._SX{width}_SY{height}_TTXW_SCLZZZZZZZ_.jpg",c={width:255,height:255},b={width:255,height:255},g=null,a=null;return{getBookCoverUrl:h,getOfflineCover:function(a){a=h(a);return KindleHostDeviceDetector.isMSEdge()?KindleImageUtil.getDataUriFromImage(a,"image/jpeg"):d(a)}}}(),KindleLibraryContentList=function(){var f=function(){var d=[],c=[];return{addChangeListener:function(b){c.push(b)},
handleBookData:function(b,g){d=b;c.forEach(function(a){a(d,g)})}}}(),h=function(){function d(a,e,f){var h=c[0];c=a;KindleLibrarySort.sortBookList(c,f);a=c[0];(e||f!==g||h&&a&&h.asin!==a.asin)&&b.forEach(function(a){a(c)});g=f}var c=[],b=[],g;f.addChangeListener(function(a,b){var c=KindleLibrarySetting.getLastSortParam();d(a,b,c)});return{addChangeListener:function(a){b.push(a)},sort:function(a){KindleLibrarySetting.setSortParam(a);d(c,!1,a)}}}(),d=function(){function d(c,e){var f;e?(f=KindleLibrarySearch.doLibrarySearch(e,
c),b=f.set):b=c;g=e;a.forEach(function(a){a(b,e)})}var c=[],b=[],g,a=[];h.addChangeListener(function(a){c=a;d(c,g)});return{addChangeListener:function(b){a.push(b)},setSearchString:function(a){var f;typeof a==="string"||a instanceof String?(a=a.replace(RegExp("[.\\\\+*?\\[\\^\\]$(){}=!<>|:\\-]","g"),"\\$&"),a=$.trim(a)):a="";if(!g||!(g.source&&a===g.source)){if(a)f=RegExp(a,"gi"),a=b&&g&&g.source&&a.search(g)===0?b:c;else{if(b===c)return;g=f=null;a=c}d(a,f)}}}}();return{addChangeListener:d.addChangeListener,
handleBookData:function(d,c){f.handleBookData(d,c)},sort:function(d){h.sort(d)},setSearchString:function(e){d.setSearchString(e)}}}(),KindleLibraryScroller=function(){function f(f,d){var e=new iScroll(f,d),c=e._momentum;e._momentum=function(b,d,a,e,f){b=b===0?0:Math.max(25,Math.abs(b))*(b<0?-1:1);return c(b,d,a,e,f)};return e}return{createScrollerObject:function(h,d){return new f(h,d)}}}(),KindleLibraryScrollPane=function(){function f(){var a=document.styleSheets[2].cssRules;if(a===void 0)a=document.styleSheets[2].rules;
y={};for(var b=0;b<a.length;b++){var c=a[b];if(c.selectorText===".grid_container .book_container")y.grid_style_container=c;if(c.selectorText===".grid_container .book_cover")y.grid_style_bookCover=c;if(c.selectorText===".grid_container .book_is_pinned")y.grid_style_pinned=c;if(c.selectorText===".grid_container .book_sample_badge")y.grid_style_sample_font=c}}function h(){for(var a=0;a<X;a++){var b=J[a],c=U[M+a],d=S[c].find(".book_image");b.height>1&&b.width>1?(d.attr("src",b.src),b.width>b.height&&
(d.removeClass("book_image").addClass("book_image_wide"),S[c].find(".book_image_container").length===1&&KindleBadging.adjustBadge(S[c]))):(d.attr("src",D),W&&(b=S[c].find(".book_title").text(),S[c].find(".alt_title").text(b).show()),ma.emit("Library::UsedBlankCoverImageFallback"))}M+=X;M>=U.length-1?(J=[],U=[],M=0):g();k()}function d(a){var b=M+X-1;a>=M&&a<=b&&(V++,V===X&&(clearTimeout(ia),h()))}function e(a){return function(){d(a)}}function c(a){return function(){ma.emit("Library::ErrorLoadingCoverImage");
d(a)}}function b(){h()}function g(){V=0;ia=setTimeout(b,K);X=Math.min(C,U.length-M);for(var a=0;a<X;a++){var d=M+a,g=U[d];J[a]||(J[a]=new Image);J[a].onload=e(d);J[a].onerror=c(d);J[a].src=la[g]||KindleLibraryBookCover.getBookCoverUrl(g)}}function a(a,b){function c(){var d=a.find(".book_image, .book_image_wide");!ha&&!KindleLibraryContextMenu.isVisible()&&(ha=!0,d.addClass("opening"),ca(b.asin,function(){d.removeClass("opening");ha=!1}))}var d=a.find("."+H);d.click(c).tap(c);var e=a.find(".book_image, .book_image_wide");
W?(a.tapHold(function(a){R(b,[a.x,a.y-100]);s._unbind("touchmove");s._unbind("touchend");s._unbind("touchcancel")}),d.activate(function(){e.addClass("opening");setTimeout(function(){e.removeClass("opening")},P)})):(d.bind("contextmenu",function(a){L&&clearTimeout(L);R(b,[a.pageX,a.pageY]);a.preventDefault()}),d.mousedown(function(a){e.addClass("held");if(!L)Q.x=a.pageX,Q.y=a.pageY,L=setTimeout(function(){R(b,[Q.x,Q.y]);clearTimeout(L);L=null},I)}),d.mouseup(function(){clearTimeout(L);e.removeClass("held");
L=null;return!0}),d.mouseout(function(){clearTimeout(L);e.removeClass("held");L=null;return!1}),d.mousemove(function(a){Q.x=a.pageX;Q.y=a.pageY}));return a}function j(a,b){var c=S[a];if(c)switch(c.removeClass("book_is_pinned book_is_cached"),b){case Kindle.BookInfo.CachedState.PINNED:c.addClass("book_is_pinned");break;case Kindle.BookInfo.CachedState.CACHED:c.addClass("book_is_cached")}}function k(){(KindleHostDeviceDetector.isFirefox()||KindleHostDeviceDetector.isIE())&&N==="grid"?$(".book_image_container ."+
z).each(function(){var a=this.nextElementSibling;this.parentElement.style.width=$(a).hasClass("book_image_wide")?"auto":a.clientWidth+"px"}):KindleHostDeviceDetector.isiOS()&&$(".book_image_container ."+z).each(function(){var a=this.nextElementSibling;a.style.display="block";setTimeout(function(){a.style.display="inline-block"},0)})}function m(){KindleHostDeviceDetector.isFirefox()&&$(".book_image_container ."+z).each(function(){this.parentElement.style.width="auto"})}function l(){v=q*O;y.grid_style_container.style.height=
v+t+"px";y.grid_style_bookCover.style.width=v+"px";y.grid_style_bookCover.style.height=v+"px";y.grid_style_pinned.style.backgroundPosition="center "+(v+3)+"px";y.grid_style_sample_font.style.fontSize=O*x+"px";y.grid_style_sample_font.style.lineHeight=v*0.13+"px"}function r(a,b){var c=-b*B;Z&&(c=F.scrollTop()+c,c=Math.min(c,Z-F.height()),c=Math.max(c,0),p(c,!0),ga(c))}function o(){W?s?s.refresh():s=KindleLibraryScroller.createScrollerObject("titles_container",{hScroll:!1,lockDirection:!1,hScrollbar:!1,
vScrollbar:!1}):(N==="grid"?(aa=v+t,Y=Math.floor(F.width()/(v+u)),y.grid_style_container.style.width=100/Y+"%"):(aa=G,Y=1),p(Math.floor(da/Y)*aa,!1),Z=F[0].scrollHeight,ka(Z,F.scrollTop(),F.height()));$("#"+A).find(".book_image_container").each(function(){$(this).find(".book_image_wide").length===1&&$(this).addClass("wide");this.style.display="block";this.clientWidth=this.clientWidth;this.style.display="inline-block"});$("#"+A).css("font-size",v+"px");k()}function p(a,b){F.scrollTop(a);b&&(da=Math.round(a/
aa)*Y)}function n(a){KindleHostDeviceDetector.isIE()&&a.addClass("ie_scrollable")}var q=21.25,t=100,u=20,G=86,x=1.3,B=75,D="./images/override/library/blank_cover.png",w="book_highlightsearch",A="titles_inner_wrapper",z="book_sample_badge",H="book_click_area",C=30,I=1E3,P=500,K=6E4,N,O,y,T,W,s,v,Z,aa,Y,da=0,F,ba,ha,ca,R,ka,ga,la,S={},U=[],J=[],M=0,V=0,X=0,ia,L=null,Q={x:0,y:0},E=null,ea=null,fa,ma;return{initialize:function(a,b,c,d,e){var g=$.Deferred(),j=$.Deferred();N=a.layoutState;O=a.coverSize;
W=KindleHostDeviceDetector.isiOS();ha=!1;ca=b;R=c;ka=d;ga=e;F=$("#titles_container");ba=$("#slide_container");ma=KindleModuleManager.getModuleSync([KindleModuleManager.METRICS_MANAGER]);f();ba.mousewheel(r);n(F);W||l();a=KindleModuleManager.getModuleSync(KindleModuleManager.DB_CLIENT).getAppDb().getCachedCovers();a.then(function(a){la=a});KindleModuleManager.getModuleSync(KindleModuleManager.DB_CLIENT).getAppDb().getAllBooks().done(function(a){fa=a});KindleUXComponentManager.initializeTemplate("KindleLibraryBookContainer",
j.resolve);$.when(a,j).then(g.resolve);return g.promise()},updateCoverSize:function(a,b){!W&&!b&&(O=a,l(),o())},setLayout:function(a){N=a;ba.removeClass("grid_container list_container").addClass(a+"_container");a==="list"&&m();o()},setView:function(a){var b=ba.hasClass("download_view")?"downloaded":"cloud";a==="downloaded"?ba.addClass("download_view"):ba.removeClass("download_view");o();return b},setScrollValue:p,updateBookCacheState:j,updateCachedAsins:function(a){T={};a.forEach(function(a){T[a.asin]=
a.cacheState;j(a.asin,a.cacheState)})},resizeScrollPane:function(){o()},displayBooks:function(b,c){function d(a,b){var c=[],e=[],g={};if(c=b.match(a)){for(var f=c.length,j=0;j<f;j++)g[c[j]]=c[j];for(j in g)e.push(RegExp(g[j],"g"));return e.sort().reverse()}else return e}function e(a,b){for(var c=a,d=b.length,g=0;g<d;g++)c=c.replace(b[g],'<span class="'+w+'">'+b[g].source+"</span>");return c}s&&(s.destroy(),s=null);var f=0,h=KindleHostDeviceDetector.isOnline(),k=$("#"+A),l=!c||c.source==="(?:)"||!c.source;
k.empty();var m=document.createDocumentFragment();b.forEach(function(b){var g,k,n;(h||T[b.asin])&&f++;if(S[b.asin])g=S[b.asin];else{g=KindleUXComponentManager.renderTemplate("KindleLibraryBookContainer",{asin:b.asin,title:b.title,author:KindleAuthor.getDisplayableString(b.authors),src:"./images/override/library/img_alt_cover.png"});if(b.contentType===Kindle.CONTENT_TYPE.EBSP){k=g;n=ResourceBundle.getLocalizedString("k_L_sample_badge_text");var o="<div class='"+z+" "+H+"'>"+n+"</div>";E=E===null?KindleBadging.createCanvasElement():
KindleBadging.cloneCanvasForBadge(E);k.addClass("sample");KindleBadging.drawBadge(E,n,"#333333");KindleBadging.addBadgeToBookContainer(o,E,k)}else{a:{k=b.asin;n=JSON.parse(KindleLocalStorage.getItem("listOfAsinsForBadging"));for(o in n)if(n[o]===k){k=!0;break a}k=!1}k&&(k=g,n=ResourceBundle.getLocalizedString("k_L_trial_badge_text"),o="<div class='book_trial_badge "+H+"'>"+n+"</div>",ea=ea===null?KindleBadging.createCanvasElement():KindleBadging.cloneCanvasForBadge(ea),k.addClass("trial"),KindleBadging.drawBadge(ea,
n,"#333333"),KindleBadging.addBadgeToBookContainer(o,ea,k))}g=a(g,b);S[b.asin]=g;U.push(b.asin);j(b.asin,T[b.asin])}b.contentType===Kindle.CONTENT_TYPE.EBOK&&g.find("."+z).remove();l||(g=g.clone(),k=d(c,b.title),k=e(b.title,k),n=d(c,b.displayableAuthorsString),n=e(b.displayableAuthorsString,n),g.find(".book_title").html(k),g.find(".book_author").html(n));g=a(g,b);m.appendChild(g[0])});k.append(m);g();n(k);o();return f},checkForBadgeUpdates:function(){var b,c=JSON.parse(KindleLocalStorage.getItem("listOfAsinsForBadging")),
d;for(d in c)if(b=$("#"+c[d]),b.find(".canvas_for_badge").length===0){var e=b,g="book_image",f=document.createElement("div");f.className="book_image_container";var j=KindleBadging.createCanvasElement();KindleBadging.drawBadge(j,ResourceBundle.getLocalizedString("k_L_trial_badge_text"),"#333333");e.find("."+H).hasClass("book_image_wide")&&(g="book_image_wide");e.find(".book_cover").append(f);g=e.find("."+g).remove();e.find(".book_image_container").append(g);$(j).removeClass("canvas_for_badge");f.appendChild($("<div>",
{className:"book_badge_container canvas_for_badge"}).appendChild(j));e.find("."+H).hasClass("book_image_wide")&&KindleBadging.adjustBadge(e);e.find(".canvas_for_badge").addClass(H);e=b;f=ResourceBundle.getLocalizedString("k_L_trial_badge_text");f="<div class='book_trial_badge "+H+"'>"+f+"</div>";e.addClass("trial");e.find(".book_details").append(f);S[c[d]]=b;var h,k;for(k in fa)if(b[0].id===fa[k].asin){h=fa[k];break}a(b,h)}}}}(),KindleLibrarySearch=function(){return{doLibrarySearch:function(f,h){var d=
[],e=-1,c=-1,b=-1,g,a=0,j;for(j in h){g=h[j];if(!g.displayableAuthorsString)g.displayableAuthorsString=KindleAuthor.getDisplayableString(g.authors);f.source?(b=g.asin.toLowerCase()===f.source.toLowerCase()?1:-1,e=g.title.search(f),c=g.displayableAuthorsString.search(f)):e=0;e!==-1||c!==-1||b!==-1?(g.hidden=!1,d[a]=g,a++):g.hidden=!0}return{set:d,queryPattern:f}}}}(),KindleLibrarySetting=function(){function f(a){a in p||(p[a]=KindleLocalStorage.getItem(a));return p[a]}function h(a,b){p[a]=b;return KindleLocalStorage.setItem(a,
b)}function d(){return f(m)}function e(a){h(m,a)}function c(){return f(r)}function b(a){h(r,a)}function g(){return f(o)}function a(a){h(o,a)}function j(){return f(l)}function k(a){h(l,a)}var m="last_layout_view",l="last_opened_view",r="last_sort_param",o="last_cover_size",p={};return{initialize:function(){var f=d(),h=c(),l=g(),m=j();f||e("grid");h||b("recent");l||a(9);KindleHostDeviceDetector.isOnline()?m||k("cloud"):k("downloaded")},getLastLayoutView:d,setLayoutView:e,getLastSortParam:c,setSortParam:b,
getLastCoverSize:g,setCoverSize:a,getLastLibraryView:j,setLibraryView:k,getSettings:function(){var a={};a.layoutState=d();a.viewState=j();a.coverSize=g();a.sortParam=c();return a}}}(),KindleLibrarySort=function(){function f(c,b){if(!c.sortTitle){if(c.lastReadTime===void 0)c.lastReadTime=-1;var d=c.titlePronunciation;d&&d!=="null"?d=KindleStringUtilities.replaceAccentedChars(d,"ja"):(d=c.title,d=KindleDeviceCapabilities.useLocaleCompare()?KindleStringUtilities.removeQuotes(d):KindleStringUtilities.replaceAccentedChars(d,
b));d=d.trim();d=d.toLowerCase();a:for(var a=ResourceBundle.getLocalizedArticles(),e,f=0;f<a.length;f++)if(e=a[f],d.indexOf(e)===0){d=d.substring(e.length);break a}c.sortTitle=d;c.sortAuthors=[];for(e=0;e<c.authors.length;e++)d=c.authors[e],(a=c.authorPronunciations&&c.authorPronunciations[d])?a=KindleStringUtilities.replaceAccentedChars(a,"ja"):(a=d,a=KindleDeviceCapabilities.useLocaleCompare()?KindleStringUtilities.removeQuotes(a):KindleStringUtilities.replaceAccentedChars(a,b,!0)),a=a.trim(),a=
a.toLowerCase(),c.sortAuthors[e]=a}}function h(c,b,d){d=typeof d==="undefined"?ResourceBundle.getLanguage():d;return KindleDeviceCapabilities.useLocaleCompare()?c.sortTitle.localeCompare(b.sortTitle,d):c.sortTitle<b.sortTitle?-1:c.sortTitle>b.sortTitle?1:0}function d(c,b){var d=(b.lastTimeRead>0?b.lastTimeRead:b.purchaseDate)-(c.lastTimeRead>0?c.lastTimeRead:c.purchaseDate);return d===0?h(c,b):d}function e(c,b,d){var d=typeof d==="undefined"?ResourceBundle.getLanguage():d,a=0,e,f,m;for(e=0;e<c.authors.length&&
e<b.authors.length&&a===0;e++)f=c.sortAuthors[e],m=b.sortAuthors[e],KindleDeviceCapabilities.useLocaleCompare()?a=f.localeCompare(m,d):f<m?a=-1:f>m&&(a=1);a===0&&(a=c.authors.length-b.authors.length);return a===0?h(c,b):a}return{SORT_BY_AUTHOR:"author",SORT_BY_TITLE:"title",SORT_BY_RECENT:"recent",SORT_BY_AUTHOR_LABEL:"k_L_sort_author_label",SORT_BY_TITLE_LABEL:"k_L_sort_title_label",SORT_BY_RECENT_LABEL:"k_L_sort_recent_label",sortBookList:function(c,b,g){var g=typeof g==="undefined"?ResourceBundle.getLanguage():
g,a;for(a in c)f(c[a],g);switch(b){case "title":c.sort(function(a,b){return h(a,b,g)});break;case "author":c.sort(function(a,b){return e(a,b,g)});break;case "recent":c.sort(d);break;default:KindleDebug.error("Trying to sort by invalid type "+b)}},compareBooks:function(c,b,f){var a;switch(f){case "recent":a=d(c,b);break;case "title":a=h(c,b);break;case "author":a=e(c,b);break;default:KindleDebug.error("Trying to compare by invalid type "+f)}return a},getLabel:function(c){switch(c){case "title":return"k_L_sort_title_label";
case "author":return"k_L_sort_author_label";case "recent":return"k_L_sort_recent_label";default:return"Invalid Sort Type"}}}}(),KindleCrypto=function(){return{decrypt:function(f,h,d){h=CryptoJS.enc.Base64.parse(h);d=CryptoJS.enc.Base64.parse(d);f=new Uint8Array(f);f=CryptoJS.lib.WordArray.create(f);f=CryptoJS.lib.CipherParams.create({ciphertext:f,algorithm:CryptoJS.algo.AES,mode:CryptoJS.mode.CBC,padding:CryptoJS.pad.PKCS5});return function(d){for(var c=d.words,b=d.sigBytes,f=new Uint8Array(b),a=
0;a<b;a++)d=c[a>>>2]>>>24-a%4*8&255,f[a]=d;return f}(CryptoJS.AES.decrypt(f,h,{iv:d}))}}}(),KindleZip=function(){if(zip.workerScriptsPath==="")zip.workerScriptsPath="./js/Worker/";zip.useWebWorkers=KindleHostDeviceDetector.areWebWorkersSupported()&&!KindleHostDeviceDetector.isiOS();if(!ArrayBuffer.prototype.slice)ArrayBuffer.prototype.slice=function(f,h){for(var d=new Uint8Array(this),f=f===void 0?0:f,h=h===void 0?d.length:h,e=new ArrayBuffer(h-f),c=new Uint8Array(e),b=0;b<c.length;b++)c[b]=d[b+f];
return e};return{unzip:function(f){var h=$.Deferred(),d=[],f=new zip.ArrayBufferReader(f);zip.createReader(f,function(e){e.getEntries(function(c){function b(a){return function(b){f++;d.push({filename:c[a].filename,data:b});f===c.length&&e.close(function(){h.resolve(d)})}}for(var f=0,a=0;a<c.length;a++)c[a].getData(new zip.ArrayBufferWriter,b(a))})},function(d){KindleDebug.error("createReader failed when trying to unzip: "+d);h.reject(d)});return h.promise()}}}(),KindleErrorMap=function(){var f,h;
return{getErrorText:function(d){if(!f){var e=KindleModuleManager.getModuleSync(KindleModuleManager.LINK_URLS);f={};f[Kindle.ERROR.OUT_OF_SPACE]={title:"k_L_saveBookOutOfSpace_Title",text:"k_L_saveBookOutOfSpace_Text",textParams:{linkStart:"<a href='"+e.getIncreaseOfflineStorageUrl()+"' target='_blank'>",linkEnd:"</a>"}};f[Kindle.ERROR.TIMEOUT]={title:"k_L_openBookTimeoutError_Title",text:"k_L_openBookTimeoutError_Text"};f[Kindle.ERROR.LOAD_FAILURE]={title:"k_L_openBookLoadFailure_Title",text:"k_L_openBookLoadFailure_Text"};
f[Kindle.ERROR.REMOVE_FAILURE]={title:"k_L_removeBookError_Title",text:"k_L_removeBookError_Text"};f[Kindle.ERROR.REMOVE_NETWORK_FAILURE]={title:"k_L_removeBookNetworkError_Title",text:"k_L_removeBookNetworkError_Text"};f[Kindle.ERROR.CONTENT_LOANED]={title:"k_L_openBookContentLoanedError_Title",text:"k_L_openBookContentLoanedError_Text"};f[Kindle.ERROR.CONTENT_LOAN_ENDED]={title:"k_L_openBookContentLoanEndedError_Title",text:"k_L_openBookContentLoanEndedError_Text"};f[Kindle.ERROR.CONTENT_LICENSE_EXCEEDED]=
{title:"k_L_openBookContentLicenseExceededError_Title",text:"k_L_openBookContentLicenseExceededError_Text"};f[Kindle.ERROR.CONTENT_UNSUPPORTED]={title:"k_L_openBookContentUnsupportedError_Title",text:"k_L_openBookContentUnsupportedError_Text"};f[Kindle.ERROR.CONTENT_UNSUPPORTED_METRO]={title:"k_L_openBookContentUnsupportedErrorMetro_Title",text:"k_L_openBookContentUnsupportedErrorMetro_Text"};f[Kindle.ERROR.CONTENT_RENTAL_EXPIRED]={title:"k_L_openBookContentRentalExpiredError_Title",text:"k_L_openBookContentRentalExpiredError_Text"};
f[Kindle.ERROR.CONTENT_RENTAL_EXPIRED_METRO]={title:"k_L_openBookContentRentalExpiredErrorMetro_Title",text:"k_L_openBookContentRentalExpiredErrorMetro_Text",textParams:{link:"<a href='http://kindle.amazon.com/' target='_blank'>http://kindle.amazon.com/</a>"}};f[Kindle.ERROR.OPEN_BOOK_ASIN_NOT_SPECIFIED]={title:"k_L_openBookAsinNotSpecified_Title",text:"k_L_openBookAsinNotSpecified_Text"};f[Kindle.ERROR.GEOLOCATION_NOT_ALLOWED]={title:"k_L_openBookGeoLocationNotAllowed_Title",text:"k_L_openBookGeoLocationNotAllowed_Text"};
f[Kindle.ERROR.FREE_TRIAL_EXPIRED]={title:"k_endOfFreeTrial_Title",text:"k_endOfFreeTrial_Text"};f[Kindle.ERROR.CONTENT_UPGRADE]={title:"k_L_openBookContentUpgrade_Title",text:"k_L_openBookContentUpgrade_Text"};f[Kindle.ERROR.SESSION_LIMIT_EXCEEDED]={title:"k_L_openBookSessionLimitExceededError_Title",text:"k_L_openBookSessionLimitExceededError_Text"};f[Kindle.ERROR.BOOK_NOT_AVAILABLE]={title:"k_L_bookNotAvailable_Title",text:"k_L_bookNotAvailable_Text"};f[Kindle.ERROR.REVOKE_FAILED]={title:"k_L_revokeFailed_Title",
text:"k_L_revokeFailed_Text"};f[Kindle.ERROR.STORE_NOT_AVAILABLE]={title:"k_L_storeNotAvailable_Title",text:"k_L_storeNotAvailable_Text"};f[Kindle.ERROR.STORE_OPEN_FAILED]={title:"k_store_open_failed_Error_Title",text:"k_store_open_failed_Error_Text"};f[Kindle.ERROR.STORE_OPEN_OFFLINE_FAILED]={title:"k_store_open_failed_offline_Error_Title",text:"k_store_open_failed_offline_Error_Text"};f[Kindle.ERROR.SYNC_FAILED]={title:"k_L_syncFailedError_Title",text:"k_L_syncFailedError_Text"};f[Kindle.ERROR.SYNC_FAILED_OFFLINE]=
{title:"k_L_syncFailedOfflineError_Title",text:"k_L_syncFailedOfflineError_Text"};f[Kindle.ERROR.NOT_IMPLEMENTED]={title:"k_lib_unimplementedFeature_Error_Title",text:"k_lib_unimplementedFeature_Error_Text"};f[Kindle.ERROR.LIBRARY_LOAD_FAILED]={title:"k_L_loadFailedError_Title",text:"k_L_loadFailedError_Text"};f[Kindle.ERROR.NETWORK]={title:"k_L_openBookNetworkError_Title",text:"k_L_openBookNetworkError_Text"};f[Kindle.ERROR.UNKNOWN_ERR]={title:"k_L_unknownError_Title",text:"k_L_unknownError_Text"};
f[Kindle.ERROR.OUTDATED_CHROME]={title:"k_L_outdatedChrome_Title",text:"k_L_outdatedChrome_Text",textParams:{linkStart:"<a href='https://www.google.com/chrome/' target='_blank'>",linkEnd:"</a>"}};f[Kindle.ERROR.SITB_OFFLINE]={title:"k_R_sitb_error_offline_title",text:"k_R_sitb_error_offline_message"};f[Kindle.ERROR.SITB_LANGUAGE_NOT_SUPPORTED]={title:"k_R_sitb_error_language_not_supported_title",text:"k_R_sitb_error_language_not_supported_message"};f[Kindle.ERROR.SITB_INDEX_NOT_AVAILABLE]={title:"k_R_sitb_error_index_not_available_title",
text:"k_R_sitb_error_index_not_available_message"};f[Kindle.ERROR.SITB_COMMON_ERROR]={title:"k_R_sitb_error_common_title",text:"k_R_sitb_error_common_message"};f[Kindle.ERROR.SITB_LANGUAGE_UNDEFINED]={title:"k_R_sitb_error_language_undefined_title",text:"k_R_sitb_error_language_undefined_message"};h={};h[Kindle.ERROR.CONTENT_UNSUPPORTED]=Kindle.ERROR.CONTENT_UNSUPPORTED_METRO;h[Kindle.ERROR.CONTENT_RENTAL_EXPIRED]=Kindle.ERROR.CONTENT_RENTAL_EXPIRED_METRO}KindleHostDeviceDetector.isMetro()&&(d=h[d]||
d);(d=f[d])||(d=f[Kindle.ERROR.UNKNOWN_ERR]);return{title:ResourceBundle.getLocalizedString(d.title,d.titleParams),text:ResourceBundle.getLocalizedString(d.text,d.textParams)}}}}(),KindleIOSScrollStopper={stopScroll:function(f){f.preventDefault()}},KindleListUtilities=function(){return{binarySearch:function(f,h,d){if(!f.length)return 0;for(var e=f.length-1,c=0,b=0,g=null,a=0;c<=e;)if(b=Math.floor((c+e)/2),g=f[b],a=0,d===void 0?g>h?a=1:g<h&&(a=-1):a=d(h,g),a>0)e=b-1;else if(a<0)c=b+1;else return b;
return b===0||a<0?b:b-1},first:function(f){return f[0]},last:function(f){return f[f.length-1]}}}(),KindleOffline=function(){function f(b){var a=new jQuery.Deferred;setTimeout(a.resolve,b);return a.promise()}function h(b,a,d){if(b.indexOf(c)>=0&&KindleHostDeviceDetector.hasCanvasPerformanceProblem()){var e=KindleModuleManager.getModuleSync(KindleModuleManager.METRICS_MANAGER),f=e.startMetrics("Reader::UnoptimizedBookOpen");KindleUnoptimizedFormatDialog.openPinning(function(b){b?(e.increaseSubCounter(f,
"Continue",1),e.endMetrics(f),e=null,a()):(e.increaseSubCounter(f,"Cancel",1),e.endMetrics(f),e=null,d())})}else a()}function d(b,a){if(a){var c=KindleModuleManager.getModuleSync(KindleModuleManager.METRICS_MANAGER),d="BookDownload::Fail::"+a,e=d;switch(b){case Kindle.ERROR.CANCELLED:e+="::Cancelled";break;case Kindle.ERROR.OUT_OF_SPACE:e+="::DBFull";break;case Kindle.ERROR.UNKNOWN_DB_ERROR:e+="::UnknownDBError";break;case Kindle.ERROR.NETWORK:e+="::Network";break;case Kindle.ERROR.TIMEOUT:e+="::Timeout";
break;case Kindle.ERROR.USER_CLOSED_BOOK:e+="::UserClosedBook";break;case Kindle.ERROR.USER_CANCELLED_PIN:e+="::UserCancelledPin";break;default:e+="::Unknown"}c.emit([{name:d,params:{breakdown:["Browser"]}},{name:e,params:{breakdown:["Browser"]}}])}}function e(){return window.localStorage.getItem("haveRun")?!1:!0}var c="topaz",b=null;return{isFirstTime:e,isEnabled:function(){return KindleModuleManager.getModuleSync(KindleModuleManager.DB_CLIENT).bookDbEnabled()},firstRunMessage:function(){var b=new jQuery.Deferred;
KindleFirstRunDialog.open({continueCB:function(){KindleHostDeviceDetector.isIE()||KindleModuleManager.getModuleSync(KindleModuleManager.DB_CLIENT).enableFullDb().then(b.resolve,b.reject);KindleLocalStorage.setItem(Kindle.App.HAVE_RUN,"true")},onDialogOpenCB:function(){KindleHostDeviceDetector.isIE()&&KindleModuleManager.getModuleSync(KindleModuleManager.DB_CLIENT).enableFullDb().then(function(){b.resolve();var a=KindleModuleManager.getModuleSync(KindleModuleManager.DB_CLIENT).getBookDb();a&&e()&&
a.BookInfoDB().reserveStorage(10)},b.reject)}});return b.promise()},enableOfflineMessage:function(){var b=new jQuery.Deferred;KindleModuleManager.getModuleSync(KindleModuleManager.DB_CLIENT).enableFullDb().then(b.resolve,b.reject);setTimeout(function(){b.isRejected()&&KindleEnableOfflineDialog.open()},500);return b.promise()},pinBook:function(b,a){function c(a){if(a.type===Kindle.ERROR.DB_LINGERING_WRITE)if(a.stalled)KindleFirefoxPromptingDialog.open(),n.getModuleSync(n.METRICS_MANAGER).emit("Pinning::FirefoxPrompting::Open");
else{KindleFirefoxPromptingDialog.close();var b="Pinning::FirefoxPrompting::Close::";b+=a.writeOk?"ok":"no";n.getModuleSync(n.METRICS_MANAGER).emit(b)}}function e(){n.getModuleSync(Kindle.MODULE.DB_CLIENT).removeEventListener(Kindle.ERROR.DB_LINGERING_WRITE,c);n.getModuleSync(n.METRICS_MANAGER).cancelMetrics(t);t=null;q.cancelDownloading(Kindle.ERROR.USER_CANCELLED_PIN);KindleLibraryProgressDialog.close();o.reject()}function m(){n.getModuleSync(Kindle.MODULE.DB_CLIENT).removeEventListener(Kindle.ERROR.DB_LINGERING_WRITE,
c);n.getModuleSync(n.METRICS_MANAGER).endMetrics(t);KindleLibraryProgressDialog.updateValue(100);$.when(p,f(200)).then(function(){KindleLibraryProgressDialog.close();o.resolve(q.getBookType(),q.isContentScrambled())})}function l(b,e){var f=!1;n.getModuleSync(Kindle.MODULE.DB_CLIENT).removeEventListener(Kindle.ERROR.DB_LINGERING_WRITE,c);t&&n.getModuleSync(n.METRICS_MANAGER).endMetrics(t);KindleLibraryProgressDialog.close();b&&(b.getContext&&b.getContext().downloadRestrictionReason&&(f=!0),b.getOpenError&&
(b=b.getOpenError()));b!==Kindle.ERROR.USER_CANCELLED_PIN&&b!==Kindle.ERROR.CANCELLED&&b!==Kindle.ERROR.USER_CLOSED_BOOK&&a(b,e);f||d(b,"Library");o.reject(b)}function r(){function a(b,c){var d=Math.round(100*Math.min(b,c)/Math.max(1,c)),d=Math.max(1,d);KindleLibraryProgressDialog.updateValue(d)}q.getSizeInfo().then(function(b){b.bookSize*1.53>b.quota?(u.reject(),l(Kindle.ERROR.OUT_OF_SPACE)):q.getBookInfoDfd().then(function(){var b=q.getBookType();h(b,function(){n.getModuleSync(Kindle.MODULE.DB_CLIENT).addEventListener(Kindle.ERROR.DB_LINGERING_WRITE,
c);u.resolve(!0);q.getDownloadComplete(a).then(m,l)},function(){u.reject();e()})})})}var o,p,n,q,t,u;Date.now();o=new jQuery.Deferred;if(!KindleModuleManager.getModuleSync(KindleModuleManager.DB_CLIENT).bookDbEnabled())return o.reject(),o.promise();n=KindleModuleManagerFactory();window.parent.KindleApp.getSharedModules().done(function(a){n.registerModuleList(a);t=n.getModuleSync(n.METRICS_MANAGER).startMetrics("Pin");q=KindleReaderBookInfoProvider.BookInfo(b,n);p=f(1500);u=new jQuery.Deferred;KindleLibraryProgressDialog.open(e);
q.startDownloading(t,u).then(r,l)});return o.promise()},downloadBook:function(c,a,e,h){function m(){n.getModuleSync(n.METRICS_MANAGER).endMetrics(q);$.when(p,f(200)).then(function(){o.resolve();e()})}function l(a){var b=!1;n.getModuleSync(n.METRICS_MANAGER).cancelMetrics(q);a&&(a.getContext&&a.getContext().downloadRestrictionReason&&(b=!0),a.getOpenError&&(a=a.getOpenError()));if(a!==Kindle.ERROR.CANCELLED){if(a===Kindle.ERROR.CONTENT_UNSUPPORTED&&KindleHostDeviceDetector.isMetro())a=Kindle.ERROR.CONTENT_UNSUPPORTED_METRO;
var c=KindleErrorMap.getErrorText(a);c.code=a;h(c)}b||d(a,"Library");o.reject(a)}function r(){function c(b,d){a(Math.round(100*Math.min(b,d)/Math.max(1,d)))}b.getSizeInfo().then(function(a){a.quota>0&&a.bookSize*1.53>a.quota?l(Kindle.ERROR.OUT_OF_SPACE):(t.resolve(!0),b.getDownloadComplete(c).then(m,l))})}var o,p,n,q,t;o=new jQuery.Deferred;if(!KindleModuleManager.getModuleSync(KindleModuleManager.DB_CLIENT).bookDbEnabled())return o.reject(),o.promise();n=KindleModuleManagerFactory();window.parent.KindleApp.getSharedModules().done(function(a){n.registerModuleList(a);
q=n.getModuleSync(n.METRICS_MANAGER).startMetrics("Pin");b=KindleReaderBookInfoProvider.BookInfo(c,n);p=f(1500);t=new jQuery.Deferred;b.startDownloading(q,t).then(r,l)});return o.promise()},removeBook:function(b,a,c){function d(a){o.endMetrics(p);c(a)}function e(){o.endMetrics(p);a()}function f(a){a.cacheState!==Kindle.BookInfo.CachedState.PINNED||a.context.isSample?a=!0:KindleHostDeviceDetector.isOnline()?(a={asin:b.asin,kindleSessionId:a.context.kindleSessionId,isOffline:!1},a=KindleModuleManager.getModuleSync(KindleModuleManager.SERVICE_CLIENT).setOfflineStatus(a)):
a=(new $.Deferred).reject(Kindle.ERROR.NETWORK).promise();return a}var h,o,p;o=KindleModuleManager.getModuleSync(KindleModuleManager.METRICS_MANAGER);p=o.startMetrics("Unpin");h=KindleModuleManager.getModuleSync(KindleModuleManager.DB_CLIENT).getBookDb();h.getRecord("bookinfo",{asin:b.asin},{cacheState:!0,context:!0}).then(function(a){a&&a.length>0?$.when(f(a[0])).fail(d).done(function(){h.deleteBooksData([b.asin]).then(e,d)}):e()},d)},cancelBookDownload:function(){b.cancelDownloading()},sendDownloadFailMetric:d}}(),
KindleKatakana=function(){function f(c){var b=c.substring(0,1);return d[b]?b+d[b].v:c}var h={"\u3042":"\u30a2","\u3044":"\u30a4","\u3046":"\u30a6","\u3048":"\u30a8","\u304a":"\u30aa","\u304b":"\u30ab","\u304d":"\u30ad","\u304f":"\u30af","\u3051":"\u30b1","\u3053":"\u30b3","\u3055":"\u30b5","\u3057":"\u30b7","\u3059":"\u30b9","\u305b":"\u30bb","\u305d":"\u30bd","\u305f":"\u30bf","\u3061":"\u30c1","\u3064":"\u30c4","\u3066":"\u30c6","\u3068":"\u30c8","\u306a":"\u30ca","\u306b":"\u30cb","\u306c":"\u30cc",
"\u306d":"\u30cd","\u306e":"\u30ce","\u306f":"\u30cf","\u3072":"\u30d2","\u3075":"\u30d5","\u3078":"\u30d8","\u307b":"\u30db","\u307e":"\u30de","\u307f":"\u30df","\u3080":"\u30e0","\u3081":"\u30e1","\u3082":"\u30e2","\u3084":"\u30e4","\u3086":"\u30e6","\u3088":"\u30e8","\u3089":"\u30e9","\u308a":"\u30ea","\u308b":"\u30eb","\u308c":"\u30ec","\u308d":"\u30ed","\u308f":"\u30ef","\u3092":"\u30f2","\u3093":"\u30f3","\u304c":"\u30ac","\u304e":"\u30ae","\u3050":"\u30b0","\u3052":"\u30b2","\u3054":"\u30b4",
"\u3056":"\u30b6","\u3058":"\u30b8","\u305a":"\u30ba","\u305c":"\u30bc","\u305e":"\u30be","\u3060":"\u30c0","\u3062":"\u30c2","\u3065":"\u30c5","\u3067":"\u30c7","\u3069":"\u30c9","\u3070":"\u30d0","\u3073":"\u30d3","\u3076":"\u30d6","\u3079":"\u30d9","\u307c":"\u30dc","\u3071":"\u30d1","\u3074":"\u30d4","\u3077":"\u30d7","\u307a":"\u30da","\u307d":"\u30dd","\u3094":"\u30f4","\u3041":"\u30a1","\u3043":"\u30a3","\u3045":"\u30a5","\u3047":"\u30a7","\u3049":"\u30a9","\u3063":"\u30c3","\u3083":"\u30e3",
"\u3085":"\u30e5","\u3087":"\u30e7","\u308e":"\u30ee"},d={"\u30a2":{v:"\u30a2"},"\u30a4":{v:"\u30a4"},"\u30a6":{v:"\u30a6"},"\u30a8":{v:"\u30a8"},"\u30aa":{v:"\u30aa"},"\u30ab":{v:"\u30a2"},"\u30ad":{v:"\u30a4"},"\u30af":{v:"\u30a6"},"\u30b1":{v:"\u30a8"},"\u30b3":{v:"\u30aa"},"\u30b5":{v:"\u30a2"},"\u30b7":{v:"\u30a4"},"\u30b9":{v:"\u30a6"},"\u30bb":{v:"\u30a8"},"\u30bd":{v:"\u30aa"},"\u30bf":{v:"\u30a2"},"\u30c1":{v:"\u30a4"},"\u30c4":{v:"\u30a6"},"\u30c6":{v:"\u30a8"},"\u30c8":{v:"\u30aa"},"\u30ca":{v:"\u30a2"},
"\u30cb":{v:"\u30a4"},"\u30cc":{v:"\u30a6"},"\u30cd":{v:"\u30a8"},"\u30ce":{v:"\u30aa"},"\u30cf":{v:"\u30a2"},"\u30d2":{v:"\u30a4"},"\u30d5":{v:"\u30a6"},"\u30d8":{v:"\u30a8"},"\u30db":{v:"\u30aa"},"\u30de":{v:"\u30a2"},"\u30df":{v:"\u30a4"},"\u30e0":{v:"\u30a6"},"\u30e1":{v:"\u30a8"},"\u30e2":{v:"\u30aa"},"\u30e4":{v:"\u30a2"},"\u30e6":{v:"\u30a6"},"\u30e8":{v:"\u30aa"},"\u30e9":{v:"\u30a2"},"\u30ea":{v:"\u30a4"},"\u30eb":{v:"\u30a6"},"\u30ec":{v:"\u30a8"},"\u30ed":{v:"\u30aa"},"\u30ef":{v:"\u30a2"},
"\u30f0":{v:"\u30a4"},"\u30f1":{v:"\u30a8"},"\u30f2":{v:"\u30aa"},"\u30f3":{v:"\u30a2"},"\u30ac":{v:"\u30a2",nq:"\u30ab"},"\u30ae":{v:"\u30a4",nq:"\u30ad"},"\u30b0":{v:"\u30a6",nq:"\u30af"},"\u30b2":{v:"\u30a8",nq:"\u30b1"},"\u30b4":{v:"\u30aa",nq:"\u30b3"},"\u30b6":{v:"\u30a2",nq:"\u30b5"},"\u30b8":{v:"\u30a4",nq:"\u30b7"},"\u30ba":{v:"\u30a6",nq:"\u30b9"},"\u30bc":{v:"\u30a8",nq:"\u30bb"},"\u30be":{v:"\u30aa",nq:"\u30bd"},"\u30c0":{v:"\u30a2",nq:"\u30bf"},"\u30c2":{v:"\u30a4",nq:"\u30c1"},"\u30c5":{v:"\u30a6",
nq:"\u30c4"},"\u30c7":{v:"\u30a8",nq:"\u30c6"},"\u30c9":{v:"\u30aa",nq:"\u30c8"},"\u30d0":{v:"\u30a2",nq:"\u30cf"},"\u30d3":{v:"\u30a4",nq:"\u30d2"},"\u30d6":{v:"\u30a6",nq:"\u30d5"},"\u30d9":{v:"\u30a8",nq:"\u30d8"},"\u30dc":{v:"\u30aa",nq:"\u30db"},"\u30d1":{v:"\u30a2",nq:"\u30cf"},"\u30d4":{v:"\u30a4",nq:"\u30d2"},"\u30d7":{v:"\u30a6",nq:"\u30d5"},"\u30da":{v:"\u30a8",nq:"\u30d8"},"\u30dd":{v:"\u30aa",nq:"\u30db"},"\u30f4":{v:"\u30af",nq:"\u30a6"},"\u30f7":{v:"\u30a2",nq:"\u30ef"},"\u30f8":{v:"\u30a4",
nq:"\u30f0"},"\u30f9":{v:"\u30a8",nq:"\u30f1"},"\u30fa":{v:"\u30aa",nq:"\u30f2"},"\u30a1":{v:"\u30a2"},"\u30a3":{v:"\u30a4"},"\u30a5":{v:"\u30a6"},"\u30a7":{v:"\u30a8"},"\u30a9":{v:"\u30aa"},"\u30c3":{v:"\u30a6"},"\u30e3":{v:"\u30a2"},"\u30e5":{v:"\u30a6"},"\u30e7":{v:"\u30aa"},"\u30ee":{v:"\u30a2"}},e=/.\u30fc/g;return{normalizeKatakana:function(c){c=c.replace(/[\u3040-\u30ff]/g,function(b){b=h[b]||b;return b=d[b]&&d[b].nq||b});return c=c.replace(e,f)},hasHiraganaKatakana:function(c){return c.search(/[\u3040-\u30ff]/)>=
0}}}(),KindleImageUtil=function(){return{getDataUriFromImage:function(f,h){var d=$.Deferred(),e=new Image;e.crossOrigin="Anonymous";e.onload=function(){var c;c=document.createElement("CANVAS");c.height=this.height;c.width=this.width;ctx=c.getContext("2d");ctx.drawImage(this,0,0);c=c.toDataURL(h);d.resolve(c)};e.onerror=d.reject;e.src=f;return d.promise()}}}(),KindleStringUtilities=function(){var f={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;"},h=RegExp("["+Object.keys(f).join("")+
"]","g"),d={"\u2019":"'","\uff07":"'","'":"'","\u00e0":"a","\u00e1":"a","\u00e2":"a","\u00e3":"a","\u00e4":"a","\u00e5":"a","\u00c0":"a","\u00c1":"a","\u00c2":"a","\u00c3":"a","\u00c4":"a","\u00c5":"a","\u0100":"a","\u0101":"a","\u0102":"a","\u0103":"a","\u0104":"a","\u0105":"a","\u00e8":"e","\u00e9":"e","\u00ea":"e","\u00eb":"e","\u00c8":"e","\u00c9":"e","\u00ca":"e","\u00cb":"e","\u0112":"e","\u0113":"e","\u0114":"e","\u0115":"e","\u0116":"e","\u0117":"e","\u0118":"e","\u0119":"e","\u011a":"e",
"\u011b":"e","\u00ec":"i","\u00ed":"i","\u00ee":"i","\u00ef":"i","\u00cc":"i","\u00cd":"i","\u00ce":"i","\u00cf":"i","\u0128":"i","\u0129":"i","\u012a":"i","\u012b":"i","\u012c":"i","\u012d":"i","\u012e":"i","\u012f":"i","\u0130":"i","\u00f2":"o","\u00f3":"o","\u00f4":"o","\u00f5":"o","\u00f6":"o","\u00d2":"o","\u00d3":"o","\u00d4":"o","\u00d5":"o","\u00d6":"o","\u014c":"o","\u014d":"o","\u014e":"o","\u014f":"o","\u0150":"o","\u0151":"o","\u00f9":"u","\u00fa":"u","\u00fb":"u","\u00fc":"u","\u00d9":"u",
"\u00da":"u","\u00db":"u","\u00dc":"u","\u0168":"u","\u0169":"u","\u016a":"u","\u016b":"u","\u016c":"u","\u016d":"u","\u016e":"u","\u016f":"u","\u0170":"u","\u0171":"u","\u0172":"u","\u0173":"u","\u00fd":"y","\u00ff":"y","\u00dd":"y","\u0176":"y","\u0177":"y","\u0178":"y","\u00e7":"c","\u00c7":"c","\u0106":"c","\u0107":"c","\u0108":"c","\u0109":"c","\u010a":"c","\u010b":"c","\u010c":"c","\u010d":"c","\u00d0":"d","\u010e":"d","\u010f":"d","\u00f0":"d","\u011c":"g","\u011d":"g","\u011e":"g","\u011f":"g",
"\u0120":"g","\u0121":"g","\u0122":"g","\u0123":"g","\u0124":"h","\u0125":"h","\u0134":"j","\u0135":"j","\u0136":"k","\u0137":"k","\u0139":"l","\u013a":"l","\u013b":"l","\u013c":"l","\u013d":"l","\u013e":"l","\u00f1":"n","\u00d1":"n","\u0143":"n","\u0144":"n","\u0145":"n","\u0146":"n","\u0147":"n","\u0148":"n","\u0154":"r","\u0155":"r","\u0156":"r","\u0157":"r","\u0158":"r","\u0159":"r","\u015a":"s","\u015b":"s","\u015c":"s","\u015d":"s","\u015e":"s","\u015f":"s","\u0160":"s","\u0161":"s","\u0162":"t",
"\u0163":"t","\u0164":"t","\u0165":"t","\u0174":"w","\u0175":"w","\u0179":"z","\u017a":"z","\u017b":"z","\u017c":"z","\u017d":"z","\u017e":"z","\u00df":"s","\u00e6":"a","\u00c6":"a","\u00de":"t","\u00fe":"t","\u00d8":"o","\u00f8":"o"},e={'"':"","'":"","\u00b4":"","\u2018":"","\u2019":"","\u201c":"","\u201d":""},c={fr:{},de:{"\u00df":"ss"},it:{},es:{"\u00d1":"OAAAAA","\u00f1":"oaaaaa"},en:d};return{replaceAccentedChars:function(b,e){var a,f=c[e]||[];a=b.replace(/[^A-Za-z0-9 ]/g,function(a){return f[a]||
d[a]||a});KindleKatakana.hasHiraganaKatakana(a)&&(a=KindleKatakana.normalizeKatakana(a));return a},removeQuotes:function(b){return b=b.replace(/[^A-Za-z0-9 ]/g,function(b){var a=e[b];return a===""?a:b})},escapeForHTML:function(b){return b.replace(h,function(b){return f[b]})},substitute:function(b,c){return b.replace(/\{\{([A-Za-z0-9\_]+)\}\}/g,function(a,b){return b in c?c[b]:a})}}}(),KindleTouchEventsToggler=function(){function f(a){if(g)for(var c=$(":hasTouchEvent"),d=0;d<c.length;d++){var e=c[d];
if((!a||!a(e))&&e._listeners)for(var f=e._listeners.slice(0),h=0;h<f.length;h++){var o=f[h][0];if(o==="touchstart"||o==="touchmove"||o==="touchend")o={element:e,type:o,func:f[h][1],useCapture:f[h][2]},b.push(o),e.removeEventListener(o.type,o.func,o.useCapture)}}}function h(){if(g){for(var a=0;a<b.length;a++){var c=b[a];c.element.addEventListener(c.type,c.func,c.useCapture)}b=[]}}var d=null,e=null,c=!1,b=[],g=!1;return{initialize:function(){if(!c)d=HTMLElement.prototype.addEventListener,HTMLElement.prototype.addEventListener=
function(){if(!this._listeners)this._listeners=[];this._listeners.push(arguments);d.apply(this,arguments)},e=HTMLElement.prototype.removeEventListener,HTMLElement.prototype.removeEventListener=function(){function a(a,b){try{return typeof a==="function"&&typeof b==="function"?a===b:a.handleEvent===b.handleEvent}catch(c){}return!1}if(this._listeners)for(var b=0;b<this._listeners.length;++b)if(this._listeners[b][0]===arguments[0]&&a(this._listeners[b][1],arguments[1])){this._listeners.splice(b,1);break}e.apply(this,
arguments)},g=c=!0,$.expr[":"].hasTouchEvent=function(a){if(a._listeners)for(var b=0;b<a._listeners.length;b++){var c=a._listeners[b][0];if(c==="touchstart"||c==="touchmove"||c==="touchend")return!0}return!1},$.expr[":"].hasListeners=function(a){return a._listeners!==void 0}},deInitialize:function(){if(c){var a=0;$(":hasListeners").each(function(b,c){for(var d=c._listeners.slice(0),e=0;e<d.length;e++)c.removeEventListener(d[e][0],d[e][1]),a++});HTMLElement.prototype.addEventListener=d;HTMLElement.prototype.removeEventListener=
e;b=[];c=!1}},on:h,off:f,disallowTouchEvents:function(){g=!0;f();g=!1},allowTouchEvents:function(){g=!0;h()},isRequired:function(){return KindleHostDeviceDetector.isiOS()&&!KindleHostDeviceDetector.isiOS_7x()&&!KindleHostDeviceDetector.isiOS_8x()}}}();
(function(f){var h=["tap","tapHold","swipeLeft","swipeRight","activate","pinch","zoom","doubletap"];f.each(h,function(d,e){f.fn[e]=function(c,b){b=b||{};return e==="tap"?KindleHostDeviceDetector.isTouchDevice()?c?gt(this).on(e,c,f.extend(b,{expire:700,moveThreshold:10})):this.trigger(e):c?this.click(c):this.trigger("click"):c?gt(this).on(e,c,b):this.trigger(e)};f.attrFn[e]=!0});f.each(h,function(d,e){var c="unbind"+e.slice(0,1).toUpperCase()+e.slice(1);f.fn[c]=function(b){return e==="tap"&&!KindleHostDeviceDetector.isTouchDevice()?
b?this.unbind("click",b):this.unbind("click"):gt(this).off(e,b)};f.attrFn[c]=!0})})(jQuery);
var KindleUXComponentManager=function(){function f(a){if(a.callbacks.onDialogOpen)a.callbacks.onDialogOpen(a.component);a.callbacks.onOverlayClicked&&$(".ui-widget-overlay").tap(a.callbacks.onOverlayClicked).bind("contextmenu",function(b){a.callbacks.onOverlayClicked();b.preventDefault()})}function h(a,b,c){g(a,function(){var d;d=$(Handlebars.templates[a](c));k[a]={component:d};b(d)})}function d(a){a.stopPropagation()}function e(a,b,e,g){var h=k[a];h.callbacks=e;if(e.onInitializationDone)e.onInitializationDone(b);
if(e.getDialogSettings)h.dialogSettings=e.getDialogSettings();if(h.dialogSettings.width===void 0){if(KindleHostDeviceDetector.isiPad())a=l;else if(KindleHostDeviceDetector.isMetro()){if(a=o,h.dialogSettings.dialogClass="wide-dialog",!g)h.dialogSettings.k4w_transparent_modal_overlay=!1}else a=r;h.dialogSettings.width=a}h.dialogSettings.modal&&b.keydown(d).keyup(d);if(KindleHostDeviceDetector.isiOS_5xOrGreater()){a=h.dialogSettings;if(a.modal)a.modal=!1,a.k4w_modal=!0;b=b.dialog(a)}else b=b.dialog(h.dialogSettings);
h.component=b;if(!g&&!KindleHostDeviceDetector.isiOS_5xOrGreater()){var j=b.dialog("option","position");$(window).resize(function(){b.dialog("option","position",j)})}b.bind("dialogopen",function(){f(h)});b.bind("dialogclose",function(){if(h.callbacks.onDialogClose)h.callbacks.onDialogClose(h.component);h.dialogSettings.k4w_modal&&KindleDialogOverlay.removeOverlay()});b.bind("dialogbeforeclose",function(){$(".ui-widget-overlay").unbindTap();h.dialogSettings.modal&&p&&p(!0);h.callbacks.beforeDialogClose&&
h.callbacks.beforeDialogClose(h.component)});c(h)}function c(a){a.component.dialog("isOpen")||(a.dialogSettings.k4w_transparent_modal_overlay?$("body").addClass(m):$("body").removeClass(m),a.callbacks.beforeDialogOpen&&a.callbacks.beforeDialogOpen(a.component),a.dialogSettings.modal&&p&&p(!1),a.dialogSettings.k4w_modal&&KindleDialogOverlay.showOverlay(a),a.component.dialog("open"))}function b(a){k[a]&&k[a].component.dialog("isOpen")&&k[a].component.dialog("close")}function g(b,c){a(b).then(function(){j[b]||
c()},function(){KindleDebug.error("Template "+b+" is missing")})}function a(a){var b=$.Deferred();(a=Handlebars.templates[a])?b.resolve(a):b.reject();return b.promise()}function j(a){return!!Handlebars.templates[a]}var k=[],m="transparent_overlay",l=475,r=400,o="100%",p;return{initializeTemplate:g,hasTemplate:j,renderTemplate:function(a,b){if(!Handlebars.templates[a])throw{name:"initializationError",message:"Please call KindleUXComponentManager.initializeTemplate function first"};return $(Handlebars.templates[a](b))},
initializeComponent:h,openDialog:function(a,b,d){var f=k[a];f?c(f):f!==null&&(k[a]=null,h(a,function(c){e(a,c,b)},d))},closeDialog:b,isVisible:function(a){return k[a]&&k[a].component.dialog("isOpen")?!0:!1},showMenu:function(a,b){var d;b||(d=k[a.componentName]);d?(a.buttonID||KindlePopupMenu.updatePosition(a.componentName,a.position),a.enabledFlags&&KindlePopupMenu.updateMenu(d.component,a.enabledFlags,a.componentName),c(d)):(a.doneCallback=function(b,c){a.enabledFlags&&KindlePopupMenu.updateMenu(b,
a.enabledFlags,a.componentName);k[a.componentName]={component:b};e(a.componentName,b,c,!0)},KindlePopupMenu.initialize(a))},updateMenu:function(a,b){var c=k[a];c&&KindlePopupMenu.updateMenu(c.component,b,a)},hideMenu:b,registerKeyEventsEnabledCallback:function(a){p=a}}}(),KindleWindowSizeWatcher=function(){function f(){r||(r=!0,q.emit(j+"::"+k+"::"+n))}function h(){p||(p=!0,q.emit(j+"::"+m+"::"+n))}function d(){var d=$(window).width();0<d&&d<b?!r&&!p&&KindleSmallWindowDialog.open({onDialogIgnoreCB:h,
onDialogOpenCB:f}):r&&(KindleSmallWindowDialog.close(),r=!1);o&&c(a)}function e(){l!==null&&(clearTimeout(l),l=null)}function c(){var a=g;e();l=setTimeout(d,a)}var b=720,g=200,a=500,j="SmallWindowDialog",k="Shown",m="Ignored",l=null,r=!1,o=!1,p=!1,n,q;return{setMetricsContext:function(a){q||(q=KindleModuleManager.getModuleSync(KindleModuleManager.METRICS_MANAGER));n=a},onWindowResized:c,startPolling:function(){o=!0;var b=a;e();l=setTimeout(d,b)},stopPolling:function(){o=!1}}}(),KindleDialogOverlay=
function(){return{showOverlay:function(f){$("body").append("<div class='ui-widget-overlay ui-widget-overlay-kcr-ios-hack'></div>");$(".ui-widget-overlay-kcr-ios-hack").attr("style","z-index: 1000;");(function(){var h=f.component.dialog("option","position");$("body",Kindle.top.document).bind("orientationchange.dialog",function(){f.dialogSettings.k4w_transparent_modal_overlay&&$(".ui-widget-overlay-kcr-ios-hack").css({width:0,height:0});f.component.dialog("option","position",h)})})();(function(){f.callbacks.onOverlayClicked&&
$(".ui-widget-overlay-kcr-ios-hack").tap(function(f){f.preventDefault()})})()},removeOverlay:function(){$(".ui-widget-overlay-kcr-ios-hack").remove();$("body",Kindle.top.document).unbind("orientationchange.dialog")}}}(),KindleEnableOfflineDialog=function(){function f(){KindleUXComponentManager.closeDialog(h)}var h="KindleEnableOfflineDialog",d={BUTTON_TEXT:"k_dialog_enableOffline_button_text",OFFLINE_TITLE:"k_dialog_enable_offline_title",FIREFOX_MSG:"k_dialog_enable_offline_firefox_msg"},e={DIALOG:"kindle_dialog_enableOffline",
CONTENT:"kindle_dialog_enableOffline_content",BUTTON:"kindle_dialog_enableOffline_button"},c={TITLE:"enable_offline_title",TOP_MSG:"enable_offline_top_msg"},b,g={getDialogSettings:function(){return{autoOpen:!1,width:626,modal:!0,draggable:!1,resizable:!1,dialogClass:"enableOfflineDialog"}},beforeDialogOpen:function(a){b=a;var g,h;KindleHostDeviceDetector.isFirefox()&&(g=ResourceBundle.getLocalizedString(d.OFFLINE_TITLE),h=ResourceBundle.getLocalizedString(d.FIREFOX_MSG,{linkStart:"<a href='"+LinkUrls.getOfflineReadingUrl()+
"' target='_blank'>",linkEnd:"</a>"}));a={title:g,topInstruction:h,topInstructionClass:void 0};b.find("#"+c.TITLE).html(a.title);b.find("#"+c.TOP_MSG).html(a.topInstruction);a.topInstructionClass&&b.find("#"+c.TOP_MSG).addClass(a.topInstructionClass);a=b.find("#"+e.BUTTON);a.html(ResourceBundle.getLocalizedString(d.BUTTON_TEXT));a.one("click",f)},onDialogOpen:function(){var a=$("#"+e.DIALOG);a.parents(".ui-dialog:first").removeClass("ui-widget ui-widget-content ui-corner-all");a.removeClass("ui-dialog-content ui-widget-content")}};
return{open:function(){KindleUXComponentManager.openDialog(h,g)},close:function(){KindleUXComponentManager.closeDialog(h)}}}(),KindleFirefoxPromptingDialog=function(){function f(){KindleHostDeviceDetector.hasHangingDbPrompt()&&KindleUXComponentManager.closeDialog(h)}var h="KindleFirefoxPromptingDialog",d={CLOSE_BUTTON:"k_common_close_button",MESSAGE:"k_dialog_ffPrompting_Text"},e={DIALOG:"kindle_dialog_ffPrompting",IMAGE:"ffPrompting_img",MESSAGE:"kindle_dialog_ffPrompting_text"},c,b={getDialogSettings:function(){return{autoOpen:!1,
modal:!0,draggable:!1,resizable:!1,k4w_transparent_modal_overlay:!1}},beforeDialogOpen:function(b){var a={linkStart:"<a href='"+LinkUrls.getIncreaseOfflineStorageUrl()+"' target='_blank'>",linkEnd:"</a>"};c=b;c.find("#kindle_dialog_ffPrompting_url").text(parent.window.location);c.find("#kindle_dialog_ffPrompting_tab_title").text(parent.document.title);b={};a=ResourceBundle.getLocalizedString(d.MESSAGE,a);c.find("#"+e.MESSAGE).html(a);b[ResourceBundle.getLocalizedString(d.CLOSE_BUTTON)]=f;c.dialog("option",
"buttons",b)}};return{open:function(){KindleHostDeviceDetector.hasHangingDbPrompt()&&KindleUXComponentManager.openDialog(h,b)},close:f}}(),KindleFirstRunDialog=function(){function f(){KindleUXComponentManager.closeDialog(e);j&&j()}function h(){var a,b;if(KindleHostDeviceDetector.isChromeApp())return null;else if(KindleHostDeviceDetector.isChrome())a=ResourceBundle.getLocalizedString(c.OFFLINE_TITLE),b=ResourceBundle.getLocalizedString(c.CHROME_MSG);else if(KindleHostDeviceDetector.isiOS())a=ResourceBundle.getLocalizedString(c.OFFLINE_TITLE),
b=ResourceBundle.getLocalizedString(c.IOS_PROMPT_MSG);else if(KindleHostDeviceDetector.isFirefox())return null;else KindleHostDeviceDetector.isIE()?(a=ResourceBundle.getLocalizedString(c.OFFLINE_TITLE),b=ResourceBundle.getLocalizedString(c.IE_PROMPT_MSG)):(a=ResourceBundle.getLocalizedString(c.OFFLINE_TITLE),b=ResourceBundle.getLocalizedString(c.SAFARI_PROMPT_MSG));return{title:a,topInstruction:b}}function d(){KindleUXComponentManager.closeDialog(e)}var e="KindleFirstRunDialog",c={BUTTON_TEXT:"k_dialog_firstRun_button_text",
BUTTON_TEXT_CHROME:"k_dialog_firstRun_button_text_chrome",CRX_BUTTON_TEXT:"k_dialog_firstRun_button_crx_text",INSTALLING_BUTTON_TEXT:"k_dialog_firstRun_button_installing_text",INSTALLED_BUTTON_TEXT:"k_dialog_firstRun_button_installed_text",CONTINUE_BUTTON_TEXT:"k_dialog_firstRun_button_text_chrome_done",OFFLINE_TITLE:"k_dialog_firstRun_offline_title",CHROME_APP_TITLE:"k_dialog_firstRun_chrome_app_title",CHROME_APP_MSG:"k_dialog_firstRun_chrome_app_msg",CHROME_MSG:"k_dialog_firstRun_chrome_msg",FIREFOX_MSG:"k_dialog_firstRun_firefox_msg",
IOS_PROMPT_MSG:"k_dialog_firstRun_ios_prompt_msg",SAFARI_PROMPT_MSG:"k_dialog_firstRun_safari_prompt_msg",IE_PROMPT_MSG:"k_dialog_firstRun_ie_prompt_msg"},b={DIALOG:"kindle_dialog_firstRun",CONTENT:"kindle_dialog_firstRun_content",BUTTON:"kindle_dialog_firstRun_button",CRX_BUTTON:"kindle_dialog_firstRun_button_crx"},g={TITLE:"first_run_title",TOP_MSG:"first_run_top_msg",TOP_IMG:"first_run_top_img",BOTTOM_IMG:"first_run_bottom_img"},a,j,k,m,l={getDialogSettings:function(){return{autoOpen:!1,width:626,
modal:!0,draggable:!1,resizable:!1,dialogClass:"firstRunDialog"}},beforeDialogOpen:function(a){function e(){KindleChromeInstaller.install();d()}k=a;k.find("#"+g.TITLE).html(m.title);k.find("#"+g.TOP_MSG).html(m.topInstruction);a=k.find("#"+b.BUTTON);a.html(ResourceBundle.getLocalizedString(c.BUTTON_TEXT));a.one("click",f);KindleHostDeviceDetector.isChrome()&&!KindleHostDeviceDetector.isChromeApp()&&(a.removeClass("primary_btn").addClass("chrome_btn").html(ResourceBundle.getLocalizedString(c.BUTTON_TEXT_CHROME)),
a=k.find("#"+b.CRX_BUTTON),a.removeClass("disabled").html(ResourceBundle.getLocalizedString(c.CRX_BUTTON_TEXT)),a.unbind("click"),a.one("click",e),a.show())},onDialogOpen:function(){var c=$("#"+b.DIALOG);c.parents(".ui-dialog:first").removeClass("ui-widget ui-widget-content ui-corner-all");c.removeClass("ui-dialog-content ui-widget-content");a&&a()}};return{open:function(b){(m=h())?(j=b&&b.continueCB,a=b&&b.onDialogOpenCB,KindleUXComponentManager.openDialog(e,l)):b&&b.continueCB&&b.continueCB()},
close:d}}(),KindleMessageDialog=function(){function f(a){if((a.keyCode||a.which)===27)return j(),a.stopImmediatePropagation(),!1}var h={TITLE_ID:"kindle_dialog_message_title_text",TEXT_ID:"kindle_dialog_message_text"},d={dismiss:"k_dialog_message_dismissButton_text"},e,c,b,g,a,j=function(){KindleUXComponentManager.closeDialog("KindleMessageDialog")},k={getDialogSettings:function(){return{autoOpen:!1,modal:!0,draggable:!1,resizable:!1,k4w_transparent_modal_overlay:!0}},beforeDialogOpen:function(e){function k(a){return function(){j();
"function"===typeof a.callback&&a.callback()}}var m={};if(a)for(var p=0;p<a.length;p++){var n=a[p];m[n.buttonText]=k(n)}else g=g?g:ResourceBundle.getLocalizedString(d.dismiss),m[g]=j;e.dialog("option","buttons",m);e.find("#"+h.TITLE_ID).empty().append(b);e.find("#"+h.TEXT_ID).empty().append(c);if(KindleHostDeviceDetector.isMetro())$(".ui-dialog").on("keydown",f)},beforeDialogClose:function(){KindleHostDeviceDetector.isMetro()&&$(".ui-dialog").off("keydown")},onDialogClose:function(){e&&e()}},m=function(d,
f,h,j,m){b=d;c=f;e=h;g=j;a=m;KindleUXComponentManager.openDialog("KindleMessageDialog",k)};return{open:m,close:j,showError:function(a,b,c,d){var e=a;if(a&&a.name)e=a.name;e=KindleErrorMap.getErrorText(e);a&&a.code&&(e.text+=" ["+a.code+"]");m(e.title,e.text,b,c,d)}}}(),KindleNotificationDialog=function(){function f(a){$(window).unbind("touchstart.notification mousedown.notification");KindleHostDeviceDetector.isiOS_5xOrGreater()?$("body",top.document).unbind("orientationchange.notification"):$(window).unbind("resize.notification");
a.removeClass(k.SHOWN);setTimeout(function(){a.remove()},p)}function h(b){function c(d){var e,f,g,h;if(e=a[d.optionProperty])if(typeof e==="string"?f=e:(f=e.id,g=e.localizationParams,h=e.htmlClass),e=ResourceBundle.getLocalizedString(f,g))d=$(d.tag).addClass(d.htmlClass).html(e),h&&d.addClass(h),b.find("."+k.CONTAINER).append(d)}b.find("."+k.CONTAINER).empty();c(k.PRETITLE);c(k.TITLE);c(k.BODY);c(k.LEGAL)}function d(a,b){var c=$("#kindleNotificationArrow"),d=$("#"+b.targetElementId),e=0,f=0;b.targetAlignment===
"right"?(e=d.offset().left+d.outerWidth(),e-=a.outerWidth()):(e=d.offset().left+d.outerWidth()/2,e-=a.outerWidth()/2);(function(){var b=$("body").outerWidth();e+a.outerWidth()>b&&(e=b-a.outerWidth());e<0&&(e=0)})();(function(){var a=b.targetBeakOffset||0;f=d.offset().left-e+d.outerWidth()/2+a})();a.css("left",e+"px");c.css("left",f+"px")}function e(b){function c(){d(b,a);KindleHostDeviceDetector.isiOS()&&b.show();h=null}function e(){h?clearTimeout(h):KindleHostDeviceDetector.isiOS()&&b.hide();h=setTimeout(c,
n)}function g(){u=!0;t&&G.increment();f(b)}var h;$(window).bind("touchstart.notification mousedown.notification",function(b){(!b.srcElement||!b.srcElement.id||!a.clickIdsToIgnore||!a.clickIdsToIgnore[b.srcElement.id])&&setTimeout(g,o)});KindleHostDeviceDetector.isiOS_5xOrGreater()?$("body",top.document).bind("orientationchange.notification",e):$(window).bind("resize.notification",e);setTimeout(g,r)}function c(b){e(b);$("body").append(b);d(b,a);setTimeout(function(){u||(b.addClass(k.SHOWN),setTimeout(function(){t=
!0},l))},m)}function b(a){h(a);c(a)}function g(a){var b=$("<canvas id='kindleNotificationArrow' width='32' height='32'></canvas>"),c=b[0].getContext("2d");c.beginPath();c.moveTo(0,24);c.lineTo(0,25);c.lineTo(32,25);c.lineTo(32,24);c.lineTo(16,0);c.closePath();c.fillStyle="#eee";c.fill();c.beginPath();c.moveTo(0,24);c.lineTo(16,0);c.lineTo(32,24);c.strokeStyle="rgba(32,32,32,0.8)";c.stroke();b.css("top","-24px");b.css("left","50%");b.css("margin-left","-16px");b.css("position","absolute");a.prepend(b);
q.resolve(a)}var a={},j={},k={BODY:{htmlClass:"notificationBodyText",tag:"<div></div>",optionProperty:"bodyId"},LEGAL:{htmlClass:"notificationLegalText",tag:"<div></div>",optionProperty:"legalId"},TITLE:{htmlClass:"notificationTitleText",tag:"<span></span>",optionProperty:"titleId"},PRETITLE:{htmlClass:"notificationPreTitleText",tag:"<span></span>",optionProperty:"preTitleId"},CONTAINER:"notificationContainer",SHOWN:"shown"},m=2E3,l=1E3,r=2E4,o=250,p=3E3,n=100,q=null,t=!1,u=!1,G;return{show:function(c){a=
$.extend({},j,c);G=LocalStorageCounter("kcrNotifications."+a.notificationId);c=a.notificationCount|1;G.getValue()<c&&(q||(q=new jQuery.Deferred,KindleUXComponentManager.initializeComponent("KindleNotificationDialog",g)),q.done(b))},hide:function(){var a=$("#kindleNotification");f(a)}}}(),KindlePopupMenu=function(){function f(b){var c=KindleUXComponentManager.renderTemplate(j),d=c.find(m),e=B[b].menuItems,f=!0,g,k=o;if(B[b].isAppBarMenu){k+=" "+n;var l=B[b].title;if(l){var p=document.createElement("div"),
l=document.createTextNode(l);p.appendChild(l);p.setAttribute("class",q);d.append(p)}}for(var r in e)g=$(document.createElement("div")).addClass(k).addClass(t).text(e[r].content).attr("id",e[r].elementId),f&&(g.addClass(u),f=!1),g.tap(h(g,e[r].clickHandler)),KindleEventBroker.subscribe(e[r].elementId,e[r].clickHandler),d.append(g);g.addClass(G);KindleHostDeviceDetector.isiOS()&&"onorientationchange"in window&&$("body",Kindle.top.document).bind("orientationchange",function(){KindleUXComponentManager.hideMenu(b)});
B[b].doneCallback(c,a(b))}function h(a,b){return function(){a.hasClass(t)&&b()}}function d(a,b,c){var d=[];b?(b=$("#"+b),c==="down"?(c=b.offset(),b=c.top+b.outerHeight(),d[0]=KindleHostDeviceDetector.isMetro()?c.left+23:c.left,d[1]=KindleHostDeviceDetector.isMetro()?b+10:b):(d[0]="right",d[1]="bottom")):d=c;a.dialog("option","position",d)}function e(){w&&(w.removeClass(x),w=null)}function c(a,b,c){var a=a.find(m).children(),d=b;do{if(c==="next")d?(d=d.next(),d.length<=0&&(d=a.first())):d=a.first();
else if(c==="prev")d?(d=d.prev(),d.length<=0&&(d=a.last())):d=a.last();else break;if(d===b)break}while(!d.hasClass(t));return d}function b(a,b){d(a,B[b].buttonID,B[b].position);$(".ui-dialog").on("keydown",function(d){var f=d.keyCode||d.which;KindleEventUtil.preventKeyScroll(d);switch(f){case 38:w&&w.removeClass(x);w=c(a,w,"prev");w.addClass(x);d.stopPropagation();break;case 40:w&&w.removeClass(x);w=c(a,w,"next");w.addClass(x);d.stopPropagation();break;case 13:w&&(d.stopPropagation(),w.removeClass(x),
d=w.attr("id"),KindleEventBroker.fire(d),e());break;case 9:e();D&&KindleUXComponentManager.hideMenu(b);break;case 27:e(),KindleUXComponentManager.hideMenu(b),d.preventDefault(),d.stopPropagation()}});a.find(m).children().each(function(a,b){$(b).on("mouseover",function(a){a=$(a.currentTarget);a.hasClass(t)&&(w?w!==a&&(w.removeClass(x),w=a,a.addClass(x)):(w=a,w.addClass(x)))})})}function g(a){$(".ui-dialog").off("keydown");a.find(m).children().each(function(a,b){$(b).off("mouseover")})}function a(a){return{getDialogSettings:function(){var b=
B[a],c=k;b.isAppBarMenu&&(c+=" "+p);b.buttonID&&(c+=" "+(b.position==="down"?l:r));return{autoOpen:!1,draggable:!1,resizable:!1,modal:!0,minHeight:0,width:"auto",dialogClass:c,k4w_transparent_modal_overlay:!0}},beforeDialogOpen:function(c){b(c,a)},beforeDialogClose:function(b){g(b,a)},onDialogOpen:function(){D=!0},onDialogClose:function(){D=!1},onOverlayClicked:function(){D&&KindleUXComponentManager.hideMenu(a);e()}}}var j="KindlePopupMenu",k="kindle_menu",m="#kindle_menu_border",l="down_menu",r=
"up_menu",o="kindle_menu_button",p="kindle_appbar_menu",n="appbar_menu_button",q="appbar_menu_title",t="button_enabled",u="ui-corner-top",G="ui-corner-bottom",x="selected",B={},D=!1,w=null;return{MENU_POSITION_CONSTANTS:{APPBAR_MENU_MARGIN_PX:5,APPBAR_HEIGHT_PX:102,APPBAR_HEIGHT_SNAPVIEW_PX:70},ITEM_ENABLED:0,ITEM_DISABLED:1,ITEM_HIDDEN:2,initialize:function(a){B[a.componentName]={menuItems:a.menuItems,doneCallback:a.doneCallback,buttonID:a.buttonID,position:a.position,title:a.title,isAppBarMenu:a.isAppBarMenu};
KindleUXComponentManager.hasTemplate(j)?f(a.componentName):KindleUXComponentManager.initializeTemplate(j,function(){f(a.componentName)})},updateMenu:function(a,b,c){for(var d,e,f=0;f<b.length;f++)b[f]!==2&&(d===void 0&&(d=f),e=f);var g=B[c].isAppBarMenu;a.find("."+o).each(function(a){var c=o;if(g||$(this).hasClass(n))c+=" "+n;$(this).attr("class",c);switch(b[a]){case 0:$(this).addClass(t);break;case 1:$(this).addClass("button_disabled");break;case 2:$(this).addClass("button_hidden")}a===d&&$(this).addClass(u);
a===e&&$(this).addClass(G)})},updatePosition:function(a,b){B[a].position=b}}}(),KindlePromptDialog=function(){var f={OK_BUTTON_STRING_ID:"k_common_confirm_button",CANCEL_BUTTON_STRING_ID:"k_common_cancel_button"},h={TEXT_LABEL_ID:"kindle_dialog_prompt_label"},d,e,c,b=function(){c="ok";KindleUXComponentManager.closeDialog("KindlePromptDialog")},g=function(){c="cancel";KindleUXComponentManager.closeDialog("KindlePromptDialog")},a={getDialogSettings:function(){var a={};a[ResourceBundle.getLocalizedString(f.CANCEL_BUTTON_STRING_ID)]=
g;a[ResourceBundle.getLocalizedString(f.OK_BUTTON_STRING_ID)]=b;return{autoOpen:!1,modal:!0,draggable:!1,resizable:!1,buttons:a,k4w_transparent_modal_overlay:!0}},beforeDialogOpen:function(a){var b=ResourceBundle.getLocalizedString(e);a.find("#"+h.TEXT_LABEL_ID).empty().append(b)},onDialogClose:function(){d(c)}};return{open:function(b,f){d=f;c=!1;e=b;KindleUXComponentManager.openDialog("KindlePromptDialog",a)}}}(),KindleSigningOutDialog=function(){var f={getDialogSettings:function(){return{autoOpen:!1,
modal:!0,draggable:!1,resizable:!1,width:"450px"}}};return{show:function(){KindleUXComponentManager.openDialog("KindleSigningOutDialog",f)},hide:function(){KindleUXComponentManager.closeDialog("KindleSigningOutDialog")}}}(),KindleSmallWindowDialog=function(){function f(){KindleUXComponentManager.closeDialog(h);b&&b()}var h="KindleSmallWindowDialog",d={BUTTON_TEXT:"k_dialog_smallWindow_button_ignore",TITLE:"k_dialog_smallWindow_title",DESCRIPTION:"k_dialog_smallWindow_msg"},e={DIALOG:"kindle_dialog_smallWindow",
CONTENT:"kindle_dialog_firstRun_content",TITLE:"small_window_title",DESCRIPTION:"small_window_description",BUTTON:"kindle_dialog_smallWindow_button"},c,b,g,a,j={getDialogSettings:function(){return{autoOpen:!1,width:"auto",modal:!0,draggable:!1,resizable:!1,dialogClass:"smallWindowDialog"}},beforeDialogOpen:function(b){g=b;g.find("#"+e.TITLE).html(a.title);g.find("#"+e.DESCRIPTION).html(a.description);b=g.find("#"+e.BUTTON);b.html(ResourceBundle.getLocalizedString(d.BUTTON_TEXT));b.one("click",f)},
onDialogOpen:function(){var a=$("#"+e.DIALOG);a.parents(".ui-dialog:first").removeClass("ui-widget ui-widget-content ui-corner-all");a.removeClass("ui-dialog-content ui-widget-content");c&&c()}};return{open:function(e){a={title:ResourceBundle.getLocalizedString(d.TITLE),description:ResourceBundle.getLocalizedString(d.DESCRIPTION)};b=e&&e.onDialogIgnoreCB;c=e&&e.onDialogOpenCB;KindleUXComponentManager.openDialog(h,j)},close:function(){KindleUXComponentManager.closeDialog(h)}}}(),KindleUnoptimizedFormatDialog=
function(){var f={TEXT_LABEL_STRING_ID:"k_R_dialog_unoptimizedFormat_message",METRO_TEXT_LABEL_STRING_ID:"k_R_dialog_unoptimizedFormat_metro_message",CLOSE_BUTTON_STRING_ID:"k_R_dialog_unoptimizedFormat_close",STOP_BUTTON_STRING_ID:"k_R_dialog_unoptimizedFormat_stopSave",CONTINUE_BUTTON_STRING_ID:"k_R_dialog_unoptimizedFormat_continue"},h={TEXT_LABEL_ID:"kindleReader_dialog_unoptimizedFormat_message_id"},d,e,c,b=function(){KindleUXComponentManager.closeDialog("KindleUnoptimizedFormatDialog")},g=function(){e=
!0;KindleUXComponentManager.closeDialog("KindleUnoptimizedFormatDialog")},a={getDialogSettings:function(){var a={};a[ResourceBundle.getLocalizedString(f.CLOSE_BUTTON_STRING_ID)]=b;a[ResourceBundle.getLocalizedString(f.CONTINUE_BUTTON_STRING_ID)]=g;return{autoOpen:!1,modal:!0,draggable:!1,resizable:!1,buttons:a,k4w_transparent_modal_overlay:!0}},beforeDialogOpen:function(a){var b=KindleHostDeviceDetector.isMetro()?f.METRO_TEXT_LABEL_STRING_ID:f.TEXT_LABEL_STRING_ID,b=ResourceBundle.getLocalizedString(b,
{linkStart:"<a href='http://itunes.apple.com/us/app/kindle/id302584613?mt=8'>",linkEnd:"</a>"});a.find("#"+h.TEXT_LABEL_ID).empty().append(b);$(a[0].parentNode).find(".ui-button-text").first().text(c)},onDialogClose:function(){d(e)}};return{open:function(b){c=ResourceBundle.getLocalizedString(f.CLOSE_BUTTON_STRING_ID);d=b;e=!1;KindleUXComponentManager.openDialog("KindleUnoptimizedFormatDialog",a)},openPinning:function(b){c=ResourceBundle.getLocalizedString(f.STOP_BUTTON_STRING_ID);d=b;e=!1;KindleUXComponentManager.openDialog("KindleUnoptimizedFormatDialog",
a)}}}(),KindleLibraryAppCacheFailDialog=function(){function f(){KindleUXComponentManager.closeDialog(h)}var h="KindleLibraryAppCacheFailDialog",d={DIALOG:"kindle_dialog_appCacheFail",IMG_ARROW_ID:"appCacheDialogFail_arrow",CONTENT_TEXT_ID:"appCacheDialogFail_content",TOGGLER_ID:"appCacheDialogFail_toggler",BUTTON:"kindle_appCacheDialog_button"},e=!1,c=!1,b,g={onDialogOpen:function(a){var b=$("#"+d.DIALOG);b.parents(".ui-dialog:first").removeClass("ui-widget ui-widget-content ui-corner-all");b.removeClass("ui-dialog-content ui-widget-content");
e=!0;a.dialog("option","position","center")},getDialogSettings:function(){return{autoOpen:!1,modal:!0,draggable:!1,resizable:!1,width:626,position:"center",k4w_transparent_modal_overlay:!0}},onInitializationDone:function(a){b=KindleModuleManager.getModuleSync(KindleModuleManager.METRICS_MANAGER);a.find("#"+d.BUTTON).bind("click",f);var e=a.find("#"+d.TOGGLER_ID),g=a.find("#"+d.IMG_ARROW_ID),h=a.find("#"+d.CONTENT_TEXT_ID);e.tap(function(){h.slideToggle("fast",function(){a.dialog("option","position",
"center")});g.hasClass("kindleLibrary_arrowClosed")?g.switchClass("kindleLibrary_arrowClosed","kindleLibrary_arrowOpen",0):g.switchClass("kindleLibrary_arrowOpen","kindleLibrary_arrowClosed",0);c||b.emit("KindleApp:AppCacheError:BrowserRebootPrompt:ExpandClicked",{breakdown:["Browser"]});c=!0})}};return{hasBeenShownThisSession:function(){return e},open:function(){KindleUXComponentManager.openDialog(h,g)},close:f}}(),KindleLibraryContextMenu=function(){function f(a){return function(){d();a(c)}}function h(c){function d(a,
b,c){return{elementId:a,content:b,clickHandler:c}}b={};var e=0,h;for(h in a)b[a[h]]=d(a[h],ResourceBundle.getLocalizedString(g[h]),f(c[e])),e++}function d(){KindleUXComponentManager.hideMenu(e)}var e="KindleLibraryContextMenu",c,b,g={ITEM_OPEN_BOOK:"k_L_context_read",ITEM_PIN:"k_L_context_pin",ITEM_REMOVE:"k_L_context_remove",ITEM_DOWNLOAD_PIN:"k_L_context_download_pin",ITEM_REVOKE_SAMPLE:"k_L_context_revoke_sample"},a={ITEM_OPEN_BOOK:"kindleLibrary_contextMenuItem_open_book",ITEM_PIN:"kindleLibrary_contextMenuItem_pin",
ITEM_REMOVE:"kindleLibrary_contextMenuItem_remove",ITEM_DOWNLOAD_PIN:"kindleLibrary_contextMenuItem_download_pin",ITEM_REVOKE_SAMPLE:"kindleLibrary_contextMenuItem_revoke"};return{isVisible:function(){return KindleUXComponentManager.isVisible(e)},show:function(a,d,f,g){c=a;b=null;h(g);KindleUXComponentManager.showMenu({componentName:e,menuItems:b,buttonID:null,position:f,title:null,isAppBarMenu:!1,enabledFlags:d})},hide:d}}(),KindleLibraryControlBar=function(){function f(a,b){var c=A.find("#"+a).children(),
d,e;for(d=0;d<c.length;d++)e=c[d].id,e===b?$(c[d]).addClass(D.ACTIVE):$(c[d]).removeClass(D.ACTIVE)}function h(a,b,c){var d=a.find("#"+b);d.tap(function(){if(c)return c(d[0]),!1})}function d(d){A=d;A.find("#view_"+k).addClass(D.ACTIVE);A.find("#view_"+m).addClass(D.ACTIVE);var l=a[o],r=a[t],u=a[p];h(d,x.VIEW_GRID_ID,function(a){f(x.LAYOUT_BUTTONS_ID,x.VIEW_GRID_ID);z&&z.show();l(a.getAttribute("value"))});h(d,x.VIEW_LIST_ID,function(a){f(x.LAYOUT_BUTTONS_ID,x.VIEW_LIST_ID);z&&z.hide();l(a.getAttribute("value"))});
h(d,x.SORT_BUTTON_ID,function(){u()});$.each(x.VIEW,function(a,b){h(d,b,function(a){!KindleHostDeviceDetector.isOnline()&&a.id===x.VIEW.CLOUD_ID||!KindleOffline.isEnabled()&&a.id===x.VIEW.DOWNLOAD_ID||f(x.VIEW_BUTTONS_ID,a.id);r(a.getAttribute("value"))})});switch(G()){case Kindle.APP_CACHE.CACHE_NEEDS_BROWSER_RESTART:c();break;case Kindle.APP_CACHE.CACHE_NEEDS_RETRY:c();break;case Kindle.APP_CACHE.CACHE_PROGRESS:e(H);break;case Kindle.APP_CACHE.CACHE_CACHED:b();break;case Kindle.APP_CACHE.CACHE_DONE:b()}if(KindleHostDeviceDetector.isiOS())g(d);
else{z=KindleLibraryImageSlider;var w={};w[z.EVENT_LIBRARY_IMAGE_CHANGING]=a[n];w[z.EVENT_LIBRARY_IMAGE_CHANGED]=a[q];z.initialize(function(a){a.insertAfter(A.find("#"+x.VIEW_TOGGLE_ID));g(d)},j,k,w)}}function e(a){H=a;A&&A.addClass(D.CACHING)}function c(){if(A){A.removeClass(D.CACHE_SUCCESS).addClass(D.CACHE_ERROR);var a=KindleHostDeviceDetector.isiPad()?B.CACHE_ERROR_MESSAGE_PAD:B.CACHE_ERROR_MESSAGE;A.find("#"+x.MESSAGE_ID).empty().append(ResourceBundle.getLocalizedString(a)).tap(u)}}function b(){A&&
(A.find("#"+x.MESSAGE_ID).empty().append(ResourceBundle.getLocalizedString(B.CACHE_DONE_MESSAGE)),A.removeClass(D.CACHE_ERROR).addClass(D.CACHE_SUCCESS),setTimeout(function(){A.removeClass(D.CACHING)},w))}var g,a,j,k,m,l,r=0,o=r++,p=r++,n=r++,q=r++,t=r++,u,G,x={VIEW_GRID_ID:"view_grid",VIEW_LIST_ID:"view_list",SORT_BUTTON_ID:"kindleLibrary_button_sort",VIEW:{DOWNLOAD_ID:"view_downloaded",CLOUD_ID:"view_cloud"},VIEW_BUTTONS_ID:"view_state_buttons",CONTAINER_ID:"view_sort_size_controls",LAYOUT_BUTTONS_ID:"view_buttons",
SORT_BUTTONS_ID:"view_sort",VIEW_TOGGLE_ID:"view_toggle",MESSAGE_ID:"cache_message"},B={CACHE_MESSAGE:"k_L_caching",CACHE_DONE_MESSAGE:"k_L_cached",CACHE_ERROR_MESSAGE:"k_L_cacheError",CACHE_ERROR_MESSAGE_PAD:"k_L_cacheError_pad"},D={ACTIVE:"btn_set_active",CACHING:"caching",CACHE_ERROR:"cacheError",CACHE_SUCCESS:"cacheSuccess"},w=3E3,A,z,H=1;return{EVENT_LIBRARY_LAYOUT_CLICKED:o,EVENT_LIBRARY_SORT_CLICKED:p,EVENT_LIBRARY_IMAGE_CHANGING:n,EVENT_LIBRARY_IMAGE_CHANGED:q,EVENT_LIBRARY_VIEW_CLICKED:t,
CONTAINER_HEIGHT:45,initialize:function(b,c,e){g=b;a=e;j=c.coverSize;k=c.layoutState;m=c.viewState;l=c.sortParam;KindleModuleManager.getModuleSync(KindleModuleManager.METRICS_MANAGER);b=ResourceBundle.getLocalizedString(KindleLibrarySort.getLabel(l));KindleUXComponentManager.initializeComponent("KindleLibraryControlBar",d,{sortParam:b})},setViewState:function(a){m=a;f(x.VIEW_BUTTONS_ID,"view_"+a)},setCacheProgress:e,setCacheNeedsRetry:c,setCacheDone:b,setRetryCallback:function(a){u=a},setAppCacheStatusGetter:function(a){G=
a},hideViewTabs:function(){$("#page_body").addClass("search_mode",200)},showViewTabs:function(){$("#page_body").removeClass("search_mode",200)}}}(),KindleLibraryFeedbackDialog=function(){function f(){KindleUXComponentManager.closeDialog(d)}function h(){var a=g.find("#"+c).val();if($.trim(a)){g.find("#"+c);var e=g.find("#"+b);e.addClass("sending").removeClass("success error");e.html(ResourceBundle.getLocalizedString("k_provide_feedback_sending"));KindleRemoteClient.uploadFeedback({text:a}).then(function(){e.removeClass("sending error").addClass("success");
e.html(ResourceBundle.getLocalizedString("k_provide_feedback_success"));setTimeout(function(){KindleUXComponentManager.closeDialog(d)},1500)},function(){e.removeClass("success sending").addClass("error");e.html(ResourceBundle.getLocalizedString("k_provide_feedback_error"))})}}var d="KindleLibraryFeedbackDialog",e={DIALOG_SEND_FEEDBACK_BTN_ID:"k_send_feedback_button",DIALOG_CANCEL_BTN_ID:"k_common_cancel_button"},c="kindleLibrary_feedback_area",b="kindleLibrary_feedback_status",g,a=function(a){a.which===
27&&f()},j={onInitializationDone:function(a){g=a;a.click(function(a){a.stopPropagation()});KindleTouchEventsToggler.isRequired()&&(g.find("#"+c).focus(function(){KindleTouchEventsToggler.off()}),g.find("#"+c).blur(function(){KindleTouchEventsToggler.on()}))},getDialogSettings:function(){var a={};a[ResourceBundle.getLocalizedString(e.DIALOG_CANCEL_BTN_ID)]=f;a[ResourceBundle.getLocalizedString(e.DIALOG_SEND_FEEDBACK_BTN_ID)]=h;return{autoOpen:!1,modal:!0,draggable:!1,resizable:!1,buttons:a,k4w_transparent_modal_overlay:!0}},
beforeDialogOpen:function(){g.find("#"+b).html("");g.find("#"+c).val("");KindleHostDeviceDetector.isiOS()&&g.find("#"+c).attr("tabindex","-1");g.find("#"+c).off("keydown",a);g.find("#"+c).on("keydown",a)}};return{show:function(){KindleUXComponentManager.openDialog(d,j)}}}(),KindleLibraryHeaderBar=function(){function f(a,b){a.find("#"+q[b]).tap(function(){var a=A[t[b]];a&&a();return!1})}function h(a){z=a;H=$(a.find("#"+q.SYNC_BUTTON_ID)[0]);var c=A[t.SYNC_BUTTON_ID];A[t.SYNC_BUTTON_ID]=function(){C||
c()};a.find(":not(.search)").click(function(){B&&b(!0)});var e=a.find("#"+q.SEARCH_BAR_ID),h=a.find("#"+q.CLEAR_BUTTON_ID);e.keydown(function(a){a.keyCode===13&&a.preventDefault()});KindleLibrary.registerControlHotkey("F",d);e.keyup(function(){var a=e.attr("value");if(x[G.SEARCH]&&(!KindleHostDeviceDetector.isArm()||a.length>1||a.length===0))x[G.SEARCH](a);a&&!D?h.fadeIn(200):!a&&D&&h.fadeOut(420);D=a});A[t.CLEAR_BUTTON_ID]=g;a.find("#"+q.SEARCH_BUTTON_ID).click(d);a.find("#"+q.CLEAR_BUTTON_ID).click(g);
for(var j in q)q[j]===q.SEARCH_BUTTON_ID||q[j]===q.SEARCH_BAR_ID||q[j]===q.CLEAR_BUTTON_ID||f(a,j);KindleTouchEventsToggler.isRequired()&&(e.focus(function(){KindleTouchEventsToggler.off(function(a){return a&&a.tagName==="BODY"?!1:!0})}),e.blur(function(){KindleTouchEventsToggler.on()}));setTimeout(function(){var b=a.find("#kindleLibrary_search"),c=a.find("#header_right"),b=b.position().left+b.outerWidth()+c.outerWidth()-$(document).width();b>0&&(b=e.width()-b,b>100&&e.width(b))},0);w(a)}function d(){B?
b(!0):e()}function e(){if(!I){I=!0;var a=$("#"+q.SEARCH_BAR_ID),b=$("#"+q.SEARCH_BUTTON_ID);B=!0;if(x[G.ENABLE])x[G.ENABLE]();a.attr("value","");a.show();a.prop("disabled",!1);a.focus();a.css("opacity",100);a.hide();b.fadeOut(150,function(){b.removeClass("header_bar_icon large");b.addClass("small");b.fadeIn(100);a.fadeIn(420,function(){I=!1;a.focus()})})}}function c(){if(KindleHostDeviceDetector.isiOS()){var a=$("#"+q.SEARCH_BUTTON_ID),b=$("#"+q.SEARCH_BAR_ID);b.detach();a.after(b)}}function b(a){if(B&&
!I){var b=$("#"+q.SEARCH_BAR_ID);if(!b.val().trim()||a){var d=$("#"+q.SEARCH_BUTTON_ID);I=!0;c();b.blur();B=!1;g();if(x[G.DISABLE])x[G.DISABLE]();b.fadeOut(333,function(){b.attr("disabled","disabled");b.css("opacity",0);d.hide();d.removeClass("small");d.addClass("header_bar_icon large");d.fadeIn(150,function(){I=!1})})}}}function g(){$("#"+q.SEARCH_BAR_ID).attr("value","");D="";$("#"+q.CLEAR_BUTTON_ID).fadeOut(420);B&&$("#"+q.SEARCH_BAR_ID).focus();if(x[G.SEARCH])x[G.SEARCH]("")}var a=0,j=a++,k=a++,
m=a++,l=a++,r=a++,o=a++,p=a++,n=a++,q={KINDLE_LOGO_ID:"kindleLibrary_kindleLogo",NOTEBOOK_BUTTON_ID:"kindleLibrary_button_notebook",SEARCH_BUTTON_ID:"kindleLibrary_button_search",SYNC_BUTTON_ID:"kindleLibrary_button_sync",MANAGE_BUTTON_ID:"kindleLibrary_button_manage",STORE_BUTTON_ID:"kindleLibrary_button_store",SEARCH_BAR_ID:"kindleLibrary_bar_search",CLEAR_BUTTON_ID:"kindleLibrary_clear_search"},t={KINDLE_LOGO_ID:j,SEARCH_BUTTON_ID:k,SEARCH_BAR_ID:m,CLEAR_BUTTON_ID:l,NOTEBOOK_BUTTON_ID:o,SYNC_BUTTON_ID:r,
MANAGE_BUTTON_ID:p,STORE_BUTTON_ID:n},a=0,l=a++,u=a++,a=a++,G={ENABLE:l,SEARCH:u,DISABLE:a},x,B=!1,D="",w,A,z,H,C=!1,I=!1;return{EVENT_LOGO_CLICKED:j,EVENT_SEARCH_CLICKED:k,EVENT_BAR_CLICKED:m,EVENT_NOTEBOOK_CLICKED:o,EVENT_SYNC_CLICKED:r,EVENT_MANAGE_CLICKED:p,EVENT_STORE_CLICKED:n,SEARCH_CALLBACK:G,initialize:function(a,b,c){w=a;A=b;x=c;KindleUXComponentManager.initializeComponent("KindleLibraryHeaderBar",h)},setSyncButtonDisabled:function(a){z&&(a?H.addClass("disabled"):H.removeClass("disabled"),
C=a)},activateSearch:e,deactivateSearch:b,dismissKeyboard:function(){B&&($("#"+q.SEARCH_BAR_ID).attr("value")===""?b():c())},clearSearch:g}}(),KindleLibraryHomeScreenPopup=function(){function f(a){var f=$(document.createElement("span")).addClass(d.STRONG_TEXT_CLASS).text(ResourceBundle.getLocalizedString(e.STRONG_TEXT_ID)).context.outerHTML;a.find("."+d.TEXT_CLASS).append(ResourceBundle.getLocalizedString(e.TEXT_ID,{addToHomeText:f}));$("body").append(a);KindleHostDeviceDetector.isiOS_7x()?$("#"+
d.POPUP_ID).addClass(d.IOS7):KindleHostDeviceDetector.isiOS_8x()&&$("#"+d.POPUP_ID).addClass(d.IOS8);setTimeout(function(){a.addClass(h);a.tap(function(){KindleHostDeviceDetector.isiOS_5xOrGreater()&&KindleLibraryHeaderBar.deactivateSearch();a.removeClass(h)});setTimeout(function(){a.removeClass(h)},b);setTimeout(function(){a.remove()},g)},c)}var h="shown",d={IMAGE_CLASS:"addToHomeActionIcon",TEXT_CLASS:"addToHomeText",STRONG_TEXT_CLASS:"addToHomeStrongText",POPUP_ID:"kindleAddToHomeScreen",IOS7:"ios7",
IOS8:"ios8"},e={TEXT_ID:"k_addToHomeScreen_text",STRONG_TEXT_ID:"k_addToHomeScreen_strong_text"},c=5E3,b=14E3,g=17E3,a;return{show:function(){!a&&KindleHostDeviceDetector.isiOS()&&!KindleHostDeviceDetector.isInAppMode()&&(a=!0,KindleUXComponentManager.initializeComponent("KindleLibraryHomeScreenPopup",f))}}}(),KindleLibraryImageSlider=function(){function f(){k&&k.hide()}function h(g){k=g;var h=c[a],o=c[j],p=k.find("#"+m.IMAGE_SLIDER_ID);p.slider({range:"min",value:d,max:12,min:6,step:1,animate:!0,
slide:h,change:o});p.find(".ui-slider-handle").removeAttr("href");p.find(".ui-slider-handle").attr("id",m.IMAGE_SLIDER_HANDLE_ID);e==="list"&&f();b(g)}var d,e,c,b,g=0,a=g++,j=g++,k,m={IMAGE_SLIDER_ID:"kindleLibrary_coverImage_slider",IMAGE_SLIDER_HANDLE_ID:"kindleLibrary_coverImage_slider_handle"};return{EVENT_LIBRARY_IMAGE_CHANGING:a,EVENT_LIBRARY_IMAGE_CHANGED:j,initialize:function(a,f,g,j){b=a;e=g;c=j;d=f;KindleUXComponentManager.initializeComponent("KindleLibraryImageSlider",h)},show:function(){k&&
k.show()},hide:f}}(),KindleLibraryJPMerchandiseDialog=function(){function f(){KindleUXComponentManager.closeDialog(j);t()}function h(a){a&&(a=(a.target||a.srcElement).getAttribute("data-asin"),q(a))}function d(a){if(a&&a.length>0){var b=$("#"+l.ContentContainer);b.empty();var d=KindleUXComponentManager.renderTemplate(k,{bookList:a});b.append(d);b=d.find("."+r.BookCover);b.on("click",h);var e=0,f=a.length;b.bind("load",function(){e++;e===f&&c()}).each(function(){this.complete&&$(this).load()})}}function e(){var a=
$("#"+l.Pane),d=b();a.dialog("option","height",d.height);a.dialog("option","width",d.width);a.dialog("option","position",{my:"center",at:"center",of:window});c()}function c(){var a=$("#"+l.ScrollPane);p?a.jScrollPane({showArrows:!0,verticalGutter:35}):o?n?n.refresh():n=new iScroll(l.ScrollWrapper,{vScrollbar:!1}):a.addClass("ie_scrollable");$("#"+l.ScrollPane).focus()}function b(){var a;a=KindleHostDeviceDetector.isiOS()?$("body",Kindle.top.document).height()-100:KindleHostDeviceDetector.isMetro()?
window.outerHeight-250:window.innerHeight-100;var b=window.outerWidth<960?Math.max(720,window.outerWidth):960,b=KindleHostDeviceDetector.isiOS()?"80%":b-30+"px";return{height:a,width:b}}function g(){var a={};a[ResourceBundle.getLocalizedString(m.CLOSE_BUTTON_STRING_ID)]=f;var c={},c=b();return c={autoOpen:!1,width:c.width,height:c.height,modal:!0,draggable:!1,resizable:!1,buttons:a}}function a(){clearTimeout(u);u=setTimeout(e,50)}var j="KindleLibraryJPMerchandiseDialog",k="KindleLibraryJPMerchandiseContent",
m={CLOSE_BUTTON_STRING_ID:"k_common_close_button"},l={Pane:"kindleLibrary_jp_merchandise_pane",ContentContainer:"kindleLibrary_jp_merchandise_content",ScrollPane:"kindleLibrary_jp_merchandise_scrollPane",ScrollWrapper:"kindleLibrary_jp_merchandise_scrollWrapper"},r={BookCover:"book_merch_image"},o=KindleHostDeviceDetector.isiOS(),p=!o&&!KindleHostDeviceDetector.isIE(),n,q,t,u;return{open:function(b,c,e){q=c;t=e;KindleUXComponentManager.openDialog(j,{onDialogOpen:function(){d(b);$(window).on("resize",
a)},onDialogClose:function(){$(window).off("resize",a)},getDialogSettings:g})}}}(),KindleLibraryMessagePane=function(){function f(a){g=!1;a.find(h.EMPTY_LIBRARY_BOX).tap(function(){b();return!0});var f=ResourceBundle.getLocalizedString(e.EMPTY_SEARCH_MSG);a.find("#"+h.EMPTY_SEARCH_TEXT).text(f);f=ResourceBundle.getLocalizedString(e.EMPTY_SEARCH_OFFLINE);a.find("#"+h.EMPTY_SEARCH_DETAIL).text(f);f=ResourceBundle.getLocalizedString(e.EMPTY_LIBRARY_storeName);f=ResourceBundle.getLocalizedString(j?e.EMPTY_LIBRARY_MANGA_MSG:
e.EMPTY_LIBRARY_MSG,{storeName:f});a.find(h.EMPTY_LIBRARY_MAIN).text(f);j&&(f=ResourceBundle.getLocalizedString(e.EMPTY_LIBRARY_MANGA_BUTTON),a.find("."+d.EMPTY_LIBRARY_BUTTON).text(f));c(a)}var h={EMPTY_LIBRARY_BOX:"#empty-lib-box",EMPTY_LIBRARY_MAIN:"#empty-lib-box p.main",EMPTY_LIBRARY_FREE:"#empty-lib-box p.free",EMPTY_SEARCH_BOX:"#empty_search_box",EMPTY_SEARCH_TEXT:"#empty_search_text",EMPTY_SEARCH_DETAIL:"#empty_search_detail"},d={EMPTY_LIBRARY_STORENAME:"store-name",EMPTY_LIBRARY_BUTTON:"primary_btn"},
e={EMPTY_SEARCH_MSG:"k_empty_search_msg",EMPTY_SEARCH_OFFLINE:"k_empty_search_offline",EMPTY_LIBRARY_MSG:"k_empty_library_main",EMPTY_LIBRARY_storeName:"k_empty_library_store_name",EMPTY_LIBRARY_MANGA_MSG:"k_empty_library_manga_msg",EMPTY_LIBRARY_MANGA_BUTTON:"k_empty_library_manga_button"},c,b,g,a,j;return{initialize:function(a,d,e){c=a;b=d;j=e;KindleUXComponentManager.initializeComponent("KindleLibraryMessagePane",f)},showEmptyLibraryMessage:function(){function a(){var c=b[0].getClientRects()[0].top,
d=b.find(".legal")[0].getClientRects()[0].bottom,e=parseInt(b.css("padding-bottom"),10),c=d-c-e;c>200&&b.css({height:c})}var b=$(h.EMPTY_LIBRARY_BOX);g||($("#page_body_content_containers").hide(),b.show(),g=!0,a())},hideEmptyLibraryMessage:function(){g&&($("#page_body_content_containers").show(),$(h.EMPTY_LIBRARY_BOX).hide(),g=!1)},showEmptySearchMessage:function(b){!a&&!g&&($("#page_body_content_containers").hide(),$(h.EMPTY_SEARCH_BOX).show(),$(h.EMPTY_SEARCH_TEXT).show(),b?$(h.EMPTY_SEARCH_DETAIL).show():
$(h.EMPTY_SEARCH_DETAIL).hide(),a=!0)},hideEmptySearchMessage:function(){a&&($("#page_body_content_containers").show(),$(h.EMPTY_SEARCH_BOX).hide(),$(h.EMPTY_SEARCH_TEXT).hide(),$(h.EMPTY_SEARCH_DETAIL).hide(),a=!1)}}}(),KindleLibraryNoDownloadedMessage=function(){function f(f){c=f;var f=c.find("."+e.TOGGLER_CLASS),a=c.find("."+e.IMG_ARROW_CLASS),j=c.find("."+e.CONTENT_TEXT_CLASS);f.tap(function(){j.slideToggle("fast");a.hasClass(h)?a.switchClass(h,d,0):a.switchClass(d,h,0)});b.resolve()}var h="kindleLibrary_arrowClosed",
d="kindleLibrary_arrowOpen",e={TOGGLER_CLASS:"kindleLibrary_noDownloadedToggle",CONTENT_TEXT_CLASS:"kindleLibrary_noDownloadedContent",IMG_ARROW_CLASS:"kindleLibrary_noDownloadedArrow"},c,b;return{show:function(){b||(b=new jQuery.Deferred,KindleUXComponentManager.initializeComponent("KindleLibraryNoDownloadedMessage",f));b.promise().then(function(){$("#kindleLibrary_noDownloadsMsg").length<=0&&$("#titles_container").append(c)})},hide:function(){b&&c.detach()}}}(),KindleLibraryProgressDialog=function(){function f(){KindleUXComponentManager.closeDialog(d);
b()}function h(a){g&&a>=0&&a<=100&&g.find("#"+c.PROGRESS_DIV_ID).slider("option","value",a)}var d="KindleLibraryProgressDialog",e={DIALOG_CANCEL_BTN_ID:"k_common_cancel_button"},c={PROGRESS_DIV_ID:"kindleLibrary_progressbar_div"},b,g,a={getDialogSettings:function(){var a={};a[ResourceBundle.getLocalizedString(e.DIALOG_CANCEL_BTN_ID)]=f;return{autoOpen:!1,modal:!0,draggable:!1,resizable:!1,buttons:a,k4w_transparent_modal_overlay:!0}},beforeDialogOpen:function(){h(0)},onInitializationDone:function(a){g=
a;g.find("#"+c.PROGRESS_DIV_ID).slider({range:"min",value:0,disabled:!0,max:100,min:0,step:1,animate:!0});g.find(".ui-slider-range").addClass("ui-corner-all")}};return{open:function(c){b=c;KindleUXComponentManager.openDialog(d,a)},close:function(){KindleUXComponentManager.closeDialog(d)},updateValue:h}}(),KindleLibraryScrollBar=function(){function f(a){u=a;g(u.find("#"+m.UP_ARROW_ID),!0);g(u.find("#"+m.DOWN_ARROW_ID),!1);D&&k();q(u)}function h(a,b){w=z-b.value;t(w,!1)}function d(a,b){w=z-b.value;
t(w,!0)}function e(a){w=a;u.find("#"+m.PROGRESS_ID).slider("option","value",z-a)}function c(a){a=w+a;a=Math.min(a,z);a=Math.max(a,0);e(a);t(a,!0)}function b(){u.find("#"+m.PROGRESS_ID).slider({orientation:"vertical",animate:!0,slide:h,stop:d});u.find("."+l).removeAttr("href");u.find("."+l).attr("id",m.SLIDER_HANDLE_ID);u.find("#"+m.SLIDER_CONTAINER_ID).tap(function(a){w=a.clientY<a.currentTarget.offsetHeight/2?0:z;e(w);t(w,!0)});G=!0}function g(b,c){b.bind({mousedown:function(){a(c)},mouseup:j,mouseleave:j})}
function a(a){j();var b=a?-r:r;c(b);B=0;x=setInterval(function(){B++;B>=p&&c(b)},o)}function j(){clearInterval(x)}function k(){G||b();var a=u.find("#"+m.SLIDER_CONTAINER_ID).height(),a=Math.max(a*A/D,n);u.find("#"+m.SLIDER_DIV_ID).css({top:a/2+"px",bottom:a/2+"px"});z=D-A;u.find("#"+m.PROGRESS_ID).slider("option","min",0).slider("option","max",z);e(w);u.find("."+l).css({"margin-bottom":-a/2+"px",height:a+"px"})}var m={SLIDER_CONTAINER_ID:"KindleLibrarySliderContainer",SLIDER_DIV_ID:"KindleLibrarySliderDiv",
SLIDER_HANDLE_ID:"kindleLibrarySliderHandle",PROGRESS_ID:"KindleLibraryProgress",UP_ARROW_ID:"kindleLibrarySliderUpArrow",DOWN_ARROW_ID:"kindleLibrarySliderDownArrow"},l="ui-slider-handle",r=80,o=100,p=5,n=20,q,t,u,G,x,B,D,w,A,z;return{initialize:function(a,b){q=a;t=b;KindleUXComponentManager.initializeComponent("KindleLibraryScrollBar",f)},updateValueRange:function(a,b,c){D=a;w=b;A=c;u&&k()},updateValue:function(a){w=a;u&&e(a)},moveStart:a,moveEnd:j,movePage:function(a){c(a?-A:A)}}}(),KindleLibrarySettingsMenu=
function(){function f(){c();KindleSigningOutDialog.show();KindleX.deregister(null,!0).progress(function(a){var b=KindleModuleManager.getModuleSync(KindleModuleManager.LINK_URLS);a&&(a.clearDbAttempts>=1?(KindleMessageDialog.open(ResourceBundle.getLocalizedString(g.PREV_SIGNOUT_FAILED_TITLE),ResourceBundle.getLocalizedString(g.PREV_SIGNOUT_FAILED_TEXT),null,null,[{buttonText:ResourceBundle.getLocalizedString(g.OK_ID)},{buttonText:ResourceBundle.getLocalizedString(g.HELP_ID),callback:function(){window.open(b.getTroubleshootingUrl())}}]),
KindleModuleManager.getModuleSync(KindleModuleManager.METRICS_MANAGER).emit("Library::SignOut::PrevAttemptFailed",{breakdown:["Browser"]})):a.blocked&&KindleMessageDialog.open(ResourceBundle.getLocalizedString(g.DB_BLOCKED_TITLE),ResourceBundle.getLocalizedString(g.DB_BLOCKED_TEXT)))}).fail(function(){KindleSigningOutDialog.hide();KindleMessageDialog.open(ResourceBundle.getLocalizedString(g.OFFLINE_LOGOUT_TITLE),ResourceBundle.getLocalizedString(g.OFFLINE_LOGOUT_TEXT))})}function h(){c();KindleLibraryFeedbackDialog.show()}
function d(){function b(a,c,d){return{elementId:a,content:c,clickHandler:d}}var c={},d=KindleModuleManager.getModuleSync(KindleModuleManager.LINK_URLS);c.ITEM_HELP=b(a.ITEM_HELP,ResourceBundle.getLocalizedString(g.HELP_ID),e(d.getHelpUrl(),a.ITEM_HELP));c.ITEM_TERMS=b(a.ITEM_TERMS,ResourceBundle.getLocalizedString(g.TERM_OF_USE_ID),e(d.getTermsOfUseUrl(),a.ITEM_TERMS));c.ITEM_LEGAL=b(a.ITEM_LEGAL,ResourceBundle.getLocalizedString(g.LEGAL_NOTICE_ID),e(d.getLegalUrl(),a.ITEM_LEGAL));c.ITEM_PRIVACY=
b(a.ITEM_PRIVACY,ResourceBundle.getLocalizedString(g.PRIVACY_ID),e(d.getPrivacyUrl(),a.ITEM_PRIVACY));c.ITEM_CONTACT_US=b(a.ITEM_CONTACT_US,ResourceBundle.getLocalizedString(g.CONTACT_US_ID),h);c.ITEM_DEREGISTER=b(a.ITEM_DEREGISTER,ResourceBundle.getLocalizedString(g.DEREGISTER_ID),f);return c}function e(b,d){var e=KindleModuleManager.getModuleSync(KindleModuleManager.METRICS_MANAGER);return function(){switch(d){case a.ITEM_HELP:e.emit("Library::Open::HelpLink");break;case a.ITEM_TERMS:e.emit("Library::Open::TermsLink");
break;case a.ITEM_LEGAL:e.emit("Library::Open::Legal");break;case a.ITEM_PRIVACY:e.emit("Library::Open::PrivacyLink")}c();j(b)}}function c(){KindleUXComponentManager.hideMenu(b)}var b="KindleLibrarySettingsMenu",g={OK_ID:"k_common_confirm_button",HELP_ID:"k_L_help",TERM_OF_USE_ID:"k_L_terms_of_use",LEGAL_NOTICE_ID:"k_L_legal_notices",PRIVACY_ID:"k_L_privacy",DEREGISTER_ID:"k_L_deregister_title",CONTACT_US_ID:"k_L_contact_us",OFFLINE_LOGOUT_TITLE:"k_dialog_offlineLogout_Title",OFFLINE_LOGOUT_TEXT:"k_dialog_offlineLogout_Text",
DB_BLOCKED_TITLE:"k_dialog_dbBlocked_Title",DB_BLOCKED_TEXT:"k_dialog_dbBlocked_Text",PREV_SIGNOUT_FAILED_TITLE:"k_dialog_prevSignOutFailed_Title",PREV_SIGNOUT_FAILED_TEXT:"k_dialog_prevSignOutFailed_Text"},a={ITEM_HELP:"kindleLibrary_settingsMenu_item_help",ITEM_TERMS:"kindleLibrary_settingsMenu_item_terms",ITEM_LEGAL:"kindleLibrary_settingsMenu_item_legal",ITEM_PRIVACY:"kindleLibrary_settingsMenu_item_privacy",ITEM_CONTACT_US:"kindleLibrary_settingsMenu_item_contactUs",ITEM_DEREGISTER:"kindleLibrary_settingsMenu_item_signOut"},
j;return{show:function(a){j=a;a={componentName:b,menuItems:d(),buttonID:"kindleLibrary_button_manage",position:"down",title:null,isAppBarMenu:!1,enabledFlags:null};KindleUXComponentManager.showMenu(a)},hide:c}}(),KindleLibrarySortMenu=function(){function f(e){function c(b,a,c){return{elementId:b,content:a,clickHandler:c}}var b={};b.ITEM_SORT_RECENT=c(d.ITEM_SORT_RECENT,ResourceBundle.getLocalizedString(h.SORT_RECENT),function(){KindleLibrarySortMenu.hide();e("recent")});b.ITEM_SORT_AUTHOR=c(d.ITEM_SORT_AUTHOR,
ResourceBundle.getLocalizedString(h.SORT_AUTHOR),function(){KindleLibrarySortMenu.hide();e("author")});b.ITEM_SORT_TITLE=c(d.ITEM_SORT_TITLE,ResourceBundle.getLocalizedString(h.SORT_TITLE),function(){KindleLibrarySortMenu.hide();e("title")});return b}var h={SORT_RECENT:"k_L_sort_recent",SORT_AUTHOR:"k_L_sort_author",SORT_TITLE:"k_L_sort_title"},d={ITEM_SORT_RECENT:"kindleLibrary_sortMenuItem_sortByRecent",ITEM_SORT_AUTHOR:"kindleLibrary_sortMenuItem_sortByAuthor",ITEM_SORT_TITLE:"kindleLibrary_sortMenuItem_sortByTitle"};
return{show:function(d,c){var b={componentName:"KindleLibrarySortMenu",menuItems:f(c),buttonID:"kindleLibrary_button_sort",position:d,title:null,isAppBarMenu:!1,enabledFlags:null};KindleUXComponentManager.showMenu(b)},hide:function(){KindleUXComponentManager.hideMenu("KindleLibrarySortMenu")}}}(),KindleUnsupportedContentDialog=function(){function f(){KindleUXComponentManager.closeDialog(d)}function h(){c.emit("UnsupportedContentDialog::GetAppLink")}var d="KindleUnsupportedContentDialog",e=KindleHostDeviceDetector.isiOS(),
c,b={textMeWidgetWrapper:"#unsupportedContent_text_me_widget_wrapper",getApp:"#unsupportedContent_get_app_button"},g={getDialogSettings:function(){var a={};a[ResourceBundle.getLocalizedString("k_common_close_button")]=f;return{width:"500px",autoOpen:!1,modal:!0,draggable:!1,resizable:!1,buttons:a}},beforeDialogOpen:function(a){if(a.find(".textMe_widget").length===0){var c=new KindleTextMeWidget({showAppleLogo:!0,showWindowsLogo:!1,showAmazonLogo:!0,showAndroidLogo:!0},d);a.find(b.textMeWidgetWrapper).append(c);
a.find("#"+b.getApp).click(h)}}};return{open:function(){var a=KindleModuleManager.getModuleSync(KindleModuleManager.LINK_URLS);c||(c=KindleModuleManager.getModuleSync(KindleModuleManager.METRICS_MANAGER));a={getAppLink:a.getKCPLandingPageLink(),isiPad:e};KindleUXComponentManager.openDialog(d,g,a)}}}();
function KindleBadgingFactory(){return{drawBadge:function(f,h,d){var e=Math.PI/180,c=36/Math.sqrt(2),b=(c-10)/2,g=f.getContext("2d");g.fillStyle=d;g.beginPath();g.rotate(45*e);g.fillRect(0,0,500,-c);g.stroke();g.beginPath();g.fillStyle="#FFFFFF";g.font="10pt Helvetica";g.opacity=0.95;g.fillText(h,f.width/2-(h.length>5?(h.length-5)*4:0),-b);g.stroke()},createCanvasElement:function(){var f=document.createElement("canvas");f.className="canvas_for_badge";f.height=100;f.width=100;return f},pushAsinForBadgeUpdate:function(f){var h=
JSON.parse(KindleLocalStorage.getItem("listOfAsinsForBadging"));if(h){var d;a:{for(d in h)if(h[d]===f){d=!0;break a}d=!1}d||(h[h.length]=f,KindleLocalStorage.setItem("listOfAsinsForBadging",JSON.stringify(h)))}else h=[],h[0]=f,KindleLocalStorage.setItem("listOfAsinsForBadging",JSON.stringify(h))},addBadgeToBookContainer:function(f,h,d){d.find(".book_cover").append("<div class='book_image_container'></div>");d.find(".book_image").appendTo(d.find(".book_image_container"));var e=$("<div>").addClass("book_badge_container");
e.append(h);d.find(".book_image_container").append(e);d.find(".book_details").append(f);d.find(".canvas_for_badge").addClass("book_click_area")},adjustBadge:function(f){f.find(".book_image_container").find(".book_click_area").hasClass("book_image_wide")&&f.find(".book_image_container").addClass("wide")},cloneCanvasForBadge:function(f){var h=document.createElement("canvas"),d=h.getContext("2d");h.width=f.width;h.height=f.height;h.className=f.className;d.drawImage(f,0,0);return h}}}
var KindleBadging=KindleBadgingFactory();
