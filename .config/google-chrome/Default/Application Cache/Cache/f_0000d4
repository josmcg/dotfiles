/*
 * Copyright (c) 2014 Amazon.com, Inc. All rights reserved.
 */
var goog=goog||{};goog.userAgent=goog.userAgent||{};goog.global=this;goog.string=goog.string||{};goog.string.contains=function(a,g){return a.indexOf(g)!==-1};goog.userAgent.ASSUME_IE=!1;goog.userAgent.ASSUME_GECKO=!1;goog.userAgent.ASSUME_WEBKIT=!1;goog.userAgent.ASSUME_MOBILE_WEBKIT=!1;goog.userAgent.ASSUME_OPERA=!1;goog.userAgent.BROWSER_KNOWN_=goog.userAgent.ASSUME_IE||goog.userAgent.ASSUME_GECKO||goog.userAgent.ASSUME_MOBILE_WEBKIT||goog.userAgent.ASSUME_WEBKIT||goog.userAgent.ASSUME_OPERA;
goog.userAgent.getUserAgentString=function(){return goog.global.navigator?goog.global.navigator.userAgent:null};goog.userAgent.getNavigator=function(){return goog.global.navigator};
goog.userAgent.init_=function(){goog.userAgent.detectedOpera_=!1;goog.userAgent.detectedIe_=!1;goog.userAgent.detectedWebkit_=!1;goog.userAgent.detectedMobile_=!1;goog.userAgent.detectedGecko_=!1;var a;if(!goog.userAgent.BROWSER_KNOWN_&&(a=goog.userAgent.getUserAgentString())){var g=goog.userAgent.getNavigator();if(a.indexOf("Opera")===0)goog.userAgent.detectedOpera_=!0,goog.userAgent.ENGINE="Opera";if(!goog.userAgent.detectedOpera_&&a.indexOf("MSIE")!==-1)goog.userAgent.detectedIe_=!0,goog.userAgent.ENGINE=
"IE";if(!goog.userAgent.detectedOpera_&&a.indexOf("WebKit")!==-1)goog.userAgent.detectedWebkit_=!0,goog.userAgent.ENGINE="WebKit";if(goog.userAgent.detectedWebkit_&&a.indexOf("Mobile")!==-1)goog.userAgent.detectedMobile_=!0;if(!goog.userAgent.detectedOpera_&&!goog.userAgent.detectedWebkit_&&g.product==="Gecko")goog.userAgent.detectedGecko_=!0,goog.userAgent.ENGINE="Gecko"}};goog.userAgent.BROWSER_KNOWN_||goog.userAgent.init_();
goog.userAgent.OPERA=goog.userAgent.BROWSER_KNOWN_?goog.userAgent.ASSUME_OPERA:goog.userAgent.detectedOpera_;goog.userAgent.IE=goog.userAgent.BROWSER_KNOWN_?goog.userAgent.ASSUME_IE:goog.userAgent.detectedIe_;goog.userAgent.GECKO=goog.userAgent.BROWSER_KNOWN_?goog.userAgent.ASSUME_GECKO:goog.userAgent.detectedGecko_;goog.userAgent.WEBKIT=goog.userAgent.BROWSER_KNOWN_?goog.userAgent.ASSUME_WEBKIT||goog.userAgent.ASSUME_MOBILE_WEBKIT:goog.userAgent.detectedWebkit_;
goog.userAgent.MOBILE=goog.userAgent.ASSUME_MOBILE_WEBKIT||goog.userAgent.detectedMobile_;goog.userAgent.SAFARI=goog.userAgent.WEBKIT;goog.userAgent.determinePlatform_=function(){var a=goog.userAgent.getNavigator();return a&&a.platform||""};goog.userAgent.PLATFORM=goog.userAgent.determinePlatform_();goog.userAgent.ASSUME_MAC=!1;goog.userAgent.ASSUME_WINDOWS=!1;goog.userAgent.ASSUME_LINUX=!1;goog.userAgent.ASSUME_X11=!1;
goog.userAgent.PLATFORM_KNOWN_=goog.userAgent.ASSUME_MAC||goog.userAgent.ASSUME_WINDOWS||goog.userAgent.ASSUME_LINUX||goog.userAgent.ASSUME_X11;
goog.userAgent.initPlatform_=function(){goog.userAgent.OS="";if(goog.string.contains(goog.userAgent.PLATFORM,"Mac"))goog.userAgent.detectedMac_=!0,goog.userAgent.OS="Mac";if(goog.string.contains(goog.userAgent.PLATFORM,"Win"))goog.userAgent.detectedWindows_=!0,goog.userAgent.OS="Windows";if(goog.string.contains(goog.userAgent.PLATFORM,"Linux"))goog.userAgent.detectedLinux_=!0,goog.userAgent.OS="Linux";if(goog.userAgent.getNavigator()&&goog.string.contains(goog.userAgent.getNavigator().appVersion||
"","X11"))goog.userAgent.detectedX11_=!0,goog.userAgent.OS="X11"};goog.userAgent.PLATFORM_KNOWN_||goog.userAgent.initPlatform_();goog.userAgent.MAC=goog.userAgent.PLATFORM_KNOWN_?goog.userAgent.ASSUME_MAC:goog.userAgent.detectedMac_;goog.userAgent.WINDOWS=goog.userAgent.PLATFORM_KNOWN_?goog.userAgent.ASSUME_WINDOWS:goog.userAgent.detectedWindows_;goog.userAgent.LINUX=goog.userAgent.PLATFORM_KNOWN_?goog.userAgent.ASSUME_LINUX:goog.userAgent.detectedLinux_;
goog.userAgent.X11=goog.userAgent.PLATFORM_KNOWN_?goog.userAgent.ASSUME_X11:goog.userAgent.detectedX11_;
goog.userAgent.determineVersion_=function(){var a="",g;goog.userAgent.OPERA&&goog.global.opera?(a=goog.global.opera.version,a=typeof a==="function"?a():a):(goog.userAgent.GECKO?g=/rv\:([^\);]+)(\)|;)/:goog.userAgent.IE?g=/MSIE\s+([^\);]+)(\)|;)/:goog.userAgent.WEBKIT&&(g=/WebKit\/(\S+)/),g&&(a=(a=g.exec(goog.userAgent.getUserAgentString()))?a[1]:""));return goog.userAgent.IE&&(g=goog.userAgent.getDocumentMode_(),g>parseFloat(a))?String(g):a};
goog.userAgent.getDocumentMode_=function(){var a=goog.global.document;return a?a.documentMode:void 0};goog.userAgent.VERSION=goog.userAgent.determineVersion_();goog.userAgent.isDocumentModeCache_={};goog.userAgent.isDocumentMode=function(a){return goog.userAgent.isDocumentModeCache_[a]||(goog.userAgent.isDocumentModeCache_[a]=goog.userAgent.IE&&document.documentMode&&document.documentMode>=a)};goog.userAgent.product=goog.userAgent.product||{};goog.userAgent.product.ASSUME_FIREFOX=!1;
goog.userAgent.product.ASSUME_CAMINO=!1;goog.userAgent.product.ASSUME_IPHONE=!1;goog.userAgent.product.ASSUME_IPAD=!1;goog.userAgent.product.ASSUME_ANDROID=!1;goog.userAgent.product.ASSUME_CHROME=!1;goog.userAgent.product.ASSUME_SAFARI=!1;
goog.userAgent.product.PRODUCT_KNOWN_=goog.userAgent.ASSUME_IE||goog.userAgent.ASSUME_OPERA||goog.userAgent.product.ASSUME_FIREFOX||goog.userAgent.product.ASSUME_CAMINO||goog.userAgent.product.ASSUME_IPHONE||goog.userAgent.product.ASSUME_IPAD||goog.userAgent.product.ASSUME_ANDROID||goog.userAgent.product.ASSUME_CHROME||goog.userAgent.product.ASSUME_SAFARI;
goog.userAgent.product.init_=function(){goog.userAgent.product.BROWSER_NAME="";goog.userAgent.product.detectedFirefox_=!1;goog.userAgent.product.detectedCamino_=!1;goog.userAgent.product.detectedIphone_=!1;goog.userAgent.product.detectedIpad_=!1;goog.userAgent.product.detectedAndroid_=!1;goog.userAgent.product.detectedChrome_=!1;goog.userAgent.product.detectedSafari_=!1;var a=goog.userAgent.getUserAgentString();if(a)if(a.indexOf("iPhone")!==-1||a.indexOf("iPod")!==-1)goog.userAgent.product.detectedIphone_=
!0,goog.userAgent.product.BROWSER_NAME="iPhone";else if(a.indexOf("iPad")!==-1)goog.userAgent.product.detectedIpad_=!0,goog.userAgent.product.BROWSER_NAME="iPad";else if(a.indexOf("Android")!==-1)goog.userAgent.product.detectedAndroid_=!0,goog.userAgent.product.BROWSER_NAME="Android";else if(a.indexOf("Chrome")!==-1)goog.userAgent.product.detectedChrome_=!0,goog.userAgent.product.BROWSER_NAME="Chrome";else if(a.indexOf("Safari")!==-1)goog.userAgent.product.detectedSafari_=!0,goog.userAgent.product.BROWSER_NAME=
"Safari";else if(a.indexOf("MSIE")!==-1)goog.userAgent.product.detectedIe_=!0,goog.userAgent.product.BROWSER_NAME="IE";else if(a.indexOf("Camino")!==-1)goog.userAgent.product.detectedCamino_=!0,goog.userAgent.product.BROWSER_NAME="Camino";else if(a.indexOf("Firefox")!==-1)goog.userAgent.product.detectedFirefox_=!0,goog.userAgent.product.BROWSER_NAME="Firefox"};goog.userAgent.product.PRODUCT_KNOWN_||goog.userAgent.product.init_();goog.userAgent.product.OPERA=goog.userAgent.OPERA;
goog.userAgent.product.IE=goog.userAgent.IE;goog.userAgent.product.FIREFOX=goog.userAgent.product.PRODUCT_KNOWN_?goog.userAgent.product.ASSUME_FIREFOX:goog.userAgent.product.detectedFirefox_;goog.userAgent.product.CAMINO=goog.userAgent.product.PRODUCT_KNOWN_?goog.userAgent.product.ASSUME_CAMINO:goog.userAgent.product.detectedCamino_;goog.userAgent.product.IPHONE=goog.userAgent.product.PRODUCT_KNOWN_?goog.userAgent.product.ASSUME_IPHONE:goog.userAgent.product.detectedIphone_;
goog.userAgent.product.IPAD=goog.userAgent.product.PRODUCT_KNOWN_?goog.userAgent.product.ASSUME_IPAD:goog.userAgent.product.detectedIpad_;goog.userAgent.product.ANDROID=goog.userAgent.product.PRODUCT_KNOWN_?goog.userAgent.product.ASSUME_ANDROID:goog.userAgent.product.detectedAndroid_;goog.userAgent.product.CHROME=goog.userAgent.product.PRODUCT_KNOWN_?goog.userAgent.product.ASSUME_CHROME:goog.userAgent.product.detectedChrome_;
goog.userAgent.product.SAFARI=goog.userAgent.product.PRODUCT_KNOWN_?goog.userAgent.product.ASSUME_SAFARI:goog.userAgent.product.detectedSafari_;goog.userAgent.platform=goog.userAgent.platform||{};goog.userAgent.platform.determineVersion_=function(){var a;if(goog.userAgent.WINDOWS)return a=/Windows NT ([0-9.]+)/,(a=a.exec(goog.userAgent.getUserAgentString()))?a[1]:"0";else if(goog.userAgent.MAC)return a=/10[_.][0-9_.]+/,(a=a.exec(goog.userAgent.getUserAgentString()))?a[0].replace(/_/g,"."):"10";return""};
goog.userAgent.platform.VERSION=goog.userAgent.platform.determineVersion_();
goog.userAgent.product.determineVersion_=function(){var a="",g,d;if(goog.userAgent.product.FIREFOX)g=/Firefox\/([0-9.]+)/;else if(goog.userAgent.product.IE||goog.userAgent.product.OPERA)return goog.userAgent.VERSION;else goog.userAgent.product.CHROME?g=/Chrome\/([0-9.]+)/:goog.userAgent.product.SAFARI?g=/Version\/([0-9.]+)/:goog.userAgent.product.IPHONE||goog.userAgent.product.IPAD?(g=/Version\/(\S+).*Mobile\/(\S+)/,d=!0):goog.userAgent.product.ANDROID?g=/Android\s+([0-9.]+)(?:.*Version\/([0-9.]+))?/:
goog.userAgent.product.CAMINO&&(g=/Camino\/([0-9.]+)/);g&&(a=(a=g.exec(goog.userAgent.getUserAgentString()))?d?a[1]+"."+a[2]:a[2]||a[1]:"");return a};goog.userAgent.product.VERSION=goog.userAgent.product.determineVersion_();var GoogleUserAgent=function(){return{browserName:goog.userAgent.product.BROWSER_NAME,osName:goog.userAgent.OS,engineName:goog.userAgent.ENGINE,browserVersionString:goog.userAgent.product.VERSION,engineVersionString:goog.userAgent.VERSION,isMobile:goog.userAgent.MOBILE}}();
function AppCacheEventProvider(a){function g(){l=!1;m=-1;o.done(function(){});KindleBuildInfo.getCurrentTotalAppcacheFileCount().then(o.resolve,o.reject)}function d(a,b,c){function d(){k.callEventListeners(a,b)}o.then(d,d);c&&(l=!0,o=jQuery.Deferred())}function b(a){l&&g();d("checking",a,!1)}function c(a){l&&g();m+=1;if(a.total!==void 0&&a.loaded!==void 0)o.resolve(a.total+1),k.callEventListeners("progress",a);else{var b=function(){a.loaded=m;return function(b){a.total=b===-1?-1:b-1;k.callEventListeners("progress",
a)}}();o.then(b,b)}}var k=ListenerManager(),m=-1,l=!0,o;o=jQuery.Deferred();(function(){typeof a.addEventListener==="function"&&(a.addEventListener("error",function(a){d("error",a,!0)}),a.addEventListener("cached",function(a){d("cached",a,!0)}),a.addEventListener("noupdate",function(a){d("noupdate",a,!0)}),a.addEventListener("updateready",function(a){d("updateready",a,!0)}),a.addEventListener("downloading",function(a){d("downloading",a,!1)}),a.addEventListener("checking",b,!1),a.addEventListener("progress",
c,!1))})();var s={status:0,abort:a.abort,update:a.update,swapCache:a.swapCache,addEventListener:k.addEventListener,removeEventListener:k.removeEventListener};$.extend(s,CreateAppCacheConstants());return s}function CreateAppCacheConstants(){var a={};["CHECKING","DOWNLOADING","IDLE","OBSOLETE","UNCACHED","UPDATEREADY"].forEach(function(g){a[g]=window.applicationCache[g]});return a}
var KindleAppCacheEventHandler=function(){function a(){u={timer:_metricsManager.createTimer(),loaded:0,total:0}}function g(){a()}function d(){KindleHostDeviceDetector.isNetworkAvailableSync()?(n.getValue()>0?_metricsManager.emit("KindleApp:AppCacheError:RestartBrowserFailed",{breakdown:["Browser"]}):q.getValue()>0?_metricsManager.emit("KindleApp:AppCacheError:RetryFailed",{breakdown:["Browser"]}):u.timer.emit("KindleApp:AppCacheError:FirstTime",{breakdown:["Browser"]}),u.timer.emit("KindleApp:AppCacheError",
{submetrics:[{name:"progress",value:u.total}],breakdown:["Browser"]}),KindleHostDeviceDetector.isiOS_4x()&&u.loaded===u.total&&q.getValue()>=1?(l(Kindle.APP_CACHE.CACHE_NEEDS_BROWSER_RESTART),n.increment(),_metricsManager.emit("KindleApp:AppCacheError:SafariRebootPrompt",{breakdown:["Browser"]})):(l(Kindle.APP_CACHE.CACHE_NEEDS_RETRY),q.increment(),_metricsManager.emit("KindleApp:AppCacheError:RetryPrompt",{breakdown:["Browser"]})),KindleHostDeviceDetector.isiOS()&&KindleHostDeviceDetector.isOnline()&&
f==="CHECKING"&&KindleLocalStorage.getItem("cached")&&(_metricsManager.emit("KindleApp:AppCacheError:OnlineInstafail",{breakdown:["Browser"]}),KindleLocalStorage.setItem("cached",0),KindleHostDeviceDetector.isiOSAppMode()&&(_metricsManager.emit("KindleApp::iOSAppModeAppCacheFix"),KindleModuleManager.getModuleSync(KindleModuleManager.APP_REGISTRATION).register())),f=""):l(Kindle.APP_CACHE.CACHE_DONE)}function b(b){u===null&&a();l(Kindle.APP_CACHE.CACHE_PROGRESS,{progressRatio:b.total?b.loaded+1/b.total+
1:0});f="";u.loaded=b.loaded+1;u.total=b.total+1}function c(){n.getValue()>0?_metricsManager.emit("KindleApp:AppCacheError:RestartBrowserSucess",{breakdown:["Browser"]}):q.getValue()>0&&_metricsManager.emit("KindleApp:AppCacheError:RetrySucess",{breakdown:["Browser"]});q.reset();n.reset()}function k(){f="";l(Kindle.APP_CACHE.CACHE_DONE);c();u.timer.emit("KindleApp:AppCacheUpdate",{submetrics:[{name:"progress",value:u.loaded}],breakdown:["Browser"]})}function m(){f="";l(Kindle.APP_CACHE.CACHE_CACHED);
KindleLocalStorage.getItem("cached")||KindleLocalStorage.setItem("cached",1);c();u&&u.loaded&&u.timer.emit("KindleApp:AppCacheSuccess",{submetrics:[{name:"progress",value:u.loaded}],breakdown:["Browser"]})}function l(a,b){b||(b={});v=a;s.callEventListeners(a,b)}var o,s=ListenerManager(),f="",u=null,q,n,v;return{initialize:function(a,c,l){_metricsManager=c;typeof Kindle==="undefined"&&(Kindle=l);q=LocalStorageCounter("AppCacheRetryCount");n=LocalStorageCounter("AppCacheBrowserRestartCount");o=a;f=
["UNCACHED","IDLE","CHECKING","DOWNLOADING","UPDATE READY","OBSOLETE"][o.status];try{o.addEventListener("checking",g,!1),o.addEventListener("error",d,!1),o.addEventListener("progress",b,!1),o.addEventListener("cached",m,!1),o.addEventListener("noupdate",m,!1),o.addEventListener("updateready",k,!1)}catch(s){}},getCacheStatus:function(){return v},removeEventListener:function(a,b){s.removeEventListener(a,b)},addEventListener:function(a,b,c){s.addEventListener(a,b,c)}}}(),KindleAppCacheManager=function(){function a(a){if(KindleHostDeviceDetector.isiOS_4x()||
KindleHostDeviceDetector.isFirefox())a=AppCacheEventProvider(a);try{KindleAppCacheEventHandler.initialize(a,k,m),d.resolve(KindleAppCacheEventHandler)}catch(b){d.reject()}}function g(l,o){k=l;m=o;d=$.Deferred();c?b||(b=$(document.createElement("iframe")).attr("seamless",!0).css("display","none").css("visibility","hidden").attr("src",KINDLE_APPCACHER_SRC)[0],$(document.body).append($(b)),KindleDebug.log("AppCacheIframe created")):a(window.applicationCache);return d.promise()}var d,b,c,k,m;return{initialize:function(a){var b=
[KindleModuleManager.METRICS_MANAGER,KindleModuleManager.CONSTANTS];(c=KindleHostDeviceDetector.isFirefox()&&window.applicationCache.status!==window.applicationCache.UNCACHED)&&b.push(a);KindleModuleManager.define(Kindle.MODULE.APPCACHE_EVENTHANDLER,b,g)},connectIframeAppCache:a}}();
Kindle.URL=function(){function a(){return window.location.host.split(".")[0].indexOf("read-")!==-1}function g(){return window.location.protocol+"//"+window.location.hostname+window.location.port+window.location.pathname}function d(a){for(var b={},a=a.split("&"),c=0;c<a.length;c++){var f;f=a[c].split("=");var d=f[0],o="";f.length>1&&(o=f[1]);f={key:d,value:o};f.key&&(b[f.key]=decodeURIComponent(f.value))}return b}function b(a){var b=a;a.indexOf("?")===0&&a.length>1&&(b=a.substring(1));return b}function c(a){var b=
"";a&&(b+="?"+a);return b}function k(a){var b={},c;for(c in a)f.indexOf(c)>-1&&(b[c]=a[c]);return b}function m(a){var b=o();b.hasOwnProperty(a)&&delete b[a];a=$.param(b);a=c(a);l(a)}function l(a){a=window.location.protocol+"//"+window.location.hostname+window.location.port+window.location.pathname+a+window.location.hash;if(window.history.replaceState)try{window.history.replaceState(document.title,document.title,a)}catch(b){}}function o(){var a={},c=window.location.search;c&&(a=b(c),a=d(a));return a=
k(a)}function s(){var a=o(),b=a[u];if(b){var b=decodeURIComponent(b),b=d(b),c;for(c in b)a[c]=b[c];delete a[u]}return a}var f=["srsBasePath","usePdxBucket","key","version","maxDBSize","ref_","siteState","kcrFree","autoHide","tag","language","lang","stringIDMode","region","host","hostVersion","clear","asin","library","ip","rwis"],u="siteState",q;return{normalizeQueryString:function(){var a=s(),a=$.param(a),a=c(a);l(a)},removeQueryParameter:m,removeAllQueryParameters:function(){var a=o(),b;for(b in a)a.hasOwnProperty(b)&&
m(b)},removeASIN:function(){m("asin")},addSavedStateToQueryParameters:function(){var a=s();if(q)for(var b in q)a[b]=q[b];a=$.param(a);a=c(a);l(a)},getQueryParameters:o,getFragIdParameters:function(){var a={};window.location.hash.length>0&&window.location.hash.substring(1).split("&").forEach(function(b){b=b.split("=");b.length===2&&(a[b[0]]=decodeURIComponent(b[1]))});return a=k(a)},getBaseURL:g,getHostURL:function(){return window.location.protocol+"//"+window.location.hostname+window.location.port},
getBasePathURL:function(){return g().replace(/[^\/]*\.html$/,"")},getSiteState:function(){var a="",c=window.location.search,c=c||"",f;for(f in q)c&&(c+="&"),c+=f+"="+q[f];c&&(c=b(c),f=encodeURIComponent(c),a+=u+"="+f);return a},addToSavedSiteState:function(a){q||(q={});for(var b in a)q[b]=a[b]},getAmazonDomain:function(){var a=/^.*\.(amazon(\.[^.]*){1,2})$/.exec(window.location.host);return a!==null?a[1]:null},isJPDomain:function(){return Kindle.URL.isPreProd()?Kindle.URL.getPreProdCountryCode()===
"jp":Kindle.URL.getAmazonDomain()===Kindle.CountryToDomainMap.jp},isPreProd:a,getPreProdCountryCode:function(){if(a()){var b=window.location.host.split(".")[0],b=b.substr(b.length-3);if(b.charAt(0)==="-")return b.substr(1,2)}return""}}}();
function KindleAppFactory(){function a(){return!!F}function g(){return window.self!==window.top&&!F}function d(){aa||(aa=c(V.KINDLE_READER_ID,KINDLE_READER_SRC,"#"+V.KINDLE_READER_CONTAINER_ID))}function b(){ba||(ba=c(V.KINDLE_LIBRARY_ID,KINDLE_LIBRARY_SRC,"#"+V.KINDLE_LIBRARY_CONTAINER_ID))}function c(h,a,b){if(!KindleHostDeviceDetector.isMetro()&&a[0]==="."){var p=Kindle.top.location.href;p.slice(-1)!=="/"&&(p=p.slice(0,p.lastIndexOf("/")+1));a=p+a.slice(2)}h=$(document.createElement("iframe")).attr("id",
h).attr("seamless","seamless").addClass(pa);KindleHostDeviceDetector.isIE()||h.attr("src",a);$(b).append(h);KindleHostDeviceDetector.isIE()&&h[0].contentWindow.location.replace(a);return h}function k(h){if(h)h.readerClass?x.readerClass=h.readerClass:delete x.readerClass,h.readerAppBar?x.readerAppBar=h.readerAppBar:delete x.readerAppBar,h.cacheSample?x.cacheSample=h.cacheSample:delete x.cacheSample,h.returnToLibrary?x.returnToLibrary=h.returnToLibrary:delete x.returnToLibrary,h.position?(x.position=
Number(h.position),delete x.location):h.location?(x.location=Number(h.location),delete x.position):(delete x.position,delete x.location),x.asin=h.asin,h.isSample!==void 0?x.isSample=h.isSample?!0:!1:delete x.isSample,h.hostStorage===!0?x.contentProvider=n(x.asin):delete x.contentProvider;x.closeButton=g()?Kindle.Reader.CloseButtonNone:Kindle.Reader.CloseButtonAuto;x.standAlone=ba===void 0;x.asin&&G&&(G.openBook(x),KindleBanner.changeBookCover(x.asin),aa&&aa.focus(),x.standAlone&&$("#"+V.KINDLE_READER_CONTAINER_ID).removeClass("hidden"))}
function m(h){x.asin=void 0;KindleLocalStorage.setItem(Y,"");Kindle.URL.removeASIN();G&&(G.unloadReader(),G=null);$("#"+V.KINDLE_READER_CONTAINER_ID).addClass("hidden").empty();aa=void 0;h&&(fa=h);if(R)R.onReaderClose()}function l(){console.log("hiding library");ga=setTimeout(function(){$("#"+V.KINDLE_LIBRARY_CONTAINER_ID).addClass("hidden")},3E3)}function o(){console.log("hiding reader");G&&G.pauseReader();$("#"+V.KINDLE_READER_CONTAINER_ID).addClass("hidden");ga&&(clearTimeout(ga),ga=void 0);$("#"+
V.KINDLE_LIBRARY_CONTAINER_ID).removeClass("hidden");ba&&ba.focus();if(R!==null)R.onShowLibrary()}function s(){fa&&(KindleMetricsManager.endMetrics(fa),fa=null);d()}function f(){var h=KindleHostDeviceDetector.isInAppMode()?"inApp":"inBrowser",a=x.asin?"inReader":"inLibrary",p=KindleHostDeviceDetector.isOnline()?"online":"offline",h={submetrics:[{name:h,value:1},{name:a,value:1},{name:p,value:1}],breakdown:["Browser","Partner"]};KindleMetricsManager.emit("App::Open",h);g()&&KindleMetricsManager.emit("App::Open::Embedded",
h);x.kcrFree&&KindleModuleManager.getModule(KindleModuleManager.SERVICE_CLIENT).then(function(h){h=h.getAuthenticationState();KindleMetricsManager.emit("App::Open::"+h)})}function u(){G&&G.unloadReader();KindleModuleManager.require(Kindle.MODULE.DB_CLIENT).done(function(h){h.persistDB()})}function q(){var h,a=!0;!KindleHostDeviceDetector.isCookieEnabled()&&!x.kcrFree?(h=KINDLE_NO_COOKIE_SRC,a=!1):!KindleHostDeviceDetector.isLocalStorageEnabled()&&!x.kcrFree&&(h=KINDLE_NO_LOCAL_STORAGE_SRC,a=!1);a||
(h=$(document.createElement("iframe")).attr("src",h).addClass(pa).attr("seamless","seamless"),$("body").append(h));return a}function n(h){return RemoteContentCache.create({asin:h,contentProvider:F.contentProvider,contentRemover:F.deleteBookContent})}function v(){function h(p){KindleAppCacheEventHandler.addEventListener(p,function(){if(KindleHostDeviceDetector.isOnline())switch(p){case Kindle.APP_CACHE.CACHE_NEEDS_RETRY:F.onAppCacheStatus("error");a=!1;break;case Kindle.APP_CACHE.CACHE_PROGRESS:a||
(F.onAppCacheStatus("incomplete"),a=!0);break;case Kindle.APP_CACHE.CACHE_DONE:case Kindle.APP_CACHE.CACHE_CACHED:F.onAppCacheStatus("success");if(window.applicationCache.status===window.applicationCache.UPDATEREADY)F.onAppCacheUpdateReady();a=!1}})}var a=!1;h(Kindle.APP_CACHE.CACHE_NEEDS_RETRY);h(Kindle.APP_CACHE.CACHE_PROGRESS);h(Kindle.APP_CACHE.CACHE_DONE);h(Kindle.APP_CACHE.CACHE_CACHED)}function w(){function h(a,p){function b(h){var p=e.elementFromPoint(h.pageX,h.pageY);return e.createTouch(a,
p,h.identifier,h.pageX,h.pageY,h.screenX,h.screenY)}function j(h){for(var a=[],p=0;p<h.length;p++)a.push(b(h[p]));return e.createTouchList.apply(e,a)}var e=a.document,r=e.createEvent("TouchEvent",{bubbles:!0});r.initTouchEvent(p.type,p.bubbles,p.cancelable,a,p.detail,p.screenX,p.screenY,p.clientX,p.clientY,p.ctrlKey,p.altKey,p.shiftKey,p.metaKey,j(p.touches),j(p.targetTouches),j(p.changedTouches),p.scale,p.rotation);return r}function a(){return function(h){KindleTOS.proxyTouchEvent(h);h.preventDefault()}}
function p(a){return function(p){var b=a.querySelectorAll(".KindleIFrame");KindleAssert(b.length===1,"Expecting exactly one iFrame");var e=b[0],b=e.contentDocument,e=h(e.contentWindow,p);if(b=b.elementFromPoint(p.changedTouches[0].clientX,p.changedTouches[0].clientY))b.dispatchEvent(e),e.defaultPrevented&&p.preventDefault()}}document.addEventListener("touchmove",function(h){h.preventDefault()},!1);var b=["touchstart","touchmove","touchend","touchcancel"],j,e,r;if(KindleHostDeviceDetector.isiOS_8x()&&
KindleHostDeviceDetector.isInAppMode()){j=document.querySelectorAll(".touchproxy");for(e=0;e<j.length;e++)for(r=0;r<b.length;r++)j[e].addEventListener(b[r],p(j[e],0));j=document.querySelectorAll(".touchbhproxy");for(e=0;e<j.length;e++)for(r=0;r<b.length;r++)j[e].addEventListener(b[r],a(j[e]))}}function B(){KindleUpgradeDeviceDetector.isMetroUpdateRequiredBecauseI18NSupported(X,x.language)?H("langSupport"):KindleUpgradeDeviceDetector.isMetroUpdateRequiredBecauseVersionNonSupported(X)&&H();KindleUpgradeDeviceDetector.isMetroUpdateRequiredBecauseCountryNotSupported(X,
x.language,x.ip).done(function(h){h&&H("countryBlk")})}function H(h){if(F){var a=Kindle.URL.getBasePathURL();a.indexOf("k4w")===-1&&(a=Kindle.URL.getHostURL()+"/");var p=KINDLE_UPGRADE_SRC.substr(1+KINDLE_UPGRADE_SRC.indexOf("/")),b=x.language||KindleHostDeviceDetector.getBrowserLanguage();a+=p+"?language="+b;a+=h?"&type="+h:"";F.showWebPage({url:a})}}function E(){var h,a,p;if(!F){p="library";if(x.hasOwnProperty("library"))KindleLocalStorage.removeItem(Y),Kindle.URL.removeQueryParameter("library");
else if(x.asin)p="book";else if(x.clear)Kindle.URL.removeQueryParameter("clear");else if(a=KindleLocalStorage.getItem(Y))try{h=JSON.parse(a);if(h.isSample!==void 0)x.isSample=h.isSample;if(h.type==="reader")p="book",x.asin=h.asin}catch(e){x.asin=a}p==="library"&&(b(),o())}d();f()}function J(h,a){var p=jQuery.Deferred();KindleModuleManager.getModule(KindleModuleManager.SERVICE_CLIENT).then(function(b){KindleHostDeviceDetector.isOnline()?b.getOwnedContent(h,a).then(p.resolve,p.reject):p.reject("offline")},
p.reject);return p.promise()}function D(){return{setLoginParameters:function(h){e(h)},setFocusToReader:function(){G&&G.setFocus()},showAppbar:function(){G&&G.setToolbarVisible(!0)},hideAppbar:function(){G&&G.setToolbarVisible(!1)},toggleAppbar:function(){G&&G.toggleToolbar()},openBook:function(h){x.asin&&(m(),d());k(h)},goTo:function(h){G&&(h.position>=0?G.goToPosition(h.position):h.location>=0&&G.goToLocation(h.location))},deregister:function(){return ca(!1,!0)},clearDatabases:function(){return KindleModuleManager.require(Kindle.MODULE.DB_CLIENT).pipe(function(h){return h.clear()})},
clearLocalStorage:function(){KindleLocalStorage.clear();return $.Deferred().resolve({success:!0}).promise()},sendMetrics:function(h){h.metrics.method?KindleMetricsManager.emit(h.metrics.method,h.metrics):KindleMetricsManager.emit(h.metrics)},sendMetricsNow:function(h){h.metrics.method?KindleMetricsManager.emitNow(h.metrics.method,h.metrics):KindleMetricsManager.emitNow(h.metrics)},getOwnedContent:function(h){return J(h&&h.lastSyncTime||null,h&&h.reason||null)},requestDeviceName:function(){KindleDebug.warn("requestDeviceName not implemented yet (waiting for new service api)")},
requestDownloadedBookList:function(){return y()},getDownloadedBookInfo:function(h){return A(h)},downloadBook:function(h){C(h)},cancelBookDownload:function(){G&&G.cancelBookDownload()},removeBook:function(h){var a=$.Deferred();G?G.removeBook(h,a.resolve,a.reject):a.reject();return a.promise()},removeBookOwnership:function(h){return L(h)},getSearchContext:function(h){return G?G.getSearchContext(h):$.Deferred().reject()},requestOemAssociateId:function(h){var a=jQuery.Deferred();KindleModuleManager.getModule(KindleModuleManager.SERVICE_CLIENT).then(function(p){p.getOemAssociateId(h).then(a.resolve,
a.reject)},a.reject);return a.promise()},getTodoItems:function(h){var a=jQuery.Deferred();KindleModuleManager.getModule(KindleModuleManager.SERVICE_CLIENT).then(function(p){p.getTodoItems(h).then(a.resolve,a.reject)},a.reject);return a.promise()},removeTodoItems:function(h){var a=jQuery.Deferred();KindleModuleManager.getModule(KindleModuleManager.SERVICE_CLIENT).then(function(p){p.removeTodoItems(h).then(a.resolve,a.reject)},a.reject);return a.promise()},uploadSnapshot:function(h){var a=jQuery.Deferred();
KindleModuleManager.getModule(KindleModuleManager.SERVICE_CLIENT).then(function(p){p.uploadSnapshot(h).then(a.resolve,a.reject)},a.reject);return a.promise()},getSearchIndex:function(h){return KindleModuleManager.getModule(KindleModuleManager.SERVICE_CLIENT).pipe(function(a){return a.getSearchIndexInfo(h)})},getSelectedText:function(h){return G.getSelectedText(h)},hideContextMenu:function(){G.hideContextMenu()},setServiceHost:function(h){KindleModuleManager.getModule(KindleModuleManager.SERVICE_CLIENT).done(function(a){a.setServiceHost(h)})},
uploadJournal:function(){return KindleModuleManager.getModule(KindleModuleManager.JOURNAL_MANAGER).pipe(function(h){return h.uploadJournal()})},setStoreCookies:function(h){var a=$.Deferred();try{for(var p=0;p<h.length;p++)document.cookie=h[p].value;setTimeout(a.resolve,0);return a.promise()}catch(b){return a.reject(b)}},updateAppCache:function(){window.applicationCache.update()},getTOSParams:function(h){var a=$.Deferred(),h=h||{};h.width=h.hasTouch?1366:2560;h.height=h.hasTouch?768:1440;h.dpi=h.hasTouch?
148:72;return a.resolve({cachePollAttemptInterval:18E5,cachePollWaitAfterSuccess:432E5,width:h.width,height:h.height,dpi:h.dpi}).promise()},moveAsinToHost:function(h){return KindleModuleManager.getModule(KindleModuleManager.CONTENT_MIGRATION).pipe(function(a){return a.moveBook(h)})},notifyMigrationStatus:function(h){return KindleModuleManager.getModule(KindleModuleManager.CONTENT_MIGRATION).pipe(function(a){return a.notifyMigrationStatus(h)})},convertPositions:function(h){if(G)return G.convertPositions(h)},
updateAnnotations:function(h){if(G)return G.updateAnnotations(h)},updateReaderChrome:function(h){if(G)return G.updateReaderChrome(h)},pingNA:function(){return KindleNetwork.pingNA()},getUrlForPfm:function(h){var a=new $.Deferred,p="";h&&h.method&&h.pfm&&Kindle.PFMLinks[h.pfm]&&(p=Kindle.PFMLinks[h.pfm][h.method]);return a.resolve({url:p})}}}function L(h){return KindleModuleManager.getModule(KindleModuleManager.SERVICE_CLIENT).pipe(function(a){return a.removeOwnership(h.asin,h.contentType)})}function y(){var h=
jQuery.Deferred();KindleModuleManager.getModuleList([KindleModuleManager.DB_CLIENT]).then(function(a){(a=a[KindleModuleManager.DB_CLIENT].getAppDb())&&a.getCachedAsins(Kindle.BookInfo.CachedState.FULLY_DOWNLOADED).then(h.resolve,h.reject)},h.reject);return h.promise()}function A(h){function a(b){var e,j,r={asin:h.asin};b.context=b.context||{};b.metadata=b.metadata||{};for(e in h)e!=="asin"&&h.hasOwnProperty(e)&&(j=b[e]||b.context[e]||b.metadata[e],j!==void 0&&(r[e]=j));p.resolve(r)}var p=jQuery.Deferred();
KindleModuleManager.getModule(KindleModuleManager.DB_CLIENT).then(function(b){b.getBookDb().BookInfoDB(h.asin).getBookInfo().then(a,p.reject)},p.reject);return p.promise()}function C(h){function a(){F.onBookDownloadComplete({asin:h.asin})}function p(a){F.onBookDownloadFailed({asin:h.asin,error:a})}function b(a){if(a!==h.prevPct)h.prevPct=a,F.onBookDownloadProgress({asin:h.asin,pct:a})}if(G){if(h.hostStorage===!0)h.contentProvider=n(h.asin);h.prevPct=0;G.downloadBook(h,b,a,p)}}function j(){k()}function t(h){var a=
h&&h.canOpen,p=h&&h.errorCode,h=h&&h.subErrorCode;KindleTOS.setOpenBookReady();ka();a?($("#"+V.KINDLE_READER_CONTAINER_ID).removeClass("hidden"),l()):r();if(R)R.onReaderOpenStatus(a,p,h)}function r(h){m(h);b();o()}function I(h){if(h){h={asin:x.asin,type:"reader"};if(x.isSample!==void 0)h.isSample=x.isSample;KindleLocalStorage.setItem(Y,JSON.stringify(h))}}function e(h){var a={hostApp:N(),hostVersion:X,loginParams:h};KindleModuleManager.define(Kindle.MODULE.SERVICE_INITIALIZATION_ARGS,[],function(){return a})}
function z(h){function a(){Kindle.URL.addSavedStateToQueryParameters();window.location.reload(!0)}switch(h.newState){case Kindle.Service.AuthOK:ha.resolve();break;case Kindle.Service.AuthError:h.prevState===Kindle.Service.AuthOK?ca(!0):ia();break;case Kindle.Service.AuthUserMismatch:KindleMetricsManager.emitNow("Service::ClientHashMismatch",{breakdown:["Browser"]});qa().always(a);break;case Kindle.Service.AuthTokenMismatch:a()}}function N(){return F?{onServiceAuthState:F.onServiceAuthState,getRequestSigningHeaders:F.getRequestSigningHeaders}:
{onServiceAuthState:z,getRequestSigningHeaders:function(){KindleDebug.error("Non-Embedded applications do not use signed request headers.")}}}function P(){function h(p){var b={version:"1.0",clientName:x.kcrFree?Kindle.ClientName.KCRFree:KindleHostDeviceDetector.getClientName(),devicePlatform:a,marketplace:Kindle.DomainToCountryMap[Kindle.URL.getAmazonDomain()]},p={uploadCallback:KindleModuleManager.getModuleSync(Kindle.MODULE.METRICS_UPLOADER).uploadMetrics,platformContext:b,dbClient:p,logger:KindleDebug,
isOnline:KindleHostDeviceDetector.isOnline,isNumber:isNumber,persistMetrics:!!p};KindleMetricsManager.initialize(p)}var a=KindleHostDeviceDetector.getDeviceType()+":"+KindleHostDeviceDetector.getDevicePlatform();h();KindleMetricsManager.setBreakdown("Version",KindleVersion.getMetricsVersionString());da()&&KindleMetricsManager.setBreakdown("Partner",da());KindleModuleManager.getModule(KindleModuleManager.DB_CLIENT).done(function(a){h(a)})}function M(){KindleModuleManager.define(Kindle.MODULE.APPLICATION_ARGS,
[],x);KindleDBClient.initialize();if(!F){var h={};h.srsBasePath=x.srsBasePath;h.usePdxBucket=x.usePdxBucket;e(h)}KindleModuleManager.registerModuleWithDeferred(KindleModuleManager.JOURNAL_MANAGER,KindlJournalManager.initialize());h=KindleUserAgentMetricsInfo.browserWithVersionString();F&&KindleHostDeviceDetector.isMetro()&&(ContentMigration.initialize(),h=X);KindleMetricsManager.setBreakdown("Browser",h);KindleModuleManager.getModule(KindleModuleManager.DB_CLIENT).done(function(){Z=KindleModuleManager.getModuleSync(KindleModuleManager.METRICS_MANAGER);
F&&Z.emit("zzz::HostVersion_"+X+"_kcr@"+KindleVersion.getMetricsVersionString())}).fail(function(){KindleDebug.error("metricsManagerInitializeError: Can not initialize metrics manager")})}function Q(h){var a;a={};if(da())a.tag=da();if(x.kcrFree)a.kcrFree=!0;if(h.refTag)a.refTag=h.refTag;if(a.asin=h.asin){KindleLocalStorage.removeItem(Y);if(!a.refTag)a.refTag=h.from===Kindle.SampleToDetailPageButton.Close?Kindle.RefTag.Values.StoreSampleClose:Kindle.RefTag.Values.StoreSample;Kindle.URL.isJPDomain()?
(a="http://www.amazon.co.jp/dp/"+h.asin+"?ref="+a.refTag,W(a,h.openInNewTab)):LinkUrls.getDetailPage(a).then(function(a){W(a,h.openInNewTab||g())})}else Kindle.URL.isJPDomain()?(a=a.refTag?"&ref_="+a.refTag:"",W("http://www.amazon.co.jp/b?node=2275256051"+a,h.openInNewTab)):(a.refTag=a.refTag||Kindle.RefTag.Values.StoreLibButton,LinkUrls.getStoreUrl(a).then(function(a){W(a,h.openInNewTab||g())}))}function K(){return!Kindle.URL.isJPDomain()}function O(h,a){var p=Z.startMetrics("Store::TOSOpen"),a=
$.extend({storeStartTime:Date.now()},a),b=h===U.LIBRARY?R&&R.onStoreOpenStatus:G&&G.onStoreOpenStatus;ja||(ja=!0,KindleTOS.open(a).then(function(a){b&&b(Kindle.STORE.OPEN_STORE);a?KindleLocalStorage.removeItem(Y):(h!==U.LIBRARY&&(m(),d()),l(),ka(),KindleTOS.setStoreClosedCallback(ra));Z.endMetrics(p);ja=!1},function(){b&&b(Kindle.STORE.GENERIC_ERROR);Z.modifyMetricsMethod(p,"Store::TOSOpenFail");Z.endMetrics(p);ja=!1}))}function S(){var h=!!x.storePath,a=Kindle.PFMLinks[la]?Kindle.PFMLinks[la].country===
"US":!1;return!g()&&Kindle.URL.getAmazonDomain()===Kindle.CountryToDomainMap.us&&a&&(KindleHostDeviceDetector.isiOS()||h)}function T(h,a){var p=h===U.LIBRARY?R&&R.onStoreOpenStatus:G&&G.onStoreOpenStatus;!KindleHostDeviceDetector.isOnline()&&p?p(Kindle.STORE.OFFLINE_ERROR):S()?O(h,a):(a.openInNewTab=a.openInNewTab||KindleHostDeviceDetector.isiOS(),Q(a),p&&p(Kindle.STORE.OPEN_STORE))}function h(h,a){var p=a&&a.hasOwnProperty("asin")?a.asin:null,b=h===U.LIBRARY?Kindle.RefTag.Values.NotebookLibrary:
Kindle.RefTag.Values.NotebookReader,e=h===U.LIBRARY?R&&R.onNotebookOpenStatus:G&&G.onNotebookOpenStatus;!KindleHostDeviceDetector.isOnline()&&e?e(Kindle.Notebook.OFFLINE_ERROR):(p=LinkUrls.getNotebookURL(p,b),W(p,!0),e&&e(Kindle.Notebook.OPEN_NOTEBOOK))}function p(h){h=Kindle.URL.getBaseURL()+"?asin="+h.asin;W(h,g())}function ra(){x.asin?(d(),va(1E3)):(b(),o(),R&&R.libraryUpdateNeeded())}function va(h){ma=setTimeout(function(){ea&&($("body").append(ea),ea=null);var h=$("#loading_spinner"),a=$(window).width(),
p=parseInt(h.css("width"),10),b=$(window).height(),e=parseInt(h.css("height"),10);h.css("top",(b-e)/2+"px").css("left",(a-p)/2+"px").show()},h)}function ka(){ma&&clearTimeout(ma);var h=$("#loading_spinner").detach();h.length&&!ea&&(ea=h)}function W(h,a){if(F)KindleDebug.error("Tried to go to a different URL when we are hosted");else if(a&&KindleHostDeviceDetector.isiOS()&&window.navigator.standalone){var p=document.createElement("a");p.href=h;p.target="_blank";var b=document.createEvent("MouseEvents");
b.initEvent("click",!0,!0);p.dispatchEvent(b)}else a?window.open(h):window.location=h}function ia(){return KindleRegistrationHandler.register()}function ca(h,a){return KindleRegistrationHandler.deregister(h,a).then(function(){if(F&&F.onDeregister)F.onDeregister(!0)},function(){if(F&&F.onDeregister)F.onDeregister(!1)})}function qa(){KindleLocalStorage.clear();return KindleModuleManager.getModuleSync(KindleModuleManager.DB_CLIENT).clear()}function da(){return x.tag}function sa(){$(window).height()!==
ta&&(ta=$(window).height(),$(window).trigger("resize"),window.scrollTo(0,0));setTimeout(sa,1E3)}var V={KINDLE_READER_ID:"KindleReaderIFrame",KINDLE_READER_CONTAINER_ID:"KindleReaderContainer",KINDLE_LIBRARY_ID:"KindleLibraryIFrame",KINDLE_LIBRARY_CONTAINER_ID:"KindleLibraryContainer",KINDLE_STORE_CONTAINER_ID:"KindleStoreContainer"},U={LIBRARY:"fromLibrary",READER:"fromReader"},na,la="",pa="KindleIFrame",Y="last_app_activity",aa,ba,x={},G=null,R=null,fa,ja=!1,ga,ma,ea,Z,oa,X,F,ha,ta=$(window).height,
ua=!1;return{initialize:function(){if(!ua){ua=!0;KindleHostDeviceDetector.isiOSAppMode()||(Kindle.URL.normalizeQueryString(),x=$.extend({},Kindle.URL.getFragIdParameters(),Kindle.URL.getQueryParameters()));ka();na=[Kindle.MODULE.APPCACHE_EVENTHANDLER,KindleModuleManager.RESOURCE_BUNDLE,KindleModuleManager.DB_CLIENT,KindleModuleManager.METRICS_MANAGER,KindleModuleManager.SERVICE_CLIENT,KindleModuleManager.CONSTANTS,KindleModuleManager.NETWORK,KindleModuleManager.JOURNAL_MANAGER,KindleModuleManager.LINK_URLS];
KindleModuleManager.registerModule(KindleModuleManager.CONSTANTS,Kindle);KindleModuleManager.registerModule(KindleModuleManager.RESOURCE_BUNDLE,ResourceBundle);KindleModuleManager.registerModule(KindleModuleManager.NETWORK,KindleNetwork);KindleModuleManager.registerModule(KindleModuleManager.METRICS_MANAGER,KindleMetricsManager);KindleModuleManager.registerModule(KindleModuleManager.LINK_URLS,LinkUrls);ResourceBundle.setStringIDMode(!!x.stringIDMode);ResourceBundle.initialize(x.language||x.lang,x.region);
KindleTemplateManager.initialize();KindleStreamingReaderClient.initialize();P();w();document.title=ResourceBundle.getLocalizedString("k_window_title");ha=new jQuery.Deferred;KindleAppCacheManager.initialize(ha);KindleHostDeviceDetector.isiOS()&&$("body").addClass("ipad");if(KindleHostDeviceDetector.hasiOSInnerHeightBug())window.onresize=function(){window.scrollTo(0,0)},$("body").addClass("iosInnerHeightBug");if(KindleHostDeviceDetector.isSafari(6.1))$(document).on("mousewheel",function(){});KindleDeviceCapabilities.hasPageResizeIssues()&&
sa();if(q()){window.onbeforeunload=u;if(x.host){if(!KindleHostDeviceDetector.isMetro()||!/^(ms-appx:\/\/)?amznmobilellc.kindleforwindows8$/.test(x.host)){console.error("unknown embedded host: "+x.host);return}oa=x.host;X=x.hostVersion;F=ReaderHostInterfaceFactory(D(),oa);KindleModuleManager.define(KindleModuleManager.EMBEDDED_HOSTINTERFACE,[],F);Kindle.URL.removeQueryParameter("host");B();F.onReaderLoaded({readerVersion:KindleVersion.getVersionString(),sendCrashWVMetricsVersions:[]});v();KindleHostDeviceDetector.isMetro()&&
KindleModuleManager.getModuleList([KindleModuleManager.DB_CLIENT]).then(function(h){h[KindleModuleManager.DB_CLIENT].enableFullDb().then(function(){KindleDebug.log("In metro mode, enabling full database")},function(){KindleDebug.error("In metro mode, was not able to enable full database.")})})}if(x.ref_)if(Kindle.RefTag.isRWISRefTag(x.ref_)){var h=x.ref_,a=x.asin?x.asin:"";Kindle.URL.addToSavedSiteState(x);Kindle.URL.removeAllQueryParameters();KindleBanner.showRWISBanner(h,a)}else Kindle.URL.addToSavedSiteState({ref_:x.ref_}),
Kindle.URL.removeQueryParameter("ref_");x.tag&&(Kindle.URL.addToSavedSiteState({tag:x.tag}),Kindle.URL.removeQueryParameter("tag"));if(x.kcrFree&&!x.asin)x.asin=Kindle.ERROR.OPEN_BOOK_ASIN_NOT_SPECIFIED;M();x.storePath&&KindleTOS.setStoreURL(decodeURIComponent(x.storePath));KindleTOS.setOpenBookCallback(k);KindleTOS.setStoreClosedCallback(ra);if(x.kcrFree)E();else{var p;KindleModuleManager.getModule(KindleModuleManager.SERVICE_CLIENT).pipe(function(h){p=h;return h.authenticate()}).pipe(function(){p.getPFM().done(function(h){la=
h.pfm;LinkUrls.initializeEid(h.eid)});E()})}(F||x.kcrFree)&&ha.resolve();KindleChromeInstaller.initialize()}}},registerEventCallback:function(h,a){var p=[],b;for(b in Kindle.APP_CACHE)p.push(Kindle.APP_CACHE[b]);p.indexOf(h)>=0&&KindleAppCacheEventHandler.addEventListener(h,a)},getSharedModuleSync:function(h){na.indexOf(h)===-1&&KindleDebug.error(h+"is not a shared module");return KindleModuleManager.getModuleSync(h)},getSharedModules:function(){return KindleModuleManager.getModuleList(na)},getAppInterfaceForReader:function(){function b(h){setTimeout(function(){m(h);
d()},0)}return F?{onReaderReady:j,closeReader:function(h){F.onBookClose();b(h)},onStartReadingStatus:function(h){F.onBookOpenStatus(h);(!h||!h.canOpen)&&b()},onRendererLoaded:I,openStore:function(h){F.onOpenStore({origin:U.READER,asin:h})},openNotebook:function(h){F.onOpenNotebook({origin:U.READER,asin:h})},pinBookToStart:function(h){F.pinBookToStart(h)},onReaderTapped:function(){F.onReaderTapped()},onUserAction:function(){F.onUserAction()},hideAppBar:function(){F.hideAppBar()},onBookDownloadComplete:function(h){F.onBookDownloadComplete(h)},
searchContent:function(h){F.searchContent(h)},showAnnotations:function(h){F.showAnnotations(h)},isHostControlled:a,isEmbeddedInWebsite:g,isNotebookAvailable:K}:{onReaderReady:j,closeReader:r,onStartReadingStatus:t,onRendererLoaded:I,openStore:function(h){T(U.READER,h)},openNotebook:function(a){h(U.READER,a)},openFullKCR:p,register:ia,deregister:ca,pinBookToStart:function(){},onReaderTapped:function(){},onUserAction:function(){},hideAppBar:function(){},onBookDownloadComplete:function(){},searchContent:function(){},
showAnnotations:function(){},isHostControlled:a,isEmbeddedInWebsite:g,isNotebookAvailable:K}},setReaderInterface:function(h){KindleInterfaces.assertImplements(h,KindleInterfaces.IKindleReader);G=h},getAppInterfaceForLibrary:function(){return{openExternalLink:function(h){W(h,!0)},storeIsTOS:S,openStore:function(h){T(U.LIBRARY,h)},isNotebookAvailable:K,openNotebook:function(a){h(U.LIBRARY,a)},openBook:k,onLibraryLoaded:s,getQueryParameters:function(){return x},register:ia,deregister:ca}},setLibraryInterface:function(h){KindleInterfaces.assertImplements(h,
KindleInterfaces.IKindleLibrary);R=h},cleanupForNextUser:qa,register:ia,deregister:ca,getQueryParams:function(){return x},gotoURL:W,isHostControlled:a,isEmbeddedInWebsite:g,isNotebookAvailable:K,getEmbeddorHostname:function(){return oa},getPartnerTag:da}}var KindleApp=KindleAppFactory();typeof amznJQ!=="undefined"&&amznJQ.declareAvailable("cascade");
var KindleBanner=function(){function a(){if(k){var a=window.innerHeight||document.body.clientHeight||document.documentElement.clientHeight;a-=$("#"+b.KINDLE_BANNER_CONTAINER_ID).height();a={height:a};$("."+b.KINDLE_APP_CONTAINER).css(a)}}function g(){if(!k){k=!0;$("."+b.KINDLE_BANNER_CONTAINER_ID).css("display","block");var c={top:$("#"+b.KINDLE_BANNER_CONTAINER_ID).height()+"px"};$("."+b.KINDLE_APP_CONTAINER).css(c);a();window.addEventListener("resize",a)}}function d(a){return"https://images-na.ssl-images-amazon.com/images/P/"+
a+".01._SX60_SY80_TTXW_SCLZZZZZZZ_.jpg"}var b={KINDLE_APP_CONTAINER:"KindleAppContainer",KINDLE_BANNER_CONTAINER_ID:"KindleBannerContainer",KINDLE_BANNER_CENTER:"kindleApp_banner_center",KINDLE_BANNER_TEXT:"kindleApp_banner_RWIS_text"},c,k=!1,m={rwis:4,next_available:5},l={rwis:1};return{showRWISBanner:function(o,s){function f(){c.emit("Banner::RWIS::LearnMore")}function u(){c.emit("Banner::RWIS::GetAppLink")}if(!m.rwis||!l.rwis?0:LocalStorageCounter("kcrNotification."+m.rwis).getValue()<l.rwis){c||
(c=KindleModuleManager.getModuleSync(KindleModuleManager.METRICS_MANAGER));c.emit("Banner::RWIS::Show");var q=KindleHostDeviceDetector.isiOS(),n=o&&o==="kcr_rwis_kshare"?!0:!1,n={learnMoreLink:LinkUrls.getKCPLandingPageLink(o),bookCoverURL:d(s),isiPad:q,isKp:n},n=$(Handlebars.templates.KindleRWISBanner(n)),v=ResourceBundle.getLanguage();if(q)switch(n.find("#kindleApp_banner_get_app_button").click(u),v){case "de":case "fr":n.find("#"+b.KINDLE_BANNER_CENTER).css("width","540px");n.find("#"+b.KINDLE_BANNER_TEXT).css({"line-height":"20px",
"padding-top":"0"});break;case "ja":case "it":n.find("#"+b.KINDLE_BANNER_TEXT).css("padding-top","0");n.find("#"+b.KINDLE_BANNER_CENTER).css("width","465px");break;case "pt":n.find("#"+b.KINDLE_BANNER_TEXT).css("padding-top","0");n.find("#"+b.KINDLE_BANNER_CENTER).css("width","505px");break;case "es":n.find("#"+b.KINDLE_BANNER_TEXT).css("padding-top","0"),n.find("#"+b.KINDLE_BANNER_CENTER).css("width","525px")}else q={showAppleLogo:!0,showWindowsLogo:!Kindle.URL.isJPDomain(),showAmazonLogo:!0,showAndroidLogo:!0},
q=new KindleTextMeWidget(q,"KindleRWISBanner"),n.find("#kindleApp_banner_text_me_widget_wrapper").append(q),n.find("#kindleApp_banner_learn_more").click(f),v==="fr"&&n.find("#"+b.KINDLE_BANNER_TEXT).css("line-height","20px");n.find("#kindleApp_banner_close_button").click(function(){k&&(window.removeEventListener("resize",a),$("."+b.KINDLE_BANNER_CONTAINER_ID).css("display","none"),$("."+b.KINDLE_APP_CONTAINER).css({top:"0px",height:"100%"}),k=!1);m.rwis&&l.rwis&&LocalStorageCounter("kcrNotification."+
m.rwis).increment();c.emit("Banner::RWIS::Close")});$("#KindleBannerContainer").append(n);g()}},changeBookCover:function(a){k&&(a=d(a),$("#kindleApp_banner_book_cover").attr("src",a))}}}(),KindleBuildInfo=function(){function a(a,b,c){var k=$.Deferred();$.getJSON(g,Math.floor(Math.random()*1E9),function(m){m=m[a];c(m)?k.resolve(m):k.reject(b)}).error(function(){k.reject(b)});return k.promise()}var g="./offline/build_info.uncached.js";return{getCurrentTotalAppcacheFileCount:function(){return a("filecount",
-1,function(a){return typeof a==="number"&&a>1})}}}(),KindleMetricsManager=function(){function a(){function a(){Date.now()-j>b&&(P=Date.now());j=Date.now();setTimeout(a,e)}if(!M){M=!0;var b=2E4,e=5E3,j;P=0;Date.now();j=Date.now();setTimeout(a,e)}}function g(a){if(a.timerStart>=P)return!0;a=Date.now()-a.timerStart;H("Metrics::Suspended",{time:a});return!1}function d(){if(D.length>0){var a=D;D=[];f().insertList(a).fail(function(){Array.prototype.push.apply(a,D);D=a})}}function b(){e&&z<=Date.now()+
N||(clearTimeout(e),e=setTimeout(function(){e=null;b();s()},N),z=Date.now()+N)}function c(a){if($.isArray(a))return a;var b;if(a){b=[];for(var e in a)b.push(a[e])}return b}function k(a){var b=a.timers;if(b)for(var e in b);a.timers=c(a.timers);a.counters=c(a.counters)}function m(a){for(var b=new jQuery.Deferred,e=0;e<a.length;e++)k(a[e]);a.length>0&&f()?f().insertList(a).then(function(){b.resolve(a)},function(){o(a).then(function(){b.resolve(a)},function(){Array.prototype.push.apply(D,a);b.reject(a)})}):
(Array.prototype.push.apply(D,a),b.resolve(a));return b.promise()}function l(a,b,e){var j=y[a],a=j.counters;if(!a)a=j.counters={};j=a[b];if(!j&&(j=a[b]={},j.name=b,j.count=0,e))typeof e==="string"&&(e=[e]),j.breakDown=e;return j}function o(a){var b=new jQuery.Deferred,e=/exception/i;C()?A(t.devicePlatform,t.clientName,t.version,t.marketplace,t.breakdownDeclarations,a).then(function(j){j.Output.metricProcessCount&&j.Output.metricProcessCount>0||j.Output.__type&&j.Output.__type.match(e)?b.resolve(a):
b.reject(a)},function(){b.reject(a)}):b.reject(a);return b.promise()}function s(){var a,b=new jQuery.Deferred;if(C()){if(!f())return b.reject(),b.promise();f().batchTransaction([{operation:Kindle.DB.GET_RECORD_OPERATION,tableName:E,params:[]},{operation:Kindle.DB.DELETE_RECORD_OPERATION,tableName:E,params:[]}]).done(function(e){if(e[0]&&e[0].length>0){a=e[0];for(e=0;e<a.length;e++){var j=a[e];if(j.breakDown)j.breakdown=j.breakDown,delete j.breakDown}o(a).done(b.resolve).fail(function(){f()&&f().insertList(a);
b.reject()})}}).fail(function(){b.reject()})}else b.reject();return b.promise()}function f(){try{if(J)return J.getAppDb().getTable(E)}catch(a){}return null}function u(a){function b(a,h){var p={};p.name=h.name;p.count=h.value;var e=q(h.breakdown);if(e.length>0)p.breakDown=e;if(!a.counters)a.counters=[];a.counters.push(p)}if(!(typeof a==="object"&&typeof a.name==="string"&&typeof a.params==="undefined"||typeof a.params==="object"))return null;var e={},r=a.name,a=$.extend({},a.params);e.method=r;e.time=
0;if(a){if(a.time>=0&&j(a.time))e.time=a.time;if(a.submetrics){if(!$.isArray(a.submetrics))a.submetrics=[a.submetrics];for(r=0;r<a.submetrics.length;r++)b(e,a.submetrics[r])}r=q(a.breakdown);if(r.length>0)e.breakDown=r}return e}function q(a){var b=[];if(a===void 0)return b;$.isArray(a)||(a=[a]);for(var e=0;e<a.length;e++)typeof a[e]==="string"&&(r.indexOf(a[e]),b.push(a[e]));return b}function n(a){a||(a={});if(!a.startTime)a.startTime=Date.now();j(a.startTime);this.params=a}function v(a,b){return a=
$.map(a,function(a){a.time=b;return a})}function w(a){if(typeof a[0]==="string"){var b={};b.name=a[0];if(a[1])b.params=a[1];a=[b]}else a=$.isArray(a[0])?a[0]:[];return $.map(a,u)}function B(){}function H(){var a=w(arguments);return m(a).fail(B)}var E="metrics",J=null,D=[],L=0,y={},A,C=function(){return navigator.onLine},j=isNumber,t={breakdownDeclarations:{}},r=["Browser","Version","Partner","ProcessorClass","ViewState","SystemLanguage","Online","CloudItemsCount","LocalItemsCount","HostVersion","PFM",
"CrashLocation"],I=Object.freeze({Short:3E4,Default:3E5,Min:1E4,Max:6E5}),e=null,z=0,N=I.Default,P,M=!1;n.prototype.elapsed=function(){var a=0;j(this._elapsed)?a=this._elapsed:j(this.params.startTime)&&g({timerStart:this.params.startTime})&&(a=Date.now()-this.params.startTime);return a};n.prototype.stop=function(){this._elapsed=Date.now()-this.params.startTime;return this};n.prototype.emit=function(){var a=this.elapsed(),b=w(arguments),b=v(b,a);return m(b).fail(B)};n.prototype.emitNow=function(){var a=
this.elapsed(),b=w(arguments),b=v(b,a);return o(b).fail(B)};return{modifyMetricsMethod:function(a,b){if(y[a])y[a].method=b},startMetrics:function(a,b){var e={};e.method=a;e.timerStart=Date.now();if(b&&b.breakdown)e.breakDown=q(b.breakdown);L++;y[L]=e;return L},endMetrics:function(a,b){var e,j=y[a];if(j&&j.timerStart){if(g(j))j.time=Date.now()-j.timerStart;delete j.timerStart;var r=[j];b&&(typeof b==="string"&&(b=[b]),$.each(b,function(h,a){var b=$.extend({},j);b.method+=a;r.push(b)}));e=m(r);delete y[a]}else e=
(new jQuery.Deferred).reject().promise();return e},cancelMetrics:function(a){delete y[a]},startSubTimer:function(a,b,e){var j=y[a],a=j.timers;if(!a)a=j.timers={};j=a[b];if(!j&&(j=a[b]={},j.name=b,j.count=0,j.time=0,e=q(e),e.length>0))j.breakDown=e;if(!j.timerStart)j.timerStart=Date.now()},endSubTimer:function(a,b){var e=y[a].timers[b];e.timerStart!==void 0&&(g(e)&&(e.count+=1,e.time+=Date.now()-e.timerStart),delete e.timerStart)},renameSubTimer:function(a,b,e){var a=y[a],j=a.timers[b];if(j.time>=
0)a.timers[e]=j,a.timers[e].name=e,delete a.timers[b]},getSubTimer:function(a,b){return y[a].timers[b]},setSubCounter:function(a,b,e,r){a=l(a,b,r);j(e)||(e=1);a.count=e},increaseSubCounter:function(a,b,e,r){a=l(a,b,r);j(e)||(e=1);a.count+=e},initialize:function(e){A=e.uploadCallback;t=$.extend(t,e.platformContext);J=e.dbClient;C=e.isOnline||C;j=e.isNumber;e.persistMetrics&&(d(),b());a()},uploadMetrics:s,setMetricsUploadInterval:function(a){var e=N;I.Min<a&&a<I.Max||(a=N);a!==N&&(N=a,b());return e},
UploadInterval:I,setBreakdown:function(a,b){$.isArray(b)&&(b=b.join(":"));typeof b==="string"&&r.indexOf(a)>-1&&(t.breakdownDeclarations[a]=b)},clearBreakdowns:function(){t.breakdownDeclarations={}},replaceBreakdowns:function(a){t.breakdownDeclarations=a},createTimer:function(){return new n},emitNow:function(){var a=w(arguments);return o(a).fail(B)},emit:H}}(),KindleNetwork=function(){function a(){return o=navigator.onLine}function g(){a()===!1?d(!1):$.ajax("/service/web/reader/ping")}function d(a){m&&
(window.clearTimeout(m),m=0);l=Date.now();a!==k&&(k=a,c.callEventListeners(a?"online":"offline"));b()}function b(){c.hasEventListener(k?"offline":"online")?m||(m=window.setTimeout(g,k?9E5:18E4)):m&&(window.clearTimeout(m),m=0)}var c=new ListenerManager,k=!0,m,l=0,o;return{pingNA:function(){var a=new $.Deferred;$.ajax("https://read.amazon.com").then(function(b,c,d){a.resolve(d&&d.status!==0)},function(){a.resolve(!1)});return a.promise()},initialize:function(){$(document).ajaxComplete(function(a,b,
c){c.qaMetricsIngester||d(!!b.status)});document.body.addEventListener("offline",g);document.body.addEventListener("online",g);d(a())},addEventListener:function(a,f){c.addEventListener(a,f);b()},removeEventListener:function(a,f){c.removeEventListener(a,f);b()},isOnline:function(b){o!==a()&&d(o);b=Number(b);return Date.now()-l<(b>=0?b:Infinity)?k:o===!1?!1:null}}}();
Kindle.RefTag=function(){return{Values:{StorePromoMangaJP:"kcr_store_promo_manga_jp",StoreLibButton:"kcr_store_libbutton",StoreSample:"kcr_store_sample",StoreSampleClose:"kcr_store_sample_close",StoreEmptyLibIpad:"kcr_store_emptylib_ipad",StoreLibButtonIpad:"kcr_store_libbutton_ipad",NotebookLibrary:"kcr_notebook_lib",NotebookReader:"kcr_notebook_rdr"},isRWISRefTag:function(a){return a&&a.indexOf("kcr_rwis_")===0}}}();
var KindleRegistrationHandler=function(){function a(){var a=g(Kindle.URL.getBaseURL()),c=d.apUrl;c+="?openid.assoc_handle="+d.assocHandle;c+="&openid.return_to="+encodeURIComponent(a);c+="&openid.mode=logout";c+="&openid.ns=http%3A%2F%2Fspecs.openid.net%2Fauth%2F2.0";(a=Kindle.URL.getSiteState())&&(c+="&"+a);KindleApp.gotoURL(c)}function g(a){var c=d.apUrl;c+="?openid.assoc_handle="+d.assocHandle;c+="&openid.return_to="+encodeURIComponent(a);c+="&openid.mode=checkid_setup";c+="&openid.ns=http%3A%2F%2Fspecs.openid.net%2Fauth%2F2.0";
c+="&openid.identity=";c+="http%3A%2F%2Fspecs.openid.net%2Fauth%2F2.0%2Fidentifier_select";c+="&openid.claimed_id=";c+="http%3A%2F%2Fspecs.openid.net%2Fauth%2F2.0%2Fidentifier_select";c+="&pageId=amzn_kcr";(a=Kindle.URL.getSiteState())&&(c+="&"+a);return c}var d=function(){function a(b){b=b.toLowerCase();return{apUrl:"https://"+b+"-pre-prod.amazon.com/ap/signin",assocHandle:"amzn_kweb_"+b}}var c=Kindle.URL.getAmazonDomain();if(Kindle.URL.isPreProd()){var d=Kindle.URL.getPreProdCountryCode();if(d)return a(d)}return function(){var a=
Kindle.DomainToCountryMap[c];return{apUrl:"https://www."+c+"/ap/signin",assocHandle:a==="us"?"amzn_kweb":"amzn_kweb_"+a}}()}();return{register:function(){KindleApp.gotoURL(g(Kindle.URL.getBaseURL()))},deregister:function(b,c){function d(){var a=new jQuery.Deferred;KindleModuleManager.getModule(KindleModuleManager.JOURNAL_MANAGER).then(function(b){b.uploadJournal().then(a.resolve,a.resolve)});return a.promise()}function m(){var a=new jQuery.Deferred;v.getAppDb().getPinnedSessionIds().done(function(b){KindleModuleManager.getModuleSync(KindleModuleManager.SERVICE_CLIENT).deregisterSessions(b).then(a.resolve,
a.reject)});return a.promise()}function l(){function a(){g.uploadMetrics().then(s,s)}q.then(a,a)}function o(){f.reject()}function s(){c?KindleApp.cleanupForNextUser().then(function(){KindleDebug.log("db & localStorage cleared.");KindleApp.isHostControlled()||a();f.resolve()},function(){KindleDebug.log("Failed to clear db/localStorage");KindleApp.isHostControlled()||a();f.resolve()},function(a){f.notify(a)}):(KindleLocalStorage.removeItem(Kindle.App.LIBRARY_FAIL_FLAG),v.getAppDb().clearDeviceToken().then(a,
a),f.resolve())}var f=new jQuery.Deferred,g=KindleModuleManager.getModuleSync(KindleModuleManager.METRICS_MANAGER),q,n=g.createTimer();q=c?n.emit([{name:"Library::SignOut"},{name:"Library::SignOut:Intentional"}]):n.emit([{name:"Library::SignOut"},{name:"Library::SignOut:Unintentional"}]);var v=KindleModuleManager.getModuleSync(KindleModuleManager.DB_CLIENT);b?s():$.when(d(),m()).then(l,o);return f.promise()}}}(),KindleStreamingReaderClient=function(){function a(a){var b,a=a||{};b=(a.srsHostName||
"")+("/"+(a.srsBasePath||"service")+"/")+"web/";J=b+"content/";a.useSignedServiceRequests&&(b+="device/");E=b+"reader/";D=b+"register/";L=E+"setOfflineStatus/";y=E+"deregisterSessions/";A=E}function g(){C=!0}function d(a){var b={prevState:N,newState:a};if(a===Kindle.Service.AuthOK&&(b.eid=I,e))b.deviceName=e;N=a;z.onServiceAuthState(b)}function b(a,b,e){function j(){d(Kindle.Service.AuthError);r.reject(a,b,e)}if(a.status===H){var r=$.Deferred();t=null;M.clearDeviceToken().then(j,j);return r.promise()}else return $.Deferred().reject(a,
b,e)}function c(a,e){return $.ajax({url:a,dataType:"json",beforeSend:function(a){a.setRequestHeader("x-amzn-sessionid",e);return!0}}).pipe(null,b)}function k(){var a=$.cookie("session-id"),b=function(){var a=D+"getDeviceToken",h=KindleHostDeviceDetector.getDeviceType();a+="?serialNumber="+(Q||h)+"&deviceType="+h;return encodeURI(a)}(),e=P.createTimer();return c(b,a).pipe(function(a,h,b){h=jQuery.Deferred();a.deviceSessionToken?h.resolve(a):(h.reject(b,"failed"),e.emit("Service::GetDeviceTokenCallBrokenResult"));
e.emit("Service::GetDeviceTokenCall");return h.promise()}).fail(function(){e.emitNow("Service::GetDeviceTokenCallFail")})}function m(a,b){return{url:a,type:"POST",dataType:"json",processData:!1,contentType:"application/json",data:JSON.stringify(b)}}function l(a){function e(){KindleDebug.error("Failed to sign SRS request.");return $.Deferred().reject()}function j(a){var h;h=/\/web.*$/.exec(a.url);return!h?e():z.getRequestSigningHeaders({path:h[0],verb:a.type||"GET",data:a.data||""}).pipe(function(h){a.beforeSend=
function(a){$.each(h,function(h,b){a.setRequestHeader(h,b)});return!0};return $.Deferred().resolve(a)},e)}function r(a){return t?(a.beforeSend=function(a){a.setRequestHeader("X-ADP-Session-Token",t);return!0},$.Deferred().resolve(a)):(KindleDebug.error("Device Token must be loaded in order to make an authenticated request. Cancelling request."),d(Kindle.Service.AuthError),$.Deferred().reject())}n();return(K?j(a):r(a)).pipe($.ajax).pipe(null,b)}function o(a){a.beforeSend=function(a){a.setRequestHeader("Amzn-Device-Type",
KindleHostDeviceDetector.getDeviceType());return!0};return $.ajax(a)}function s(a){function b(){l(r).done(j.resolve).fail(function(a){KindleHostDeviceDetector.isiOSAppMode()&&a.status===0&&f.emit("KindleApp::iOSAppModeStatusCodeIsZero")}).fail(function(a,h,e){a.status!==H&&(h!=="timeout"&&t-- >0?(setTimeout(b,c),c*=2):j.reject(a,h,e))})}var e=a.url,j=$.Deferred(),r={url:e,dataType:"json"},t=1,c=50;b();var f=P.createTimer();j.done(function(){f.emit(a.metricId)});j.fail(function(){f.emitNow(a.metricId+
"Fail")});return j.promise()}function f(a){function b(){o(r).done(j.resolve).fail(function(a,h,e){a.status!==H&&h!=="timeout"&&t-- >0?(setTimeout(b,c),c*=2):j.reject(a,h,e)})}var e=a.url,j=$.Deferred(),r={url:e,dataType:"json"},t=1,c=50;b();var f=P.createTimer();j.done(function(){f.emit(a.metricId)});j.fail(function(){f.emitNow(a.metricId+"Fail")});return j.promise()}function u(){function a(h,b,e){function j(){(!h||h.status!==H)&&d(Kindle.Service.AuthError);z.reject(h,b,e)}t=null;M.clearDeviceToken().then(j,
j)}function b(){N!==Kindle.Service.AuthOK&&d(Kindle.Service.AuthOK);z.resolve(t)}function j(c){if(r&&r!==c.clientHashId)d(Kindle.Service.AuthUserMismatch);else{t=c.deviceSessionToken;r=c.clientHashId;I=c.eid;if(c.deviceName)e=c.deviceName;jQuery.when(M.setDeviceToken(c.deviceSessionToken),M.setUserHashId(c.clientHashId),M.setEID(c.eid)).then(b,a)}}function c(){k().then(j,a)}function f(a){r=a[Kindle.Service.UserHashIdKey];I=a[Kindle.Service.EidKey];a[Kindle.Service.DeviceTokenKey]?(t=a[Kindle.Service.DeviceTokenKey],
b()):c()}var z=$.Deferred();t?z.resolve(t):M.getValuesForKeys([Kindle.Service.DeviceTokenKey,Kindle.Service.UserHashIdKey,Kindle.Service.EidKey]).then(f,c);return z.promise()}function q(){var a=$.Deferred();M.getValuesForKeys([Kindle.Service.DeviceTokenKey,Kindle.Service.UserHashIdKey,Kindle.Service.EidKey]).then(function(b){r=b[Kindle.Service.UserHashIdKey];I=b[Kindle.Service.EidKey];b[Kindle.Service.DeviceTokenKey]?(t=b[Kindle.Service.DeviceTokenKey],a.resolve(!0)):a.resolve(!1)},function(){a.resolve(!1)});
return a.promise()}function n(){function a(){d(Kindle.Service.AuthTokenMismatch);b.reject()}var b=$.Deferred();if(!t)return b.resolve();var e=P.createTimer();M.getDeviceToken().done(function(j){j!==t?e.emit("Service::CheckTokenConsistencyMismatch",{breakdown:["Browser"]}).always(a):b.resolve()}).fail(function(){C||e.emit("Service::CheckTokenConsistencyFail",{breakdown:["Browser"]}).always(a)});return b.promise()}function v(a){return a&&(a==="only"||N!==Kindle.Service.AuthOK)}function w(a,b){var e=
E+a+"?asin="+b.asin+"&kindleSessionId="+b.kindleSessionId;return b.position&&b.position>0?(e+="&lastPageRead="+b.position+"&localTimeOffset="+b.localTimeOffset+"&countryCode="+b.countryCode,e+="&positionType="+b.positionType,e=encodeURI(e)+(!b.refEmId?"":"&guid="+encodeURIComponent(b.refEmId))):encodeURI(e)}function B(a,b,e,j,r,c){function t(a,h,b,e,p,r){return{Operation:r?"uploadMetricsExternal":"uploadMetrics",Input:{devicePlatform:a,clientName:h,version:b,marketplace:j,metricBreakdown:e,metrics:p}}}
var f;return function(){function j(a,h,b){var e=$.Deferred();return b.responseText.indexOf("UploadMetricsResponse")===-1?e.reject():e.resolve(a,h,b)}var z=Kindle.Service.AuthOK===N&&(K||$.cookie("at-main")),d=E+"uploadMetrics";return z?(f=t(a,b,e,r,c,!1),l(m(d,f)).pipe(j)):$.Deferred().reject()}().pipe(null,function(){var j=J+"uploadMetrics";f=t(a,b,e,r,c,!0);return o(m(j,f))}).done(function(){var a;if(a=O||KindleLocalStorage.getItem("QAMetricsURL"))a={url:a,type:"POST",dataType:"json",processData:!1,
headers:{Source:window.location.href},contentType:"application/json",data:JSON.stringify(f),qaMetricsIngester:!0},$.ajax(a).fail(function(a){a.status&&KindleDebug.warn("Failed to echo metrics to the QA ingester service; statusCode="+a.statusCode)})})}var H=403,E,J,D,L,y,A,C=!1,j,t,r,I,e,z,N,P,M,Q,K,O,S;a();$.ajaxSetup({headers:{"Cache-Control":"no-cache",Pragma:"no-cache"},timeout:6E4});var T={getAuthenticationState:function(){return N},authenticate:function(){if(N===Kindle.Service.AuthOK)return $.Deferred().resolve();
else if(K)return $.Deferred().reject();return u()},checkTokenConsistency:n,deregisterSessions:function(a){return s({metricId:"Service::DeregisterSessionsCall",url:function(a){a=y+"?sessions="+a.join();return encodeURI(a)}(a)})},doneReading:function(a){return s({metricId:"Service::DoneReadingCall",url:w("doneReading",a)})},getAnnotations:function(a,b){var e=E+"getAnnotations?asin="+encodeURIComponent(a)+(!b?"":"&guid="+encodeURIComponent(b));return s({metricId:"Service::GetAnnotationsCall",url:e})},
getEID:function(){function a(){return $.Deferred().resolve(I)}function b(){var e=P.createTimer();return k().fail(function(){e.emitNow("Service::GetEIDTokenCallFail")}).pipe(function(b){I=b.eid;e.emit("Service::GetEIDTokenCallSuccess");return M.setEID(b.eid).pipe(a,a)},null)}return I?a():M.getEID().pipe(null,b)},getFileUrl:function(a){var b=v(a.kcrFree),e={metricId:"Service::GetFileUrlCall",url:function(){var e=b?J:E;e+="getFileUrl?asin="+a.asin+"&contentVersion="+a.contentVersion+"&formatVersion="+
a.formatVersion;KindleHostDeviceDetector.hasCanvasSizeLimitProblem()||(e+="&clientVersion="+j);e+=S?"&usePdxBucket="+S:"";e+=a.kindleSessionId?"&kindleSessionId="+a.kindleSessionId:"";e+=a.isSample?"&isSample="+a.isSample:"";e+=a.skeletonIds?"&skeletonIds="+a.skeletonIds.join(","):"";e+=a.fragmentIds?"&fragmentIds="+a.fragmentIds.join(","):"";e+=a.glyphIds?"&glyphIds="+a.glyphIds.join(","):"";e+=a.resourceIds?"&resourceIds="+a.resourceIds.join(","):"";e+=a.locationMapIds?"&locationMapIds="+a.locationMapIds.join(","):
"";return encodeURI(e)}()};return(b?f:s)(e)},getLPR:function(a,b){var e=E+"getLPR?asin="+encodeURIComponent(a)+(!b?"":"&guid="+encodeURIComponent(b));return s({metricId:"Service::GetLPRCall",url:e})},getOemAssociateId:function(a){var a={Operation:"getAssociateId",Input:{deviceType:a.deviceType,deviceParameters:{eid:a.eid,oemPartnerName:a.oemPartnerName,oemDealGuid:a.oemDealGuid}}},b=E+"getAssociateId",e=P.createTimer();return l(m(b,a)).then(function(a){e.emit("Service::OemAssociateIdSuccess");(!a||
!a.Output||!a.Output.associateId)&&e.emit("Service::OemAssociateIdEmpty")},function(){e.emit("Service::OemAssociateIdFailure")})},getOwnedContent:function(a,b){return s({metricId:"Service::GetOwnedContentCall",url:function(){var e="";a&&(e="?lastSyncTime="+encodeURIComponent(a));b&&(e?e+="&":e="?",e+="reason="+encodeURIComponent(b));return E+"getOwnedContent"+e}()})},getPFM:function(){return s({metricId:"Service::GetPFMCall",url:E+"getPFM"})},getTodoItems:function(a){var b=a.reason,e=a.versionNumber,
a=A+"getTodoListItems?maxNumItems="+(a.maxNumItems||a.count);b&&(a+="&reason="+b);e&&(a+="&softwareRev="+e);a=encodeURI(a);return s({metricId:"Service::GetTodoItemCall",url:a})},getSearchIndexInfo:function(a){var b=v(a.kcrFree),e=b?J:E;e+="getSearchIndex?asin="+encodeURIComponent(a.asin)+"&formatVersion="+encodeURIComponent(a.formatVersion)+"&contentVersion="+encodeURIComponent(a.contentVersion);return(b?f:s)({url:e,metricId:"Service::GetSearchIndex"})},getWordDefinition:function(a){var b=Kindle.Service.AuthOK===
N,a={metricId:"Service::GetWordDefinitionCall",url:encodeURI((b?E:J)+"getWordDefinition?word="+a)};return(b?s:f)(a)},removeTodoItems:function(a){if(a.length!==1)return $.Deferred().reject("Must be one item").promise();var a=a[0],b=A+"removeTodoListItem";b+="?type="+a.type+"&action="+a.action+"&key="+a.key+"&completeStatus="+(a.completeStatus||a.complete_status)+"&failureCode="+(a.failureCode||a.failure_code||"");b=encodeURI(b);return s({metricId:"Service::RemoveTodoItemsCall",url:b})},resetLPR:function(a){return s({metricId:"Service::ResetLPRCall",
url:w("resetLPR",a)})},removeOwnership:function(a,b){return s({metricId:"Service::RemoveOwnershipCall",url:E+"removeOwnership?asin="+a+"&contentType="+b})},setOfflineStatus:function(a){return s({metricId:"Service::SetOfflineStatusCall",url:encodeURI(L+"?asin="+a.asin+"&kindleSessionId="+a.kindleSessionId+"&offline="+(a.isOffline?"true":"false"))})},setServiceHost:function(h){a({useSignedServiceRequests:K,srsHostName:h})},startReading:function(a){var b=v(a.kcrFree),e={metricId:"Service::StartReadingServiceCall",
url:function(){var e=b?J:E;e+="startReading?asin="+a.asin;e+=a.kindleSessionId?"&kindleSessionId="+a.kindleSessionId:"";e+=a.contentVersion?"&contentVersion="+a.contentVersion:"";e+=a.formatVersion?"&formatVersion="+a.formatVersion:"";e+=a.isSample!==void 0?"&isSample="+(a.isSample?"true":"false"):"";j&&(e+="&clientVersion="+j);return encodeURI(e)}()};return(b?f:s)(e)},stillReading:function(a){return s({metricId:"Service::StillReadingCall",url:w("stillReading",a)})},updateAnnotations:function(a,b){var e=
E+"updateAnnotations",j={Operation:"updateAnnotations",Input:{annotations:a,localTimeOffset:b}},r=P.createTimer();return l(m(e,j)).then(function(){r.emit("Service::UpdateAnnotationsCall")},function(){r.emitNow("Service::UpdateAnnotationsCallFail")})},uploadMetrics:B,uploadSnapshot:function(a){a=A+"uploadSnapshot?snapshot="+encodeURIComponent(a.response);return s({metricId:"Service::UploadSnapshotCall",url:a})},whenOnline:function(){var a=jQuery.Deferred();if(KindleNetwork.isOnline())a.resolve();else{var b=
function(){KindleNetwork.removeEventListener("online",b);a.resolve()};KindleNetwork.addEventListener("online",b)}return a.promise()}};return{initialize:function(){KindleModuleManager.define(Kindle.MODULE.SERVICE_CLIENT,[Kindle.MODULE.SERVICE_INITIALIZATION_ARGS,KindleModuleManager.METRICS_MANAGER,Kindle.MODULE.DB_CLIENT],function(h,b,e){var r=jQuery.Deferred();P=b;M=e.getAppDb();var c,t;z=h.hostApp;if(h.loginParams)Q=h.loginParams.dsn,K=!!h.loginParams.useSignedServiceRequests,O=h.loginParams.qaMetricsUrl,
c=h.loginParams.hostName,t=h.loginParams.srsBasePath,S=h.loginParams.usePdxBucket;j=KindleApp.isHostControlled()?KindleVersion.parseVersionString(h.hostVersion):KindleVersion.getVersionNumber();KindleNetwork.initialize();window.addEventListener("beforeunload",g,!1);K?M.getUserHashId().always(function(b){b&&h.loginParams.clientHashId&&b!==h.loginParams.clientHashId?d(Kindle.Service.AuthUserMismatch):d(Kindle.Service.AuthOK);a({useSignedServiceRequests:!0,srsHostName:c,srsBasePath:t});r.resolve(T)}):
(t&&a({srsBasePath:t}),q().then(function(a){d(a?Kindle.Service.AuthOK:Kindle.Service.NotAuth);r.resolve(T)},r.reject));return r});KindleModuleManager.define(Kindle.MODULE.METRICS_UPLOADER,[],function(){return{uploadMetrics:B}})}}}(),KindleTOS=function(){function a(){var a="https://images-na.ssl-images-amazon.com/images/G/01/kindle/kindlefortheweb/store/"+L+"/BrowserHost-min.js",b=$.Deferred();if(g())return b.resolve().promise();$.getScript(a,function(){g()?b.resolve():b.reject()});return b.promise()}
function g(){return typeof BrowserHostAPI!=="undefined"}function d(){var a=new jQuery.Deferred,b={w:$(window).width(),h:$(window).height(),dpi:null,osv:null,deviceType:KindleHostDeviceDetector.getDeviceType(),bhv:L};KindleModuleManager.getModule([KindleModuleManager.SERVICE_CLIENT]).then(function(e){e.getEID().then(function(e){b.eid=e;a.resolve("?"+$.param(b))},function(){KindleDebug.error("Couldn't fetch EID.");a.reject("?"+$.param(b))})},function(){KindleDebug.error("SRS not loaded");a.reject("?"+
$.param(b))});return a.promise()}function b(a){function b(e){var j=H?"&asin="+encodeURIComponent(H):"",e=D+e+j+("&ref_="+(a||(H?Kindle.RefTag.Values.StoreSample:J?Kindle.RefTag.Values.StoreEmptyLibIpad:Kindle.RefTag.Values.StoreLibButtonIpad))),j=KindleApp.getPartnerTag();e+=j?"&tag="+j:"";u&&$("#"+q.KINDLE_STORE_CONTAINER_ID).addClass("hidden").empty();j=new Date;u=$(document.createElement("iframe")).attr("id",q.KINDLE_STORE_ID+j.getTime()).attr("src",e).attr("seamless","seamless").addClass(n);$("#"+
q.KINDLE_STORE_CONTAINER_ID).append(u)}d().then(b,b)}function c(){$("#"+q.KINDLE_STORE_CONTAINER_ID).addClass("hidden").empty();C=u=null;j=!0;A&&A()}function k(){var b=$.Deferred();a().then(function(){var a={hostVersion:v,storeStartTime:E,deviceType:KindleHostDeviceDetector.getDeviceType()};BrowserHost=new K4WBrowserHost(a,{pageReady:m,closeStore:l,openBook:o,bookStatus:s,openInExternalBrowser:f});b.resolve()},b.reject);return b.promise()}function m(){clearTimeout(w);$("#"+q.KINDLE_STORE_CONTAINER_ID).removeClass("hidden");
B.resolve(!1)}function l(){c()}function o(a){if(j){j=!1;var b=a.type,a=a.asin;if(y)switch(b){case t.EBOOK:y({asin:a,isSample:!1});c();break;case t.SAMPLE:y({asin:a,isSample:!0}),C=a,$("#"+q.KINDLE_STORE_CONTAINER_ID).hide(),A&&A()}}}function s(a){return{id:a,status:1,percentDownloaded:1}}function f(a){clearTimeout(w);B.resolve(!0);var b=document.createElement("a");b.href=a;b.target="_blank";a=document.createEvent("MouseEvents");a.initEvent("click",!0,!0);b.dispatchEvent(a)}var u,q={KINDLE_STORE_ID:"store",
KINDLE_STORE_CONTAINER_ID:"KindleStoreContainer"},n="KindleIFrame",v=3,w,B,H,E,J,D="https://www.amazon.com/gp/kindle/kcp/tos.html",L="029",y,A,C,j=!0,t={EBOOK:"EBOK",SAMPLE:"EBSP"};return{open:function(a){B=$.Deferred();H=a.asin;E=a.storeStartTime;J=a.isSourceEmptyLibBtn;if(H&&H===C&&u)return $("#"+q.KINDLE_STORE_CONTAINER_ID).show(),B.resolve(!1),B.promise();k().then(function(){w=setTimeout(function(){B.reject();c()},3E4);b(a.refTag)},B.reject);return B.promise()},setOpenBookCallback:function(a){y=
a},setStoreClosedCallback:function(a){A=a},setOpenBookReady:function(){j=!0},setStoreURL:function(a){D=a},proxyTouchEvent:function(a){if(g()){var b=JSON.parse(JSON.stringify(a));b.type=a.type;b.bubbles=a.bubbles;BrowserHost.proxyTouchEvent(b)}}}}(),KindleUpgradeDeviceDetector=function(){function a(a,d,b){a=KindleVersion.parseVersionString(a);return KindleVersion.parseVersionString(d)<=a&&a<=KindleVersion.parseVersionString(b)}return{isMetroUpdateRequiredBecauseVersionNonSupported:function(g){if(!KindleHostDeviceDetector.isMetro())return!1;
var d=!!KindleHostDeviceDetector.isOnline();return g&&d?a(g,"0.0.0.0","1.1.3.1"):!1},isMetroUpdateRequiredBecauseI18NSupported:function(g,d){if(!KindleHostDeviceDetector.isMetro())return!1;var b=!!KindleHostDeviceDetector.isOnline();return["de","es","it","fr","pt"].indexOf((d||KindleHostDeviceDetector.getBrowserLanguage()).substr(0,2))>-1&&g&&b?a(g,"1.0.2.0","1.0.2.99"):!1},isMetroUpdateRequiredBecauseCountryNotSupported:function(g,d,b){var c=jQuery.Deferred(),k=!!KindleHostDeviceDetector.isOnline(),
d=(d||KindleHostDeviceDetector.getBrowserLanguage()).substr(0,2);if(!KindleHostDeviceDetector.isMetro()||!k||!a(g,"1.0.2.0","1.0.2.99"))return c.resolve(!1).promise();g="/kcrservice/checkBLCountry?lang="+d;b&&(g+="&ip="+b);$.ajax({url:g,dataType:"json"}).then(function(a){c.resolve(a?a.value:!1)},function(){c.resolve(!1)});return c.promise()}}}(),ResourceBundle=function(a,g){function d(a){return!a||!f[a.toUpperCase()]?"":a.toUpperCase()}function b(a){return!a?"":s[a]?a:a.length===2&&B[a]?B[a]:(a=B[a.substr(0,
2).toLowerCase()])?a:""}function c(){KindleAssert(n,"Language and culture must be set before calling getLanguage");return n.substr(0,2).toLowerCase()}function k(){KindleAssert(v,"Language and culture must be set before calling getFormatRegion");return v}function m(a,b){function c(a,j){var f=b[j];delete b[j];return f}for(var f=/\$\{([A-Za-z0-9_]+)\}/g,b=$.extend({},b),j;f.exec(a)&&j!==a;)j=a,a=a.replace(f,c);return a}function l(a){return a&&a.length>=5?a.substr(3,2).toUpperCase():""}function o(){return navigator&&
(navigator.language||navigator.userLanguage)?navigator.language||navigator.userLanguage:""}var s=a,f=g,u=!1,q,n,v,w=-(new Date).getTimezoneOffset(),B={de:"de-DE",en:"en-US",es:"es-ES",fr:"fr-FR",it:"it-IT",pt:"pt-BR",ja:"ja-JP",zh:"zh-CN"},H={"amazon.com":"en-US","amazon.com.au":"en-AU","amazon.co.uk":"en-GB","amazon.in":"en-IN","amazon.ca":"en-CA","amazon.de":"de-DE","amazon.fr":"fr-FR","amazon.it":"it-IT","amazon.es":"es-ES","amazon.com.mx":"es-MX","amazon.com.br":"pt-BR","amazon.co.jp":"ja-JP",
"amazon.cn":"zh-CN"},E=function(a,b){if(u)return a;if(s[b])return s[b][a]},J={en:["the ","a ","an "],de:["die ","der ","das ","des ","dem ","den ","ein ","eine ","einer ","einem ","einen "],es:["el ","la ","los ","las ","un ","una ","unos ","unas "],pt:["o ","a ","os ","as ","um ","uma ","uns ","umas "],fr:["le ","la ","l'","les ","un ","une ","des "],it:["il ","lo ","la ","l'","i ","gli ","le ","un ","uno ","una ","un'"]},D={da:["og","i","jeg","det","at","en","den","til","er","som","p\u00e5","de",
"med","han","af","for"],de:["der","die","das","des","dem","den","ein","eine","einer","einem","einen","dies","diese","diesem","diesem","diesen","dieser","dieses","ich","du","er","sie","es","wir","ihr","sie","Sie","als","an","ans","auch","auf","aufs","aus","bei","fuer","f\u00fcr","nicht","nur","oder","so","und","um","ums","vom","von","in","im"],en:["the","a","an","this","that","these","those","i","you","she","he","it","we","they","as","like","at","to","also","on","of","by","for","not","only","or","so",
"and","about","from","in"],es:["el","la","los","las","un","una","unos","unas","del","al","este","ese","aquel","estos","esos","aquellos","esta","esa","aquella","estas","esas","aquellas","yo","t\u00fa","tus","vos","usted","\u00e9l","ella","ello","nosotros","nosotras","vosotros","vosotras","ustedes","ellos","ellas","en","y","o","a","por","no","ni","desde","e"],fi:["olla","olen","olet","on","olemme","olette","ovat","ole","se","sen","sit\u00e4","siin\u00e4","siit\u00e4","siihen","sill\u00e4","silt\u00e4",
"sille","sin\u00e4","siksi","kanssa"],fr:["le","la","l'","les","un","une","des","du","de","au","aux","ce","cet","cette","ces","je","tu","elle","il","on","nous","vous","elles","ils","comme","\u00e0","aussi","sur","par","pour","ne","n\u2019","pas","ou","or","donc","et","dans"],hu:["a","az","egy","be","ki","le","fel","meg","el","\u00e1t","r\u00e1","ide","oda","sz\u00e9t","\u00f6ssze","vissza","de","h\u00e1t","\u00e9s","vagy","hogy","van","lesz","volt","csak","nem","igen","mint","\u00e9n","te","\u00f5",
"mi","ti","\u00f5k","\u00f6n"],it:["il","lo","la","l'","i","gli","le","un","uno","una","un'","del","dello","della","dell'","dei","degli","degl'","delle","questo","questa","questi","queste","quello","quella","quelli","codesto","codesta","codesti","codeste","io","noi","tu","voi","egli","esso","essi","ella","essa","esse","ad","al","allo","agli","all","agl","alla","alle","con","col","coi","da","dal","dallo","dai","dagli","dall","dagl","dalla","dalle","di","del","dello","dei","degli","dell","degl","della",
"delle","in","nel","nello","nei","nell","negl","nella","nelle","su","sul","sullo","sui","sugli","sull","sugl","sulla","sulle","per","ed","anche","non","a","e","o"],nl:["de","en","van","ik","te","dat","die","in","een","hij","het","niet","zijn","is","was","op","aan","met","als","voor","had","er"],no:["at","en","et","den","til","er","p\u00e5","med","han","av","var","ved","fra","bli","ble","blei","blitt","v\u00e6re","kom","for","\u00e5","blir","v\u00e6rt","v\u00e6re","d\u00e5","ein","eit","eitt","vere",
"vore","verte","vort","varte","vart"],pt:["o","a","os","as","um","uma","uns","umas","esta","estes","estas","aquele","aquela","aqueles","aqueles","aquelas","isto","aquilo","eu","voc\u00ea","ele","ela","n\u00f3s","v\u00f3s","voc\u00eas","eles","elas","de","a","e","em","para","n\u00e3o","no","na","por","como","ou"],ro:["o","unui","unei","unor","cel","cea","cei","cele","celui","celei","celor","al","a","ai","ale","pe","la","\u00een","f\u0103r\u0103","sub","despre","c\u0103tre","cu","de","din","l\u00e2ng\u0103",
"spre","ca","sunt","s","e\u015fti","este","e","suntem","sunte\u0163i","eram","erai","era","era\u0163i","erau","fiu","fii","fie","fim","fi\u0163i","fi","fiind","fost"],sv:["och","det","att","i","en","jag","hon","som","han","p\u00e5","den","med","var","sig","f\u00f6r","s\u00e5","till","\u00e4r","men","ett","om","hade","de","av"],tr:["acaba","altm\u00fd\u00fe","alt\u00fd","ama","bana","baz\u00fd","belki","ben","benden","beni","benim","be\u00fe","bin","bir","biri","birka\u00e7","birkez","bir\u00feey",
"bir\u00feeyi","biz","bizden","bizi","bizim","bu","buna","bunda","bundan","bunu","bunun","da","daha","dahi","de","defa","diye","doksan","dokuz","d\u00f6rt","elli","en","gibi","hem","hep","hepsi","her","hi\u00e7","iki","ile","INSERmi","ise","i\u00e7in","katrilyon","kez","ki","kim","kimden","kime","kimi","k\u00fdrk","milyar","milyon","mu","m\u00fc","m\u00fd","nas\u00fdl","ne","neden","nerde","nerede","nereye","niye","ni\u00e7in","on","ona","ondan","onlar","onlardan","onlari","onlar\u00fdn","onu","otuz",
"sanki","sekiz","seksen","sen","senden","seni","senin","siz","sizden","sizi","sizin","trilyon","t\u00fcm","ve","veya","ya","yani","yedi","yetmi\u00fe","yirmi","y\u00fcz","\u00e7ok","\u00e7\u00fcnk\u00fc","\u00fc\u00e7","\u00feey","\u00feeyden","\u00feeyi","\u00feeyler","\u00feu","\u00feuna","\u00feunda","\u00feundan","\u00feunu"]};return{initialize:function(a,c){var f=H[Kindle.URL.getAmazonDomain()];n=b(a)||b(o())||b(f)||"en-US";v=d(c)||d(l(n))||"US";f=c&&c.toUpperCase()||l(a)||l(o())||l(f)||"US";
q=n.substr(0,2).toLowerCase()+"-"+f},getFormatRegion:k,getUserLanguageCulture:function(){KindleAssert(q,"Language and culture must be set before calling getUserLanguageCulture");return q},getLanguage:c,getLocalizedString:function(a,c,f){var d=n;f&&(d=b(f));f=E(a,d);typeof f!=="string"&&(d!=="en-US"&&(f=E(a,"en-US")),f||(f=a));c&&(f=m(f,c));return f},getLocalizedTime:function(a){return $.format.date(a,f[k()].k_format_time,c())},getLocalTimeOffset:function(){return w},getLocalizedDate:function(a){return $.format.date(a,
f[k()].k_format_date,c())},getLocalizedDateTime:function(a){return $.format.date(a,f[k()].k_format_date_time,c())},getLocalizedArticles:function(){return J[c()]||[]},getLocalizedSearchStopWords:function(a){a=a||c();return D[a]||[]},isLanguageEN:function(){return n.substring(0,2)==="en"},setStringIDMode:function(a){u=!!a},languageCultureNameToRegion:l}}(Kindle.strings,Kindle.formats),KindleO_Aaa=function(){function a(a){for(var c=[],d,s,f,g,k,n,v=0;v<a.length;)f=a.charCodeAt(v++)&255,d=a.charCodeAt(v++),
g=d&255,s=a.charCodeAt(v++),k=s&255,n=f>>2,f=(f&3)<<4|g>>4,g=(g&15)<<2|k>>6,k&=63,isNaN(d)?g=k=64:isNaN(s)&&(k=64),c.push(b.charAt(n)+b.charAt(f)+b.charAt(g)+b.charAt(k));return c.join("")}function g(a){for(var b=[],d,g,f,k,q,n=0;n<a.length;)d=c[a.charCodeAt(n++)],g=c[a.charCodeAt(n++)],k=c[a.charCodeAt(n++)],q=c[a.charCodeAt(n++)],d=d<<2|g>>4,g=(g&15)<<4|k>>2,f=(k&3)<<6|q,b.push(String.fromCharCode(d)),k!==64&&b.push(String.fromCharCode(g)),q!==64&&b.push(String.fromCharCode(f));return b.join("")}
function d(a,b){var c=[];c.length=256;for(var d=0;d<256;d++)c[d]=d;for(var f=0,g,d=0;d<256;d++)f=f+c[d]+b[d%b.length]&255,g=c[d],c[d]=c[f],c[f]=g;for(var f=d=0,k=[],n=0;n<a.length;n++)d=d+1&255,f=f+c[d]&255,g=c[d],c[d]=c[f],c[f]=g,k.push(String.fromCharCode(a.charCodeAt(n)^c[c[d]+c[f]&255]));return k.join("")}for(var b="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",c=[],k=0;k<b.length;k+=1)c[b.charCodeAt(k)]=k;return{o_aaa:a,o_aag:g,o_aac:function(b,c){var g;g=b.replace(/\x0d\x0a/g,
"\n");for(var s=[],f=0;f<g.length;f++){var u=g.charCodeAt(f);u<128?s.push(String.fromCharCode(u)):(u>127&&u<2048?s.push(String.fromCharCode(u>>6|192)):(s.push(String.fromCharCode(u>>12|224)),s.push(String.fromCharCode(u>>6&63|128))),s.push(String.fromCharCode(u&63|128)))}g=s.join("");s=c;s+="00000000000000000000000000000000".substring(0,32-s.length);f=[];for(k=0;k<s.length;k+=2)f.push(parseInt(s.substring(k,k+2),16));return a(d(g,f))},o_aad:function(a,b){for(var c=g(a),k=[],f=0;f<b.length;f++)k.push(b.charCodeAt(f));
for(var c=d(c,k),k=[],f=0,u,q,n;f<c.length;)u=c.charCodeAt(f),u<128?(k.push(String.fromCharCode(u)),f++):u>191&&u<224?(q=c.charCodeAt(f+1),k.push(String.fromCharCode((u&31)<<6|q&63)),f+=2):(q=c.charCodeAt(f+1),n=c.charCodeAt(f+2),k.push(String.fromCharCode((u&15)<<12|(q&63)<<6|n&63)),f+=3);return k.join("")}}}(),KindleAppDb=function(a){function g(){return KindleModuleManager.getModuleSync(KindleModuleManager.DB_CLIENT).getBookDb()}function d(a){var b=new jQuery.Deferred;k.getRecord("keyValue",{key:a}).then(function(a){a&&
a.length>0&&b.resolve(a[0].value);b.reject()},b.reject);return b.promise()}function b(a,b){return k.upsertRecord("keyValue",{value:b},{key:a})}function c(a){return k.deleteRecord("keyValue",{key:a})}var k=a;a.updateBookData=function(a,b,c){var d,f,u=[],q=[];for(d in a)q.push(a[d].asin),u.push({operation:Kindle.DB.DELETE_RECORD_OPERATION,tableName:"bookdata",params:[{asin:a[d].asin}]});for(d in b)a=b[d],u.push({operation:Kindle.DB.UPSERT_RECORD_OPERATION,tableName:"bookdata",params:[a,{asin:a.asin}]});
f=u.length;c&&u.push({operation:Kindle.DB.UPSERT_RECORD_OPERATION,tableName:"keyValue",params:[{value:String(c)},{key:"synctime"}]});return k.batchTransaction(u).pipe(function(){function a(){return f}return q.length<1||!g()?(new jQuery.Deferred).resolve(f):g().deleteBooksData(q).pipe(a,a)})};a.getAllBooks=function(){return k.getRecord("bookdata")};a.getAllBooksForContentType=function(a){return k.getRecord("bookdata",{contentType:a})};a.getBook=function(a,b){k.getRecord("bookdata",{asin:a}).done(function(a){b(a.length>
0?a[0]:{})})};a.getBookDataLastSyncTime=function(a){d("synctime").done(function(b){a(b?b:Kindle.DB.NEVER)}).fail(function(){a(Kindle.DB.NEVER)})};a.updateLastPositionRead=function(a,b,c,d){k.updateRecord("bookdata",{lastPositionRead:b,lastTimeRead:c},{asin:a}).fail(d)};a.updateLastFPRSyncTime=function(a,b,c){k.updateRecord("bookdata",{lastFPRSyncTime:b},{asin:a}).fail(c)};a.updateLastReadTime=function(a,b,c,d){k.upsertRecord("bookdata",{lastTimeRead:b,lastFPRSyncTime:c},{asin:a}).fail(d)};a.updateMaxPosition=
function(a,b,c){k.updateRecord("bookdata",{maxPosition:b},{asin:a}).fail(c)};a.getDeviceToken=function(){return d(Kindle.Service.DeviceTokenKey)};a.setDeviceToken=function(a){return b(Kindle.Service.DeviceTokenKey,a)};a.clearDeviceToken=function(){return c(Kindle.Service.DeviceTokenKey)};a.getUserHashId=function(){return d(Kindle.Service.UserHashIdKey)};a.setUserHashId=function(a){return b(Kindle.Service.UserHashIdKey,a)};a.clearUserHashId=function(){return c(Kindle.Service.UserHashIdKey)};a.getEID=
function(){return d(Kindle.Service.EidKey)};a.setEID=function(a){return b(Kindle.Service.EidKey,a)};a.clearEID=function(){return c(Kindle.Service.EidKey)};a.getValueForKey=d;a.setValueForKey=b;a.removeValueForKey=c;a.getValuesForKeys=function(a){for(var b=[],c=new jQuery.Deferred,d=0;d<a.length;d++)b.push({operation:Kindle.DB.GET_RECORD_OPERATION,tableName:"keyValue",params:[{key:a[d]}]});k.batchTransaction(b).then(function(a){for(var b,d={},g=0;g<a.length;g++)if(a[g]&&a[g].length)b=a[g][0],d[b.key]=
b.value;c.resolve(d)},c.reject);return c.promise()};a.getCachedAsins=function(a,b){function c(b){var f,g=[];for(f=0;f<b.length;f++)a.indexOf(b[f].cacheState)>=0&&g.push(b[f]);d.resolve(g)}var d=jQuery.Deferred();if(g()){var f={asin:!0,cacheState:!0,cachedSize:!0,context:!!b};g().getRecord("bookinfo",null,f).then(a?c:d.resolve,d.reject)}else d.resolve([]);return d.promise()};a.getCachedCovers=function(){function a(c){var d,f={};for(d=0;d<c.length;d++)f[c[d].asin]=c[d].coverData;b.resolve(f)}var b=
new jQuery.Deferred;g()?g().getRecord("covers",null).then(a,b.reject):a([]);return b.promise()};a.getBookCachedState=function(a){return g()?g().getRecord("bookinfo",{asin:a},{cacheState:!0}):(a=new jQuery.Deferred,a.resolve([]),a.promise())};a.getPinnedSessionIds=function(){function a(b){var d,g=[];if(b)for(d=0;d<b.length;d++)g.push(b[d].context.kindleSessionId);c.resolve(g)}function b(){c.resolve([])}var c=new jQuery.Deferred;g()?g().getRecord("bookinfo",{cacheState:Kindle.BookInfo.CachedState.PINNED},
{context:!0}).then(a,b):c.resolve([]);return c.promise()};return a},KindleBookDb=function(a){function g(){switch(KindleHostDeviceDetector.getDevicePlatform()){case "iPad":case "iPhone":case "playBook":return 5E7;case "desktop":return KindleHostDeviceDetector.isIE()?25E7:Number.MAX_VALUE;default:return 5E7}}function d(a,b){var c={},d;for(d in a)a.hasOwnProperty(d)&&!b[d]&&(c[d]=a[d]);c=JSON.stringify(c);return c==="{}"?"":c}function b(a,b){if(b){var c=JSON.parse(b),d;for(d in c)c.hasOwnProperty(d)&&
(a[d]=c[d])}return a}function c(a,b,c,d,e,f){var g=Date.now();y.getRecord(a,{asin:c,id:{operator:Kindle.DB.IN_ARRAY,values:d}}).then(function(a){b(a,g,e)},function(a){f(a)})}function k(a,b,c,d,e,f){Date.now();var g=0,k,w=[],l;for(l in d)k=b(c,d[l]),g+=k.size,w.push(k);y.insertList(a,w).then(function(){Date.now();e(g)},function(a){f(a)})}function m(a,b,c,d){var e=KindleMetricsProfiler("getIds:"+a);y.getPieceIds(a,b).then(function(a){e.addCount(b,a.length);e.endTimer();e.log();c(a)},function(a){d(a)})}
function l(a,c,d){Date.now();var c=[],f=0,e;for(e in a){var g=a[e],k=g.id;f+=g.piece.length+g.metadata.length;c[k]=b({fragmentData:g.piece,fragmentMetadata:JSON.parse(g.metadata)},g.other)}d(c)}function o(a,b){var c=b.fragmentData,f=JSON.stringify(b.fragmentMetadata),e=d(b,{fragmentData:1,fragmentMetadata:1});return{asin:a,id:b.fragmentMetadata.id,size:c.length+f.length+e.length,piece:c,metadata:f,other:e}}function s(a,c,d){Date.now();var c=[],f;for(f in a){var e=a[f];c[e.id]=b({skeletonData:e.piece,
skeletonMetadata:JSON.parse(e.metadata)},e.other)}d(c)}function f(a,b){var c=b.skeletonData,f=JSON.stringify(b.skeletonMetadata),e=d(b,{skeletonData:1,skeletonMetadata:1});return{asin:a,id:b.skeletonMetadata.id,size:c.length+f.length+e.length,piece:c,metadata:f,other:e}}function u(a,c,d){Date.now();var c=[],f=0,e;for(e in a){var g=a[e],k=g.id;f+=g.piece.length+g.metadata.length;c[k]=b({glyphData:JSON.parse(g.piece),glyphFragmentMetadata:JSON.parse(g.metadata)},g.other)}d(c)}function q(a,b){var c=
JSON.stringify(b.glyphData),f=JSON.stringify(b.glyphFragmentMetadata),e=d(b,{glyphData:1,glyphFragmentMetadata:1});return{asin:a,id:b.glyphFragmentMetadata.id,size:c.length+f.length+e.length,piece:c,metadata:f,other:e}}function n(a,c,d){Date.now();var c=[],f=0,e;for(e in a){var g=a[e],k=g.id;f+=g.piece.length+g.metadata.length;c[k]=b({data:JSON.parse(g.piece),metadata:JSON.parse(g.metadata)},g.other)}d(c)}function v(a,b){var c=JSON.stringify(b.data),f=JSON.stringify(b.metadata),e=d(b,{data:1,metadata:1});
return{asin:a,id:b.metadata.id,size:c.length+f.length+e.length,piece:c,metadata:f,other:e}}function w(a,c,d){Date.now();var c=[],f=0,e;for(e in a){var g=a[e],k=g.id;f+=g.piece.length+g.metadata.length;c[k]=b({locations:JSON.parse(g.piece),metadata:JSON.parse(g.metadata)},g.other)}d(c)}function B(a,b){var c=JSON.stringify(b.locations),f=JSON.stringify(b.metadata),e=d(b,{locations:1,metadata:1});return{asin:a,id:b.metadata.id,size:c.length+f.length+e.length,piece:c,metadata:f,other:e}}function H(a){return y.dbDeleteBooksData(a)}
function E(a){return y.dbGetBookStatistics(a)}function J(){var a=new jQuery.Deferred;y.getRecord("bookinfo",{cacheState:Kindle.BookInfo.CachedState.PINNED},{cachedSize:!0}).then(function(b){var c=0,d;for(d in b)c+=b[d].cachedSize;a.resolve(c)},function(){a.reject()});return a.promise()}function D(){var a=new jQuery.Deferred,b=g();b===Number.MAX_VALUE?a.resolve(Number.MAX_VALUE):J().then(function(c){c=b-1E6-c*2.4;c=Math.round(c/2.4);a.resolve(c)},function(){a.resolve(0)});return a.promise()}function L(b){function d(){var a=
new jQuery.Deferred;D().then(function(b){I=b;a.resolve(b)},function(){I=0;a.resolve()});return a.promise()}var g=0,I=0;return{getFragments:function(a){var d=new jQuery.Deferred;c("fragments",l,b,a,d.resolve,d.reject);return d.promise()},putFragments:function(a){var c=new jQuery.Deferred;k("fragments",o,b,a,function(a){g+=a;c.resolve(a)},c.reject);return c.promise()},getFragmentIds:function(){var a=new jQuery.Deferred;m("fragments",b,a.resolve,a.reject);return a.promise()},getSkeletons:function(a){var d=
new jQuery.Deferred;c("skeleton",s,b,a,d.resolve,d.reject);return d.promise()},putSkeletons:function(a){var c=new jQuery.Deferred;k("skeleton",f,b,a,function(a){g+=a;c.resolve(a)},c.reject);return c.promise()},getSkeletonIds:function(){var a=new jQuery.Deferred;m("skeleton",b,a.resolve,a.reject);return a.promise()},getGlyphs:function(a){var d=new jQuery.Deferred;c("glyphs",u,b,a,d.resolve,d.reject);return d.promise()},putGlyphs:function(a){var c=new jQuery.Deferred;k("glyphs",q,b,a,function(a){g+=
a;c.resolve(a)},c.reject);return c.promise()},getGlyphIds:function(){var a=new jQuery.Deferred;m("glyphs",b,a.resolve,a.reject);return a.promise()},getResources:function(a){var d=new jQuery.Deferred;c("resources",n,b,a,d.resolve,d.reject);return d.promise()},putResources:function(a){var c=new jQuery.Deferred;k("resources",v,b,a,function(a){g+=a;c.resolve(a)},c.reject);return c.promise()},getResourceIds:function(){var a=new jQuery.Deferred;m("resources",b,a.resolve,a.reject);return a.promise()},getLocationMaps:function(a){var d=
new jQuery.Deferred;c("locations",w,b,a,d.resolve,d.reject);return d.promise()},putLocationMaps:function(a){var c=new jQuery.Deferred;k("locations",B,b,a,function(a){g+=a;c.resolve(a)},c.reject);return c.promise()},getLocationMapIds:function(){var a=new jQuery.Deferred;m("locations",b,a.resolve,a.reject);return a.promise()},getAnnotations:function(){return y.getRecord("annotationsCache",{asin:b},{annotationsData:!0}).pipe(function(a){if(a&&a.length===1)return a[0].annotationsData})},putAnnotations:function(a){return y.insertRecord("annotationsCache",
{asin:b,annotationsData:a})},getBookInfo:function(){var a=new jQuery.Deferred;y.getRecord("bookinfo",{asin:b}).then(function(b){b.length===1?(g=b[0].cachedSize||0,a.resolve(b[0])):a.reject()},a.reject);return a.promise()},insertBookInfo:function(a){a=$.extend(!0,{},a,{asin:b,openTime:Date.now()});return y.insertRecord("bookinfo",a)},updateBookInfo:function(a){a=$.extend({openTime:Date.now()},a);return y.updateRecord("bookinfo",a,{asin:b})},getBookStatistics:function(){var a=new jQuery.Deferred;E(b).then(function(c){c.totalSize!==
c.cachedSize?(g=c.cachedSize=c.totalSize,y.updateRecord("bookinfo",{cachedSize:g},{asin:b}).then(function(){a.resolve(c)},a.reject)):a.resolve(c)},a.reject);return a.promise()},getCacheQuota:function(){return{cachedSize:g,cacheQuota:I}},computeCacheQuota:function(){return d().promise()},deleteOldestBookData:function(b){return a.deleteOldestBookData(b)},deleteBooksData:function(b){return a.deleteBooksData(b)},deleteSearchIndex:function(){return y.deleteRecord("searchIndex",{asin:b})},getPageNumbers:function(){return y.getRecord("pageNumberCache",
{asin:b},{pageNumberData:!0}).pipe(function(a){if(a&&a.length===1)return a[0].pageNumberData})},putPageNumbers:function(a){return y.insertRecord("pageNumberCache",{asin:b,pageNumberData:a})},getSearchIndex:function(){return y.getSearchIndexData(b)},putSearchIndex:function(a){return y.putSearchIndexData(b,a)},reserveStorage:function(a){function b(){g=setTimeout(function(){g=null;y.dropTable(d)},1E3)}function c(){var a=new ArrayBuffer(j*1024),a=new Blob([a]);y.insertRecord(d,{asin:"0000000000",id:f,
data:a}).then(function(){g&&(clearTimeout(g),--f>0?(b(),c()):y.dropTable(d))},function(){g&&(clearTimeout(g),y.dropTable(d))})}var d="reservedStorage",j=100,f=a*1024/j,g;b();c()},getFilteredSearchIndexAsins:function(a){var b=$.Deferred();y.getRecord("searchIndex",{asin:{operator:Kindle.DB.IN_ARRAY,values:a}},{asin:!0}).then(function(a){a=a.map(function(a){return a.asin}).sort().filter(function(a,b,c){return b===0||c[b-1]!==c[b]});b.resolve(a)},b.reject);return b.promise()}}}var y=a,A=null,C=0;a.deleteBooksData=
H;a.deleteOtherBooksData=function(a){for(var b=new jQuery.Deferred,c=["fragments","glyphs","skeleton","bookinfo","annotationsCache","covers","searchIndex","pageNumberCache"],d=[],e=0;e<c.length;e++)d.push({operation:Kindle.DB.DELETE_RECORD_OPERATION,tableName:c[e],params:[{asin:{operator:Kindle.DB.NOT_EQUAL,values:[a]}}]});y.batchTransaction(d).then(function(){b.resolve()},function(a){b.reject(a)});return b.promise()};a.deleteOldestBookData=function(a){function b(){A.resolve(arguments);A=null}function c(){A.reject(arguments);
A=null}function d(e){function f(a){for(var b=function(){return a&&a.length>0?e.filter(function(b){return a.indexOf(b.asin)>=0}):e}(),c=b[0],d=1;d<b.length;d++)b[d].openTime<c.openTime&&(c=b[d]);return c.asin}function g(){H([f()]).then(b,c)}if(!e||e.length===0)KindleHostDeviceDetector.isIE()&&C===0?(b(),C++):(KindleDebug.warn("trying to delete oldest asin, but got no list of books"),C=0,c());else{C=0;var k=e.map(function(a){return a.asin});L(a).getFilteredSearchIndexAsins(k).done(function(a){a&&a.length>
0?L(f(a)).deleteSearchIndex().then(b,c):g()}).fail(g)}}A||(A=new jQuery.Deferred,y.getOldBookList(a).then(d,c));return A};a.getBookStatistics=E;a.updateBookInfos=function(a){var b=[],c;for(c in a){var d={},e;for(e in a[c])d[e]=a[c][e];b.push({operation:Kindle.DB.UPDATE_RECORD_OPERATION,tableName:"bookinfo",params:[d,{asin:c}]})}return y.batchTransaction(b)};a.BookInfoDB=L;return a},KindleDBClient=function(){function a(){if(!E)throw{name:"databaseInitializationError",message:"Please call initialize function first"};
}function g(a){var b=$.extend({appDb:D},a);B.callEventListeners(a.type,b)}function d(a){var b=$.extend({bookDb:L},a);B.callEventListeners(a.type,b)}function b(a){var b=new jQuery.Deferred;a.wrapper?a.wrapper.dropTables().then(b.resolve,b.reject,b.notify):b.resolve();return b.promise()}function c(a){if(J)return J.promise();J=new jQuery.Deferred;K.initDfd=new jQuery.Deferred;var b=KindleStubDBWrapper(P);u(!1);b.createTables(M,K.version).then(function(){m(b);KindleAppDb(b);K.wrapper=b;K.initDfd.resolve(b);
y=D=b;E=!0;J.resolve(a)},function(a){J.reject(a)});return J.promise()}function k(){function a(){++j===d&&(y=null,KindleStubDBWrapper(P).dropTables(),c.resolve())}function b(h){return function(b){var e=[],d;for(d in b)e.push({operation:Kindle.DB.UPSERT_RECORD_OPERATION,tableName:h,params:[b[d],b[d]]});D.batchTransaction(e).then(a,c.reject)}}var c=new jQuery.Deferred;if(!y)return c.resolve(),c.promise();var e=y.getTableNames(),d=e.length,j=0,f;for(f in e)y.getRecord(e[f]).then(b(e[f]),c.reject);return c.promise()}
function m(a){function b(h){return{tableName:h,insertRecord:function(b){return a.insertRecord(h,b)},insertList:function(b){return a.insertList(h,b)},updateRecord:function(b,c){return a.updateRecord(h,b,c)},getRecord:function(b,c){return a.getRecord(h,b,c)},deleteRecord:function(b){return a.deleteRecord(h,b)},batchTransaction:function(b){var c;for(c=0;c<b.length;c++)b[c].tableName=h;return a.batchTransaction(b)}}}var c=a.getTableNames(),e,d;for(d in c)e=c[d],Q[e]=b(e);a.getTable=function(a){return Q[a]}}
function l(a){a.onversionchange=function(a){K.handle&&K.handle.close();O.handle&&O.handle.close();a&&a.target&&a.target.close&&typeof a.target.close==="function"&&a.target.close();setTimeout(function(){function a(){window.location.reload(!0)}_metricsManager.emitNow("App::DatabaseGoneOnVersionZero",{breakdown:["Browser"]}).then(a,a)},500)}}function o(){function a(){m(b);KindleAppDb(b);K.wrapper=b;K.initDfd.resolve(b)}var b={};if(!K.initDfd)K.initDfd=new jQuery.Deferred,KindleHostDeviceDetector.isWebSQLSupported()?
(b=KindleSqlWrapper(K),b.flavor="websql",b.openDatabase().then(function(b){K.handle=b;a();KindleLocalStorage.setItem("haveDB","1")},K.initDfd.reject)):KindleHostDeviceDetector.isIndexedDBSupported()?(b=KindleIDBWrapper(K),b.flavor="IndexedDB",b.openDatabase().done(function(b){l(b);K.handle=b;KindleLocalStorage.setItem("haveDB","1");a()}).fail(K.initDfd.reject)):c(this);return K.initDfd.promise()}function s(){function a(){m(b);KindleBookDb(b);O.wrapper=b;O.initDfd.resolve(b)}var b={};if(!O.initDfd){O.initDfd=
new jQuery.Deferred;try{KindleHostDeviceDetector.isWebSQLSupported()?(b=KindleSqlWrapper(O),b.openDatabase().then(function(c){O.handle=c;a(b)},O.initDfd.reject)):KindleHostDeviceDetector.isIndexedDBSupported()?(b=KindleIDBWrapper(O),b.openDatabase().done(function(b){l(b);O.handle=b;a()}).fail(O.initDfd.reject)):O.initDfd.reject("nodb")}catch(c){O.initDfd.reject()}}return O.initDfd.promise()}function f(){if(KindleHostDeviceDetector.isChromeApp())return!0;if((KindleHostDeviceDetector.isFirefox()||KindleHostDeviceDetector.isIE())&&
KindleLocalStorage.getItem("haveDB"))return!0;var a=KindleLocalStorage.getItem("booksdb");if(a==="true")return!0;else if(a==="false")return!1}function u(a){KindleLocalStorage.setItem("booksdb",a?"true":"false")}function q(){var a;a=new jQuery.Deferred;if(L)return a.resolve(L),a.promise();var b;b=!KindleHostDeviceDetector.isWebSQLSupported()&&!KindleHostDeviceDetector.isIndexedDBSupported()?!1:KindleHostDeviceDetector.isChrome()&&!KindleHostDeviceDetector.isChromeApp()?!1:!0;if(!b)return a.reject(),
a.promise();O.initDfd=null;s().then(function(b){L=b;u(!0);a.resolve(L)},function(){u(!1);a.reject()});return a.promise()}function n(){var a;a=new jQuery.Deferred;if(D&&D!==y)return a.resolve(D).promise();K.initDfd=null;o().then(function(b){D=b;a.resolve(D)},function(){a.reject()});return a.promise()}function v(){function a(){D=y;KindleLocalStorage.removeItem("haveDB");C=A.memAppDb}function b(){C=A.dbBookDb}function c(e){return k().pipe(function(){D=e;y=null;KindleLocalStorage.removeItem(P);C=A.dbAppDb;
return q().pipe(b)},a)}var e;switch(C){case A.dbBookDb:e=$.Deferred().resolve();break;case A.dbAppDb:e=q().pipe(b);break;case A.memAppDb:e=n().pipe(c,a)}return e.promise()}function w(){function a(b,h){D=b;C=(L=h)?A.dbBookDb:A.dbAppDb;E=!0;H.resolve(S)}function b(h){$.when(f()?s():null).then(function(b){C=A.dbBookDb;a(h,b)},function(){C=A.dbAppDb;a(h,null)})}function e(){C=A.memAppDb;c(S).done(H.resolve)}if(!H)H=new jQuery.Deferred,(KindleHostDeviceDetector.isFirefox()||KindleHostDeviceDetector.isIE()?
KindleLocalStorage.getItem("haveDB"):1)?o().then(b,e):(C=A.memAppDb,c(S).done(H.resolve));return H.promise()}var B=ListenerManager(),H=null,E=!1,J=null,D=null,L=null,y=null,A={none:"none",memAppDb:"memAppDb",dbAppDb:"dbAppDb",dbBookDb:"dbBookDb"},C=A.none,j=Kindle.DB.TEXT_TYPE,t=Kindle.DB.NUMBER_TYPE,r=Kindle.DB.OBJECT_TYPE,I=Kindle.DB.BLOB_TYPE,e=Kindle.DB.ALLOW_NULL,z=Kindle.DB.PRIMARY_KEY,N=Kindle.DB.PIECE_ID_TYPE,P="app_db_storage",M={bookdata:{asin:j|z,contentType:j|e,title:j|e,authors:r|e,purchaseDate:t|
e,maxPosition:t|e,lastTimeRead:t|e,lastPositionRead:t|e,lastFPRSyncTime:t|e,authorPronunciations:r|e,titlePronunciation:j|e},keyValue:{key:j|z,value:j|e},metrics:{method:j,time:t,timers:r|e,counters:r|e,breakDown:r|e},journal:{id:Kindle.DB.AUTO_INCREMENT,entry:r}},j={bookinfo:{asin:j|z,cacheState:j|Kindle.DB.SECONDARY_KEY,cachedSize:t|e,openTime:t,context:r,metadata:r,manifest:r,fragmap:r},skeleton:{asin:j|z,id:t|z|N,size:t,piece:j,metadata:j,other:j},fragments:{asin:j|z,id:t|z|N,size:t,piece:j,metadata:j,
other:j},glyphs:{asin:j|z,id:t|z|N,size:t,piece:j,metadata:j,other:j},resources:{asin:j|z,id:t|z|N,size:t,piece:j,metadata:j,other:j},locations:{asin:j|z,id:t|z|N,size:t,piece:j,metadata:j,other:j},annotationsCache:{asin:j|z,annotationsData:r},covers:{asin:j|z,coverData:j},searchIndex:{asin:j|z,component:j|z,data:I},pageNumberCache:{asin:j|z,pageNumberData:r},reservedStorage:{asin:j|z,id:j|z,data:I}},Q={},K={shortName:"K4W",version:2,displayName:"Kindle Cloud Reader",defaultSize:5E6,initDfd:null,
wrapper:null,handle:null,tables:M,versionUpdate:[{version:2,tableName:"bookdata",operation:Kindle.DB.ALTER_TABLE_OPERATION,params:["contentType"]},{version:2,tableName:"bookdata",operation:Kindle.DB.UPDATE_RECORD_OPERATION,params:[{contentType:"EBOK"}]},{version:3,tableName:"bookdata",operation:Kindle.DB.ALTER_TABLE_OPERATION,params:["authorPronunciations","titlePronunciation"]}]},O={shortName:"K4Wbooks",version:7,displayName:"Kindle Cloud Reader Books",defaultSize:5E7,initDfd:null,wrapper:null,handle:null,
tables:j,versionUpdate:[{version:4,tableName:"bookinfo",operation:Kindle.DB.ALTER_TABLE_OPERATION,params:["manifest"]},{version:5,tableName:"searchIndex",operation:Kindle.DB.CREATE_TABLE_OPERATION,params:[j.searchIndex]},{version:6,tableName:"pageNumberCache",operation:Kindle.DB.CREATE_TABLE_OPERATION,params:[j.pageNumberCache]},{version:7,tableName:"reservedStorage",operation:Kindle.DB.CREATE_TABLE_OPERATION,params:[j.reservedStorage]}]},S={enableFullDb:function(){return v(this)},getAppDb:function(){a();
return D},getBookDb:function(){a();return L},bookDbEnabled:f,persistDB:function(){D&&D.persist&&D.persist();L&&L.persist&&L.persist()},clear:function(a,h){function c(){K.wrapper=null;D=K.initDfd=null;O.wrapper=null;y=L=O.initDfd=null;E=!1;J=_initializeFullDeferred=null;e.resolve()}var e=new jQuery.Deferred;(function(){function a(b){b=Number(b)||0;e.notify({clearDbAttempts:b});return K.wrapper.setValueForKey("clearDbAttempts",b+1)}return K.wrapper.getValueForKey("clearDbAttempts").pipe(a,a)})().always(function(){b(K).then(function(){b(O).then(c,
e.reject)},e.reject,e.notify)});e.then(a,h);return e.promise()},addEventListener:function(a,b){D&&D.addEventListener&&D.addEventListener(a,g);L&&L.addEventListener&&L.addEventListener(a,d);B.addEventListener(a,b)},removeEventListener:function(a,b){B.removeEventListener(a,b)}};return{initialize:function(){KindleModuleManager.define(Kindle.MODULE.DB_CLIENT,[Kindle.MODULE.APPLICATION_ARGS],w)}}}();
function KindleIDBWrapper(a){function g(a,b){b=b||{};b.type=b.type||a;N.callEventListeners(a,b)}function d(a){if(!z[a])throw{name:"databaseAccessError",message:"Trying to access undefined table "+a};}function b(){var a=[],b;for(b in z)a.push(b);return a}function c(a,b,c){if(z[a].info[b]&Kindle.DB.PIECE_ID_TYPE){for(a=""+c;a.length<t;)a="0"+a;return a}else return c}function k(a,b){if(a&&b){d(b);var e=z[b],f="";if(e.genKeyPath)for(var e=e.keyList,g=0;g<e.length;++g){if(a[e[g]]===void 0){f=void 0;break}f+=
c(b,e[g],a[e[g]]);g<e.length-1&&(f+=j)}else f=a[e.keyPath];return f}}function m(a,b,e){for(var d="",f,g,r=0;r<b.length;++r){f=b[r];g=e[f];if(!g)break;g=g.hasOwnProperty(Kindle.DB.OPERATOR)?g[Kindle.DB.VALUES][0]:g;d+=c(a,f,g);r<b.length-1&&(d+=j)}return d}function l(a,b,e){var d="",f,g,r;for(r=0;r<b.length;++r){g=b[r];f=e[g];if(!f)throw{name:"CreateUpperBoundException",message:"Need at least the root primary key to create an upper bound"};if(f.hasOwnProperty(Kindle.DB.OPERATOR)){var k=f[Kindle.DB.VALUES][f[Kindle.DB.VALUES].length-
1];if(typeof k==="number")f=f[Kindle.DB.VALUES][f[Kindle.DB.VALUES].length-1];else if(typeof k==="string")f=k;else throw{name:"InvalidKeyException",message:"Tried to generate a lowerbound key with invalid keys"};}d+=c(a,g,f);r<b.length-1&&(d+=j)}return d}function o(a,b){for(var c=Date.now()-2E3,e=0;e<Q.length;e++)if(Q[e].id===a){Q[e].time<c&&KindleDebug.log("Long write: "+(Date.now()-Q[e].time));Q.splice(e,1);break}Q.length===0&&(clearInterval(S),S=null);K&&(K=!1,g(Kindle.ERROR.DB_LINGERING_WRITE,
{stalled:!1,writeOk:b}))}function s(){var a=Date.now()-5E3;Q.some(function(b){return b.time<a&&!b.warned})&&(Q.forEach(function(a){a.warned=!0}),K=!0,g(Kindle.ERROR.DB_LINGERING_WRITE,{stalled:!0}))}function f(a,b,c){var d,f=new jQuery.Deferred,j=new jQuery.Deferred,g=$.makeArray(a),r;c===M?(S||(S=setInterval(s,5E3)),Q.push({id:++O,time:Date.now(),warned:K}),r=O):r=0;var k=r;try{d=e.transaction(g,c)}catch(t){return f.reject().promise()}d.oncomplete=function(){k&&o(k,!0);j.then(f.resolve,f.reject)};
d.onerror=function(a){k&&o(k,!1);f.reject(a)};d.onabort=function(){k&&o(k,!1);f.reject({code:Kindle.DB.QUOTA_ERR,message:"Assumed QUOTA_ERR"})};b(d,a,j);return f.promise()}function u(a,b,c){function e(){++d===f&&w.resolve(B)}for(var d=0,f=c.length,j=z[b].tableInfo,g=z[b].keyPath,r=z[b].genKeyPath,t=z[b].autoInc,w=new jQuery.Deferred,l,B=[],m=0;m<c.length;m++){for(var v in c[m])l=j[v],l&Kindle.DB.TEXT_TYPE?c[m][v]=typeof c[m][v]==="string"?c[m][v]:String(c[m][v]):l&Kindle.DB.NUMBER_TYPE&&(c[m][v]=
typeof c[m][v]==="number"?c[m][v]:Number(c[m][v]));!t&&!c[m][g]?(l=r?k(c[m],b):g,l=a.put(c[m],l)):l=t?a.add(c[m]):a.put(c[m]);l.onsuccess=e;l.onerror=w.reject;B.push(c[m])}return w.promise()}function q(a,b){if(!a||!b)throw{name:"databaseInsertError",message:"Tried to insert with an empty table name or empty object list"};d(a);return f(a,function(a,c,h){a=a.objectStore(c);u(a,c,b).then(h.resolve,h.reject)},M)}function n(a,b,c){function e(a,b){return a-b}d(b);var f=c?$.extend(!0,{},c):c,j,g=z[b].tableInfo,
r=z[b].keyPath,c=z[b].keyList,t=z[b].autoInc,w=new jQuery.Deferred,B=!1,v;if(f)for(var o in f){var u=f[o];if(u){var I=g[o],u=u.hasOwnProperty(Kindle.DB.OPERATOR);if(I&Kindle.DB.TEXT_TYPE)if(u){for(var H in f[o][Kindle.DB.VALUES])I=f[o][Kindle.DB.VALUES][H],f[o][Kindle.DB.VALUES][H]=typeof I==="string"?I:String(I);f[o][Kindle.DB.VALUES].sort()}else typeof f[o]!=="string"&&(f[o]=String(f[o]));else if(I&Kindle.DB.NUMBER_TYPE)if(u){for(var E in f[o][Kindle.DB.VALUES])I=f[o][Kindle.DB.VALUES][E],f[o][Kindle.DB.VALUES][E]=
typeof I==="number"?I:Number(I);f[o][Kindle.DB.VALUES].sort(e)}else typeof f[o]!=="number"&&(f[o]=Number(f[o]));!B&&u&&(B=!0)}}!B&&f&&(f[r]?j=f[r]:t||(j=k(f,b)));if(j)v=a.get(j),v.onsuccess=function(a){(a=a.target.result)?w.resolve([a]):w.resolve([])},v.onerror=w.reject;else{var s=[],q;if(f){j=!0;for(var n in c)if(!f[c[n]]){j=!1;break}if(j)j=m(b,c,f),b=l(b,c,f),b=IDBKeyRange.bound(j,b,!1,!1),v=a.openCursor(b);else{n={};for(var J in c)if(f[c[J]]){q=c[J];n[q]=f[q];break}if(!q){for(var D in f)if(f[D].hasOwnProperty(Kindle.DB.OPERATOR)){q=
D;n[D]=f[D];break}q||(q=Object.keys(f)[0])}n[q]&&n[q].hasOwnProperty(Kindle.DB.OPERATOR)?(j=m(b,[q],n),b=l(b,[q],n),b=IDBKeyRange.bound(j,b,!1,!1)):b=IDBKeyRange.only(f[q]);try{v=a.index(q).openCursor(b)}catch(y){v=a.openCursor()}}}else v=a.openCursor();v.onerror=w.reject;v.onsuccess=function(a){var a=a.target.result,b=!0;if(a){for(var c in f){var h=f[c];if(h){if(h.hasOwnProperty(Kindle.DB.OPERATOR))switch(b=$.inArray(a.value[c],h[Kindle.DB.VALUES])!==-1,h[Kindle.DB.OPERATOR]){case Kindle.DB.NOT_EQUAL:b=
!b}else h!==a.value[c]&&(b=!1);if(!b)break}}b&&s.push(a.value);a["continue"]()}else w.resolve(s)}}return w.promise()}function v(a,b,c){var e=c[0],c=c[1],d=new jQuery.Deferred;n(a,b,c).then(function(c){if(c.length>0){for(var f in c)c[f]=$.extend(c[f],e);u(a,b,c).then(d.resolve,d.reject)}else d.resolve(c)},d.reject);return d.promise()}function w(a,b,c){return f(a,function(a,h,e){a=a.objectStore(h);v(a,h,[b,c]).then(e.resolve,e.reject)},M)}function B(a,b,c){var e=new jQuery.Deferred;v(a,b,c).then(function(d){d.length===
0?(c[0]=$.extend(c[0],c[1]),u(a,b,[c[0]]).then(e.resolve,e.reject)):e.resolve(d)},e.reject);return e.promise()}function H(a,b,c){return n(a,b,c[0])}function E(a,b,c){return f(a,function(a,e,h){a=a.objectStore(e);H(a,e,[b]).then(function(a){if(c)for(var b in a)for(var e in a[b])e in c||delete a[b][e];h.resolve(a)},h.reject)},P)}function J(a,b,c){function e(c){function j(){return function(){++g===c.length&&d.resolve()}}var g=0;if(c.length===0)d.resolve();else for(var r in c){var t=k(c[r],b);f=a["delete"](t);
f.onsuccess=j(t,c[r]);f.onerror=d.reject}}var c=c[0],d=new jQuery.Deferred,f;c?n(a,b,c).then(e,d.reject):(f=a.clear(),f.onsuccess=d.resolve,f.onerror=d.reject);return d.promise()}function D(a){for(var b=new jQuery.Deferred,c=e.transaction(a,M),d=0;d<a.length;d++)c.objectStore(a[d]).clear().onerror=b.reject;c.oncomplete=b.resolve;c.onabort=b.reject;c.onerror=b.reject;return b.promise()}function L(){var b=new jQuery.Deferred;e.onversionchange=function(){e.close();e=void 0};e.close();var c=window.indexedDB.deleteDatabase(a.shortName);
c.onsuccess=function(){b.resolve()};c.onerror=function(){b.reject()};c.onblocked=function(){b.notify({blocked:!0})};return b.promise()}function y(){return A(function(a){return a.value})}function A(a){return f("bookinfo",function(b,c,e){var d=[],b=b.objectStore(c).openCursor();b.onsuccess=function(b){if(b=b.target.result){var c=a(b);c&&d.push(c);b["continue"]()}else e.resolve(d)};b.onerror=e.reject},P)}function C(a){function c(a){w.reject(a)}function d(a){w.reject(a)}function f(a){if(a=a.target.result)a["delete"](),
a["continue"]()}function j(){}var g=b(),t,w,l,v,m,B,o,I;w=new jQuery.Deferred;B=e.transaction(g,M);B.oncomplete=function(){w.resolve()};B.onerror=c;B.onabort=c;for(l=0;l<a.length;++l){v=a[l];m=k({asin:v,id:0},"skeleton");I=k({asin:v,id:r},"skeleton");I=IDBKeyRange.bound(m,I);for(m=0;m<g.length;m++)t=z[g[m]],o=B.objectStore(g[m]),t.genKeyPath?(t=o.openCursor(I),t.onsuccess=f):(t=o["delete"](v),t.onsuccess=j),t.onerror=d}return w.promise()}var j=String.fromCharCode(31),t=8,r="99999999",I=a,e=null,z=
{},N=ListenerManager(),P=IDBTransaction.READ_ONLY||"readonly",M=IDBTransaction.READ_WRITE||"readwrite",Q=[],K=!1,O=1,S=null,T={};T[Kindle.DB.INSERT_LIST_OPERATION]=u;T[Kindle.DB.UPDATE_RECORD_OPERATION]=v;T[Kindle.DB.UPSERT_RECORD_OPERATION]=B;T[Kindle.DB.DELETE_RECORD_OPERATION]=J;T[Kindle.DB.GET_RECORD_OPERATION]=H;T[Kindle.DB.CREATE_TABLE_OPERATION]=function(){KindleDebug.error("Illegal function: doCreateTable")};if(!function(a){var b,c;for(c in a){b=c;var e=!0,d=!1,f=void 0,g=[],r=[],t="",k=[],
w=a[c],l=void 0;for(l in w){f=w[l];if(f&Kindle.DB.AUTO_INCREMENT||f&Kindle.DB.PRIMARY_KEY)d?e=!1:(d=!!(f&Kindle.DB.AUTO_INCREMENT))||g.push(l);f&(Kindle.DB.PRIMARY_KEY|Kindle.DB.SECONDARY_KEY)&&k.push({name:l,keyPath:l,unique:!1,multientry:!1})}if(e){for(var f=!1,m=0;m<g.length;++m)t+=g[m],r[m]=w[l],m<g.length-1&&(t+=j,f=!0);g.length===0&&(d=!0);z[b]={info:w,keyList:g,keyPath:t?t:void 0,genKeyPath:f,genKeyTypes:r,indexes:k,autoInc:d,tableInfo:w}}b=e;if(b&Kindle.DB.CONSTRAINT_ERROR)return!1}return!0}(a.tables))throw Error("Invalid table description for "+
a.shortName);return{createTables:function(){KindleDebug.error("Called deprecated createTables function")},openDatabase:function(){var a=new jQuery.Deferred,b;window.indexedDB=window.indexedDB||window.mozIndexedDB||window.msIndexedDB||window.webkitIndexedDB;window.IDBTransaction=window.IDBTransaction||window.webkitIDBTransaction;b=window.indexedDB.open(I.shortName,I.version);b.onsuccess=function(b){e=b.target.result;a.resolve(e)};b.onerror=function(b){a.reject(b)};b.onupgradeneeded=function(a){var c;
a:{c=I.tables;var a=a.target.result,e,h,d;d=a.objectStoreNames;for(e=0;e<d.length;e++)h=d[e],c.hasOwnProperty(h)||a.deleteObjectStore(h);for(h in c)if($.inArray(h,d)===-1){var f=a;e=h;if(z[e]===void 0)e=Kindle.DB.CONSTRAINT_ERR;else{var j={autoIncrement:z[e].autoInc};if(!j.autoIncrement&&!z[e].genKeyPath)j.keyPath=z[e].keyPath;var f=f.createObjectStore(e,j),g=j=void 0;for(g in z[e].indexes)j=z[e].indexes[g],f.createIndex(j.name,j.keyPath,{unique:j.unique});e=null}if(e&Kindle.DB.CONSTRAINT_ERR){c=
!1;break a}}c=!0}c||b.abort()};return a.promise()},dropTable:function(a){return D([a])},dropTables:function(){function a(){y().then(b,j)}function b(a){function e(){d(a).then(f,j)}a.length===0?f():c(a).then(e,j)}function c(a){function b(){++h===a.length&&e.resolve()}for(var e=new jQuery.Deferred,h=0,d=0;d<a.length;d++)w("bookinfo",{cacheState:Kindle.BookInfo.CachedState.PARTIAL},{asin:a[d].asin}).then(b,e.reject);return e.promise()}function d(a){function b(){++e===a.length&&c.resolve()}for(var c=new jQuery.Deferred,
e=0,h=0;h<a.length;h++)C([a[h].asin]).then(b,c.reject);return c.promise()}function f(){D($.makeArray(e.objectStoreNames)).then(g.resolve,j)}function j(){KindleDebug.error("Error occured signing out");g.reject()}var g;if(window.indexedDB.deleteDatabase)return L();g=new jQuery.Deferred;e.name==="K4Wbooks"?$.when(D(["annotationsCache"]),D(["pageNumberCache"])).then(a,j):f();return g.promise()},getTableNames:b,insertRecord:function(a,b){return q(a,[b])},insertList:q,upsertRecord:function(a,b,c){return f(a,
function(a,e,h){a=a.objectStore(e);B(a,e,[b,c]).then(h.resolve,h.reject)},M)},updateRecord:w,getRecord:E,deleteRecord:function(a,b){return f(a,function(a,c,e){a=a.objectStore(c);J(a,c,[b]).then(e.resolve,e.reject)},M)},batchTransaction:function(a){if(!a||a.length===0){var b=new jQuery.Deferred;b.resolve([]);return b.promise()}var b=[],c=!0,e=[],j=0,g;for(g in a)$.inArray(a[g].tableName,b)===-1&&(d(a[g].tableName),b.push(a[g].tableName)),c&&a[g].operation!==Kindle.DB.GET_RECORD_OPERATION&&(c=!1);return f(b,
function(b,c,f){function g(b){return function(c){e[b]=c;++j===a.length?f.resolve(e):t()}}function r(){b.abort();f.reject()}function t(){(k=a[w])||f.reject();d(k.tableName);T[k.operation](b.objectStore(k.tableName),k.tableName,k.params).then(g(w),r);++w}var k,w=0;t();return f.promise()},c?P:M)},getPieceIds:function(a,b){d(a);return f(a,function(c,e,d){var f=[],g,c=c.objectStore(a),e=k({asin:b,id:0},a);g=k({asin:b,id:r},a);e=IDBKeyRange.bound(e,g);c=c.openCursor(e);c.onsuccess=function(a){var b;(a=
a.target.result)?(b=a.key.split(j),b=parseInt(b[1],10),f.push(b),a["continue"]()):d.resolve(f)};c.onerror=d.reject},P)},getOldBookList:function(a){return A(function(b){if(b.key!==a&&b.value.cacheState!==Kindle.BookInfo.CachedState.PINNED)return b.value})},dbGetBookStatistics:function(a){function c(a){g.reject(a)}function d(a){g.reject(a)}function f(a){w[a]={count:0,size:0};return function(b){(b=b.target.result)?(w[a].count++,w[a].size+=b.value.size,b["continue"]()):w.totalSize+=w[a].size}}var j=[];
$.each(b(),function(a,b){z[b]&&z[b].info.size&&j.push(b)});j.push("bookinfo");var g,t,w,l,m,v;g=new jQuery.Deferred;w={totalSize:0,cacheState:"",cachedSize:0};l=e.transaction(j,P);l.oncomplete=function(){g.resolve(w)};l.onerror=c;l.onabort=c;t=k({asin:a,id:0},j[0]);v=k({asin:a,id:r},j[0]);v=IDBKeyRange.bound(t,v);for(t=0;t<j.length-1;t++)w[j[t]]={count:0,size:0},m=l.objectStore(j[t]),m=m.openCursor(v),m.onsuccess=f(j[t]),m.onerror=d;m=l.objectStore("bookinfo");m=m.get(a);m.onsuccess=function(a){if(a=
a.target.result)w.cacheState=a.cacheState,w.cachedSize=a.cachedSize||0};m.onerror=d;return g.promise()},dbDeleteBooksData:C,getSearchIndexData:function(a){var b=$.Deferred(),c=KindleMetricsProfiler("retrieve db search index");E("searchIndex",{asin:a}).then(function(a){if(!a||!a.length)b.reject();else{var e={};a.forEach(function(a){e[a.component]=a.data});c.endTimer();c.log();b.resolve(e)}},b.reject);return b.promise()},putSearchIndexData:function(a,b){var c=$.Deferred(),e=KindleMetricsProfiler("save db search index"),
d=[];d.push({asin:a,component:"positions",data:b.positions});d.push({asin:a,component:"words",data:b.words});d.push({asin:a,component:"properties",data:b.properties});q("searchIndex",d).always(function(){e.endTimer();e.log();c.resolve(b)});return c.promise()},deleteJournalEntries:function(a){return f("journal",function(b,c,e){b=b.objectStore(c).openCursor();b.onsuccess=function(b){if(b=b.target.result){var c=b.value,d;for(d in a)if(c.type===a[d].type&&(c.guid||c.refEmId)===(a[d].guid||a[d].refEmId)&&
c.start===a[d].start&&c.end===a[d].end&&c.position===a[d].position&&c.modifiedTimestamp===a[d].modifiedTimestamp&&c.asin===a[d].asin){delete a[d];b["delete"]();break}b["continue"]()}else e.resolve()};b.onerror=e.reject},M)},addEventListener:N.addEventListener,removeEventListener:N.removeEventListener}}
function KindleSqlWrapper(a,g){function d(a){if(!A[a])throw{name:"databaseAccessError",message:"Trying to access undefined table "+a};}function b(a,b){var c=new jQuery.Deferred,d=[];y[b?"readTransaction":"transaction"](function(b){a(b,d)},function(a){c.reject(a)},function(){c.resolve(d)});return c.promise()}function c(){var a=[],b;for(b in A)a.push(b);return a}function k(a,b,c){var d=[],e,f;for(f in a)e=b[f],e!==void 0?a[f]&Kindle.DB.OBJECT_TYPE?d.push(JSON.stringify(e)):a[f]&Kindle.DB.BLOB_TYPE?
d.push(L(e)):d.push(e):c&&!(a[f]&Kindle.DB.AUTO_INCREMENT)&&d.push(null);return d}function m(a,b){var c="",d,e;for(e in a)if(d=b[e])if(c+=(c?" AND ":"")+e,d.hasOwnProperty(Kindle.DB.OPERATOR))switch(d[Kindle.DB.OPERATOR]){case Kindle.DB.NOT_EQUAL:c+=" != ?";break;case Kindle.DB.IN_ARRAY:c+=" IN (?";for(var f=1;f<d[Kindle.DB.VALUES].length;f++)c+=", ?";c+=")"}else c+=" = ?";return c}function l(a){var b="";a&Kindle.DB.TEXT_TYPE||a&Kindle.DB.OBJECT_TYPE||a&Kindle.DB.BLOB_TYPE?b+="TEXT ":a&Kindle.DB.AUTO_INCREMENT?
b+="INTEGER PRIMARY KEY AUTOINCREMENT ":a&Kindle.DB.NUMBER_TYPE&&(b+="INTEGER ");!(a&Kindle.DB.PRIMARY_KEY)&&!(a&Kindle.DB.ALLOW_NULL)&&(b+="NOT NULL ");return b}function o(a,b){var c="DELETE FROM "+a;b&&(c+=" WHERE "+m(A[a],b));return c+";"}function s(a,b,c){if(c===void 0)c="*";else{var d=A[a],e="",f;for(f in d)c[f]&&(e+=(e?", ":"")+f);c=e}c="SELECT "+c+" FROM "+a;b&&(c+=" WHERE "+m(A[a],b));return c+";"}function f(a,c){d(a);if($.isArray(c)){if(c.length===0)return(new jQuery.Deferred).resolve().promise()}else return(new jQuery.Deferred).reject().promise();
return b(function(b){u(b,a,[c])},!1)}function u(a,b,c,d,e){var c=c[0],f,d=A[b],e="INSERT OR "+(e?"IGNORE":"REPLACE")+" INTO "+b+" (",g="",w="";for(f in d)d[f]&Kindle.DB.AUTO_INCREMENT||(g+=(g?", ":"")+f,w+=(w?", ":"")+"?");e+=g+") VALUES ("+w+");";f=e;b=A[b];for(e=0;e<c.length;e++)d=k(b,c[e],!0),a.executeSql(f,d)}function q(a,b,c,d,e){var d=c[0],c=c[1],f=A[b],g=A[b],w="",l;for(l in g)d[l]!==void 0&&(w+=(w?", ":"")+l+" = ?");b="UPDATE "+(e?"OR IGNORE ":"")+b+" SET "+w;c&&(b+=" WHERE "+m(g,c));b+=";";
d=k(f,d);c&&(d=d.concat(k(f,c)));a.executeSql(b,d)}function n(a,b,c){q(a,b,c,[],!0);u(a,b,[[$.extend({},c[0],c[1])]],[],!0)}function v(a,b){var c={},d,e,f;for(f in a)if(d=b[f],d!==void 0&&d!==null){e=a[f];var g=c,k=f;if(e&Kindle.DB.OBJECT_TYPE)d=JSON.parse(d);else if(e&Kindle.DB.BLOB_TYPE){e=d;d=e.slice(1);e.charAt(0)==="x"&&(d=KindleO_Aaa.o_aag(d));e=new ArrayBuffer(d.length);for(var w=new Uint8Array(e),l=0;l<d.length;l++)w[l]=d.charCodeAt(l);d=e}g[k]=d}return c}function w(a,c,f){d(a);return b(function(b,
e){H(b,a,[c,f],e)},!0)}function B(a){var b=[],c;if(a)for(var d in a)c=a[d],c.hasOwnProperty(Kindle.DB.VALUES)?b=b.concat(c[Kindle.DB.VALUES]):b.push(c);return b}function H(a,b,c,d){var e=c[0],f=A[b];a.executeSql(s(b,e,c[1]),B(e),function(a,b){if(b.rows.length>0)for(var c=0;c<b.rows.length;c++)d.push(v(f,b.rows.item(c)))})}function E(a,b,c){c=c[0];a.executeSql(o(b,c),B(c))}function J(a){return b(function(b,c){for(var d,e=0;e<a.length;e++)if(d=C[a[e].operation])c[e]=[],d(b,a[e].tableName,a[e].params,
c[e])},!1)}function D(a){var b,c=[];for(b in a)c.push({operation:Kindle.DB.CREATE_TABLE_OPERATION,tableName:b,params:[a[b]]});return J(c)}function L(a){a=function(a){var b;b=a instanceof ArrayBuffer||Object.prototype.toString.call(a)==="[object ArrayBuffer]";if(!b)throw"[KindleSqlWrapper binaryToString] Unknown data type passed. Expect ArrayBuffer.";var c,e;if(KindleHostDeviceDetector.hasArrayLikeApply())try{var d=a.byteLength;b=d;for(c=[];b>=0;){var f=d-b,g=a.slice(f,Math.min(f+1E4,d));e=new Uint8Array(g);
c.push(String.fromCharCode.apply(null,e));b-=1E4}}catch(j){c=null}if(!c){c=[];e=new Uint8Array(a);for(a=0;a<e.length;a++)c.push(String.fromCharCode(e[a]))}return c.join("")}(a);return a.match(/\x00/g)?"x"+KindleO_Aaa.o_aaa(a):"t"+a}var y=null,A={},C={};C[Kindle.DB.INSERT_LIST_OPERATION]=u;C[Kindle.DB.UPDATE_RECORD_OPERATION]=q;C[Kindle.DB.UPSERT_RECORD_OPERATION]=n;C[Kindle.DB.DELETE_RECORD_OPERATION]=E;C[Kindle.DB.GET_RECORD_OPERATION]=H;C[Kindle.DB.CREATE_TABLE_OPERATION]=function(a,b,c){var c=
c[0],d="CREATE TABLE IF NOT EXISTS "+b+"(",e="",f,g=!0,k;for(k in c)g?g=!1:d+=", ",d+=k+" ",f=c[k],d+=l(f),f&Kindle.DB.PRIMARY_KEY&&(e+=e?", ":" PRIMARY KEY (",e+=k);e&&(d+=", "+e+")");d+=");";A[b]=c;a.executeSql(d,[])};C[Kindle.DB.ALTER_TABLE_OPERATION]=function(a,b,c){var d=A[b],e,f;e="";for(var g=0;g<c.length;g++)e=c[g],f=d[e]|Kindle.DB.ALLOW_NULL,e="ALTER TABLE "+b+" ADD COLUMN "+e+" ",e+=l(f),e+=";",a.executeSql(e,[])};return{createTables:function(){KindleDebug.error("Called deprecated createTables function")},
openDatabase:function(){var b=new jQuery.Deferred,c=a.defaultSize;g!==void 0&&c>g*1E6&&(c=_maxDbSize*1E6);try{y=openDatabase(a.shortName,"",a.displayName,c)}catch(d){try{y=openDatabase(a.shortName,"",a.displayName,5E6)}catch(f){return b.reject(f)}}var e=parseInt(y.version,10)||y.version;KindleHostDeviceDetector.isiOS_4x()||y.changeVersion(e,a.version);D(a.tables).done(function(){var c=a.versionUpdate,d=[];if(c&&c.length)for(var f=0;f<c.length;f++)c[f].version>e&&d.push({operation:c[f].operation,tableName:c[f].tableName,
params:c[f].params});J(d).then(b.resolve(y),b.reject)}).fail(b.reject);return b.promise()},dropTables:function(){return b(function(a){for(var b in A)a.executeSql("DROP TABLE IF EXISTS "+b+";")},!1)},getTableNames:c,insertRecord:function(a,b){return f(a,[b])},insertList:f,upsertRecord:function(a,c,f){d(a);return b(function(b){n(b,a,[c,f])},!1)},updateRecord:function(a,c,f){d(a);return b(function(b){q(b,a,[c,f])},!1)},getRecord:w,deleteRecord:function(a,c){d(a);return b(function(b){E(b,a,[c])},!1)},
batchTransaction:J,getPieceIds:function(a,b){var c=new jQuery.Deferred;w(a,{asin:b},{id:!0}).then(function(a){var b=[],d;for(d in a)b.push(a[d].id);c.resolve(b)},c.reject);return c.promise()},getOldBookList:function(a){var b=new jQuery.Deferred;w("bookinfo",{asin:{operator:Kindle.DB.NOT_EQUAL,values:[a]},cacheState:{operator:Kindle.DB.NOT_EQUAL,values:[Kindle.BookInfo.CachedState.PINNED]}},{asin:!0,openTime:!0}).then(function(a){a.length===0?b.reject():b.resolve(a)},b.reject);return b.promise()},
dbGetBookStatistics:function(a){var b=new jQuery.Deferred,d=[];$.each(c(),function(a,b){A[b]&&A[b].size&&d.push(b)});for(var f={totalSize:0,cacheState:"",cachedSize:0},e,g=[],k=0;k<d.length;k++)g.push({operation:Kindle.DB.GET_RECORD_OPERATION,tableName:d[k],params:[{asin:a},{size:!0}]});g.push({operation:Kindle.DB.GET_RECORD_OPERATION,tableName:"bookinfo",params:[{asin:a},{cacheState:!0,cachedSize:!0}]});J(g).then(function(a){for(var c=0;c<d.length;c++){var g=a[c],j=0,k=void 0;for(k in g)j+=g[k].size;
e={count:g.length,size:j};f[d[c]]=e;f.totalSize+=e.size}f.cacheState=a[a.length-1][0].cacheState;f.cachedSize=a[a.length-1][0].cachedSize||0;b.resolve(f)},function(){b.resolve(f)});return b.promise()},dbDeleteBooksData:function(a){var b,d,f,e=[];f=c();for(d=0;d<a.length;++d)for(b=0;b<f.length;++b)e.push({operation:Kindle.DB.DELETE_RECORD_OPERATION,tableName:f[b],params:[{asin:a[d]}]});return J(e)},getSearchIndexData:function(a){var b=$.Deferred();w("searchIndex",{asin:a}).then(function(a){if(!a||
!a.length)b.reject();else{var c={},d={};a.forEach(function(a){c[a.component]=a.data});d.positions=c.positions;d.words=c.words;d.properties=c.properties;b.resolve(d)}},b.reject);return b.promise()},putSearchIndexData:function(a,b){var c=$.Deferred(),d=[];d.push({asin:a,component:"positions",data:b.positions});d.push({asin:a,component:"words",data:b.words});d.push({asin:a,component:"properties",data:b.properties});f("searchIndex",d).always(function(){c.resolve(b)});return c.promise()},deleteJournalEntries:function(a){var b=
[],c;for(c in a)b.push({operation:Kindle.DB.DELETE_RECORD_OPERATION,tableName:"journal",params:[{id:a[c].id}]});return J(b)}}}
function KindleStubDBWrapper(a){function g(a){if(!f[a])throw{name:"databaseAccessError",message:"Trying to access undefined table "+a};}function d(a,b){var c=b[0],d,k,l,m;for(m in c){d={};l=a;k=d;var o;o=l;var n=c[m];g(o);var s=f[o],C=!0,j=void 0,t=void 0;for(t in s.info)if(j=s.info[t],n[t])if(j&Kindle.DB.AUTO_INCREMENT)C=!1;else{switch(typeof n[t]){case "number":C=j&Kindle.DB.NUMBER_TYPE;break;case "string":C=j&Kindle.DB.TEXT_TYPE;break;case "object":C=j&Kindle.DB.OBJECT_TYPE}if(!C)break}else if(j&
Kindle.DB.AUTO_INCREMENT)q[o]++,n[t]=q[o];else if(!(j&Kindle.DB.ALLOW_NULL)||j&Kindle.DB.PRIMARY_KEY)C=!1;o=C?null:Kindle.DB.CONSTRAINT_ERR;C=s=n=void 0;if(o===null){C=f[l].keyList;s=u[l];for(l=0;l<C.length-1;l++)n=C[l],s[n]||(s[n]={}),s=s[k];k.container=s;k.key=C[C.length-1]}k=o;if(k===null)l=c[m][d.key],d.container[l]?k=Kindle.DB.CONSTRAINT_ERR:d.container[l]=c[m];else{k=Kindle.DB.CONSTRAINT_ERR;break}}return k}function b(a,b){var c=new jQuery.Deferred,f=d(a,[b]);f?c.reject(f):c.resolve();return c.promise()}
function c(a,b){g(a);var c=f[a].keyList,d=u[a],k,l,m={};for(k=0;k<c.length;k++)if(l=c[k],b[l])if(k===c.length-1){m.key=b[l];break}else d[b[l]]||(u[b[l]]={}),d=u[b[l]],delete b[l];else break;if(k<c.length-1)throw"unsupported use case for in-memory DB!!";m.container=d;m.selection=b;return m}function k(a,b){var d=b[0],f=null,g=c(a,b[1]);g.container&&g.key&&g.container[g.key]?$.extend(g.container[g.key],d):f=Kindle.DB.CONSTRAINT_ERR;return f}function m(a,b){$.extend(b[0],b[1]);var c=d(a,[[b[0]]]);c===
Kindle.DB.CONSTRAINT_ERR&&(c=k(a,b));return c}function l(a,b,d){var b=b[0],g=f[a],k=u[a],l,m;if(b){if(a=c(a,b),k=a.container)if(a.key)k[a.key]&&d.push(k[a.key]);else for(l in a=a.selection,g=!0,k){for(m in a)if(k[l][m]!==b[m]){g=!1;break}g&&d.push(k[l])}}else if(g.keyList.length!==1)throw"unsupported use case for in-memory DB!!";else for(l in k)d.push(k[l]);return null}function o(a,b){var d=b[0],f,g=u[a],k,l,m;if(d){if(f=c(a,d),g=f.container)if(f.key)delete g[f.key];else for(k in f=f.selection,m=
!0,g){for(l in f)if(g[k][l]!==d[l]){m=!1;break}m&&delete g[k]}}else u[a]={};return null}function s(a){var b=new jQuery.Deferred,c,d=[],f;for(f in a)if(c=a[f],d[f]=[],c=n[c.operation](c.tableName,c.params,d[f]))break;c===null?b.resolve(d):b.reject(c);return b.promise()}var f={},u={},q={},n={};n[Kindle.DB.INSERT_LIST_OPERATION]=d;n[Kindle.DB.UPDATE_RECORD_OPERATION]=k;n[Kindle.DB.UPSERT_RECORD_OPERATION]=m;n[Kindle.DB.DELETE_RECORD_OPERATION]=o;n[Kindle.DB.GET_RECORD_OPERATION]=l;n[Kindle.DB.CREATE_TABLE_OPERATION]=
function(a,b){var c=!0,d=!1,g,k=[],l=0,m=b[0],o;for(o in m)if(g=m[o],g&Kindle.DB.AUTO_INCREMENT||g&Kindle.DB.PRIMARY_KEY)d?c=!1:(d=g&Kindle.DB.AUTO_INCREMENT,k.push(o));if(c){if(k.length===0)k.push("id"),m.id=Kindle.DB.AUTO_INCREMENT,d=!0;f[a]={info:m,keyList:k};(g=u[a])||(u[a]={});if(d){for(var n in g)l=Math.max(l,parseInt(n,10));q[a]=l}}return c?null:Kindle.DB.CONSTRAINT_ERR};(function(){var b;try{b=JSON.parse(KindleLocalStorage.getItem(a))}catch(c){}b&&typeof b==="object"&&(u=b)})();return{persist:function(){var b=
null;try{KindleLocalStorage.setItem(a,JSON.stringify(u))}catch(c){b=Kindle.DB.QUOTA_ERR}return b},createTables:function(a){var b,c,d;b=new jQuery.Deferred;d=[];for(c in a)d.push({operation:Kindle.DB.CREATE_TABLE_OPERATION,tableName:c,params:[a[c]]});s(d).then(b.resolve,b.reject);return b.promise()},dropTables:function(){u={};f={};q={};KindleLocalStorage.setItem(a,null);return(new $.Deferred).resolve().promise()},getTableNames:function(){var a=[],b;for(b in f)a.push(b);return a},insertRecord:function(a,
c){return b(a,[c])},insertList:b,upsertRecord:function(a,b,c){var d=new jQuery.Deferred;(a=m(a,[b,c]))?d.reject(a):d.resolve();return d.promise()},updateRecord:function(a,b,c){var d=new jQuery.Deferred;(a=k(a,[b,c]))?d.reject(a):d.resolve();return d.promise()},getRecord:function(a,b){var c=new jQuery.Deferred,d=[],f=l(a,[b],d);f?c.reject(f):c.resolve(d);return c.promise()},deleteRecord:function(a,b){var c=new jQuery.Deferred,d=o(a,[b]);d?c.reject(d):c.resolve();return c.promise()},batchTransaction:s,
deleteJournalEntries:function(a){var b=[],c;for(c in a)b.push({operation:Kindle.DB.DELETE_RECORD_OPERATION,tableName:"journal",params:[{id:a[c].id}]});return s(b)}}}
var BookChunk=function(){var a=Object.freeze?function(a){return Object.freeze(a)}:function(a){return a},g=["fragment","glyph","skeleton","resource","locationMap"],d={};g.forEach(function(a){d[a]={}});d.resource.huge=!0;var b={types:a(g),properties:a(d),getId:function(a){if(a.fragmentMetadata!==void 0)return a.fragmentMetadata.id;else if(a.skeletonMetadata!==void 0)return a.skeletonMetadata.id;else if(a.glyphFragmentMetadata!==void 0)return a.glyphFragmentMetadata.id;else if(a.metadata!==void 0)return a.metadata.id;
else KindleAssert(!1,"Can't get id from book chunk: unrecognizable metadata.")}};g.forEach(function(a){b[a.toUpperCase()+"_TYPE"]=a});return a(b)}(),RemoteContentCache=function(){return{create:function(a){function g(a){m=a;if(!d||d.state!=="pending")d=$.Deferred();d.resolve(m)}var d=$.Deferred(),b=a.asin,c=a.contentProvider,k=a.contentRemover,m,l={};BookChunk.types.forEach(function(a){l[a]={getChunks:function(d,f,g){c("getChunks",b,a,d).then(f,g)},putChunks:function(d,f,g){var k={};d.forEach(function(a,
b){k[b]=a});c("putChunks",b,a,k).then(f,g)},getCachedIds:function(d,f){c("getChunkIds",b,a).then(d,f)}}});l.queryBookinfo=function(){return c("getBookinfo",b).pipe(function(a){g(a);return a})};l.getBookinfo=function(){return d.promise()};l.putBookinfo=function(a){g(a);return c("putBookinfo",b,a)};l.updateBookinfo=function(a){if(!m)return $.Deferred().reject("bad state");$.extend(m,a);return c("updateBookinfo",b,a)};l.getAnnotations=function(){return c("getAnnotations",b)};l.putAnnotations=function(a){return c("putAnnotations",
b,a)};l.getPageNumbers=function(){return c("getPageNumbers",b)};l.putPageNumbers=function(a){return c("putPageNumbers",b,a)};l.computeQuota=function(){return $.Deferred().resolve(0)};l.getBookStatistics=function(){return $.Deferred().reject()};l.checkCache=function(){return!0};l.deleteOldestBook=function(a,b){b()};l.deleteBooksData=function(){m=void 0;d.state()!=="pending"&&(d=$.Deferred());return k({asin:b})};l.downloadSearchIndex=function(a){return c("getSearchIndexReader",b,a)};l.initMetadata=
function(a){return c("initMetadata",b,a)};return l}}}(),ContentMigration=function(){function a(a){function b(d){var g="get"+(d.substr(0,1).toUpperCase()+d.substr(1))+"Ids";return a.source[g]().pipe(function(b){function g(){var m=b.splice(0,100);if(m.length===0)k.then(l.resolve,l.reject);else{var o="get"+(d.substr(0,1).toUpperCase()+d.substr(1))+"s",m=a.source[o](m);$.when(m,k).then(function(b){var l={};b.forEach(function(a,b){l[b]=a});k=a.target("putChunksNonT",a.asin,d,l);setTimeout(g,100)},l.reject)}}
var k=$.Deferred().resolve(),l=$.Deferred();g();return l.promise()})}function d(){var a=BookChunk.types[o++];a?b(a).then(d,g.reject):g.resolve()}var g=$.Deferred(),o=0,s=a.timer.createSubTimer("chunks");d();g.done(function(){s.endTimer()});return g.promise()}function g(a){var b=$.Deferred(),d=a.timer.createSubTimer("annotations");a.source.getAnnotations().then(function(d){a.target("putAnnotations",a.asin,d).then(b.resolve,b.reject)},b.reject);b.done(function(){d.endTimer()});return b.promise()}function d(a){var b=
$.Deferred(),d=a.timer.createSubTimer("pageNumbers");a.source.getPageNumbers().then(function(d){a.target("putPageNumbers",a.asin,d).then(b.resolve,b.reject)},b.reject);b.done(function(){d.endTimer()});return b.promise()}function b(a){var b=$.Deferred(),d=a.timer.createSubTimer("bookinfo");a.source.getBookInfo().then(function(d){a.target("putBookinfo",a.asin,d).then(b.resolve,b.reject)},b.reject);b.done(function(){d.endTimer()});return b.promise()}return{initialize:function(){KindleModuleManager.define(KindleModuleManager.CONTENT_MIGRATION,
[Kindle.MODULE.DB_CLIENT,KindleModuleManager.EMBEDDED_HOSTINTERFACE],function(c,k){return{moveBook:function(m){var l=$.Deferred(),o=c.getBookDb();if(!m)return l.reject("Need ASIN as param").promise();var s={timer:KindleMetricsProfiler("Migrate "+m),asin:m,target:k.contentProvider,source:o.BookInfoDB(m)},m=$.when(a(s),g(s),d(s),b(s));m.then(function(){s.timer.endTimer();s.timer.log()});m.then(l.resolve,l.reject);return l.promise()},notifyMigrationStatus:function(a){var b=$.Deferred();if(!a||!a.status)return b.reject("Need param.status as param").promise();
a.status==="done"?c.getBookDb().dropTables().then(b.resolve,b.reject):b.reject("this status is not handled");return b.promise()}}})}}}();function AssertionError(a){Error.call(this,a)}AssertionError.prototype=Error();AssertionError.prototype.name="AssertionError";function KindleAssert(){}
var KindleDebug=function(){return{error:function(){},log:function(){},warn:function(){},saveLogs:function(){saveLog=!0}}}(),KindleDeviceCapabilities=function(){function a(){return KindleHostDeviceDetector.isMetro()||KindleHostDeviceDetector.isIE()?!0:!1}var g;return{searchInTheBook:function(){return!KindleHostDeviceDetector.isiOS_4x()},showPageNumbers:function(){return!KindleHostDeviceDetector.isiOS_4x()},multiColumnMode:function(){return!0},useNativeSelection:a,useCSSRegions:function(){return a()},
useLocaleCompare:function(){if(g===void 0){try{"a".localeCompare("b","i")}catch(a){return g=a.name==="RangeError"}g=!1}return g},showFirstRunDialog:function(){return!KindleHostDeviceDetector.isMSEdge()},hasPageResizeIssues:function(){return KindleHostDeviceDetector.isiOS_9x()?!0:!1},hasSplitView:function(){return KindleHostDeviceDetector.isiOS()&&KindleHostDeviceDetector.getOSMajorVersion()>=9}}}(),KindleHostDeviceDetector=function(){function a(){return navigator.platform.indexOf("iPad")!==-1}function g(){return navigator.platform.indexOf("iPhone")!==
-1||navigator.platform.indexOf("iPod")!==-1}function d(){return a()||g()||s()}function b(){var a=-1;d()&&(a=navigator.userAgent.match(/OS (\d+)_/)[1]);return a}function c(){return(a()||g())&&parseInt(b(),10)===7}function k(){return(a()||g())&&parseInt(b(),10)>=8}function m(){return(a()||g())&&parseInt(b(),10)>=9}function l(){return navigator.userAgent.indexOf("Firefox")!==-1&&navigator.userAgent.indexOf("Trident")<0}function o(a){var b=navigator.userAgent.match(/Version\/(\d+\.\d+)(?:\.\d+)*(?: Mobile\/\S+)? Safari/);
return!b?!1:!a?!0:Number(b[1])>=Number(a)}function s(){return navigator.userAgent.indexOf("Cloud9")!==-1}function f(){return navigator.userAgent.indexOf("MSAppHost")!==-1}function u(){return f()&&q()}function q(){return!!/arm/i.test(navigator.cpuClass)}function n(){return l()?navigator.onLine:KindleModuleManager.getModuleSync(KindleModuleManager.NETWORK).isOnline()}function v(){return navigator.userAgent.indexOf("MSIE")!==-1||navigator.userAgent.indexOf("Trident")!==-1}function w(){return navigator.userAgent.indexOf("Chrome")!==
-1&&navigator.userAgent.indexOf("Safari")!==-1&&navigator.userAgent.indexOf("Edge")!==-1}function B(){return"standalone"in navigator&&navigator.standalone}function H(){return window.chrome&&Kindle.top.chrome.app&&Kindle.top.chrome.app.isInstalled}function E(){return window.navigator.msMaxTouchPoints>=1}return{isiOS:d,isiPad:a,isiPhone:g,isiOS_4x:function(){return(a()||g())&&navigator.userAgent.indexOf("OS 4")!==-1},isiOS_5xOrGreater:function(){return(a()||g())&&parseInt(b(),10)>=5},isiOS_7x:c,isiOS_8x:k,
isiOS_9x:m,hasiOSInnerHeightBug:function(){return!m()&&(c()||k())},hasCanvasSizeLimitProblem:function(){return d()},isMacintosh:function(){return navigator.userAgent.indexOf("(Macintosh;")!==-1},isFirefox:l,hasHangingDbPrompt:function(){if(!l())return!1;var a=/Firefox\/(\d+)/.exec(navigator.userAgent);return a.length>=1&&a[1]>=17},isSafari:o,isMetro:f,isMetroArm:u,isMetroSnappedView:function(){return f()&&window.outerWidth===320},isIE:v,isIE10:function(){return v()&&navigator.userAgent.indexOf("Trident/6.0")!==
-1},isIE11:function(){return v()&&(navigator.userAgent.indexOf("Trident/7.0")!==-1||navigator.userAgent.indexOf("Trident/8.0")!==-1)},isMSEdge:w,isArm:q,isCloud9:s,isTablet:function(){return a()||f()},isOnline:n,isNetworkAvailable:function(){if(!n())return(new jQuery.Deferred).reject().promise();var a=$.Deferred();$.ajax({url:"/ping",error:function(){a.reject()},timeout:5E3}).then(a.resolve,a.reject);return a.promise()},isNetworkAvailableSync:function(){if(!n())return!1;var a=!0;$.ajax({url:"/ping",
error:function(){a=!1},timeout:50,async:!1});return a},isChrome:function(){return window.chrome&&!w()},isiOSAppMode:B,isChromeApp:H,isFirefoxAppSupported:function(){return!!KindleHostDeviceDetector.isFirefox()&&window.navigator.mozApps},isInAppMode:function(){return B()||H()},isCookieEnabled:function(){return navigator.cookieEnabled},areWebWorkersSupported:function(){return typeof Worker!=="undefined"},isLocalStorageEnabled:function(){return KindleLocalStorage.isLocalStorageEnabled()},hasArrayLikeApply:function(){return!d()||
parseInt(KindleHostDeviceDetector.getOSMajorVersion(),10)>=6},isWebSQLSupported:function(){return!!window.openDatabase},isIndexedDBSupported:function(){return!!window.mozIndexedDB||!!window.indexedDB},isMSTouchEnabledDevice:E,isTouchDevice:function(){return d()||E()},getDevicePlatform:function(){return a()?"iPad":g()?"iPhone":s()?"otter":u()?"metroArm":f()?"metro":"desktop"},hasCanvasPerformanceProblem:function(){return a()&&KindleHostPadDetector.isPad1(B())||u()},hasMissingImgOnLoadProblem:function(){return o()||
B()||l()},hasImageRenderingProblem:function(){return o()||B()},getDeviceType:function(){return f()?Kindle.DeviceType.Metro:Kindle.DeviceType.KCR},getClientName:function(){return f()?Kindle.ClientName.Metro:Kindle.ClientName.KCR},getOSMajorVersion:b,getOSMinorVersion:function(){var a=-1;d()&&(a=navigator.userAgent.match(/OS (\d+)_(\d+_?(\d+)?)/)[2]);return a},getBrowserLanguage:function(){return navigator.language||navigator.userLanguage}}}(),KindleHostPadDetector=function(){return{isPad1:function(a){if(KindleLocalStorage.getItem("definitelyNotPad1"))return!1;
var g=0,d=1E3,b=0,c;for(i=0;i<3;i++)c=SunSpiderBenchmark.get3DSpeed(),c>g?g=c:c<d&&(d=c),b+=c;g=b/3;if(g>=200&&a)return!0;if(g>=100&&!a)return!0;KindleLocalStorage.setItem("definitelyNotPad1","true");return!1}}}();
function KindleInterfacesFactory(){function a(a,d){for(var b in d)if(d.hasOwnProperty(b)&&typeof a[b]!==typeof d[b])return!1;return!0}return{IKindleLibrary:{onReaderOpenStatus:function(){},onReaderClose:function(){},onStoreOpenStatus:function(){},libraryUpdateNeeded:function(){}},IKindleReader:{openBook:function(){},unloadReader:function(){},onStoreOpenStatus:function(){},pauseReader:function(){},resumeReader:function(){},setToolbarVisible:function(){},downloadBook:function(){},removeBook:function(){}},
IKindleAppForLibrary:{storeIsTOS:function(){},openStore:function(){},openBook:function(){},onLibraryLoaded:function(){},getQueryParameters:function(){}},IKindleAppForReader:{onReaderReady:function(){},closeReader:function(){},onStartReadingStatus:function(){},onRendererLoaded:function(){},openStore:function(){},pinBookToStart:function(){},onReaderTapped:function(){},onUserAction:function(){},hideAppBar:function(){}},checkImplements:a,assertImplements:function(g,d){a(g,d)||KindleAssert(!1,"Object fails to provide all properties of interface prototype")}}}
var KindleInterfaces=KindleInterfacesFactory(),KindlJournalManager=function(){function a(a){var b=[],c;for(c in a){var d=a[c].entry;d.guid=d.guid||d.refEmId;delete d.refEmId;d&&b.push(d)}return b}function g(a){var b=[],d;for(d in a)b.push({entry:a[d]});return k.getAppDb().getTable(c).insertList(b)}function d(b){function c(){var q,n=KindleModuleManager.getModuleSync(KindleModuleManager.RESOURCE_BUNDLE).getLocalTimeOffset();f<b.length?(g=Math.min(f+100,b.length),q=Array.prototype.slice.call(b,f,g),
f=g,m.updateAnnotations(a(q),n).then(function(){k.getAppDb().deleteJournalEntries(q).then(c,d.reject)},d.reject)):d.resolve()}var d=new jQuery.Deferred,f=0,g;c();return d.promise()}function b(){var a=new jQuery.Deferred;k.getAppDb().getTable(c).getRecord().then(function(b){b.length>0?d(b).then(a.resolve,a.reject):a.resolve()},a.reject);return a.promise()}var c="journal",k=null,m=null;return{initialize:function(){var a=new jQuery.Deferred,b=this;KindleModuleManager.getModuleList([KindleModuleManager.SERVICE_CLIENT,
KindleModuleManager.DB_CLIENT]).then(function(c){m=c[KindleModuleManager.SERVICE_CLIENT];k=c[KindleModuleManager.DB_CLIENT];a.resolve(b)},a.reject);return a.promise()},saveToJournal:function(a){var c=new jQuery.Deferred;g(a).then(function(){b().then(c.resolve,c.resolve)},c.reject);return c.promise()},uploadJournal:b}}(),KindleLegacyDeviceTokenStorage=function(){return{hasDeviceTokenFromStorage:function(){return KindleLocalStorage.getItem("kindleDeviceToken")!==null},getDeviceTokenFromStorage:function(){return KindleLocalStorage.getItem("kindleDeviceToken")},
setDeviceToken:function(a){KindleLocalStorage.setItem("kindleDeviceToken",a)},clearDeviceTokenFromStorage:function(){KindleLocalStorage.removeItem("kindleDeviceToken")}}}(),KindleMetricsProfiler=function(a){function g(a){for(var c=0,d=0;d<a.length;d+=1)c+=a[d].end-a[d].start;return c}var d={};d.name=a;d.counters=null;d.subTimers=null;d.runs=[{start:(new Date).getTime(),end:null}];d.endTimer=function(){var a=this.runs[this.runs.length-1];if(a.end===null)a.end=(new Date).getTime()};d.addCount=function(a,
c){if(this.counters===null)this.counters={};this.counters[a]===void 0?this.counters[a]=c:this.counters[a]+=c};d.createSubTimer=function(a){if(this.subTimers===null)this.subTimers={};this.subTimers[a]===void 0?this.subTimers[a]=KindleMetricsProfiler(a):this.subTimers[a].runs.push({start:(new Date).getTime(),end:null});return this.subTimers[a]};d.log=function(){this.logAsPercentageOfTime("",g(this.runs))};d.logAsPercentageOfTime=function(a,c){var d=a+":"+this.name,m,l=g(this.runs);KindleDebug.log(d+
":Time: "+l+"ms - ("+(c?l/c*100:100).toFixed(2)+"%)");for(m in this.counters)KindleDebug.log(d+":"+m+" : "+this.counters[m]);for(m in this.subTimers)this.subTimers[m].logAsPercentageOfTime(d,c)};return d};
function KindleModuleManagerFactory(){function a(a,b){if(n[a])throw"Duplicate registration of module "+a;if(!b)throw"Module is not initialized with an object "+a;n[a]=b;v[a].resolve(b)}function g(a){if(n.hasOwnProperty(a))throw"Duplicate registration of module "+a;n[a]=void 0}function d(b,c){v[b]||(v[b]=new jQuery.Deferred);a(b,c)}function b(b,c){g(b);v[b]||(v[b]=new jQuery.Deferred);c(v[b]);v[b].done(function(c){a(b,c)})}function c(a,c){b(a,function(a){c.done(a.resolve).fail(a.reject)})}function k(a){v[a]||
(v[a]=new jQuery.Deferred);return v[a].promise()}function m(a){if(!n[a])throw"Trying to get uninitialized module "+a;return n[a]}function l(a){return n.hasOwnProperty(a)}function o(a,b){n[a]=b}function s(a){var b=n[a];return{done:function(a){a(b)},fail:function(){},when:function(a){a(b)}}}function f(a){for(var b={},c=0;c<a.length;c++)b[name]=n[a];return{done:function(a){a(b)},fail:function(){},when:function(a){a(b)}}}function u(){n={}}var q={CONSTANTS:"Constants",DB_CLIENT:"DBClient",RESOURCE_BUNDLE:"ResourceBundle",
METRICS_MANAGER:"metrics_manager",SERVICE_CLIENT:"ServiceClient",APP_REGISTRATION:"Registration",JOURNAL_MANAGER:"JournalManager",BOOK_METADATA:"book_metaData",BOOK_FRAGMAP:"book_fragmap",EMBEDDED_HOSTINTERFACE:"embeddedHostInterface",CONTENT_MIGRATION:"contentMigration",NETWORK:"network",LINK_URLS:"linkUrls"},n={},v={};return{CONSTANTS:q.CONSTANTS,DB_CLIENT:q.DB_CLIENT,RESOURCE_BUNDLE:q.RESOURCE_BUNDLE,METRICS_MANAGER:q.METRICS_MANAGER,SERVICE_CLIENT:q.SERVICE_CLIENT,APP_REGISTRATION:q.APP_REGISTRATION,
JOURNAL_MANAGER:q.JOURNAL_MANAGER,BOOK_METADATA:q.BOOK_METADATA,BOOK_FRAGMAP:q.BOOK_FRAGMAP,EMBEDDED_HOSTINTERFACE:q.EMBEDDED_HOSTINTERFACE,CONTENT_MIGRATION:q.CONTENT_MIGRATION,NETWORK:q.NETWORK,LINK_URLS:q.LINK_URLS,ERROR_CODE_CANCEL:"canceled",registerModule:d,registerModuleList:function(a){for(var b in a)d(b,a[b])},registerModuleWithInitializer:b,registerModuleWithDeferred:c,detachModule:function(a){var b=n[a],c=v[a];c&&!c.isResolved()&&c.reject("canceled");delete n[a];delete v[a];return b},getModule:k,
getModuleList:function(a){var b=new jQuery.Deferred,c,d=[];for(c=0;c<a.length;c++)d.push(k(a[c]));$.when.apply($,d).done(function(){var c,d={};for(c=0;c<a.length;c++)d[a[c]]=arguments[c];b.resolve(d)}).fail(b.reject);return b.promise()},getModuleSync:m,isModuleInitialized:function(a){return n[a]!==void 0},isModuleRegistered:l,switchToTestMode:function(){this.registerModuleTest=o;this.getModule=s;this.getModuleSync=m;this.getModuleList=f;this.clear=u;delete this.registerModuleWithDeferred;delete this.registerModuleWithInitializer},
define:function(a,b,d){if(!l(a)){var f=[],g=$.Deferred();c(a,g);b&&b.length&&b.forEach(function(a){f.push(a&&$.isFunction(a.promise)?a:k(a))});$.when.apply($,f).then(function(){var a;typeof d==="function"?(a=$.makeArray(arguments),a=d.apply(d,a)):a=d;a&&$.isFunction(a.promise)?a.then(g.resolve,function(){g.reject()}):g.resolve(a)},function(){g.reject()})}},require:function(a,b){$.isArray(a)||(a=[a]);var c,d,f=[];a.forEach(function(a){f.push(a&&$.isFunction(a.promise)?a:k(a))});b||(d=$.Deferred(),
c=d.promise());$.when.apply($,f).then(function(){var a=$.makeArray(arguments);b?b.apply(b,a):d.resolve.apply(d,a)},function(){d&&d.reject()});return c}}}
var KindleModuleManager=KindleModuleManagerFactory(),KindleRemoteClient=function(){return{uploadFeedback:function(a){if(!a)return(new $.Deferred.reject).promise();var g=KindleLibrarySetting.getSettings(),g={DevicePlatform:KindleHostDeviceDetector.getDevicePlatform(),UserAgent:navigator.userAgent,WindowHeight:window.innerHeight,WindowWidth:window.innerWidth,AppCached:!!KindleLocalStorage.getItem("cached"),AppCacheStatus:window.applicationCache.status,TouchEnabled:KindleHostDeviceDetector.isTouchDevice(),
ApplicationMode:KindleHostDeviceDetector.isInAppMode(),Language:navigator.language,LocalStorageEnabled:KindleHostDeviceDetector.isLocalStorageEnabled(),LibrarySort:g.sortParam,LibraryView:g.viewState,TLD:Kindle.URL.getAmazonDomain()||"unknown"};return function(a){return KindleModuleManager.getModule(KindleModuleManager.DB_CLIENT).pipe(function(b){try{var c=b.getAppDb(),g=c.getCachedAsins(Kindle.BookInfo.CachedState.FULLY_DOWNLOADED),m=c.getAllBooks();a.info.OfflineStorageEnabled=!!b.bookDbEnabled();
return $.when(g,m)}catch(l){return $.Deferred.reject()}}).pipe(function(b,c){$.extend(a.info,{TotalBookCount:c.length,TotalBookDownloaded:b.length});return a.eid?a.eid:KindleModuleManager.getModuleSync(Kindle.MODULE.SERVICE_CLIENT).getEID()}).pipe(function(b){a.eid=b;return a},function(){return $.Deferred().resolve(a)})}({version:KindleVersion.getVersionString(),message:a.text,deviceType:KindleHostDeviceDetector.getDeviceType(),info:g}).pipe(function(a){a={url:"/remote/feedback",type:"POST",processData:!1,
contentType:"application/json",data:JSON.stringify(a)};return $.ajax(a)})}}}(),KindleTemplateManager=function(){return{initialize:function(){Handlebars.registerHelper("str",function(a){return ResourceBundle.getLocalizedString(a)})}}}(),KindleUserAgentMetricsInfo=function(){function a(){function a(){var b=/MSAppHost\/([0-9\.]+)/.exec(navigator.userAgent);if(b)return b[1]}var b;if(!(b=function(){var a;if(["ipad","iphone"].indexOf(d)!==-1&&(d="ios",(a=/CPU OS ([0-9_]+) /.exec(navigator.userAgent))&&
a.length>=2))return a[1]}())){var c;KindleHostDeviceDetector.isIE()&&(c=KindleHostDeviceDetector.isIE10()?"10":KindleHostDeviceDetector.isIE11()?"11":"unknown");b=c||a()||GoogleUserAgent.browserVersionString.toLowerCase()}return b}var g,d,b,c,k,m={chrome:14,firefox:7,safari:5,metro:1,ie:10,ios:4};return{browserWithVersionString:function(){if(!g){d=GoogleUserAgent.browserName.toLowerCase();b=a();a:{if(b){var l=/^0*([0-9]+)/.exec(b);if(l&&l.length>=2){c=parseInt(l[1],10);break a}else KindleDebug.error("Bad regex on versionString: "+
b)}c=void 0}k="undefined"===typeof c?"other":m[d]?[d,c].join("@"):"other";g=!0}return k}}}(),KindleVersion=function(){var a="011201999";window.location.hostname==="k4w-dev.aka.amazon.com"&&(a="999999998");if(a.length!==9)throw{name:"BadVersion",message:"bad version number. got: "+a};var g=null,d=null;return{getMetricsVersionString:function(){d||(d=parseInt(a.slice(0,2),10),d+=".",d+=parseInt(a.slice(2,4),10),d+=".",d+=parseInt(a.slice(4,6),10));return d},getVersionString:function(){g||(g=parseInt(a.slice(0,
2),10),g+=".",g+=parseInt(a.slice(2,4),10),g+=".",g+=parseInt(a.slice(4,6),10),g+=".",g+=parseInt(a.slice(6),10));return g},getVersionNumber:function(){return Number(a)},parseVersionString:function(a){return a&&(a=/(\d{1,2})\.(\d{1,2})\.(\d{1,2})\.(\d{1,3})/.exec(a))?Number(a[1])*1E7+Number(a[2])*1E5+Number(a[3])*1E3+Number(a[4]):NaN}}}(),LinkUrls=function(){function a(){b||(Kindle.URL.isPreProd()?(d=(d=Kindle.URL.getPreProdCountryCode())?d:"us",b=Kindle.CountryToDomainMap[d]):(b=Kindle.URL.getAmazonDomain(),
d=Kindle.DomainToCountryMap[b]))}function g(a){return $.Deferred().resolve(function(){var b;b=c+Kindle.CountryToDomainMap.us+k;b+="?"+l.DeviceType+"="+Kindle.DeviceType.KCR+"&"+l.Eid+"="+(s||"")+"&"+l.Method+"="+a;return b}())}var d,b,c="https://www.",k="/gp/kindle/kcp/links",m={Help:{NodeId:"200701430"},OfflineReading:{NodeId:"201255020"},IncreaseOfflineStorage:{NodeId:"201265520"},TroubleShooting:{NodeId:"200732370"},License:{NodeId:"200701450",RefTag:"kcr_legalnotices_menu"},KCPLanding:{DocId:{us:"1000493771",
uk:"1000425503",de:"1000482783",fr:"1000538763",it:"1000576423",es:"1000576363",jp:"3077089376",au:"3077705566",cn:"98968","in":"1000659093",ca:"1000817631",br:"1000828031",mx:"1001216041"},iTunesURL:"https://itunes.apple.com/",iTunesEndPoint:"/app/apple-store/id302584613?mt=8",DesktopEndpoint:"/gp/feature.html",DesktopQueryParam:"?ie=UTF8&docId="}},l={DeviceType:"deviceType",Eid:"eid",Method:"method",Asin:"a"},o={Help:"Help",Legal:"License",Terms:"TermsCond",Store:"StoreFront",Privacy:"Privacy",
DetailPage:"DetailPage"},s;return{getStoreUrl:function(d){if(s&&!d.kcrFree)return g(o.Store).pipe(function(a){d.tag&&(a+="&tag="+d.tag);d.refTag&&(a+="&ref_="+d.refTag);return a});else{a();var k=c+b+"?ref_="+d.refTag;d.tag&&(k+="&tag="+d.tag+"&at="+d.tag);return $.Deferred().resolve(k)}},getPrivacyUrl:function(){a();return c+b+"/privacy"},getTermsOfUseUrl:function(){return"http://www.kindle.com/support/terms"},getLegalUrl:function(){a();return c+b+"/gp/help/customer/display.html?nodeId="+m.License.NodeId+
"ref="+m.License.RefTag},getHelpUrl:function(){a();return c+b+"/gp/help/customer/display.html?nodeId="+m.Help.NodeId},getOfflineReadingUrl:function(){a();return c+b+"/gp/help/customer/display.html?nodeId="+m.OfflineReading.NodeId},getIncreaseOfflineStorageUrl:function(){a();return c+b+"/gp/help/customer/display.html?nodeId="+m.IncreaseOfflineStorage.NodeId},getTroubleShootingUrl:function(){a();return c+b+"/gp/help/customer/display.html?nodeId="+m.TroubleShooting.NodeId},getDetailPage:function(d){if(s&&
!d.kcrFree)return g(o.DetailPage).pipe(function(a){a+="&"+l.Asin+"="+d.asin;d.tag&&(a+="&tag="+d.tag);d.refTag&&(a+="&ref_="+d.refTag);return a});else{a();var k=c+b+"/dp/"+d.asin+("?ref_="+(d.refTag||Kindle.RefTag.Values.StoreSample));d.tag&&(k+="&tag="+d.tag+"&at="+d.tag);return $.Deferred().resolve(k)}},getKCPLandingPageLink:function(f){(!b||!d)&&a();var g;KindleHostDeviceDetector.isiPad()?g=m.KCPLanding.iTunesURL+d+m.KCPLanding.iTunesEndPoint:(g=c+b+m.KCPLanding.DesktopEndpoint,g=f?g+"/ref="+f:
g,g+=m.KCPLanding.DesktopQueryParam+m.KCPLanding.DocId[d]);return g},getDownloadLink:function(f){(!b||!d)&&a();var g=c+b+"/gp/kindle/kcpApp.html";return f?g+"/ref="+f:g},getAmazonDomainURL:function(){(!b||!d)&&a();return c+b},getRTEServiceURL:function(){(!b||!d)&&a();if(Kindle.URL.isPreProd()){var c="https://kindlestore-preprod";if(d==="it"||d==="es"||d==="in")c+="-eux";return c+"."+b+"/gp/digital/fiona/ajax/send-email-or-sms.html"}return this.getAmazonDomainURL()+"/gp/digital/fiona/ajax/send-email-or-sms.html"},
getNotebookURL:function(a,b){var c=Kindle.URL.getHostURL()+"/notebook",d=[];a&&d.push("asin="+a);b&&d.push("ref_="+b);return c=d?c+"?"+d.join("&"):c},initializeEid:function(a){s=a}}}(),KindleChromeInstaller=function(){function a(){function a(){window.location.reload(!1)}Kindle.top.chrome.webstore.install(void 0,function(){KindleDebug.log("install success");setTimeout(a,250)},function(a){KindleDebug.error(a)})}function g(){return window.chrome&&Kindle.top.chrome.webstore&&Kindle.top.chrome.webstore.install}
return{install:function(){g()?window.parent.document.getElementById("inlineInstallProxy").click():KindleMessageDialog.showError(Kindle.ERROR.OUTDATED_CHROME)},initialize:function(){if(KindleHostDeviceDetector.isChrome()&&g()){var d=document.createElement("button");d.id="inlineInstallProxy";d.style.display="none";$(d).click(a);$("body").append(d)}}}}(),KindleFirefoxInstaller=function(){function a(){return Kindle.URL.getHostURL()+"/offline/kcr_ff.webapp"}function g(){if(!KindleHostDeviceDetector.isFirefoxAppSupported())return $.Deferred().reject().promise();
var d=$.Deferred(),b=navigator.mozApps.getInstalled();b.onsuccess=function(){var c=!1,g=a();b.result.forEach(function(a){a.manifestURL===g&&(c=!0)});d.resolve(c)};b.onerror=function(){KindleDebug.error("Error checking installation status: "+this.error.message);d.reject()};return d.promise()}return{install:function(){var d=$.Deferred();g().done(function(b){b?d.reject():(b=navigator.mozApps.install(a()),b.onsuccess=function(){KindleDebug.log("Firefox App successfully installed.");d.resolve()},b.onerror=
function(){KindleDebug.error("Firefox App failed to install.");d.reject()})}).fail(d.reject);return d.promise()}}}();
EmbeddedReaderAPI={setLoginParameters:function(){},setFocusToReader:function(){},showAppbar:function(){},hideAppbar:function(){},toggleAppbar:function(){},sendMetrics:function(){},sendMetricsNow:function(){},deregister:function(){},clearDatabases:function(){},clearLocalStorage:function(){},openBook:function(){},goTo:function(){},downloadBook:function(){},requestDownloadedBookList:function(){},cancelBookDownload:function(){},removeBook:function(){},removeBookOwnership:function(){},getSearchContext:function(){},
requestOemAssociateId:function(){},getTodoItems:function(){},removeTodoItems:function(){},uploadSnapshot:function(){},getSearchIndex:function(){},getDownloadedBookInfo:function(){},requestDeviceName:function(){},getSelectedText:function(){},hideContextMenu:function(){},setStoreCookies:function(){},setServiceHost:function(){},uploadJournal:function(){},getTOSParams:function(){},moveAsinToHost:function(){},notifyMigrationStatus:function(){},updateAppCache:function(){},convertPositions:function(){},
updateAnnotations:function(){}};
ReaderHostAPI={onReaderLoaded:function(){},onAppCacheStatus:function(){},onAppCacheUpdateReady:function(){},onBookOpenStatus:function(){},onBookClose:function(){},onOpenStore:function(){},onServiceAuthState:function(){},pinBookToStart:function(){},onBookDownloadComplete:function(){},onBookDownloadFailed:function(){},onBookDownloadProgress:function(){},onDeregister:function(){},onReaderTapped:function(){},onUserAction:function(){},hideAppBar:function(){},showWebPage:function(){},getRequestSigningHeaders:$.rpc.fn(),
contentProvider:$.rpc.fn({timeout:9E4}),deleteBookContent:$.rpc.fn(),searchContent:function(){},showAnnotations:function(){}};function ReaderHostInterfaceFactory(a,g){KindleInterfaces.assertImplements(a,EmbeddedReaderAPI);return $.rpc({name:"KCR",iRemote:ReaderHostAPI,local:a,channelId:"reader",target:window.parent,remoteDomain:g})};
